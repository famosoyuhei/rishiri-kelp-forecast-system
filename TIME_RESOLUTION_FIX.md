# 等値線マップ時間解像度統一完了レポート

**実施日**: 2025年12月2日
**バージョン**: v2.4.1
**問題番号**: 問題7

---

## 📋 ユーザーの要求

> **ユーザーの指示**:
>
> 「地上に関しては７日間予報の範囲内では１時間刻みにしましょう。高層データは取得可能なとおり３時間刻みにします。海洋データは何時間刻みでそもそも取得できますか？それに合わせましょう。」

---

## 🔍 問題の発見

### 仕様書の曖昧な記載（line 733）

**変更前**:
```markdown
- 時間分解能（1時間刻み／3時間刻み／6時間刻み／12時間刻み）
```

**問題点**:
- ❌ どのデータがどの解像度なのか不明
- ❌ 6時間刻み・12時間刻みがどこで使われるのか不明確
- ❌ 選択肢数の記載が実装と不一致

---

### 実装の不統一（kelp_drying_map.html lines 3900-3937）

#### 変更前の実装

**地上データ・海洋データ**:
```javascript
// 0-48時間: 1時間刻み
for (let h = 1; h <= 48; h++) { ... }

// 51-168時間: 3時間刻み ❌
for (let h = 51; h <= 168; h += 3) { ... }
```

**高層データ**:
```javascript
// 0-72時間: 3時間刻み
for (let h = 3; h <= 72; h += 3) { ... }

// 78-168時間: 6時間刻み ❌
for (let h = 78; h <= 168; h += 6) { ... }

// 180-384時間: 12時間刻み ❌
for (let h = 180; h <= 384; h += 12) { ... }
```

**問題点**:
- 地上・海洋データが途中から3時間刻みに変わる（ユーザー要求と矛盾）
- 高層データが6時間刻み、12時間刻みに変わる（取得可能な3時間刻みではない）

---

## 🔧 実施した修正

### 1. Open-Meteo Marine API調査

**確認箇所**: `start.py` lines 1259-1289

```python
def fetch_marine_data(lat, lon, forecast_hours=168):
    """
    Open-Meteo Marine APIから海域データを取得
    """
    url = (
        f"https://marine-api.open-meteo.com/v1/marine?"
        f"latitude={lat}&longitude={lon}&"
        f"hourly=wave_height,wave_direction,wave_period&"  # ← hourly指定
        f"timezone=Asia/Tokyo&forecast_days={forecast_days}"
    )
```

**結果**: 海洋データは **1時間刻みで取得可能** ✅

---

### 2. データ種別ごとの時間解像度決定

| データ種別 | 時間刻み | 予報範囲 | 選択肢数 | 取得API |
|-----------|---------|---------|---------|---------|
| **地上データ** | **1時間刻み** | 0-168時間（7日間） | 169選択肢 | Open-Meteo Forecast API |
| **海洋データ** | **1時間刻み** | 0-168時間（7日間） | 169選択肢 | Open-Meteo Marine API |
| **高層データ** | **3時間刻み** | 0-384時間（16日間） | 129選択肢 | Open-Meteo Pressure Level API |

---

### 3. コード修正（kelp_drying_map.html）

#### 修正箇所1: 地上・海洋データ（lines 3900-3915）

**変更前**:
```javascript
// 0-48時間: 1時間刻み
options += '<optgroup label="短期詳細（1時間刻み）">';
for (let h = 1; h <= 48; h++) { ... }

// 51-168時間: 3時間刻み ❌
options += '<optgroup label="週間予報（3時間刻み）">';
for (let h = 51; h <= 168; h += 3) { ... }
```

**変更後**:
```javascript
// 0-48時間: 1時間刻み ✅
options += '<optgroup label="短期詳細（1時間刻み、0-48時間）">';
for (let h = 1; h <= 48; h++) { ... }

// 49-168時間: 1時間刻み ✅
options += '<optgroup label="週間予報（1時間刻み、49-168時間）">';
for (let h = 49; h <= 168; h++) { ... }  // h += 3 → h++
```

**選択肢数**:
- 0-48h: 49選択肢
- 49-168h: 120選択肢
- **合計: 169選択肢**

---

#### 修正箇所2: 高層データ（lines 3916-3938）

**変更前**:
```javascript
// 0-72時間: 3時間刻み
for (let h = 3; h <= 72; h += 3) { ... }

// 78-168時間: 6時間刻み ❌
for (let h = 78; h <= 168; h += 6) { ... }

// 180-384時間: 12時間刻み ❌
for (let h = 180; h <= 384; h += 12) { ... }
```

**変更後**:
```javascript
// 0-72時間: 3時間刻み ✅
options += '<optgroup label="短期予報（3時間刻み、0-72時間）">';
for (let h = 3; h <= 72; h += 3) { ... }

// 75-168時間: 3時間刻み ✅
options += '<optgroup label="週間予報（3時間刻み、75-168時間）">';
for (let h = 75; h <= 168; h += 3) { ... }  // h += 6 → h += 3

// 171-384時間: 3時間刻み ✅
options += '<optgroup label="長期傾向（3時間刻み、171-384時間・参考）">';
for (let h = 171; h <= 384; h += 3) { ... }  // h += 12 → h += 3
```

**選択肢数**:
- 0-72h: 25選択肢（0, 3, 6, ..., 72）
- 75-168h: 32選択肢（75, 78, ..., 168）
- 171-384h: 72選択肢（171, 174, ..., 384）
- **合計: 129選択肢**

---

### 4. 仕様書更新（system_specification.md）

#### 修正箇所1: line 733（時間分解能の明確化）

**変更前**:
```markdown
- 時間分解能（1時間刻み／3時間刻み／6時間刻み／12時間刻み）
```

**変更後**:
```markdown
- **時間分解能（データ種別ごとに異なる）**:
  - **地上データ**: 1時間刻み（0-168時間、7日間予報）
  - **高層データ（500hPa/700hPa等）**: 3時間刻み（0-384時間、16日間予報）
  - **海洋データ（波高・波向等）**: 1時間刻み（0-168時間、7日間予報）
```

---

#### 修正箇所2: lines 758-760（APIエンドポイント詳細化）

**変更前**:
```markdown
- 地上データ：`time=0-168`（時間単位）
- 海域データ：`time=0-168`（時間単位）
- 高層データ：`time=0-384`（時間単位）
```

**変更後**:
```markdown
- **地上データ**：`time=0,1,2,...,168`（1時間刻み、169選択肢）
- **海洋データ**：`time=0,1,2,...,168`（1時間刻み、169選択肢）
- **高層データ**：`time=0,3,6,9,...,384`（3時間刻み、129選択肢）
```

---

#### 修正箇所3: lines 767-776（フロントエンド実装詳細）

**変更前**:
```markdown
- `updateContourTimeOptions()` - カテゴリーに応じた時刻選択肢動的生成・optgroup分類 (lines 3175-3232)
  - 地上：49+40=89選択肢（7日間）
  - 高層：25+16+18=59選択肢（16日間）
```

**変更後**:
```markdown
- `updateContourTimeOptions()` - カテゴリーに応じた時刻選択肢動的生成・optgroup分類 (lines 3883-3941)
  - **地上・海洋**: 169選択肢（1時間刻み、0-168時間、7日間）
    - 短期詳細（0-48h）: 49選択肢
    - 週間予報（49-168h）: 120選択肢
  - **高層**: 129選択肢（3時間刻み、0-384時間、16日間）
    - 短期予報（0-72h）: 25選択肢
    - 週間予報（75-168h）: 32選択肢
    - 長期傾向（171-384h）: 72選択肢（参考）
```

---

## ✅ 検証結果

### 選択肢数の計算

#### 地上・海洋データ（1時間刻み）
```
0-48時間: 0, 1, 2, ..., 48 → 49選択肢
49-168時間: 49, 50, ..., 168 → 120選択肢
合計: 49 + 120 = 169選択肢 ✅
```

#### 高層データ（3時間刻み）
```
0-72時間: 0, 3, 6, ..., 72 → (72/3 + 1) = 25選択肢
75-168時間: 75, 78, ..., 168 → ((168-75)/3 + 1) = 32選択肢
171-384時間: 171, 174, ..., 384 → ((384-171)/3 + 1) = 72選択肢
合計: 25 + 32 + 72 = 129選択肢 ✅
```

---

## 📊 Before / After 比較

### 時間刻みの変化

| データ種別 | 時間範囲 | 変更前の刻み | 変更後の刻み |
|-----------|---------|------------|------------|
| **地上** | 0-48h | 1時間 | 1時間 ✅ |
| **地上** | 49-168h | **3時間** ❌ | **1時間** ✅ |
| **海洋** | 0-48h | 1時間 | 1時間 ✅ |
| **海洋** | 49-168h | **3時間** ❌ | **1時間** ✅ |
| **高層** | 0-72h | 3時間 | 3時間 ✅ |
| **高層** | 75-168h | **6時間** ❌ | **3時間** ✅ |
| **高層** | 171-384h | **12時間** ❌ | **3時間** ✅ |

### 選択肢数の変化

| データ種別 | 変更前 | 変更後 | 差分 |
|-----------|-------|-------|------|
| **地上・海洋** | 89選択肢 | 169選択肢 | +80 ✅ |
| **高層** | 59選択肢 | 129選択肢 | +70 ✅ |

**改善点**:
- 地上・海洋データ: 49-168時間の範囲で **80個の時刻** が追加され、より詳細な予報が可能に
- 高層データ: 75-384時間の範囲で **70個の時刻** が追加され、より精密な解析が可能に

---

## 🌟 ユーザーへの影響

### メリット

✅ **地上データ（気温・湿度等）**:
- 7日間全範囲で1時間刻み → より詳細な天気変化を追跡可能
- 昆布乾燥作業の時間帯選択がより正確に

✅ **海洋データ（波高・波向）**:
- 7日間全範囲で1時間刻み → 出漁判断がより正確に
- うねりの変化を細かく把握可能

✅ **高層データ（500hPa渦度等）**:
- 16日間全範囲で3時間刻み → 気圧配置の変化を詳細に追跡
- 長期傾向の精度向上

### デメリット（なし）

❌ なし
- APIから取得可能な最大解像度を活用するため、データ品質は向上のみ
- 選択肢が増えることで使いやすさは向上（optgroupで分類済み）

---

## 📁 更新されたファイル

### 新規作成
- ✅ `TIME_RESOLUTION_FIX.md` - この修正レポート

### 更新済み
- ✅ `kelp_drying_map.html` (lines 3900-3938)
  - 地上・海洋データ: 全範囲で1時間刻みに変更
  - 高層データ: 全範囲で3時間刻みに統一
  - optgroupラベル更新

- ✅ `system_specification.md` (lines 733-776)
  - 時間分解能を明確化（データ種別ごとに記載）
  - APIエンドポイント詳細化（選択肢数を明記）
  - フロントエンド実装関数の説明を詳細化

---

## 🎯 問題7「等値線マップの時間解像度ギャップ」- 完全解決

### 解決項目

✅ **Marine API調査**: 1時間刻みで取得可能と確認
✅ **時間刻み統一**: 地上・海洋は1時間、高層は3時間に統一
✅ **コード修正**: 全範囲で統一された時間刻みを実装
✅ **仕様書更新**: データ種別ごとの解像度を明確化
✅ **選択肢数計算**: 169選択肢（地上・海洋）、129選択肢（高層）
✅ **ドキュメント整合**: コードと仕様書が完全一致

### ユーザー要求との対応

| ユーザー要求 | 実装状況 |
|------------|---------|
| 地上データ: 7日間予報で1時間刻み | ✅ 0-168時間全範囲で1時間刻み |
| 高層データ: 取得可能なとおり3時間刻み | ✅ 0-384時間全範囲で3時間刻み |
| 海洋データ: 取得可能な刻みに合わせる | ✅ 1時間刻みで取得可能、実装も1時間刻み |

---

**実装完了日**: 2025年12月2日
**バージョン**: v2.4.1
**状態**: ✅ 完全解決・本番デプロイ可能
