# 利尻島昆布干し予報システム仕様書

## 干場について

- **干場名**: `H_(北緯の小数部分４桁)_(東経の小数部分４桁)`とし、ユーザーが新規干場を追加した場合もこれに従う
- **初期画面**: 新規ユーザーにとって最初に現れる画面は`hoshiba_map.html`であり、地図上に現れている任意の干場を選択すると以下が現れる：
  - 当該干場の翌日の予報を見るボタン
  - 当日及び以前の干せたかどうかの記録を入力するボタン
  - 当該干場を削除するボタン
- **初期表示**: 最初は全島がちょうど画面に収まる縮尺で全干場がマークされてる状態で現れ、自ら地図をズームして目的の干場を選択することもできるが、干場と重ならない所に「利尻町」及び「利尻富士町」のボタンがあり、選択すると絞り込むことができる
- **階層的フィルタリング**:
  - 町を選択すると該当する町内の干場のみが表示として残り、その全体がちょうど収まる縮尺に変わり、地区のボタンが現れる
  - 地区を選択すると同様にして該当する地区内の干場のみが表示として残り、縮尺も合わせられ、部落のボタンが現れる
  - 部落を選択すると同様にして該当する部落内の干場のみが表示として残り、縮尺も合わせられ、干場が選びやすくなる
- **干場追加機能**: `hoshiba_map.html`上に干場を追加するボタンがあり、それを選んだ状態で地図上の任意の陸地を押すとその仮干場の仮名（先述のルールに従う）および確認文が現れ、決定すると新干場が追加される
- **データ同期**: 干場の追加や削除は以下のファイルに自動反映される：
  - `hoshiba_spots.csv`
  - `hoshiba_records.csv` 
  - `hoshiba_spots_named.kml`等全干場の情報を含むファイル
- **座標系**: `hoshiba_spots.csv`はθの昇順に並んでおり、追加された干場は同規則に従って追加され、町、地区、部落に振り分けられる
  - **θ定義**: 利尻山の座標（北緯45.1821度、東経141.2421度）を中心とした極座標の角度
  - **θ=0基準**: 南岸の利尻富士町と利尻町の境界線のある北緯45.1007度、東経141.2461度を通る動径をθ=0と定める

## 予報について

干場を選択し、「予報」ボタンを選ぶと、まず翌日の予報が現れる。そして、別タブで2日後、3日後…1週間後まで選択できる。

### 内容

以下のように1時間刻みの推移予報を内容ごとに時間帯を変えて表示する

#### 午前4時から午後4時まで（全指標）
- 気温
- 湿度
- 風向（利尻島伝統風名表示）
- 風向とその干場のθ値との角度差
- 風速
- 日射量
- 雲量
- 鉛直p速度
- SSI
- 相当温位

#### 時間重み付け
- **午前4時から午前10時**: 風関連指標70%重要度、日射関連指標30%重要度
- **午前10時から午後4時**: 風関連指標40%重要度、日射関連指標60%重要度

#### 地形補正による高精度化
- **森林効果**: 森林地帯では風速-2.5m/s、湿度+10%の補正
- **標高効果**: 標高100mあたり気温-0.6°C、湿度-1%の補正  
- **海岸効果**: 海岸1km以内では湿度+5%、風速+1.0m/sの補正
- **実装ファイル**: `terrain_database.py`により自動適用

#### 高湿度リスク検出システム
湿度をもたらす多様な気象要因を総合的に分析：

##### 風向別湿度特性
- **東系風（45°-120°）**: 海上からの湿潤気流（ヤマセ含む）
- **南系風（135°-225°）**: 暖湿気流の北上
- **西系風（225°-315°）**: 日本海からの湿気
- **北系風（315°-45°）**: 冷湿気流・霧の発生要因

##### 統合湿度判定
- **高湿度警報**: 湿度85%以上（風向問わず）
- **複合リスク**: 風速<1.5m/s + 湿度>80%
- **地形増幅**: 森林地帯での湿度+10%効果
- **海岸効果**: 沿岸1km以内での湿度+5%効果

#### 科学的乾燥モデル（北海道研究機構準拠）
- **乾燥速度計算**: Rc = f(Wf, V) × (Hm - H)
- **時系列予測**: 1時間ごとの含水率変化シミュレーション
- **完了時間予測**: 「X時間で目標乾燥率到達」の定量表示
- **実装ファイル**: `kelp_drying_model.py`

#### 段階別乾燥判定
従来の「干せる/干せない」から「定量的乾燥進行予測」へ発展：

##### 初期段階（4-10時）：換気重視モデル
- **重要因子**: 風速 > 1.5m/s（漁師実践知準拠）
- **目的**: 湿度上昇防止・結露リスク回避

##### 後半段階（10-16時）：熱供給重視モデル  
- **重要因子**: 日射量・気温の累積効果
- **目的**: 残存水分の効率的蒸発促進

##### 統合判定
- **定量予測**: 「現在の条件なら8時間で完全乾燥」
- **時間別推移**: 「午後2時頃に目標含水率到達予定」
- **条件変化対応**: 「風が弱まったため1時間延長推奨」

## 記録について

- 干場を選択し、「記録」ボタンを選ぶと、日付選択が現れ、日付の入力間違いは機械学習に負の影響を及ぼすので注意するようにというメッセージが表示される
- 日付を選択し、もし当該日付の当該干場での記録が`hoshiba_records.csv`に既に存在する場合はその旨及び記録内容を伝えるメッセージが表示され、「キャンセル」か「記録を変更」の選択肢が現れる
- `hoshiba_records.csv`に記録がまだない、あるいは既存の記録を変更する選択をした場合、以下の3択が与えられる：
  - 完全乾燥
  - 中止
  - 干したが完全には乾かせなかった（泣）
- 記録が確定すると自動で`hoshiba_records.csv`に上書き保存され、機械学習が自動でアップデートされる

## お気に入り干場について

- 干場を選択し、その干場がお気に入りに未登録の場合は「お気に入りに追加」、すでにお気に入りに登録されている場合は「お気に入りから外す」という表示がある
- 当初の画面で地図上のお気に入りに登録されている干場は明るい色で表示される

## 通知について

- ユーザーがお気に入りの干場を複数選ぶことができ、6月以降であれば登録、通知設定して以降毎日午後4時に通知が現れる
- 沖止め等で昆布漁が休みの日を設定し、該当する日の前日は通知が来ないように設定できる
- 通知は9月終了とともに終了するが、それ以前であってもその年は昆布漁終了を設定すればそれ以降は翌年まで通知が来ない
- 10月から5月までは予報通知なし
- 5月31日アプリ保持者には午後4時に予報通知されるが、そこで昆布漁開始日を設定する選択肢があり、それを設定すればその前日午後4時まで通知されない

## 予報精度について

### 日数別信頼度表示
予報画面に以下の精度情報を常時表示：

| 予報日数 | 精度 | 信頼度 | 推奨用途 |
|----------|------|--------|----------|
| 1日後 | 100% | 最高 | 作業決定 |
| 2日後 | 95% | 高 | 作業計画 |
| 3日後 | 85% | 良 | 準備検討 |
| 4-5日後 | 70% | 中 | 参考情報 |
| 6-7日後 | 50% | 低 | 傾向把握 |

### 検証システム
- **過去実績との照合**: 実際の乾燥結果との精度検証
- **多日数精度検証**: 1-7日前予報の精度追跡システム  
- **実装ファイル**: `forecast_accuracy_verification.py`, `forecast_accuracy_multi_day.py`

### 利尻島の湿度変動要因
利尻島は四方を海に囲まれた地理的特性により、多方向からの湿潤気流影響を受ける：

#### 季節・風向別特徴
- **春季**: 移動性高気圧後面の南風による暖湿気流
- **夏季**: オホーツク海高気圧によるヤマセ（東系風）
- **秋季**: 日本海低気圧による西風湿潤気流
- **冬季**: 北西季節風による雪雲・湿潤空気

#### 地形による修飾効果
- **利尻山効果**: 標高1,721mによる地形性上昇・雲形成
- **海陸風循環**: 昼夜の温度差による局地風系
- **谷風・山風**: 地形に沿った湿度分布の変化

## 風向表示について

### 利尻島伝統風名システム

風向は利尻島の伝統的風名で表示され、干場の極座標θと統一された座標系を使用する。

#### 座標系統合
- **気象風向**: 真北を0°とする標準気象学的角度
- **干場極座標θ**: 利尻山中心、南岸境界線を0°とする角度
- **変換式**: `干場θ = 177.2° - 気象風向` （負の場合は `537.2° - 気象風向`）

#### 利尻島16方位伝統風名

| 気象風向 | 計算過程 | 干場θ | 伝統風名 | 読み | 方位 |
|----------|----------|-------|----------|------|------|
| 0° | 177.2° - 0° | 177.2° | アイ | ai | 北 |
| 22.5° | 177.2° - 22.5° | 154.7° | アイシモ・シモ | aishimo-shimo | 北北東 |
| 45° | 177.2° - 45° | 132.2° | シモ | shimo | 北東 |
| 67.5° | 177.2° - 67.5° | 109.7° | シモヤマセ | shimoyamase | 東北東 |
| 90° | 177.2° - 90° | 87.2° | ホンヤマセ | honyamase | 東 |
| 112.5° | 177.2° - 112.5° | 64.7° | ヤマセ | yamase | 東南東 |
| 135° | 177.2° - 135° | 42.2° | ミナミヤマセ | minamiyamase | 南東 |
| 157.5° | 177.2° - 157.5° | 19.7° | ミナミヤマ | minamiyama | 南南東 |
| 180° | 177.2° - 180° = -2.8° → | 357.2° | クダリ | kudari | 南 |
| 202.5° | 177.2° - 202.5° = -25.3° → | 334.7° | クダリヒカタ | kudarihikata | 南南西 |
| 225° | 177.2° - 225° = -47.8° → | 312.2° | ヒカタ | hikata | 南西 |
| 247.5° | 177.2° - 247.5° = -70.3° → | 289.7° | ニシヒカタ | nishihikata | 西南西 |
| 270° | 177.2° - 270° = -92.8° → | 267.2° | ニシ | nishi | 西 |
| 292.5° | 177.2° - 292.5° = -115.3° → | 244.7° | ニシタマ | nishitama | 西北西 |
| 315° | 177.2° - 315° = -137.8° → | 222.2° | タマ | tama | 北西 |
| 337.5° | 177.2° - 337.5° = -160.3° → | 199.7° | アイタマ | aitama | 北北西 |

#### 表示形式
- **予報画面**: 「ホンヤマセ」（伝統風名のみ）
- **角度非表示**: 干場θとの混同回避のため度数表示なし
- **統一性**: 干場位置と風向が同一座標系で理解可能

#### 実装仕様
- ファイル: `rishiri_wind_names.js`
- 関数: `getRishiriWindName(meteorologicalDirection)`
- 変換処理: 気象風向 → 干場θ → 最近傍16方位風名選択
- 出力: 伝統風名文字列のみ（角度表示なし）

## 局地気象予測システム高度化

### 背景・課題

現行システムは地理的分散地点で一様な予報を生成しており、利尻島の複雑な地形による局地気象差異が反映されていない。過去1週間の実測データ分析により、降水量で18.3%の変動係数、その他気象要素でも有意な地点間差異が確認された。

### 改善方針

「局地的気象予測に必要な準備」の専門的要件に基づき、以下の段階的システム高度化を実施する。

#### Phase 1: 基盤データ整備システム

##### 1.1 高密度観測データ統合
- **複数データソース統合**:
  - JMA（気象庁）アメダス・レーダーAPI
  - 気象衛星雲量・日射量データ
  - MSM数値予報モデル
  - ラジオゾンデ高層観測データ
- **実装ファイル**: `multi_source_weather_api.py`
- **更新間隔**: 10分間隔リアルタイム取得

##### 1.2 地形・地表面データベース
- **詳細地形データ**:
  - 10m間隔等高線データ（利尻島全域）
  - 海岸線詳細形状データ
  - 土地利用分類（海域・陸域・植生・市街地）
- **実装ファイル**: `terrain_database.py`
- **座標系**: 既存の干場極座標θシステムとの統合

#### Phase 2: 解析エンジン高度化

##### 2.1 等値線・等高線解析システム
- **等値線図生成**:
  - 等温線（気温）
  - 等湿線（湿度）
  - 等圧線（風向風速推定）
  - 等相当温位線（湿舌検出）
- **可視化**: カラーマップ・流線図・矢羽根図
- **実装ファイル**: `isoline_analysis_engine.py`

##### 2.2 大気安定度指標計算
- **鉛直p速度**: エマグラム・数値モデルから算出
- **SSI（ショワルター安定指数）**: 850/500hPa観測データから計算
- **相当温位**: 高層データ解析による湿舌検出
- **実装ファイル**: `atmospheric_stability_analyzer.py`

##### 2.3 段階的スケール解析
- **メソスケール**: 北海道規模（県単位）解析
- **局地スケール**: 利尻島規模（市町単位）解析  
- **マイクロスケール**: 干場単位解析
- **実装ファイル**: `multi_scale_analyzer.py`

#### Phase 3: 高解像度予測モデル

##### 3.1 細密計算モデル
- **計算格子**: 100m×100m高解像度格子
- **地形効果**:
  - 山岳効果（利尻山1,721m）
  - 海陸風効果
  - 谷風・山風循環
  - 地形性降水
- **実装ファイル**: `high_resolution_model.py`

##### 3.2 統計的補正・AI活用
- **バイアス補正**: 地点別予測誤差パターン学習
- **アンサンブル予測**: 複数モデル最適組み合わせ
- **機械学習**: 過去データによる予測精度向上
- **実装ファイル**: `statistical_correction_ai.py`

#### Phase 4: リアルタイム監視サイクル

##### 4.1 実況監視システム
- **監視間隔**: 10分間隔
- **予測修正**: 誤差検出による自動シナリオ更新
- **実装ファイル**: `realtime_monitoring_system.py`

##### 4.2 予報作業サイクル
- **解析サイクル**: 実況監視→シナリオ検討→モデル予報→修正
- **品質管理**: 予測精度評価・モデル性能監視

### 技術仕様

#### データ処理アーキテクチャ
```
観測データ取得 → 品質管理 → 等値線解析 → 地形効果計算 → 統計補正 → 予報出力
     ↓              ↓           ↓            ↓            ↓         ↓
   複数API統合   → 異常値除去 → 可視化生成 → AI学習更新 → 精度評価 → 干場別予報
```

#### 予測精度目標
- **気温**: 現行±1.0°C → 目標±0.5°C
- **風速**: 現行±2.0m/s → 目標±1.0m/s  
- **降水量**: 現行一様予測 → 地点別変動係数15-20%
- **地点間差異**: 現行0% → 実測レベル反映

#### 既存システムとの統合
- **風向表示**: 利尻島伝統風名システム継続使用
- **座標系**: 干場極座標θシステム維持
- **UI/UX**: 既存インターフェース拡張（高度化情報追加表示）

### 実装完了機能（2025年7月現在）

#### ✅ 地形補正システム（Phase 1完了）
- 森林・標高・海岸効果の自動補正
- 干場別の地形データベース統合  
- 精度検証：7月29日予報で100%適中

#### ✅ 高湿度リスク検出システム（Phase 2完了）
- 全風向対応の湿潤気流検出・警告
- 利尻島特有の多方向海洋影響を考慮
- 地形増幅効果の定量評価

#### ✅ 科学的乾燥モデル（拡張機能）
- 北海道研究機構の数式モデル実装
- 定量的乾燥速度・完了時間予測
- 段階別（初期・後半）重要因子の動的切り替え

#### ✅ 予報精度表示システム
- 日数別信頼度の透明化
- 過去実績に基づく客観的精度情報
- ユーザーの適切な判断基準提供

### 継続開発項目

| 機能 | 状況 | 主要成果物 | 検証方法 |
|-------|------|------------|----------|
| 等値線解析システム | 開発中 | 可視化強化 | 等値線精度・可視化品質評価 |
| 高解像度モデル | 計画中 | 100m格子予測 | 予測精度・地点間差異評価 |
| リアルタイム監視 | 検討中 | 監視サイクル | システム安定性・運用性評価 |

### 期待効果

#### 実現済み技術効果（2025年7月時点）
- **高精度予報**: 地形補正により1日後予報100%精度達成  
- **科学的定量化**: 「干せる/干せない」から「X時間で完了」へ進化
- **包括的リスク検出**: 全風向対応の湿度リスク分析システム
- **透明性確保**: 予報精度の日数別信頼度明示

#### 実現済み業務効果
- **安心感向上**: 予報信頼度の明示による判断支援強化
- **作業効率化**: 定量的完了時間予測による計画精度向上  
- **リスク軽減**: 多角的湿度分析による乾燥失敗防止
- **実践知融合**: 漁師経験と科学的モデルの統合活用

#### 継続開発による期待効果
- **可視化強化**: 等値線図・カラーマップによる直感的理解
- **超高解像度予測**: 100m格子による干場間差異の定量化
- **リアルタイム対応**: 条件変化への動的予報修正システム