# 等値線解析実装計画

## 背景

**問題点：**
- 予報データ：cos(角度差) vs 500hPa渦度 r=+0.788（強相関）
- 実測データ：cos(角度差) vs 500hPa渦度 r=-0.179（弱相関）
- **差異：0.967** → 予報モデルが相関を過大評価

**原因：**
1. 稚内単一観測点では空間的な渦度計算が不正確
2. 時間微分のみでは鉛直p速度・渦度の推定精度が低い
3. 利尻島周辺の局所的な気圧配置が考慮されていない

**解決策：等値線解析**

---

## 目的

1. **空間的な気圧場解析**
   - 利尻島周辺（半径200km）の500hPa・700hPa高度場
   - 等値線から実際の渦度・鉛直速度を計算

2. **実測データの統合**
   - 稚内ラジオゾンデ（上層）
   - 周辺アメダス（地上）
   - 気象庁数値予報GPVデータ（解析値）

3. **予報モデルとの比較**
   - 等値線解析（実測ベース）
   - Open-Meteo予報モデル
   - 実際の干場乾燥状況との相関

---

## データソース

### 1. 気象庁数値予報GPVデータ
- **MSM（メソモデル）解析値**
  - 空間解像度：5km
  - 時間解像度：3時間
  - 気圧面：500hPa, 700hPa, 850hPa
  - 要素：高度、気温、風向・風速

- **取得方法**
  - 気象庁HPからFTP/HTTP
  - または気象業務支援センターGPVデータ
  - GRIB2形式 → Python wgrib2/pygrib で読み込み

### 2. 稚内ラジオゾンデ（既存）
- 1日1回（09:00 JST）
- 500hPa, 700hPa, 850hPa の実測値
- 検証データとして使用

### 3. 周辺アメダス
- 利尻島内：沓形、本泊
- 北海道本島：稚内、天塩、浜頓別
- 地上風向・風速

---

## 実装ステップ

### Phase 1: データ取得・解析基盤
**優先度：高**

1. **気象庁MSM解析値取得スクリプト**
   - `fetch_jma_msm_gpv.py`
   - 利尻島周辺（44-46°N, 140-143°E）
   - 500hPa/700hPa高度場
   - 2024年6-8月

2. **GRIB2データパーサー**
   - `parse_grib_data.py`
   - pygrib または cfgrib を使用
   - NetCDF形式に変換

3. **空間補間・グリッド化**
   - `spatial_interpolation.py`
   - 利尻島を中心とした200km四方
   - 解像度：5km または 10km

### Phase 2: 等値線解析
**優先度：高**

4. **500hPa高度場等値線描画**
   - `contour_analysis_500hpa.py`
   - matplotlib.contour または cartopy
   - 等高線間隔：60m（標準）

5. **渦度計算（空間微分）**
   - `calculate_vorticity_spatial.py`
   - ∂v/∂x - ∂u/∂y（相対渦度）
   - 有限差分法で計算

6. **700hPa鉛直p速度計算**
   - `calculate_omega_spatial.py`
   - 準地衡風方程式 or 連続の式から計算
   - またはMSM解析値から直接取得

### Phase 3: 統合解析
**優先度：中**

7. **実測値との比較**
   - `validate_contour_vs_radiosonde.py`
   - 等値線解析による渦度 vs ラジオゾンデ時間微分
   - 精度評価（RMSE, 相関係数）

8. **風向-山角度差との相関再計算**
   - `recalculate_correlation_with_contour.py`
   - 等値線解析の渦度・omega を使用
   - 予報モデルとの比較

### Phase 4: 可視化・統合
**優先度：中**

9. **等値線マップ可視化**
   - `visualize_contour_maps.py`
   - 500hPa高度場 + 渦度
   - 700hPa等温線 + 鉛直p速度
   - 利尻島・干場位置オーバーレイ

10. **WebUI統合**
    - `kelp_drying_map.html` に等値線表示
    - リアルタイム気圧配置
    - 予報データと実況の切り替え

---

## 技術的課題と対策

### 課題1: GPVデータの取得
- **問題**: 気象庁GPVは一般公開が限定的
- **対策1**: 気象業務支援センター経由（有料だが高品質）
- **対策2**: JMA提供のサンプルデータで検証
- **対策3**: ERA5再解析データ（ECMWF）を代替使用

### 課題2: GRIB2形式の処理
- **問題**: GRIB2は複雑なバイナリ形式
- **対策**: pygrib または eccodes-python ライブラリ使用
- **検証**: サンプルデータで動作確認

### 課題3: 空間微分の精度
- **問題**: 5kmグリッドでの有限差分は誤差が大きい
- **対策**: 中心差分 + スムージング処理
- **検証**: ラジオゾンデとの比較で精度評価

---

## 代替案：ERA5再解析データ

**メリット：**
- 無料・即座にアクセス可能
- 全球カバー、高品質
- 0.25°解像度（約28km）
- 1時間ごと

**デメリット：**
- 解像度が粗い（MSM 5km vs ERA5 28km）
- 局所的な利尻島周辺の詳細が不足

**取得方法：**
```python
import cdsapi

c = cdsapi.Client()
c.retrieve(
    'reanalysis-era5-pressure-levels',
    {
        'product_type': 'reanalysis',
        'variable': ['geopotential', 'temperature', 'u_component_of_wind', 'v_component_of_wind'],
        'pressure_level': ['500', '700', '850'],
        'year': '2024',
        'month': ['06', '07', '08'],
        'area': [46, 140, 44, 143],  # North, West, South, East
        'format': 'netcdf'
    },
    'era5_rishiri_summer2024.nc'
)
```

---

## 優先順位と実装順序

### 最優先（今週）
1. ERA5データ取得テスト
2. NetCDF読み込み・等値線描画
3. 空間微分による渦度計算
4. ラジオゾンデとの比較

### 次優先（来週）
5. 風向-山角度差との相関再計算
6. 予報モデルとの精度比較
7. 可視化スクリプト作成

### 将来（必要に応じて）
8. 気象庁MSM-GPVデータ取得
9. WebUI統合
10. リアルタイム等値線表示

---

## 期待される成果

1. **実測ベースの相関検証**
   - 予報モデルの過大評価を定量化
   - 実際の物理プロセスを理解

2. **干場予測精度向上**
   - 空間的な気圧配置を考慮
   - シノプティックスケールの影響を正確に評価

3. **可視化による理解促進**
   - 等値線マップで直感的に理解
   - 漁業者への説明資料

---

## 次のアクション

**即座に実行：**
- ERA5データ取得スクリプト作成
- NetCDF読み込み・等値線描画テスト

**ユーザーに確認：**
- 気象業務支援センターGPVデータの利用可否
- 実装優先順位の調整
