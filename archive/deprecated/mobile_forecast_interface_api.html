<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âà©Â∞ªÂ≥∂ÊòÜÂ∏ÉÂπ≤„Åó‰∫àÂ†± APIÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', '„Éí„É©„ÇÆ„ÉéËßí„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .weather-input {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3436;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #0984e3;
        }
        
        .forecast-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .forecast-button:hover {
            transform: translateY(-2px);
        }
        
        .forecast-button:active {
            transform: translateY(0);
        }
        
        .forecast-button:disabled {
            background: #636e72;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            display: none;
            padding: 20px;
        }
        
        .overall-status {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .status-excellent {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }
        
        .status-good {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }
        
        .status-fair {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
        }
        
        .status-poor {
            background: linear-gradient(135deg, #d63031, #fd79a8);
            color: white;
        }
        
        .district-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .district-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f2f6;
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .district-card:hover {
            transform: translateY(-3px);
        }
        
        .district-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .district-score {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .district-humidity {
            font-size: 14px;
            color: #636e72;
        }
        
        .district-count {
            font-size: 12px;
            color: #636e72;
            margin-top: 5px;
        }
        
        .score-excellent { color: #00b894; font-weight: bold; }
        .score-good { color: #fdcb6e; font-weight: bold; }
        .score-fair { color: #fd79a8; font-weight: bold; }
        .score-poor { color: #d63031; font-weight: bold; }
        
        .recommendations {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .recommendations h3 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .recommendation-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 14px;
            border-left: 4px solid #0984e3;
        }
        
        .top-locations {
            margin-bottom: 20px;
        }
        
        .top-locations h3 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .location-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #00b894;
        }
        
        .location-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .location-details {
            font-size: 12px;
            color: #636e72;
        }
        
        .wind-analysis {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .wind-analysis h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .wind-info {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .refresh-button, .help-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .refresh-button {
            background: #74b9ff;
            color: white;
        }
        
        .help-button {
            background: #636e72;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #636e72;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0984e3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #c62828;
        }
        
        .footer {
            background: #2d3436;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 12px;
        }
        
        .api-status {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .status-online {
            color: #00b894;
        }
        
        .status-offline {
            color: #d63031;
        }
        
        @media (max-width: 400px) {
            .district-cards {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Âà©Â∞ªÂ≥∂ÊòÜÂ∏ÉÂπ≤„Åó‰∫àÂ†±</h1>
            <div class="subtitle">ÁßëÂ≠¶ÁöÑÂàÜÊûê„Å´„Çà„ÇãÊúÄÈÅ©Âπ≤Â†¥‰∫àÊ∏¨ (APIÁâà)</div>
        </div>
        
        <div class="weather-input">
            <div class="input-group">
                <label for="wind-direction">È¢®Âêë (Â∫¶)</label>
                <input type="number" id="wind-direction" min="0" max="359" value="295" placeholder="‰æã: 295 (ÂåóË•ø)">
            </div>
            
            <div class="input-group">
                <label for="wind-speed">È¢®ÈÄü (m/s)</label>
                <input type="number" id="wind-speed" min="0" max="30" step="0.1" value="6.5" placeholder="‰æã: 6.5">
            </div>
            
            <div class="input-group">
                <label for="temperature">Ê∞óÊ∏© (¬∞C)</label>
                <input type="number" id="temperature" min="-10" max="40" step="0.1" value="18.0" placeholder="‰æã: 18.0">
            </div>
            
            <div class="input-group">
                <label for="humidity">ÊπøÂ∫¶ (%)</label>
                <input type="number" id="humidity" min="0" max="100" step="1" value="55" placeholder="‰æã: 55">
            </div>
            
            <button class="forecast-button" id="forecast-button" onclick="generateForecast()">
                üîç ‰∫àÂ†±„ÇíÁîüÊàê
            </button>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            ‰∫àÂ†±„ÇíAPIÁµåÁî±„ÅßÂèñÂæó‰∏≠...
        </div>
        
        <div class="error" id="error" style="display: none;">
            <!-- Error messages will be shown here -->
        </div>
        
        <div class="results" id="results">
            <div class="overall-status" id="overall-status">
                <!-- Status will be populated by API response -->
            </div>
            
            <div class="wind-analysis" id="wind-analysis">
                <!-- Wind analysis will be populated by API response -->
            </div>
            
            <div class="district-cards" id="district-cards">
                <!-- District cards will be populated by API response -->
            </div>
            
            <div class="recommendations" id="recommendations">
                <!-- Recommendations will be populated by API response -->
            </div>
            
            <div class="top-locations" id="top-locations">
                <!-- Top locations will be populated by API response -->
            </div>
            
            <div class="button-group">
                <button class="refresh-button" onclick="generateForecast()">
                    üîÑ ‰∫àÂ†±„ÇíÊõ¥Êñ∞
                </button>
                <button class="help-button" onclick="window.open('/help', '_blank')">
                    ‚ùì ‰Ωø„ÅÑÊñπ
                </button>
            </div>
        </div>
        
        <div class="api-status" id="api-status">
            <span id="api-status-text">APIÊé•Á∂öÁ¢∫Ë™ç‰∏≠...</span>
        </div>
        
        <div class="footer">
            ‰ºùÁµ±ÁöÑ„Å™ÊºÅÂ∏´„ÅÆÁü•Ë≠ò √ó Áèæ‰ª£Ê∞óË±°Â≠¶<br>
            Âà©Â∞ªÂ≥∂ÊòÜÂ∏ÉÂπ≤„ÅóÊúÄÈÅ©Âåñ„Ç∑„Çπ„ÉÜ„É† (APIÁâà)
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let apiHealthy = false;
        
        // Check API health on page load
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    apiHealthy = true;
                    document.getElementById('api-status-text').innerHTML = 
                        '<span class="status-online">üü¢ APIÊé•Á∂öÊ≠£Â∏∏</span>';
                    
                    // Generate initial forecast
                    generateForecast();
                } else {
                    throw new Error('API health check failed');
                }
            } catch (error) {
                apiHealthy = false;
                document.getElementById('api-status-text').innerHTML = 
                    '<span class="status-offline">üî¥ APIÊé•Á∂ö„Ç®„É©„Éº</span>';
                showError('API„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }
        
        async function generateForecast() {
            if (!apiHealthy) {
                showError('API„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Disable button
            const button = document.getElementById('forecast-button');
            button.disabled = true;
            button.textContent = '‰∫àÂ†±ÁîüÊàê‰∏≠...';
            
            try {
                // Get input values
                const weatherData = {
                    wind_direction: parseFloat(document.getElementById('wind-direction').value),
                    wind_speed: parseFloat(document.getElementById('wind-speed').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    humidity: parseFloat(document.getElementById('humidity').value)
                };
                
                // Validate inputs
                if (!validateInputs(weatherData)) {
                    return;
                }
                
                // Call API
                const response = await fetch(`${API_BASE_URL}/api/forecast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(weatherData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateUI(data);
                    
                    // Hide loading and show results
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                } else {
                    throw new Error(data.error || 'Unknown API error');
                }
                
            } catch (error) {
                console.error('Forecast error:', error);
                showError(`‰∫àÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'üîç ‰∫àÂ†±„ÇíÁîüÊàê';
            }
        }
        
        function validateInputs(weatherData) {
            if (weatherData.wind_direction < 0 || weatherData.wind_direction > 359) {
                showError('È¢®Âêë„ÅØ0-359Â∫¶„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
            if (weatherData.wind_speed < 0 || weatherData.wind_speed > 30) {
                showError('È¢®ÈÄü„ÅØ0-30m/s„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
            if (weatherData.temperature < -10 || weatherData.temperature > 40) {
                showError('Ê∞óÊ∏©„ÅØ-10-40¬∞C„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
            if (weatherData.humidity < 0 || weatherData.humidity > 100) {
                showError('ÊπøÂ∫¶„ÅØ0-100%„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
            return true;
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }
        
        function updateUI(data) {
            updateOverallStatus(data.overall_stats);
            updateWindAnalysis(data.weather_input, data.wind_analysis);
            updateDistrictCards(data.district_summaries);
            updateRecommendations(data.recommendations);
            updateTopLocations(data.top_locations);
        }
        
        function updateOverallStatus(stats) {
            const statusEl = document.getElementById('overall-status');
            
            let statusClass, statusText;
            const excellentRatio = stats.excellent_count / stats.total_locations;
            const goodRatio = (stats.excellent_count + stats.good_count) / stats.total_locations;
            
            if (excellentRatio >= 0.7) {
                statusClass = 'status-excellent';
                statusText = `üåü ÊúÄËâØ„ÅÆ‰πæÁá•Êù°‰ª∂ (${stats.excellent_count}/${stats.total_locations}ÁÆáÊâÄ„ÅåÊúÄËâØ)`;
            } else if (goodRatio >= 0.6) {
                statusClass = 'status-good';
                statusText = `‚òÄÔ∏è ËâØÂ•Ω„Å™‰πæÁá•Êù°‰ª∂ (${stats.good_count}ÁÆáÊâÄ„ÅåËâØÂ•Ω‰ª•‰∏ä)`;
            } else if (goodRatio >= 0.3) {
                statusClass = 'status-fair';
                statusText = `‚ö†Ô∏è ÊôÆÈÄö„ÅÆÊù°‰ª∂ (Âú∞ÂüüÈÅ∏Êäû„Å´Ê≥®ÊÑè)`;
            } else {
                statusClass = 'status-poor';
                statusText = `‚ùå ‰∏çËâØ„Å™Êù°‰ª∂ (‰πæÁá•„ÅØÊé®Â•®„Åó„Åæ„Åõ„Çì)`;
            }
            
            statusEl.className = `overall-status ${statusClass}`;
            statusEl.textContent = statusText;
        }
        
        function updateWindAnalysis(weatherInput, windAnalysis) {
            const windAnalysisEl = document.getElementById('wind-analysis');
            
            windAnalysisEl.innerHTML = `
                <h3>üå¨Ô∏è È¢®ÂêëÂàÜÊûê</h3>
                <div class="wind-info">
                    <strong>${windAnalysis.sector}È¢® (${weatherInput.wind_direction}¬∞)</strong><br>
                    È¢®ÈÄü: ${weatherInput.wind_speed} m/s<br>
                    ‰∫àÊÉ≥ÊπøÂ∫¶: ${windAnalysis.expected_humidity}%<br>
                    ${windAnalysis.favorability}
                </div>
            `;
        }
        
        function updateDistrictCards(districtSummaries) {
            const cardsContainer = document.getElementById('district-cards');
            cardsContainer.innerHTML = '';
            
            districtSummaries.forEach(district => {
                const card = document.createElement('div');
                card.className = 'district-card';
                card.onclick = () => showDistrictDetails(district.name);
                
                let scoreClass;
                if (district.condition === "ÊúÄËâØ") scoreClass = 'score-excellent';
                else if (district.condition === "ËâØÂ•Ω") scoreClass = 'score-good';
                else if (district.condition === "ÊôÆÈÄö") scoreClass = 'score-fair';
                else scoreClass = 'score-poor';
                
                card.innerHTML = `
                    <div class="district-name">${district.name}</div>
                    <div class="district-score">
                        Êù°‰ª∂: <span class="${scoreClass}">${district.condition}</span>
                    </div>
                    <div class="district-humidity">
                        ‰∫àÊÉ≥ÊπøÂ∫¶: ${district.expected_humidity}%
                    </div>
                    <div class="district-count">
                        Âπ≤Â†¥Êï∞: ${district.field_count}ÁÆáÊâÄ
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
        }
        
        function updateRecommendations(recommendations) {
            const recommendationsEl = document.getElementById('recommendations');
            recommendationsEl.innerHTML = '<h3>üìù Êé®Â•®‰∫ãÈ†Ö</h3>';
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.textContent = rec;
                recommendationsEl.appendChild(item);
            });
        }
        
        function updateTopLocations(topLocations) {
            const topLocationsEl = document.getElementById('top-locations');
            topLocationsEl.innerHTML = '<h3>üèÜ Êé®Â•®Âπ≤Â†¥Ôºà‰∏ä‰Ωç10ÁÆáÊâÄÔºâ</h3>';
            
            topLocations.slice(0, 10).forEach((location, index) => {
                const item = document.createElement('div');
                item.className = 'location-item';
                
                item.innerHTML = `
                    <div class="location-name">${index + 1}. ${location.name}</div>
                    <div class="location-details">
                        Âú∞Âå∫: ${location.district} | Êù°‰ª∂: ${location.condition} | 
                        ÊπøÂ∫¶: ${location.humidity}% | „Çπ„Ç≥„Ç¢: ${(location.score * 100).toFixed(0)}ÁÇπ
                    </div>
                `;
                
                topLocationsEl.appendChild(item);
            });
        }
        
        async function showDistrictDetails(districtName) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations/${districtName}`);
                const data = await response.json();
                
                if (response.ok) {
                    alert(`${districtName}Âú∞Âå∫„ÅÆË©≥Á¥∞:\n` + 
                          `Âπ≤Â†¥Êï∞: ${data.location_count}ÁÆáÊâÄ\n` +
                          `‰∏ä‰Ωç3ÁÆáÊâÄ:\n${data.locations.slice(0, 3).map((loc, i) => 
                              `${i+1}. ${loc.name} (${loc.condition})`
                          ).join('\n')}`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert(`Âú∞Âå∫Ë©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó: ${error.message}`);
            }
        }
        
        // Initialize on page load
        window.onload = function() {
            checkApiHealth();
        };
    </script>
</body>
</html>