<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¹²å ´ãƒãƒƒãƒ— with äºˆå ±ï¼†è¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-providers/leaflet-providers.js"></script>
  <style>
    #map { height: 600px; }
    #controlPanel {
      margin: 10px 0;
    }
    #saveCancelButtons {
      margin-top: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>åˆ©å°»å³¶ å¹²å ´ãƒãƒƒãƒ—</h2>
  <div id="controlPanel">
    <button id="addModeButton">ï¼‹ æ–°è¦å¹²å ´ã‚’è¿½åŠ </button>
    <div id="saveCancelButtons">
      <span id="newSpotName"></span>
      <button id="saveSpot">ä¿å­˜</button>
      <button id="cancelSpot">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <iframe id="windyFrame" width="650" height="450" frameborder="0"></iframe>

    </div>
  </div>
  <div id="map"></div>
  <script>
    const map = L.map('map').setView([45.170, 141.150], 12);  // åˆ©å°»å³¶å…¨ä½“ã‚’ã‚«ãƒãƒ¼
    L.tileLayer.provider('Esri.WorldImagery').addTo(map);

    let spots = [];
    let addMode = false;
    let tempMarker = null;
    let tempName = '';

    fetch('http://localhost:8000/spots')
      .then(res => res.json())
      .then(data => {
        spots = data;
        spots.forEach(spot => {
          const popup = `
            <b>${spot.name}</b><br>
            <button onclick="checkForecast('${spot.name}')">å¹²ã›ã‚‹äºˆå ±</button>
            <button onclick="recordDrying('${spot.name}')">è¨˜éŒ²ã‚’ã¤ã‘ã‚‹</button><br>
            <button onclick="deleteSpot('${spot.name}')">å‰Šé™¤</button>
          `;
          L.marker([spot.lat, spot.lon]).addTo(map).bindPopup(popup);
        });
      });

    document.getElementById("addModeButton").onclick = () => {
      addMode = true;
      alert("åœ°å›³ä¸Šã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¹²å ´ã‚’ä»®ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    };

    document.getElementById("saveSpot").onclick = () => {
      if (!tempName || !tempMarker) return;
      fetch('http://localhost:8000/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: tempName, lat: tempMarker.getLatLng().lat, lon: tempMarker.getLatLng().lng })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('å¹²å ´ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');

          const csvLink = document.createElement('a');
          csvLink.href = 'http://localhost:8000/download/csv';
          csvLink.download = 'hoshiba_spots.csv';
          csvLink.click();

          const kmlLink = document.createElement('a');
          kmlLink.href = 'http://localhost:8000/download/kml';
          kmlLink.download = 'hoshiba_spots_named.kml';
          kmlLink.click();

          location.reload();
        } else {
          alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });
    };

    document.getElementById("cancelSpot").onclick = () => {
      if (tempMarker) map.removeLayer(tempMarker);
      document.getElementById("saveCancelButtons").style.display = 'none';
      tempMarker = null;
      tempName = '';
      addMode = false;
    };

    map.on('click', function(e) {
      if (!addMode) return;
      if (tempMarker) map.removeLayer(tempMarker);
      const lat = e.latlng.lat.toFixed(6);
      const lon = e.latlng.lng.toFixed(6);
      const latPart = lat.split('.')[1].substring(0, 4);
      const lonPart = lon.split('.')[1].substring(0, 4);
      tempName = `H_${latPart}_${lonPart}`;
      tempMarker = L.marker([lat, lon]).addTo(map);
      tempMarker.bindPopup(`${tempName}<br>(${lat}, ${lon})`).openPopup();
      document.getElementById("newSpotName").textContent = tempName;
      document.getElementById("saveCancelButtons").style.display = 'inline-block';
    });

    function checkForecast(name) {
      const spot = spots.find(s => s.name === name);
      if (!spot) return alert("å¹²å ´æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      const url = `http://localhost:8000/forecast?name=${name}&lat=${spot.lat}&lon=${spot.lon}`;
      fetch(url)
        .then(res => res.json())
        .then(data => alert(`${name} ã®äºˆå ±çµæœ: ${data.result}`));
    }

    function recordDrying(name) {
      const date = prompt("è¨˜éŒ²æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: 2025-06-22)");
      if (!date) return;

      fetch(`http://localhost:8000/get_record?name=${name}&date=${date}`)
        .then(res => res.json())
        .then(data => {
          let initial = data.result || "";
          let choice = prompt(`è¨˜éŒ²ï¼ˆç©ºæ¬„å¯ï¼‰\n1. å®Œå…¨ä¹¾ç‡¥\n2. ä¸­æ­¢\n3. å¹²ã—ãŸãŒå®Œå…¨ã«ã¯ä¹¾ã‹ã›ãªã‹ã£ãŸï¼ˆæ³£ï¼‰`, initial);
          if (!choice) return;

          const result =
            choice === "1" ? "å®Œå…¨ä¹¾ç‡¥" :
            choice === "2" ? "ä¸­æ­¢" :
            choice === "3" ? "å¹²ã—ãŸãŒå®Œå…¨ã«ã¯ä¹¾ã‹ã›ãªã‹ã£ãŸï¼ˆæ³£ï¼‰" :
            choice;

          const confirm1 = confirm(`è¨˜éŒ²å†…å®¹ï¼š${name} / ${date} / ${result}\nã“ã®è¨˜éŒ²ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ`);
          if (!confirm1) return;

          fetch("http://localhost:8000/record", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, date, result })
          })
            .then(res => res.json())
            .then(data => {
              if (data.status === "success") {
                alert("è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
              } else {
                alert("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
              }
            });
        });
    }

    function deleteSpot(name) {
      if (!confirm(`${name} ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

      fetch('http://localhost:8000/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.status === 'success' ? 'å‰Šé™¤ã—ã¾ã—ãŸ' : 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        if (data.status === 'success') location.reload();
      });
    }
    function showWindyMap(lat, lon) {
      const windyUrl = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=450&zoom=10&level=surface&overlay=wind&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1`;
      document.getElementById("windyFrame").src = windyUrl;
    }
  </script>
  <!-- ğŸ”µ Chatbot UI -->
<div id="chat-container" style="position: fixed; bottom: 20px; right: 20px; width: 300px; z-index: 9999; font-family: sans-serif;">
  <div style="background-color: #444; color: white; padding: 10px; border-radius: 8px 8px 0 0;">ğŸ¤– ã‚³ãƒ³ãƒ–AIãƒãƒ£ãƒƒãƒˆ</div>
  <div id="chat-log" style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; background: white;"></div>
  <div style="display: flex;">
    <input id="chat-input" type="text" placeholder="è³ªå•ã‚’å…¥åŠ›â€¦" style="flex: 1; padding: 5px;">
    <button onclick="sendChat()" style="padding: 5px 10px;">é€ä¿¡</button>
  </div>
</div>

<script>
function sendChat() {
  const input = document.getElementById("chat-input");
  const log = document.getElementById("chat-log");
  const message = input.value.trim();
  if (!message) return;

  log.innerHTML += `<div><strong>ã‚ãªãŸ:</strong> ${message}</div>`;
  input.value = "";

  fetch("http://localhost:8000/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  })
  .then(res => res.json())
  .then(data => {
    log.innerHTML += `<div><strong>ã‚³ãƒ³ãƒ–AI:</strong> ${data.reply}</div>`;
    log.scrollTop = log.scrollHeight;
  })
  .catch(err => {
    log.innerHTML += `<div><strong>ã‚¨ãƒ©ãƒ¼:</strong> å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>`;
  });
}

</script>
</body>
</html>
