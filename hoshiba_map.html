<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âà©Â∞ªÂ≥∂ÊòÜÂ∏ÉÂπ≤Â†¥„Éû„ÉÉ„Éó</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', '„Éí„É©„ÇÆ„ÉéËßí„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic', 'Meiryo', sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .controls {
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .add-hoshiba-btn {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .add-hoshiba-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,184,148,0.3);
        }
        
        .add-hoshiba-btn.active {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(253,121,168,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(253,121,168,0); }
            100% { box-shadow: 0 0 0 0 rgba(253,121,168,0); }
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #0984e3;
        }
        
        .filter-level {
            display: none;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-level.active {
            display: flex;
        }
        
        .back-filter-btn {
            background: #636e72;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
            transition: background 0.3s;
        }
        
        .back-filter-btn:hover {
            background: #2d3436;
        }
        
        #district-buttons,
        #buraku-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .map-container {
            height: calc(100vh - 140px);
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .hoshiba-popup {
            min-width: 250px;
        }
        
        .hoshiba-popup .popup-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .hoshiba-popup .popup-info {
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .hoshiba-popup .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .popup-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
        }
        
        .forecast-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }
        
        .record-btn {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #d63031, #fd79a8);
            color: white;
        }
        
        .popup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .add-hoshiba-popup {
            min-width: 200px;
        }
        
        .add-hoshiba-popup .popup-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .add-hoshiba-popup .coordinate-info {
            font-size: 12px;
            color: #636e72;
            margin-bottom: 10px;
        }
        
        .add-hoshiba-popup .suggested-name {
            font-weight: bold;
            color: #0984e3;
            margin-bottom: 15px;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .confirm-add {
            background: #00b894;
            color: white;
        }
        
        .cancel-add {
            background: #636e72;
            color: white;
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 2000;
            display: none;
        }
        
        .status-message.success {
            border-left: 4px solid #00b894;
        }
        
        .status-message.error {
            border-left: 4px solid #d63031;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
        }
        
        .legend h4 {
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-controls {
                justify-content: center;
            }
            
            .legend {
                bottom: 10px;
                left: 10px;
                right: 10px;
                font-size: 11px;
            }
            
            .map-container {
                height: calc(100vh - 180px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üóæ Âà©Â∞ªÂ≥∂ÊòÜÂ∏ÉÂπ≤Â†¥„Éû„ÉÉ„Éó</h1>
        <div class="subtitle">ÂÖ®331Âπ≤Â†¥ - „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰∫àÂ†±„ÉªË®òÈå≤„ÉªÁÆ°ÁêÜ</div>
    </div>
    
    <div class="controls">
        <button class="add-hoshiba-btn" id="addHoshibaBtn">
            ‚ûï Êñ∞„Åó„ÅÑÂπ≤Â†¥„ÇíËøΩÂä†
        </button>
        
        <div class="filter-controls">
            <!-- „É¨„Éô„É´1: ÂÖ®‰Ωì„ÉªÁî∫ÈÅ∏Êäû -->
            <div id="level1-filters" class="filter-level active">
                <button class="filter-btn active" data-filter="all" data-level="1">ÂÖ®„Å¶</button>
                <button class="filter-btn" data-filter="Âà©Â∞ªÂØåÂ£´Áî∫" data-level="1">Âà©Â∞ªÂØåÂ£´Áî∫</button>
                <button class="filter-btn" data-filter="Âà©Â∞ªÁî∫" data-level="1">Âà©Â∞ªÁî∫</button>
                <button class="filter-btn" data-filter="favorite" data-level="1">„ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
            </div>
            
            <!-- „É¨„Éô„É´2: Âú∞Âå∫ÈÅ∏Êäû -->
            <div id="level2-filters" class="filter-level" style="display: none;">
                <button class="back-filter-btn" onclick="goBackToLevel(1)">‚Üê Áî∫ÈÅ∏Êäû„Å´Êàª„Çã</button>
                <div id="district-buttons">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>
            
            <!-- „É¨„Éô„É´3: ÈÉ®ËêΩÈÅ∏Êäû -->
            <div id="level3-filters" class="filter-level" style="display: none;">
                <button class="back-filter-btn" onclick="goBackToLevel(2)">‚Üê Âú∞Âå∫ÈÅ∏Êäû„Å´Êàª„Çã</button>
                <div id="buraku-buttons">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        
        <div class="legend">
            <h4>Âπ≤Â†¥„ÅÆËâ≤ÂàÜ„Åë</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #0984e3;"></div>
                <span>Âà©Â∞ªÂØåÂ£´Áî∫</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00b894;"></div>
                <span>Âà©Â∞ªÁî∫</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fdcb6e;"></div>
                <span>„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fd79a8;"></div>
                <span>Âà©Â∞ªÂ±±Ôºà‰∏≠ÂøÉÁÇπÔºâ</span>
            </div>
        </div>
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let hoshibaData = [];
        let hoshibaMarkers = [];
        let addHoshibaMode = false;
        let centerMarker = null;
        let favoriteHoshiba = new Set(); // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂπ≤Â†¥„ÅÆ„Çª„ÉÉ„Éà
        let currentFilterLevel = 1;
        let currentTown = 'all';
        let currentDistrict = null;
        let currentBuraku = null;
        
        // Constants from the coordinate system
        const RISHIRI_SAN = {
            lat: 45.1821,
            lon: 141.2421,
            elevation: 1721
        };
        
        const SOUTH_BOUNDARY = {
            lat: 45.1007,
            lon: 141.2461
        };
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([RISHIRI_SAN.lat, RISHIRI_SAN.lon], 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add Rishiri-san center marker
            centerMarker = L.marker([RISHIRI_SAN.lat, RISHIRI_SAN.lon], {
                icon: L.divIcon({
                    className: 'center-marker',
                    html: 'üèîÔ∏è',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            centerMarker.bindPopup(`
                <div class="center-popup">
                    <strong>Âà©Â∞ªÂ±±ÔºàÊ•µÂ∫ßÊ®ô‰∏≠ÂøÉÁÇπÔºâ</strong><br>
                    Ê®ôÈ´ò: ${RISHIRI_SAN.elevation}m<br>
                    Â∫ßÊ®ô: ${RISHIRI_SAN.lat}¬∞N, ${RISHIRI_SAN.lon}¬∞E
                </div>
            `);
            
            // Add click event for adding hoshiba
            map.on('click', onMapClick);
            
            // Load hoshiba data
            loadHoshibaData();
        }
        
        // Calculate boundary-based theta
        function calculateBoundaryBasedTheta(lat, lon) {
            // Calculate relative coordinates from Rishiri-san
            const deltaLat = lat - RISHIRI_SAN.lat;
            const deltaLon = lon - RISHIRI_SAN.lon;
            
            // Convert to approximate meters for angle calculation
            const latFactor = 111000;
            const lonFactor = 111000 * Math.cos(RISHIRI_SAN.lat * Math.PI / 180);
            
            const deltaY = deltaLat * latFactor;
            const deltaX = deltaLon * lonFactor;
            
            // Calculate angle from east (standard polar coordinates)
            const thetaFromEast = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
            
            // Calculate south town boundary line angle from Rishiri-san
            const southDeltaLat = SOUTH_BOUNDARY.lat - RISHIRI_SAN.lat;
            const southDeltaLon = SOUTH_BOUNDARY.lon - RISHIRI_SAN.lon;
            const southDeltaY = southDeltaLat * latFactor;
            const southDeltaX = southDeltaLon * lonFactor;
            const southBoundaryAngle = Math.atan2(southDeltaY, southDeltaX) * 180 / Math.PI;
            
            // Adjust angle so south town boundary line becomes Œ∏=0
            let thetaAdjusted = thetaFromEast - southBoundaryAngle;
            
            // Normalize to 0-360 degrees
            while (thetaAdjusted < 0) {
                thetaAdjusted += 360;
            }
            while (thetaAdjusted >= 360) {
                thetaAdjusted -= 360;
            }
            
            return thetaAdjusted;
        }
        
        // Generate hoshiba name from coordinates
        function generateHoshibaName(lat, lon) {
            const latStr = String(Math.round((lat % 1) * 10000)).padStart(4, '0');
            const lonStr = String(Math.round((lon % 1) * 10000)).padStart(4, '0');
            return `H_${latStr}_${lonStr}`;
        }
        
        // Favorite management functions
        function loadFavorites() {
            const saved = localStorage.getItem('rishiri_favorites');
            if (saved) {
                favoriteHoshiba = new Set(JSON.parse(saved));
            }
        }
        
        function saveFavorites() {
            localStorage.setItem('rishiri_favorites', JSON.stringify([...favoriteHoshiba]));
        }
        
        function toggleFavorite(hoshibaName) {
            if (favoriteHoshiba.has(hoshibaName)) {
                favoriteHoshiba.delete(hoshibaName);
                showStatus(`${hoshibaName} „Çí„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂ§ñ„Åó„Åæ„Åó„Åü`, 'success');
            } else {
                favoriteHoshiba.add(hoshibaName);
                showStatus(`${hoshibaName} „Çí„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
            }
            saveFavorites();
            
            // „Éû„Éº„Ç´„Éº„ÇíÂÜçË°®Á§∫
            displayHoshiba();
        }
        
        // Load hoshiba data from API
        async function loadHoshibaData() {
            try {
                const response = await fetch('http://localhost:5001/api/hoshiba-data');
                if (response.ok) {
                    hoshibaData = await response.json();
                    displayHoshiba();
                    showStatus('Âπ≤Â†¥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                } else {
                    throw new Error('API Error');
                }
                
            } catch (error) {
                console.warn('API not available, using mock data', error);
                hoshibaData = generateMockData();
                displayHoshiba();
                showStatus('„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË°®Á§∫‰∏≠ (APIÊú™Êé•Á∂ö)', 'success');
            }
            
            // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Çí„É≠„Éº„Éâ
            loadFavorites();
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index]?.trim();
                });
                
                // Convert coordinates to numbers
                row.lat = parseFloat(row.lat);
                row.lon = parseFloat(row.lon);
                row.theta = calculateBoundaryBasedTheta(row.lat, row.lon);
                row.favorite = Math.random() < 0.1; // 10% chance of being favorite
                
                data.push(row);
            }
            
            return data;
        }
        
        // Generate mock data for demonstration
        function generateMockData() {
            const mockData = [];
            
            // Generate sample hoshiba around Rishiri Island
            const samples = [
                {name: 'H_1021_2473', lat: 45.1021947, lon: 141.247311, town: 'Âà©Â∞ªÂØåÂ£´Áî∫', district: 'È¨ºËÑá', buraku: 'Èáé‰∏≠'},
                {name: 'H_1025_2483', lat: 45.1025111, lon: 141.2483481, town: 'Âà©Â∞ªÂØåÂ£´Áî∫', district: 'È¨ºËÑá', buraku: 'Èáé‰∏≠'},
                {name: 'H_1094_2687', lat: 45.1094479, lon: 141.268727, town: 'Âà©Â∞ªÂØåÂ£´Áî∫', district: 'È¨ºËÑá', buraku: 'ÂçóÊµú'},
                {name: 'H_2273_2793', lat: 45.2273, lon: 141.2793, town: 'Âà©Â∞ªÂØåÂ£´Áî∫', district: 'È¥õÊ≥ä', buraku: 'ÈõÑÂø†ÂøóÂÜÖ'},
                {name: 'H_1490_1567', lat: 45.149, lon: 141.1567, town: 'Âà©Â∞ªÁî∫', district: 'Ê≤ìÂΩ¢', buraku: 'Ê†ÑÊµú'},
                {name: 'H_0988_2398', lat: 45.0988, lon: 141.2398, town: 'Âà©Â∞ªÁî∫', district: '‰ªôÊ≥ïÂøó', buraku: '‰πÖÈÄ£'}
            ];
            
            samples.forEach(sample => {
                sample.theta = calculateBoundaryBasedTheta(sample.lat, sample.lon);
                sample.favorite = Math.random() < 0.2; // 20% chance of being favorite
            });
            
            return samples;
        }
        
        // Display hoshiba markers on map with hierarchical filtering
        function displayHoshiba() {
            // Clear existing markers
            hoshibaMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            hoshibaMarkers = [];
            
            // Apply current filter
            let filteredData = applyCurrentFilter();
            
            // Add markers
            filteredData.forEach(hoshiba => {
                const markerColor = getMarkerColor(hoshiba);
                const isFavorite = favoriteHoshiba.has(hoshiba.name);
                
                const marker = L.circleMarker([hoshiba.lat, hoshiba.lon], {
                    radius: isFavorite ? 8 : 6,
                    color: 'white',
                    weight: isFavorite ? 3 : 2,
                    fillColor: markerColor,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindPopup(createHoshibaPopup(hoshiba));
                hoshibaMarkers.push(marker);
            });
            
            // Adjust map view to fit filtered data
            if (filteredData.length > 0) {
                fitMapToHoshiba(filteredData);
            }
        }
        
        // Apply current hierarchical filter
        function applyCurrentFilter() {
            let filteredData = hoshibaData;
            
            // Level 1 filtering (Áî∫ or favorite)
            if (currentTown === 'favorite') {
                filteredData = hoshibaData.filter(h => favoriteHoshiba.has(h.name));
            } else if (currentTown && currentTown !== 'all') {
                filteredData = hoshibaData.filter(h => h.town === currentTown);
            }
            
            // Level 2 filtering (Âú∞Âå∫)
            if (currentDistrict && currentFilterLevel >= 2) {
                filteredData = filteredData.filter(h => h.district === currentDistrict);
            }
            
            // Level 3 filtering (ÈÉ®ËêΩ)
            if (currentBuraku && currentFilterLevel >= 3) {
                filteredData = filteredData.filter(h => h.buraku === currentBuraku);
            }
            
            return filteredData;
        }
        
        // Fit map view to show all filtered hoshiba
        function fitMapToHoshiba(hoshiba) {
            if (hoshiba.length === 0) return;
            
            // Calculate bounds
            let minLat = Math.min(...hoshiba.map(h => h.lat));
            let maxLat = Math.max(...hoshiba.map(h => h.lat));
            let minLon = Math.min(...hoshiba.map(h => h.lon));
            let maxLon = Math.max(...hoshiba.map(h => h.lon));
            
            // Add padding
            const padding = 0.005;
            minLat -= padding;
            maxLat += padding;
            minLon -= padding;
            maxLon += padding;
            
            // Fit bounds
            const bounds = [[minLat, minLon], [maxLat, maxLon]];
            map.fitBounds(bounds, { padding: [20, 20] });
        }
        
        // Get marker color based on hoshiba properties
        function getMarkerColor(hoshiba) {
            if (favoriteHoshiba.has(hoshiba.name)) return '#fdcb6e';
            return hoshiba.town === 'Âà©Â∞ªÂØåÂ£´Áî∫' ? '#0984e3' : '#00b894';
        }
        
        // Create popup content for hoshiba
        function createHoshibaPopup(hoshiba) {
            return `
                <div class="hoshiba-popup">
                    <div class="popup-header">${hoshiba.name}</div>
                    <div class="popup-info">
                        <strong>Áî∫:</strong> ${hoshiba.town}<br>
                        <strong>Âú∞Âå∫:</strong> ${hoshiba.district}<br>
                        <strong>ÈÉ®ËêΩ:</strong> ${hoshiba.buraku}<br>
                        <strong>Œ∏:</strong> ${hoshiba.theta?.toFixed(1)}¬∞<br>
                        <strong>Â∫ßÊ®ô:</strong> ${hoshiba.lat.toFixed(4)}¬∞N, ${hoshiba.lon.toFixed(4)}¬∞E
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-btn forecast-btn" onclick="showForecast('${hoshiba.name}')">
                            üìä ‰∫àÂ†±„ÇíË¶ã„Çã
                        </button>
                        <button class="popup-btn record-btn" onclick="showRecord('${hoshiba.name}')">
                            üìù Ë®òÈå≤„ÇíÂÖ•Âäõ
                        </button>
                        ${favoriteHoshiba.has(hoshiba.name) ? 
                            `<button class="popup-btn" style="background: linear-gradient(135deg, #fd79a8, #fdcb6e); color: white;" onclick="toggleFavorite('${hoshiba.name}')">
                                ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂ§ñ„Åô
                            </button>` :
                            `<button class="popup-btn" style="background: linear-gradient(135deg, #fdcb6e, #fd79a8); color: white;" onclick="toggleFavorite('${hoshiba.name}')">
                                ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†
                            </button>`
                        }
                        <button class="popup-btn delete-btn" onclick="deleteHoshiba('${hoshiba.name}')">
                            üóëÔ∏è Âπ≤Â†¥„ÇíÂâäÈô§
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Map click handler
        function onMapClick(e) {
            if (!addHoshibaMode) return;
            
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            const suggestedName = generateHoshibaName(lat, lon);
            const theta = calculateBoundaryBasedTheta(lat, lon);
            
            // Simple classification based on theta ranges
            let town, district, buraku;
            if (theta >= 0 && theta < 122) {
                town = 'Âà©Â∞ªÂØåÂ£´Áî∫'; district = 'È¨ºËÑá'; buraku = 'Èáé‰∏≠';
            } else if (theta >= 122 && theta < 235.1) {
                town = 'Âà©Â∞ªÂØåÂ£´Áî∫'; district = 'È¥õÊ≥ä'; buraku = 'ÈõÑÂø†ÂøóÂÜÖ';
            } else if (theta >= 235.1 && theta < 296.8) {
                town = 'Âà©Â∞ªÁî∫'; district = 'Ê≤ìÂΩ¢'; buraku = 'Ê†ÑÊµú';
            } else {
                town = 'Âà©Â∞ªÁî∫'; district = '‰ªôÊ≥ïÂøó'; buraku = '‰πÖÈÄ£';
            }
            
            const popup = L.popup()
                .setLatLng(e.latlng)
                .setContent(`
                    <div class="add-hoshiba-popup">
                        <div class="popup-header">Êñ∞„Åó„ÅÑÂπ≤Â†¥„ÇíËøΩÂä†</div>
                        <div class="coordinate-info">
                            Â∫ßÊ®ô: ${lat.toFixed(6)}¬∞N, ${lon.toFixed(6)}¬∞E<br>
                            Œ∏: ${theta.toFixed(1)}¬∞
                        </div>
                        <div class="suggested-name">
                            ÊèêÊ°àÂêç: ${suggestedName}
                        </div>
                        <div class="classification-info">
                            Áî∫: ${town}<br>
                            Âú∞Âå∫: ${district}<br>
                            ÈÉ®ËêΩ: ${buraku}
                        </div>
                        <div class="confirm-buttons">
                            <button class="confirm-btn confirm-add" onclick="confirmAddHoshiba(${lat}, ${lon}, '${suggestedName}', ${theta}, '${town}', '${district}', '${buraku}')">
                                ËøΩÂä†
                            </button>
                            <button class="confirm-btn cancel-add" onclick="cancelAddHoshiba()">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                    </div>
                `)
                .openOn(map);
        }
        
        // Event handlers
        function toggleAddHoshibaMode() {
            addHoshibaMode = !addHoshibaMode;
            const btn = document.getElementById('addHoshibaBtn');
            
            if (addHoshibaMode) {
                btn.classList.add('active');
                btn.textContent = '‚ùå ËøΩÂä†„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü';
                showStatus('Âú∞Âõ≥‰∏ä„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êñ∞„Åó„ÅÑÂπ≤Â†¥„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
            } else {
                btn.classList.remove('active');
                btn.textContent = '‚ûï Êñ∞„Åó„ÅÑÂπ≤Â†¥„ÇíËøΩÂä†';
            }
        }
        
        async function confirmAddHoshiba(lat, lon, name, theta, town, district, buraku) {
            const newHoshiba = {
                name: name,
                lat: lat,
                lon: lon,
                town: town,
                district: district,
                buraku: buraku,
                theta: theta,
                favorite: false
            };
            
            try {
                // Save to API
                const response = await fetch('http://localhost:5001/api/hoshiba-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newHoshiba)
                });
                
                if (response.ok) {
                    // Reload data from API to ensure sync
                    await loadHoshibaData();
                    showStatus(`Âπ≤Â†¥ "${name}" „ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºàCSVËá™Âãï‰øùÂ≠òÔºâ`, 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'API Error');
                }
                
            } catch (error) {
                console.warn('API not available, adding locally', error);
                // Fallback to local addition
                hoshibaData.push(newHoshiba);
                hoshibaData.sort((a, b) => (a.theta || 0) - (b.theta || 0));
                displayHoshiba();
                showStatus(`Âπ≤Â†¥ "${name}" „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü („É≠„Éº„Ç´„É´„ÅÆ„Åø)`, 'success');
            }
            
            map.closePopup();
            toggleAddHoshibaMode();
        }
        
        function cancelAddHoshiba() {
            map.closePopup();
        }
        
        function showForecast(hoshibaName) {
            // Âπ≤Â†¥„Éá„Éº„Çø„ÇíÊ§úÁ¥¢
            const hoshiba = hoshibaData.find(h => h.name === hoshibaName);
            if (!hoshiba) {
                showStatus('Âπ≤Â†¥„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            // URL„Éë„É©„É°„Éº„Çø„Çí‰ΩúÊàê
            const params = new URLSearchParams({
                name: hoshiba.name,
                town: hoshiba.town,
                district: hoshiba.district,
                buraku: hoshiba.buraku,
                theta: hoshiba.theta,
                lat: hoshiba.lat,
                lon: hoshiba.lon
            });
            
            // ‰∫àÂ†±„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
            window.location.href = `hoshiba_forecast.html?${params.toString()}`;
        }
        
        function showRecord(hoshibaName) {
            // Âπ≤Â†¥„Éá„Éº„Çø„ÇíÊ§úÁ¥¢
            const hoshiba = hoshibaData.find(h => h.name === hoshibaName);
            if (!hoshiba) {
                showStatus('Âπ≤Â†¥„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            // URL„Éë„É©„É°„Éº„Çø„Çí‰ΩúÊàê
            const params = new URLSearchParams({
                name: hoshiba.name,
                town: hoshiba.town,
                district: hoshiba.district,
                buraku: hoshiba.buraku,
                theta: hoshiba.theta,
                lat: hoshiba.lat,
                lon: hoshiba.lon
            });
            
            // Ë®òÈå≤„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
            window.location.href = `hoshiba_record.html?${params.toString()}`;
        }
        
        async function deleteHoshiba(hoshibaName) {
            if (confirm(`Âπ≤Â†¥ "${hoshibaName}" „ÇíÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n‚Äª Èñ¢ÈÄ£„Åô„ÇãË®òÈå≤„Éá„Éº„Çø„ÇÇÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô`)) {
                try {
                    // Delete via API
                    const response = await fetch(`http://localhost:5001/api/hoshiba-data/${encodeURIComponent(hoshibaName)}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Reload data from API to ensure sync
                        await loadHoshibaData();
                        showStatus(`Âπ≤Â†¥ "${hoshibaName}" „ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàCSVËá™ÂãïÊõ¥Êñ∞Ôºâ`, 'success');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'API Error');
                    }
                    
                } catch (error) {
                    console.warn('API not available, deleting locally', error);
                    // Fallback to local deletion
                    hoshibaData = hoshibaData.filter(h => h.name !== hoshibaName);
                    displayHoshiba();
                    showStatus(`Âπ≤Â†¥ "${hoshibaName}" „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü („É≠„Éº„Ç´„É´„ÅÆ„Åø)`, 'success');
                }
                
                map.closePopup();
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('addHoshibaBtn').addEventListener('click', toggleAddHoshibaMode);
        
        // Setup hierarchical filter event listeners
        setupHierarchicalFilters();
        
        function setupHierarchicalFilters() {
            // Level 1 filter buttons (Áî∫ÈÅ∏Êäû)
            document.querySelectorAll('#level1-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    
                    // Update active state for level 1
                    document.querySelectorAll('#level1-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    if (filter === 'all' || filter === 'favorite') {
                        // ÂÖ®„Å¶ or „ÅäÊ∞ó„Å´ÂÖ•„Çä - „É¨„Éô„É´1„ÅÆ„Åæ„ÅæË°®Á§∫
                        currentTown = filter;
                        currentDistrict = null;
                        currentFilterLevel = 1;
                        displayHoshiba();
                    } else {
                        // Áî∫ÈÅ∏Êäû - „É¨„Éô„É´2„Å´ÈÄ≤„ÇÄ
                        currentTown = filter;
                        currentDistrict = null;
                        currentFilterLevel = 2;
                        showLevel2Filters(filter);
                    }
                });
            });
        }
        
        function showLevel2Filters(town) {
            // „É¨„Éô„É´1„ÇíÈùûË°®Á§∫„ÄÅ„É¨„Éô„É´2„ÇíË°®Á§∫
            document.getElementById('level1-filters').style.display = 'none';
            document.getElementById('level2-filters').style.display = 'flex';
            document.getElementById('level3-filters').style.display = 'none';
            
            // Âú∞Âå∫„Éú„Çø„É≥„ÇíÁîüÊàê
            generateDistrictButtons(town);
            
            // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            displayHoshiba();
        }
        
        function generateDistrictButtons(town) {
            const districtContainer = document.getElementById('district-buttons');
            districtContainer.innerHTML = '';
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÁî∫„ÅÆÂú∞Âå∫„ÇíÂèñÂæó
            const districts = getDistrictsForTown(town);
            
            districts.forEach(district => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = district;
                btn.addEventListener('click', () => {
                    // Âú∞Âå∫ÈÅ∏Êäû - „É¨„Éô„É´3„Å´ÈÄ≤„ÇÄ
                    currentDistrict = district;
                    currentFilterLevel = 3;
                    
                    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                    document.querySelectorAll('#district-buttons .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    showLevel3Filters(town, district);
                });
                districtContainer.appendChild(btn);
            });
        }
        
        function showLevel3Filters(town, district) {
            // „É¨„Éô„É´2„ÇíÈùûË°®Á§∫„ÄÅ„É¨„Éô„É´3„ÇíË°®Á§∫
            document.getElementById('level2-filters').style.display = 'none';
            document.getElementById('level3-filters').style.display = 'flex';
            
            // ÈÉ®ËêΩ„Éú„Çø„É≥„ÇíÁîüÊàê
            generateBurakuButtons(town, district);
            
            // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            displayHoshiba();
        }
        
        function generateBurakuButtons(town, district) {
            const burakuContainer = document.getElementById('buraku-buttons');
            burakuContainer.innerHTML = '';
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÁî∫„ÉªÂú∞Âå∫„ÅÆÈÉ®ËêΩ„ÇíÂèñÂæó
            const burakus = getBurakusForDistrict(town, district);
            
            burakus.forEach(buraku => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = buraku;
                btn.addEventListener('click', () => {
                    // ÈÉ®ËêΩÈÅ∏Êäû - ÊúÄÁµÇ„É¨„Éô„É´
                    currentBuraku = buraku;
                    currentFilterLevel = 3;
                    
                    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                    document.querySelectorAll('#buraku-buttons .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    displayHoshiba();
                });
                burakuContainer.appendChild(btn);
            });
        }
        
        function getDistrictsForTown(town) {
            // Áî∫„Å´Âü∫„Å•„ÅÑ„Å¶Âú∞Âå∫„ÅÆ„É™„Çπ„Éà„ÇíËøî„Åô
            const townDistricts = {
                'Âà©Â∞ªÂØåÂ£´Áî∫': ['È¨ºËÑá', 'È¥õÊ≥ä'],
                'Âà©Â∞ªÁî∫': ['Ê≤ìÂΩ¢', '‰ªôÊ≥ïÂøó']
            };
            return townDistricts[town] || [];
        }
        
        function getBurakusForDistrict(town, district) {
            // Áî∫„ÉªÂú∞Âå∫„Å´Âü∫„Å•„ÅÑ„Å¶ÈÉ®ËêΩ„ÅÆ„É™„Çπ„Éà„ÇíËøî„Åô
            const districtBurakus = {
                'Âà©Â∞ªÂØåÂ£´Áî∫': {
                    'È¨ºËÑá': ['Èáé‰∏≠', 'ÂçóÊµú'],
                    'È¥õÊ≥ä': ['ÈõÑÂø†ÂøóÂÜÖ']
                },
                'Âà©Â∞ªÁî∫': {
                    'Ê≤ìÂΩ¢': ['Ê†ÑÊµú'],
                    '‰ªôÊ≥ïÂøó': ['‰πÖÈÄ£']
                }
            };
            return districtBurakus[town]?.[district] || [];
        }
        
        function goBackToLevel(level) {
            if (level === 1) {
                // „É¨„Éô„É´1„Å´Êàª„Çã
                currentFilterLevel = 1;
                currentTown = 'all';
                currentDistrict = null;
                currentBuraku = null;
                
                document.getElementById('level1-filters').style.display = 'flex';
                document.getElementById('level2-filters').style.display = 'none';
                document.getElementById('level3-filters').style.display = 'none';
                
                // „ÄåÂÖ®„Å¶„Äç„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                document.querySelectorAll('#level1-filters .filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#level1-filters .filter-btn[data-filter="all"]').classList.add('active');
                
                displayHoshiba();
            } else if (level === 2) {
                // „É¨„Éô„É´2„Å´Êàª„Çã
                currentFilterLevel = 2;
                currentDistrict = null;
                currentBuraku = null;
                
                document.getElementById('level2-filters').style.display = 'flex';
                document.getElementById('level3-filters').style.display = 'none';
                
                displayHoshiba();
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>