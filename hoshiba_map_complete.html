<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>利尻島昆布干場予報システム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Manifest -->
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="利尻昆布予報">
  
  <!-- Icons for PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-providers/leaflet-providers.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #2c5f2d, #4a8a5a);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 5px 0 0 0;
      opacity: 0.9;
    }
    
    .main-container {
      display: flex;
      gap: 20px;
    }
    
    .map-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .sidebar {
      width: 350px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: fit-content;
    }
    
    #map { 
      height: 600px; 
      border-radius: 8px;
    }
    
    .control-panel {
      margin-bottom: 20px;
    }
    
    .btn {
      background: #4a8a5a;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn:hover {
      background: #3d7349;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .new-spot-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    
    .forecast-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      display: none;
    }
    
    .forecast-day {
      border: 1px solid #dee2e6;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      background: white;
    }
    
    .forecast-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .recommendation {
      font-size: 16px;
      font-weight: bold;
      margin: 5px 0;
    }
    
    .recommendation.excellent {
      color: #28a745;
    }
    
    .recommendation.good {
      color: #007bff;
    }
    
    .recommendation.caution {
      color: #ffc107;
    }
    
    .recommendation.poor {
      color: #dc3545;
    }
    
    .reasons {
      font-size: 12px;
      margin: 5px 0;
    }
    
    .reasons .positive {
      color: #28a745;
    }
    
    .reasons .negative {
      color: #dc3545;
    }
    
    .record-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      display: none;
    }
    
    .record-buttons {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }
    
    .spot-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }
    
    .weather-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 12px;
      margin: 5px 0;
    }
    
    .weather-item {
      background: #f8f9fa;
      padding: 5px;
      border-radius: 3px;
    }
    
    
    .location-navigation {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .location-navigation h4 {
      margin: 0 0 10px 0;
      color: #2c5f2d;
    }

    /* 地図上ナビゲーションボタン */
    .map-location-button {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      color: #2c5f2d;
      border: 2px solid #2c5f2d;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: all 0.3s ease;
      white-space: nowrap;
      user-select: none;
    }

    .map-location-button:hover {
      background: #2c5f2d;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .map-location-button.active {
      background: #2c5f2d;
      color: white;
    }

    /* モバイル対応 */
    @media (max-width: 768px) {
      .map-location-button {
        padding: 10px 14px;
        font-size: 13px;
        border-radius: 16px;
      }
    }

    .map-navigation-info {
      background: #e8f5e8;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2c5f2d;
    }

    .map-navigation-info h4 {
      margin: 0 0 8px 0;
      color: #2c5f2d;
      font-size: 14px;
    }

    .map-navigation-info p {
      margin: 0;
      font-size: 12px;
      color: #555;
    }
    
    .nav-step {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-step label {
      min-width: 80px;
      font-weight: bold;
      color: #495057;
    }
    
    .nav-step select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }
    
    .nav-step select:focus {
      outline: none;
      border-color: #4a8a5a;
      box-shadow: 0 0 0 2px rgba(74, 138, 90, 0.2);
    }
    
    .current-location {
      background: #e8f5e8;
      border: 1px solid #4a8a5a;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
      color: #2c5f2d;
    }
    
    .forecast-reliability {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      font-size: 13px;
    }
    
    .reliability-header {
      font-weight: bold;
      color: #495057;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .reliability-icon {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      background: #17a2b8;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
      font-weight: bold;
    }
    
    .reliability-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    
    .reliability-table th,
    .reliability-table td {
      padding: 4px 8px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 12px;
    }
    
    .reliability-table th {
      background: #f1f3f4;
      font-weight: bold;
      color: #495057;
    }
    
    .accuracy-excellent { color: #28a745; font-weight: bold; }
    .accuracy-good { color: #ffc107; font-weight: bold; }
    .accuracy-fair { color: #fd7e14; font-weight: bold; }
    .accuracy-poor { color: #dc3545; font-weight: bold; }
    
    .season-status {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .season-status.in-season {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .season-status.pre-season {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }
    
    .season-status.post-season {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .schedule-item {
      background: white;
      border: 1px solid #dee2e6;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    
    .schedule-item.work-day {
      border-left: 4px solid #28a745;
    }
    
    .schedule-item.rest-day {
      border-left: 4px solid #dc3545;
      background: #f8f9fa;
    }

    /* モバイル対応メディアクエリ */
    @media screen and (max-width: 1024px) {
      .main-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .sidebar {
        width: 100%;
        order: -1; /* サイドバーを上に移動 */
      }
      
      .map-container {
        padding: 15px;
      }
      
      #map {
        height: 400px; /* モバイル用に地図の高さを調整 */
      }
    }

    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .sidebar {
        padding: 15px;
      }
      
      .map-container {
        padding: 10px;
      }
      
      #map {
        height: 350px;
      }
      
      /* ボタンサイズをタッチフレンドリーに */
      .btn {
        padding: 12px 16px;
        font-size: 15px;
        margin-right: 8px;
        margin-bottom: 12px;
        min-height: 44px; /* iOS推奨タッチターゲットサイズ */
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      /* コントロールパネルのレイアウト改善 */
      .control-panel {
        margin-bottom: 15px;
      }
      
      .record-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .record-buttons .btn {
        flex: 1;
        min-width: calc(50% - 4px);
        margin: 0;
      }
      
      /* フォームコントロールの改善 */
      .nav-step select {
        padding: 12px;
        font-size: 16px; /* iOS のズーム防止 */
        border-radius: 8px;
      }
      
      /* パネルのスクロール改善 */
      .forecast-panel,
      .record-panel {
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* テキストサイズの調整 */
      .forecast-day {
        padding: 12px;
        margin: 8px 0;
      }
      
      .weather-item {
        padding: 8px;
        margin: 5px 0;
      }
      
      /* ナビゲーションの改善 */
      .location-navigation {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .nav-step {
        margin: 8px 0;
        flex-direction: column;
        align-items: stretch;
        gap: 5px;
      }
      
      .nav-step label {
        min-width: auto;
        margin-bottom: 5px;
      }
    }

    @media screen and (max-width: 480px) {
      .header h1 {
        font-size: 18px;
      }
      
      #map {
        height: 300px;
      }
      
      .btn {
        padding: 14px 12px;
        font-size: 14px;
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .record-buttons .btn {
        width: 100%;
        min-width: 100%;
      }
      
      /* 小画面では単列レイアウト */
      .main-container {
        gap: 10px;
      }
      
      .sidebar,
      .map-container {
        padding: 10px;
      }
      
      /* スクロール領域の高さ調整 */
      .forecast-panel,
      .record-panel {
        max-height: 50vh;
      }
      
      /* フォントサイズの微調整 */
      .forecast-header {
        font-size: 16px;
      }
      
      .recommendation {
        font-size: 15px;
      }
      
      /* 詳細情報の表示改善 */
      .favoritesDetails,
      .systemMonitorDetails,
      .backupDetails {
        font-size: 11px;
        line-height: 1.4;
      }
    }

    /* タッチデバイス用の追加最適化 */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        background: #4a8a5a; /* ホバー効果を無効化 */
      }
      
      .btn-secondary:hover {
        background: #6c757d;
      }
      
      .btn-danger:hover {
        background: #dc3545;
      }
      
      /* タップ時のフィードバック */
      .btn:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }
      
      /* スクロール改善 */
      * {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* 横向き表示の最適化 */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      .header {
        padding: 10px 15px;
        margin-bottom: 10px;
      }
      
      .header h1 {
        font-size: 16px;
      }
      
      #map {
        height: 250px;
      }
      
      .forecast-panel,
      .record-panel {
        max-height: 40vh;
      }
    }

    /* 追加モバイル最適化 */
    .mobile-quick-actions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
    }

    .mobile-quick-actions.show {
      display: block;
    }

    .quick-action-btn {
      display: block;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #4a8a5a;
      color: white;
      border: none;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .quick-action-btn:active {
      transform: scale(0.95);
    }

    .quick-action-btn.primary {
      background: #007bff;
      width: 64px;
      height: 64px;
      font-size: 24px;
    }

    /* モバイル専用ヘルプテキスト */
    .mobile-help {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 12px;
      color: #856404;
    }

    @media screen and (max-width: 768px) {
      .mobile-help {
        display: block;
      }
      
      .mobile-quick-actions.show {
        display: block;
      }
    }

    /* スクロールバーのカスタマイズ（webkit系ブラウザ） */
    .forecast-panel::-webkit-scrollbar,
    .record-panel::-webkit-scrollbar {
      width: 8px;
    }

    .forecast-panel::-webkit-scrollbar-track,
    .record-panel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .forecast-panel::-webkit-scrollbar-thumb,
    .record-panel::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .forecast-panel::-webkit-scrollbar-thumb:hover,
    .record-panel::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* プログレスインジケーター */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-radius: 50%;
      border-top: 2px solid #4a8a5a;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* フォーカス時の表示改善 */
    @media screen and (max-width: 768px) {
      input:focus,
      select:focus,
      textarea:focus {
        position: relative;
        z-index: 999;
        background: white;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🌊 利尻島昆布干場予報システム</h1>
    <p>昆布漁師のための干場管理・気象予報・記録システム</p>
  </div>

  <div class="main-container">
    <div class="map-container">
      <div class="control-panel">
        <div class="location-navigation" style="display: none;">
          <h4>📍 地区選択ナビゲーション</h4>
          <div class="mobile-help">
            📱 <strong>モバイル操作ガイド:</strong><br>
            • 地図を長押し（2秒）で詳細メニュー表示<br>
            • ボタンタップで各機能にアクセス<br>
            • 画面回転で最適な表示に自動調整
          </div>
          <div class="nav-step">
            <label>町選択:</label>
            <select id="townSelect" class="btn">
              <option value="">-- 町を選択 --</option>
              <option value="rishiri-town">利尻町（西部）</option>
              <option value="rishiri-fuji-town">利尻富士町（東部）</option>
            </select>
          </div>
          <div class="nav-step" id="districtStep" style="display: none;">
            <label>地区選択:</label>
            <select id="districtSelect" class="btn">
              <option value="">-- 地区を選択 --</option>
            </select>
          </div>
          <div class="nav-step" id="areaStep" style="display: none;">
            <label>地域選択:</label>
            <select id="areaSelect" class="btn">
              <option value="">-- 地域を選択 --</option>
            </select>
          </div>
          <button id="resetNavButton" class="btn btn-secondary" style="display: none;">🔄 全島表示</button>
        </div>
        
        <div id="currentLocation" class="current-location" style="display: none;">
          <strong>📍 現在表示中:</strong> <span id="currentLocationText"></span>
        </div>
        
        <!-- 地図上ナビゲーション説明 -->
        <div class="map-navigation-info">
          <h4>📍 地図ナビゲーション</h4>
          <p>地図上の地名ボタンをタップして詳細な地域を表示できます</p>
          <button id="resetMapViewButton" class="btn btn-secondary">🔄 全島表示</button>
        </div>
        
        <hr style="margin: 15px 0;">
        
        <button id="addModeButton" class="btn">＋ 新規干場を追加</button>
        <button id="refreshButton" class="btn btn-secondary">🔄 干場を更新</button>
        
        <div id="newSpotInfo" class="new-spot-info">
          <h4>新しい干場を追加</h4>
          <p>地図上の陸地をクリックして干場を設定してください</p>
          <div id="newSpotDetails" style="display: none;">
            <p><strong>干場名:</strong> <span id="newSpotName"></span></p>
            <p><strong>座標:</strong> <span id="newSpotCoords"></span></p>
            <button id="saveSpot" class="btn">✓ 保存</button>
            <button id="cancelSpot" class="btn btn-secondary">✗ キャンセル</button>
          </div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>

    <div class="sidebar">
      <div id="spotInfo" class="spot-info">
        <h3 id="selectedSpotName">干場を選択してください</h3>
        <p id="selectedSpotCoords"></p>
        
        <div class="record-buttons">
          <button id="forecastButton" class="btn">📊 予報を見る</button>
          <button id="seaFogButton" class="btn">🌫️ 海霧予測</button>
          <button id="recordButton" class="btn">📝 記録を入力</button>
          <button id="adaptiveLearningButton" class="btn btn-secondary">🤖 自動学習</button>
          <button id="seasonButton" class="btn btn-secondary">📅 漁期管理</button>
          <button id="notificationButton" class="btn btn-secondary">🔔 通知設定</button>
          <button id="favoritesButton" class="btn btn-secondary">⭐ お気に入り</button>
          <button id="systemMonitorButton" class="btn btn-secondary">🔍 システム監視</button>
          <button id="backupButton" class="btn btn-secondary">💾 バックアップ</button>
          <button id="helpButton" class="btn btn-secondary">📖 ヘルプ</button>
          <button id="deleteButton" class="btn btn-danger">🗑️ 削除</button>
        </div>
      </div>

      <div id="forecastPanel" class="forecast-panel">
        <h4>📊 1週間の乾燥予報</h4>
        <div id="forecastContent" class="loading">
          予報を読み込み中...
        </div>
      </div>

      <div id="recordPanel" class="record-panel">
        <h4>📝 乾燥記録の入力</h4>
        <p>日付: <input type="date" id="recordDate" /></p>
        <p>結果:</p>
        <div class="record-buttons">
          <button id="recordSuccess" class="btn" data-result="完全乾燥">✓ 完全乾燥</button>
          <button id="recordPartial" class="btn btn-secondary" data-result="干したが完全には乾かせなかった（泣）">△ 部分乾燥</button>
          <button id="recordCancel" class="btn btn-danger" data-result="中止">✗ 中止</button>
        </div>
        <div id="recordStatus" style="margin-top: 10px;"></div>
      </div>

      <div id="adaptiveLearningPanel" class="record-panel">
        <h4>🤖 自動学習システム</h4>
        <div class="record-buttons">
          <button id="processLearningButton" class="btn">🔄 学習処理実行</button>
          <button id="qualityReportButton" class="btn btn-secondary">📊 品質レポート</button>
          <button id="retrainModelButton" class="btn btn-secondary">🧠 モデル再訓練</button>
        </div>
        <div id="adaptiveStatus" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="seaFogPanel" class="record-panel">
        <h4>🌫️ 海霧予測・可視化</h4>
        <div id="seaFogStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
          <div class="loading">海霧予測データを読み込み中...</div>
        </div>
        <div class="record-buttons">
          <button id="fogDashboardButton" class="btn">📊 ダッシュボード</button>
          <button id="fogTimelineButton" class="btn btn-secondary">📈 時系列チャート</button>
          <button id="fogHeatmapButton" class="btn btn-secondary">🗺️ リスクマップ</button>
          <button id="fogMapLayerButton" class="btn">🗺️ 地図レイヤー</button>
          <button id="fogAlertsButton" class="btn">🚨 アラート</button>
          <button id="fogFactorsButton" class="btn btn-secondary">🔍 要因分析</button>
          <button id="fogComparisonButton" class="btn btn-secondary">📊 地点比較</button>
          <button id="fogObservationButton" class="btn btn-secondary">👁️ 観測記録</button>
        </div>
        <div id="seaFogDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="seasonPanel" class="record-panel">
        <h4>📅 漁期スケジュール管理</h4>
        <div id="seasonStatus" class="season-status"></div>
        <div class="record-buttons">
          <button id="weeklyScheduleButton" class="btn">📋 週間スケジュール</button>
          <button id="restDaysButton" class="btn btn-secondary">🚫 休漁日管理</button>
          <button id="seasonConfigButton" class="btn btn-secondary">⚙️ 漁期設定</button>
        </div>
        <div id="seasonDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="notificationPanel" class="record-panel">
        <h4>🔔 通知システム設定</h4>
        <div id="notificationStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="notificationConfigButton" class="btn">⚙️ 通知設定</button>
          <button id="subscribersButton" class="btn btn-secondary">👥 通知対象者</button>
          <button id="testNotificationButton" class="btn btn-secondary">🧪 テスト通知</button>
          <button id="schedulerButton" class="btn btn-secondary">🎯 スケジューラー</button>
        </div>
        <div id="notificationDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="systemMonitorPanel" class="record-panel">
        <h4>🔍 システム監視・パフォーマンス</h4>
        <div id="systemMonitorStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="healthCheckButton" class="btn">💚 ヘルスチェック</button>
          <button id="healthHistoryButton" class="btn btn-secondary">📈 履歴表示</button>
          <button id="alertHistoryButton" class="btn btn-secondary">🚨 アラート履歴</button>
          <button id="monitorConfigButton" class="btn btn-secondary">⚙️ 監視設定</button>
          <button id="monitorToggleButton" class="btn btn-secondary">▶️ 監視開始</button>
        </div>
        <div id="systemMonitorDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="backupPanel" class="record-panel">
        <h4>💾 データバックアップ・復元</h4>
        <div id="backupStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="createBackupButton" class="btn">📦 バックアップ作成</button>
          <button id="backupListButton" class="btn btn-secondary">📋 バックアップ一覧</button>
          <button id="autoBackupToggleButton" class="btn btn-secondary">⏰ 自動バックアップ</button>
          <button id="backupConfigButton" class="btn btn-secondary">⚙️ バックアップ設定</button>
        </div>
        <div id="backupDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
      <div id="favoritesPanel" class="record-panel">
        <h4>⭐ お気に入り干場管理</h4>
        <div id="favoritesStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="addFavoriteButton" class="btn">⭐ お気に入り追加</button>
          <button id="quickAccessButton" class="btn btn-secondary">🚀 クイックアクセス</button>
          <button id="favoritesListButton" class="btn btn-secondary">📋 一覧表示</button>
          <button id="searchFavoritesButton" class="btn btn-secondary">🔍 検索</button>
          <button id="favoritesImportButton" class="btn btn-secondary">📥 インポート</button>
          <button id="favoritesExportButton" class="btn btn-secondary">📤 エクスポート</button>
        </div>
        <div id="favoritesDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
      <div id="helpPanel" class="record-panel">
        <h4>📖 ユーザーマニュアル・ヘルプ</h4>
        <div id="helpStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
          <div><strong>📘 システムガイド:</strong> 利尻島昆布干場予報システムの使い方</div>
          <div><strong>🎯 対象:</strong> 昆布漁師・干場管理者・関係者</div>
        </div>
        <div class="record-buttons">
          <button id="tutorialButton" class="btn">🎯 チュートリアル</button>
          <button id="faqButton" class="btn btn-secondary">❓ よくある質問</button>
          <button id="featuresGuideButton" class="btn btn-secondary">🛠️ 機能ガイド</button>
          <button id="quickRefButton" class="btn btn-secondary">📋 操作早見表</button>
          <button id="troubleshootButton" class="btn btn-secondary">🔧 トラブル対応</button>
          <button id="contactButton" class="btn btn-secondary">📞 お問い合わせ</button>
        </div>
        <div id="helpDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
    </div>
  </div>

  <script>
    // グローバル変数
    const map = L.map('map').setView([45.178269, 141.228528], 11);
    // 動的にAPIベースURLを設定（スマホアクセス対応）
    const API_BASE = window.location.protocol + '//' + window.location.hostname + ':' + (window.location.port || '8000');
    
    let spots = [];
    let addMode = false;
    let tempMarker = null;
    let selectedSpot = null;
    let currentSelectedSpot = null;
    let spotMarkers = [];
    let townBoundaries = {};
    let seaFogLayer = null;
    let seaFogLayerControl = null;
    let seaFogDataCache = null;

    // 地図上ナビゲーションシステム
    let currentNavigationLevel = 0; // 0: 町レベル, 1: 地区レベル, 2: 地域レベル
    let currentTown = null;
    let currentDistrict = null;
    let mapLocationButtons = []; // 現在表示中のボタンを記録

    // 利尻島地理データ
    const rishiriGeography = {
      'rishiri-town': {
        name: '利尻町',
        center: [45.165, 141.200],
        zoom: 14,
        districts: {
          'kutsugata': {
            name: '沓形',
            center: [45.210, 141.200],
            zoom: 15,
            burakus: {
              'honcho': { name: '本町', center: [45.210, 141.200] },
              'motomachi': { name: '元町', center: [45.205, 141.195] },
              'shinmachi': { name: '新町', center: [45.215, 141.205] }
            },
            areas: {
              'kutsugata-minato': { name: '沓形港周辺', center: [45.215, 141.205], zoom: 16 },
              'kutsugata-honcho': { name: '沓形本町', center: [45.208, 141.198], zoom: 16 },
              'kutsugata-nishi': { name: '沓形西', center: [45.205, 141.192], zoom: 16 }
            }
          },
          'senposhi': {
            name: '仙法志',
            center: [45.136, 141.211],
            zoom: 15,
            areas: {
              'senposhi-minato': { name: '仙法志港周辺', center: [45.136, 141.211], zoom: 16 },
              'senposhi-misaki': { name: '仙法志御崎', center: [45.130, 141.215], zoom: 16 },
              'senposhi-honcho': { name: '仙法志本町', center: [45.138, 141.208], zoom: 16 }
            }
          }
        }
      },
      'rishiri-fuji-town': {
        name: '利尻富士町',
        center: [45.215, 141.250],
        zoom: 14,
        districts: {
          'oshidomari': {
            name: '鴛泊',
            center: [45.242, 141.231],
            zoom: 15,
            areas: {
              'oshidomari-minato': { name: '鴛泊港周辺', center: [45.242, 141.231], zoom: 16 },
              'oshidomari-onsen': { name: '鴛泊温泉', center: [45.245, 141.228], zoom: 16 },
              'oshidomari-honcho': { name: '鴛泊本町', center: [45.240, 141.233], zoom: 16 }
            }
          },
          'oniwaki': {
            name: '鬼脇',
            center: [45.180, 141.270],
            zoom: 15,
            areas: {
              'oniwaki-minato': { name: '鬼脇港周辺', center: [45.180, 141.270], zoom: 16 },
              'oniwaki-honcho': { name: '鬼脇本町', center: [45.178, 141.268], zoom: 16 },
              'oniwaki-higashi': { name: '鬼脇東', center: [45.182, 141.275], zoom: 16 }
            }
          }
        }
      }
    };

    // 地図の初期化
    L.tileLayer.provider('Esri.WorldImagery').addTo(map);
    
    // 地図上ナビゲーションシステムの初期化
    initializeMapNavigation();
    

    // 地図上ナビゲーション機能
    function initializeMapNavigation() {
      showTownButtons();
    }

    function showTownButtons() {
      clearMapLocationButtons();
      currentNavigationLevel = 0;
      
      // 利尻町ボタン（沓形・仙法志エリア中心）
      createMapLocationButton('利尻町', [45.150, 141.210], () => {
        selectTown('rishiri-town');
      });
      
      // 利尻富士町ボタン（鴛泊・鬼脇エリア中心）
      createMapLocationButton('利尻富士町', [45.210, 141.270], () => {
        selectTown('rishiri-fuji-town');
      });
    }


    // 統一的なマーカー作成関数（お気に入り状態対応）
    function createMarkersWithFavorites(spotsToShow, callback) {
      // 既存のマーカーをクリア
      spotMarkers.forEach(marker => map.removeLayer(marker));
      spotMarkers = [];

      // お気に入りデータを先に取得
      fetch(`${API_BASE}/favorites`)
        .then(response => response.json())
        .then(favoritesData => {
          const favoriteNames = favoritesData.status === 'success' 
            ? new Set(favoritesData.favorites.map(fav => fav.name))
            : new Set();

          console.log('お気に入り干場:', Array.from(favoriteNames));

          spotsToShow.forEach(spot => {
            const isFavorite = favoriteNames.has(spot.name);
            
            // マーカーアイコンの設定
            const markerIcon = isFavorite 
              ? L.divIcon({
                  className: 'custom-div-icon favorite-marker',
                  html: `
                    <div style="
                      position: relative;
                      width: 32px;
                      height: 32px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
                      <div style="
                        background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
                        color: #d84315;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 18px;
                        border: 3px solid #ff6f00;
                        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3);
                        animation: pulse-favorite 2s infinite;
                        transform: scale(1.1);
                        z-index: 1000;
                      ">⭐</div>
                    </div>
                    <style>
                      @keyframes pulse-favorite {
                        0% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3); }
                        50% { transform: scale(1.2); box-shadow: 0 6px 16px rgba(255, 193, 7, 0.8), 0 0 0 6px rgba(255, 235, 59, 0.5); }
                        100% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3); }
                      }
                    </style>
                  `,
                  iconSize: [32, 32],
                  iconAnchor: [16, 16]
                })
              : L.divIcon({
                  className: 'custom-div-icon',
                  html: '<div style="background-color: #2196f3; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold;">●</div>',
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                });

            // お気に入りボタンのステータス設定
            const favoriteButtonText = isFavorite ? 'お気に入りから外す' : 'お気に入りに追加';
            const favoriteButtonColor = isFavorite ? '#28a745' : '#ffc107';

            const marker = L.marker([spot.lat, spot.lon], { 
              icon: markerIcon,
              title: spot.name  // マーカー識別用
            })
              .bindPopup(`
                <div style="text-align: center;">
                  <b>${spot.name}</b><br>
                  <small>${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}</small><br>
                  <small>町: ${spot.town}</small><br>
                  <small>地区: ${spot.district}</small><br>
                  <small>部落: ${spot.buraku}</small><br>
                  <button onclick="window.getWeatherForecast(${spot.lat}, ${spot.lon})" class="btn btn-sm">天気予報</button><br>
                  <button onclick="window.openRecordDialog('${spot.name}')" class="btn btn-sm" style="margin-top: 5px; background: #ff9800; color: white;">記録</button><br>
                  <button onclick="window.toggleFavorite('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" id="favorite-btn-${spot.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-top: 5px; background: ${favoriteButtonColor}; color: white;">${favoriteButtonText}</button><br>
                  <button onclick="window.confirmDeleteSpot('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" style="margin-top: 5px; background: #f44336; color: white;">削除</button>
                </div>
              `)
              .addTo(map);
            
            spotMarkers.push(marker);
          });

          // コールバック関数が提供されていれば実行
          if (callback) {
            callback();
          }
        })
        .catch(error => {
          console.error('お気に入りデータ取得エラー:', error);
          // エラーの場合は通常のマーカーで表示
          spotsToShow.forEach(spot => {
            const marker = L.marker([spot.lat, spot.lon], {
              title: spot.name
            })
              .bindPopup(`
                <div style="text-align: center;">
                  <b>${spot.name}</b><br>
                  <small>${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}</small><br>
                  <small>町: ${spot.town}</small><br>
                  <small>地区: ${spot.district}</small><br>
                  <small>部落: ${spot.buraku}</small><br>
                  <button onclick="window.getWeatherForecast(${spot.lat}, ${spot.lon})" class="btn btn-sm">天気予報</button><br>
                  <button onclick="window.openRecordDialog('${spot.name}')" class="btn btn-sm" style="margin-top: 5px; background: #ff9800; color: white;">記録</button><br>
                  <button onclick="window.toggleFavorite('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" id="favorite-btn-${spot.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-top: 5px; background: #ffc107; color: white;">お気に入りに追加</button><br>
                  <button onclick="window.confirmDeleteSpot('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" style="margin-top: 5px; background: #f44336; color: white;">削除</button>
                </div>
              `)
              .addTo(map);
            
            spotMarkers.push(marker);
          });

          if (callback) {
            callback();
          }
        });
    }


    function createMapLocationButton(text, position, clickHandler) {
      // Leafletマーカーとして作成
      const button = L.marker(position, {
        icon: L.divIcon({
          className: 'map-location-button',
          html: `<div style="background: #4a8a5a; color: white; padding: 8px 12px; border-radius: 5px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; text-align: center; white-space: nowrap;">${text}</div>`,
          iconSize: [null, null], // 自動サイズ
          iconAnchor: [null, null]
        })
      }).addTo(map);

      // クリックイベントを追加
      button.on('click', function(e) {
        console.log('Button clicked:', text);
        clickHandler();
        e.originalEvent.stopPropagation();
      });
      
      // ボタンリストに追加
      mapLocationButtons.push(button);
      
      return button;
    }

    function clearMapLocationButtons() {
      mapLocationButtons.forEach(button => {
        map.removeLayer(button);
      });
      mapLocationButtons = [];
    }

    function selectTown(townId) {
      console.log('selectTown called with:', townId);
      currentTown = townId;
      currentNavigationLevel = 1;
      
      const town = rishiriGeography[townId];
      console.log('Town data:', town);
      
      // 境界線をクリア（緑枠は非表示）
      clearTownBoundaries();
      
      // 選択した町の地点のみ表示
      filterSpotsByTown(townId);
      
      // 町の地点全体が収まるように地図範囲を自動調整
      setTimeout(() => {
        fitMapToTownSpots(townId);
        showDistrictButtons(townId);
      }, 100); // フィルタリング後に実行
    }

    function showDistrictButtons(townId) {
      clearMapLocationButtons();
      
      const town = rishiriGeography[townId];
      Object.entries(town.districts).forEach(([districtId, district]) => {
        createMapLocationButton(district.name, district.center, () => {
          selectDistrict(townId, districtId);
        });
      });
    }

    function selectDistrict(townId, districtId) {
      console.log('selectDistrict called with:', townId, districtId);
      currentDistrict = districtId;
      currentNavigationLevel = 2;
      
      const district = rishiriGeography[townId].districts[districtId];
      console.log('District data:', district);
      
      // 選択した地区の地点のみ表示
      filterSpotsByDistrict(townId, districtId);
      
      // 地区の地点全体が収まるように地図範囲を自動調整
      setTimeout(() => {
        fitMapToDistrictSpots(townId, districtId);
        showAreaButtons(townId, districtId);
      }, 100); // フィルタリング後に実行
    }

    function showAreaButtons(townId, districtId) {
      clearMapLocationButtons();
      
      const district = rishiriGeography[townId].districts[districtId];
      
      // 部落ボタンを実際のCSVデータから作成
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      const districtNameMap = {
        'kutsugata': '沓形',
        'senposhi': '仙法志', 
        'oshidomari': '鴛泊',
        'oniwaki': '鬼脇'
      };
      const targetDistrict = districtNameMap[districtId];
      
      // 該当地区の部落一覧を取得
      const distinctBurakus = [...new Set(spots
        .filter(spot => spot.town === targetTown && spot.district === targetDistrict)
        .map(spot => spot.buraku)
      )];
      
      // 各部落の中心座標を計算してボタンを配置
      distinctBurakus.forEach(buraku => {
        const burakuSpots = spots.filter(spot => 
          spot.town === targetTown && 
          spot.district === targetDistrict && 
          spot.buraku === buraku
        );
        
        if (burakuSpots.length > 0) {
          const centerLat = burakuSpots.reduce((sum, spot) => sum + spot.lat, 0) / burakuSpots.length;
          const centerLon = burakuSpots.reduce((sum, spot) => sum + spot.lon, 0) / burakuSpots.length;
          
          createMapLocationButton(buraku, [centerLat, centerLon], () => {
            selectBuraku(townId, districtId, buraku);
          });
        }
      });
    }

    function selectBuraku(townId, districtId, buraku) {
      console.log('selectBuraku called with:', townId, districtId, buraku);
      
      // 部落の地点のみ表示
      filterSpotsByBuraku(townId, districtId, buraku);
      
      // 部落の地点全体が収まるように地図範囲を自動調整
      setTimeout(() => {
        fitMapToBurakuSpots(townId, districtId, buraku);
        clearMapLocationButtons(); // 最終階層なのでボタンは消す
      }, 100);
    }

    function filterSpotsByBuraku(townId, districtId, buraku) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      const districtNameMap = {
        'kutsugata': '沓形',
        'senposhi': '仙法志', 
        'oshidomari': '鴛泊',
        'oniwaki': '鬼脇'
      };
      const targetDistrict = districtNameMap[districtId];
      
      console.log(`部落フィルタ対象: ${targetTown} - ${targetDistrict} - ${buraku}`);
      
      // 選択した部落の地点のみフィルタリング
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && 
        spot.district === targetDistrict && 
        spot.buraku === buraku
      );
      
      console.log(`${buraku}の地点数: ${filteredSpots.length}`);
      
      // 統一関数でマーカーを作成（お気に入り色対応）
      createMarkersWithFavorites(filteredSpots);
    }
    
    function fitMapToBurakuSpots(townId, districtId, buraku) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      const districtNameMap = {
        'kutsugata': '沓形',
        'senposhi': '仙法志', 
        'oshidomari': '鴛泊',
        'oniwaki': '鬼脇'
      };
      const targetDistrict = districtNameMap[districtId];
      
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && 
        spot.district === targetDistrict && 
        spot.buraku === buraku
      );
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // 部落レベルでは最も詳細にズーム
        const fitOptions = {
          padding: [10, 10],
          maxZoom: 15 // 部落レベルは最も近くにズーム
        };
        
        map.fitBounds(bounds, fitOptions);
      }
    }

    function resetMapNavigation() {
      clearMapLocationButtons();
      clearTownBoundaries();
      map.setView([45.178269, 141.228528], 11);
      showAllSpots(); // 全地点を再表示
      showTownButtons();
    }

    // 町別地点フィルタリング機能
    function filterSpotsByTown(townId) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      
      // 選択した町の地点のみフィルタリング
      const filteredSpots = spots.filter(spot => spot.town === targetTown);
      
      console.log(`${targetTown}の地点数: ${filteredSpots.length}`);
      console.log('Filtered spots sample:', filteredSpots.slice(0, 3));
      
      // 統一関数でマーカーを作成（お気に入り色対応）
      createMarkersWithFavorites(filteredSpots);
    }

    // 地区別地点フィルタリング機能
    function filterSpotsByDistrict(townId, districtId) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      
      // 地区IDから実際の地区名にマッピング
      const districtNameMap = {
        'kutsugata': '沓形',
        'senposhi': '仙法志', 
        'oshidomari': '鴛泊',
        'oniwaki': '鬼脇'
      };
      
      const targetDistrict = districtNameMap[districtId];
      console.log(`フィルタ対象: ${targetTown} - ${targetDistrict}`);
      
      // 選択した町・地区の地点のみフィルタリング
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && spot.district === targetDistrict
      );
      
      console.log(`${targetDistrict}地区の地点数: ${filteredSpots.length}`);
      console.log('Filtered district spots sample:', filteredSpots.slice(0, 3));
      
      // 統一関数でマーカーを作成（お気に入り色対応）
      createMarkersWithFavorites(filteredSpots);
    }

    // 全地点を表示
    function showAllSpots() {
      displaySpots(); // 既存の表示関数を使用
    }

    // 町の地点に合わせて地図範囲を自動調整
    function fitMapToTownSpots(townId) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      const filteredSpots = spots.filter(spot => spot.town === targetTown);
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // 町ごとに最適なズーム設定
        let fitOptions;
        if (targetTown === '利尻富士町') {
          // 利尻富士町は範囲が広いので、より積極的にズームイン
          fitOptions = {
            padding: [10, 10],
            maxZoom: 12.5  // より近くにズーム
          };
        } else {
          // 利尻町は比較的コンパクト
          fitOptions = {
            padding: [20, 20],
            maxZoom: 13
          };
        }
        
        map.fitBounds(bounds, fitOptions);
      }
    }

    // 地区の地点に合わせて地図範囲を自動調整
    function fitMapToDistrictSpots(townId, districtId) {
      const targetTown = townId === 'rishiri-town' ? '利尻町' : '利尻富士町';
      
      const districtNameMap = {
        'kutsugata': '沓形',
        'senposhi': '仙法志', 
        'oshidomari': '鴛泊',
        'oniwaki': '鬼脇'
      };
      
      const targetDistrict = districtNameMap[districtId];
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && spot.district === targetDistrict
      );
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // 地区レベルではより詳細にズーム
        const fitOptions = {
          padding: [15, 15],
          maxZoom: 14 // 地区レベルはより近くにズーム
        };
        
        map.fitBounds(bounds, fitOptions);
        console.log(`${targetDistrict}地区にズーム調整完了`);
      }
    }

    // DOM要素の取得
    const addModeButton = document.getElementById('addModeButton');
    const refreshButton = document.getElementById('refreshButton');
    const newSpotInfo = document.getElementById('newSpotInfo');
    const newSpotDetails = document.getElementById('newSpotDetails');
    const newSpotName = document.getElementById('newSpotName');
    const newSpotCoords = document.getElementById('newSpotCoords');
    const saveSpot = document.getElementById('saveSpot');
    const cancelSpot = document.getElementById('cancelSpot');
    
    const spotInfo = document.getElementById('spotInfo');
    const selectedSpotName = document.getElementById('selectedSpotName');
    const selectedSpotCoords = document.getElementById('selectedSpotCoords');
    const forecastButton = document.getElementById('forecastButton');
    const recordButton = document.getElementById('recordButton');
    const deleteButton = document.getElementById('deleteButton');
    
    const forecastPanel = document.getElementById('forecastPanel');
    const forecastContent = document.getElementById('forecastContent');
    const recordPanel = document.getElementById('recordPanel');
    const recordDate = document.getElementById('recordDate');
    const recordStatus = document.getElementById('recordStatus');

    // 今日の日付を設定
    recordDate.valueAsDate = new Date();

    // 地図リセットボタンのイベントリスナー
    const resetMapViewButton = document.getElementById('resetMapViewButton');
    resetMapViewButton.addEventListener('click', resetMapNavigation);

    // 干場データの読み込み
    function loadSpots() {
      fetch(`${API_BASE}/spots`)
        .then(res => res.json())
        .then(data => {
          spots = data;
          console.log('Loaded spots data:', spots.length, 'spots');
          console.log('Sample spot:', spots[0]);
          
          // 町別データの確認
          const rishiriTown = spots.filter(s => s.town === '利尻町').length;
          const rishiriFujiTown = spots.filter(s => s.town === '利尻富士町').length;
          console.log('利尻町の地点数:', rishiriTown);
          console.log('利尻富士町の地点数:', rishiriFujiTown);
          
          displaySpots();
          showTownButtons(); // 初期化時に町ボタンも表示
        })
        .catch(err => {
          console.error('干場データの読み込みエラー:', err);
          alert('干場データの読み込みに失敗しました');
        });
    }

    // 干場をマップに表示（統一関数を使用）
    function displaySpots() {
      console.log('displaySpots: 全干場を表示');
      createMarkersWithFavorites(spots);
    }

    // 干場選択
    function selectSpot(spotName) {
      const spot = spots.find(s => s.name === spotName);
      if (!spot) return;

      selectedSpot = spot;
      currentSelectedSpot = spotName;
      selectedSpotName.textContent = spot.name;
      selectedSpotCoords.textContent = `${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}`;
      
      spotInfo.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      
      // 記録の有無をチェックして削除ボタンの表示を制御
      checkSpotRecords(spotName);
      
      // お気に入りボタンの状態を更新
      updateFavoriteButton();
      
      // 地図を選択した干場に移動
      map.setView([spot.lat, spot.lon], 15);
    }

    // 干場の記録有無チェック
    function checkSpotRecords(spotName) {
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}`)
        .then(res => res.json())
        .then(data => {
          const deleteButton = document.getElementById('deleteButton');
          if (data.has_records) {
            // 記録がある場合は削除ボタンを非表示
            deleteButton.style.display = 'none';
          } else {
            // 記録がない場合は削除ボタンを表示
            deleteButton.style.display = 'inline-block';
          }
        })
        .catch(err => {
          console.error('記録チェックエラー:', err);
          // エラーの場合は安全のため削除ボタンを非表示
          document.getElementById('deleteButton').style.display = 'none';
        });
    }

    // 新規干場追加モード
    addModeButton.addEventListener('click', () => {
      if (!addMode) {
        addMode = true;
        addModeButton.textContent = '❌ 追加をキャンセル';
        addModeButton.className = 'btn btn-danger';
        addModeButton.style.fontWeight = 'bold';
        newSpotInfo.style.display = 'block';
        spotInfo.style.display = 'none';
        forecastPanel.style.display = 'none';
        recordPanel.style.display = 'none';
        document.getElementById('adaptiveLearningPanel').style.display = 'none';
        document.getElementById('seasonPanel').style.display = 'none';
        document.getElementById('notificationPanel').style.display = 'none';

        // 地図をクリック可能にする前の警告
        showMobileMessage('⚠️ 陸地のみクリック可能です。海上は追加できません。', 'warning', 4000);

        // モバイル向けの追加指示を表示
        showAddModeInstructions();
      } else {
        cancelAddMode();
      }
    });

    // モバイル向けメッセージ表示（汎用）
    function showMobileMessage(message, type = 'info', duration = 3000) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'warning' ? '#ff6b35' : type === 'success' ? '#28a745' : '#007bff'};
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        z-index: 10001;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 90%;
        animation: slideInDown 0.3s ease-out;
      `;
      messageDiv.innerHTML = message;
      document.body.appendChild(messageDiv);
      
      // アニメーション用CSS を動的追加
      if (!document.getElementById('mobileMessageStyles')) {
        const style = document.createElement('style');
        style.id = 'mobileMessageStyles';
        style.textContent = `
          @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
          }
          @keyframes slideOutUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      setTimeout(() => {
        messageDiv.style.animation = 'slideOutUp 0.3s ease-out';
        setTimeout(() => {
          if (document.body.contains(messageDiv)) {
            document.body.removeChild(messageDiv);
          }
        }, 300);
      }, duration);
    }

    // モバイル向け追加モード指示表示
    function showAddModeInstructions() {
      // モバイルデバイスかどうかチェック
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
      
      if (isMobile) {
        // モバイル用の指示メッセージを追加
        let instructionDiv = document.getElementById('mobileAddInstructions');
        if (!instructionDiv) {
          instructionDiv = document.createElement('div');
          instructionDiv.id = 'mobileAddInstructions';
          instructionDiv.style.cssText = `
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 90%;
          `;
          instructionDiv.innerHTML = '👆 地図をタップして新しい干場を追加';
          document.body.appendChild(instructionDiv);
        }
        instructionDiv.style.display = 'block';
      }
    }

    // 追加モードキャンセル
    function cancelAddMode() {
      addMode = false;
      addModeButton.textContent = '＋ 新規干場を追加';
      addModeButton.className = 'btn';
      addModeButton.style.fontWeight = 'normal';
      newSpotInfo.style.display = 'none';
      newSpotDetails.style.display = 'none';
      
      // モバイル指示メッセージを削除
      const instructionDiv = document.getElementById('mobileAddInstructions');
      if (instructionDiv) {
        instructionDiv.style.display = 'none';
      }
      
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }

    // 地図クリック・タッチイベント（干場追加用）
    function handleMapClick(e) {
      if (!addMode) return;

      const lat = e.latlng.lat;
      const lon = e.latlng.lng;
      
      // モバイル向け視覚的フィードバック
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
      
      if (isMobile) {
        // タップ位置に一時的な視覚効果を表示
        const tapIndicator = L.circleMarker([lat, lon], {
          radius: 15,
          color: '#007bff',
          fillColor: '#007bff',
          fillOpacity: 0.3,
          weight: 3
        }).addTo(map);
        
        setTimeout(() => {
          map.removeLayer(tapIndicator);
        }, 1000);
      }
      
      // 利尻島エリア内かチェック
      if (lat < 45.120 || lat > 45.260 || lon < 141.180 || lon > 141.280) {
        if (isMobile) {
          showMobileMessage('干場は利尻島エリア内に設定してください', 'warning');
        } else {
          alert('干場は利尻島エリア内（45.120-45.260°N, 141.180-141.280°E）に設定してください。');
        }
        return;
      }
      
      // 干場名の生成（H_緯度4桁_経度4桁）
      const latPart = Math.round((lat - Math.floor(lat)) * 10000);
      const lonPart = Math.round((lon - Math.floor(lon)) * 10000);
      const spotName = `H_${latPart}_${lonPart}`;

      // 重複チェック
      if (spots.find(s => s.name === spotName)) {
        if (isMobile) {
          showMobileMessage('この場所には既に干場が存在します', 'warning');
        } else {
          alert('この場所には既に干場が存在します');
        }
        return;
      }

      // 仮マーカーを表示
      if (tempMarker) {
        map.removeLayer(tempMarker);
      }
      tempMarker = L.marker([lat, lon]).addTo(map);

      // 詳細情報を表示
      newSpotName.textContent = spotName;
      newSpotCoords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      newSpotDetails.style.display = 'block';
      
      // 保存ボタンにデータを設定
      saveSpot.onclick = () => saveNewSpot(spotName, lat, lon);
    }

    // 地図イベントをバインド（クリック・タッチ対応）
    map.on('click', handleMapClick);
    map.on('tap', handleMapClick); // タッチデバイス対応

    // 新規干場保存
    function saveNewSpot(name, lat, lon) {
      const spotData = { name, lat, lon };
      
      fetch(`${API_BASE}/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(spotData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('新しい干場が追加されました');
          cancelAddMode();
          loadSpots();
        } else {
          alert('干場の追加に失敗しました: ' + data.message);
        }
      })
      .catch(err => {
        console.error('干場追加エラー:', err);
        alert('干場の追加に失敗しました');
      });
    }

    // 干場削除
    deleteButton.addEventListener('click', () => {
      if (!selectedSpot) return;
      
      // 再度記録有無を確認（安全のため）
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(selectedSpot.name)}`)
        .then(res => res.json())
        .then(data => {
          if (data.has_records) {
            alert('この干場には記録があるため削除できません。');
            return;
          }
          
          if (confirm(`干場「${selectedSpot.name}」を削除しますか？\n※記録がない干場のみ削除可能です。`)) {
            fetch(`${API_BASE}/delete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: selectedSpot.name })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                alert('干場が削除されました');
                spotInfo.style.display = 'none';
                forecastPanel.style.display = 'none';
                recordPanel.style.display = 'none';
                document.getElementById('adaptiveLearningPanel').style.display = 'none';
                document.getElementById('seaFogPanel').style.display = 'none';
                // 海霧パネルが閉じられた場合、レイヤーも非表示にする
                if (seaFogLayer && map.hasLayer(seaFogLayer)) {
                  removeSeaFogLayerWithAutoUpdate();
                }
                document.getElementById('seasonPanel').style.display = 'none';
                document.getElementById('notificationPanel').style.display = 'none';
                selectedSpot = null;
                loadSpots();
              } else {
                alert('干場の削除に失敗しました');
              }
            })
            .catch(err => {
              console.error('干場削除エラー:', err);
              alert('干場の削除に失敗しました');
            });
          }
        })
        .catch(err => {
          console.error('記録チェックエラー:', err);
          alert('記録の確認に失敗しました');
        });
    });

    // 予報表示
    forecastButton.addEventListener('click', () => {
      console.log('Forecast button clicked, selectedSpot:', selectedSpot);
      if (!selectedSpot) return;
      
      forecastPanel.style.display = 'block';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      forecastContent.innerHTML = '<div class="loading">予報を読み込み中...</div>';
      
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const startDate = tomorrow.toISOString().split('T')[0];
      
      console.log('Fetching forecast for:', selectedSpot.lat, selectedSpot.lon, 'date:', startDate);
      
      fetch(`${API_BASE}/forecast?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}`)
        .then(res => {
          console.log('Fetch response received:', res.status);
          return res.json();
        })
        .then(data => {
          console.log('API Response received:', data);
          displayForecast(data);
        })
        .catch(err => {
          console.error('予報取得エラー:', err);
          forecastContent.innerHTML = '<div style="color: red;">予報の取得に失敗しました</div>';
        });
    });

    // 予報表示
    function displayForecast(forecastData) {
      console.log('displayForecast called with:', forecastData);
      
      const forecastContent = document.getElementById('forecastContent');
      if (!forecastContent) {
        console.error('forecastContent element not found');
        return;
      }
      
      if (!forecastData) {
        console.log('No forecast data:', forecastData);
        forecastContent.innerHTML = '<div style="color: red;">予報データがありません</div>';
        return;
      }

      const result = forecastData;
      let html = '';
      
      // 翌日予報を最優先で表示（新APIレスポンス対応）
      html += `
        <div class="tomorrow-forecast" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
          <div style="font-size: 18px; font-weight: bold; color: #1976d2; margin-bottom: 15px;">
            🌅 明日の予報 (${new Date(Date.now() + 24*60*60*1000).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})})
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">🌊 利尻島特化予測</div>
            <div class="recommendation ${getRecommendationClass(result.prediction)}" style="font-size: 16px;">
              ${result.prediction || '予測データなし'}
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              信頼度: ${result.confidence}%
            </div>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">🌬️ 気象条件</div>
            <div style="margin-bottom: 5px;">風速: ${result.wind} m/s</div>
            <div style="margin-bottom: 5px;">湿度: ${result.humidity}%</div>
          </div>
      `;
      
      // 安全警告の表示
      if (result.safety_warnings && result.safety_warnings.length > 0) {
        html += `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">⚠️ 安全情報</div>
        `;
        result.safety_warnings.forEach(warning => {
          html += `<div style="color: #856404; margin-bottom: 3px;">• ${warning}</div>`;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      
      // 推奨情報（簡素化）
      if (result.recommendation) {
        html += `
          <div style="background: #f0f8ff; border: 1px solid #b0d4f1; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="font-weight: bold; color: #1565c0; margin-bottom: 8px;">
              ✅ 作業推奨
            </div>
            <div style="background: white; padding: 12px; border-radius: 5px;">
              <div class="recommendation" style="font-size: 16px; font-weight: bold; color: #1565c0;">
                ${result.recommendation}
              </div>
            </div>
          </div>
        `;
      }
      
      // 表示完了
      forecastContent.innerHTML = html;
    }


    // 推奨レベルのCSSクラス取得（簡素化）
    function getRecommendationClass(recommendation) {
      if (!recommendation) return 'poor';
      if (recommendation.includes('◎') || recommendation.includes('Good')) return 'excellent';
      if (recommendation.includes('○')) return 'good';
      if (recommendation.includes('△') || recommendation.includes('Storm')) return 'caution';
      return 'poor';
    }

    // 天気予報を取得して表示する関数
    function getWeatherForecast(lat, lon) {
      if (!lat || !lon) {
        console.error('緯度または経度が指定されていません');
        return;
      }

      // 予報パネルを表示
      const forecastPanel = document.getElementById('forecastPanel');
      const forecastContent = document.getElementById('forecastContent');
      
      if (forecastPanel && forecastContent) {
        forecastPanel.style.display = 'block';
        forecastContent.innerHTML = '<div class="loading">天気予報を取得中...</div>';
        
        // API呼び出し
        fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}`)
          .then(response => response.json())
          .then(data => {
            console.log('Weather API Response:', data);
            displayForecast(data);
          })
          .catch(error => {
            console.error('天気予報取得エラー:', error);
            forecastContent.innerHTML = '<div style="color: red;">天気予報の取得に失敗しました</div>';
          });
      }
    }


    // 記録関連機能
    function generateDetailedHourlyDisplay(detailedHourly) {
      let html = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
          <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">🌤️ 詳細気象条件 (時間帯別)</h3>
          <div style="font-size: 12px; color: #666; text-align: center; margin-bottom: 15px;">
            干場θ値: ${detailedHourly.hoshiba_theta?.toFixed(1)}°
          </div>
      `;

      // 午前4時〜午後4時（気温・湿度）
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #e3f2fd; padding: 10px; font-weight: bold; color: #1976d2;">
            📊 午前4時〜午後4時 (気温・湿度)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; font-size: 11px;">
      `;
      
      detailedHourly.work_hours_4_16?.forEach(hour => {
        const temp = hour.temperature?.toFixed(1) || '--';
        const humidity = hour.humidity?.toFixed(0) || '--';
        html += `
          <div style="text-align: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333;">${hour.hour}時</div>
            <div style="color: #d32f2f; margin: 2px 0;">${temp}°C</div>
            <div style="color: #1976d2;">${humidity}%</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // 午前4時〜10時（風向・風速・角度差）
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #e8f5e8; padding: 10px; font-weight: bold; color: #2e7d32;">
            🌬️ 午前4時〜10時 (風向・風速・角度差)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; font-size: 10px;">
      `;
      
      detailedHourly.morning_4_10?.forEach(hour => {
        const windDir = hour.wind_direction?.toFixed(0) || '--';
        const windSpeed = hour.wind_speed?.toFixed(1) || '--';
        const angleDiff = hour.wind_theta_diff?.toFixed(0) || '--';
        html += `
          <div style="text-align: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 3px;">${hour.hour}時</div>
            <div style="color: #2e7d32;">風向: ${windDir}°</div>
            <div style="color: #1976d2;">風速: ${windSpeed}m/s</div>
            <div style="color: #f57c00;">角度差: ${angleDiff}°</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // 午前10時〜午後4時（日射・雲量・気象指標）
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #fff3e0; padding: 10px; font-weight: bold; color: #e65100;">
            ☀️ 午前10時〜午後4時 (日射・雲量・気象指標)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 9px;">
      `;
      
      detailedHourly.afternoon_10_16?.forEach(hour => {
        const solar = hour.solar_radiation?.toFixed(0) || '--';
        const cloud = hour.cloud_cover?.toFixed(0) || '--';
        const verticalV = hour.vertical_velocity?.toFixed(2) || '--';
        const ssi = hour.ssi?.toFixed(1) || '--';
        const equivTemp = hour.equivalent_potential_temp?.toFixed(0) || '--';
        
        html += `
          <div style="text-align: center; padding: 6px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 2px;">${hour.hour}時</div>
            <div style="color: #ff9800; line-height: 1.2;">日射: ${solar}W/m²</div>
            <div style="color: #607d8b; line-height: 1.2;">雲量: ${cloud}%</div>
            <div style="color: #9c27b0; line-height: 1.2;">鉛直: ${verticalV}m/s</div>
            <div style="color: #4caf50; line-height: 1.2;">SSI: ${ssi}</div>
            <div style="color: #795548; line-height: 1.2;">相当温位: ${equivTemp}K</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // 総合判定
      html += `
        <div style="background: white; border-radius: 8px; overflow: hidden;">
          <div style="background: #f3e5f5; padding: 10px; font-weight: bold; color: #7b1fa2;">
            🎯 学習データに基づく総合判定
          </div>
          <div style="padding: 15px; text-align: center;">
            <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
              上記の気象条件と過去の学習データを総合的に分析した結果:
            </div>
            <div style="padding: 10px; background: #e8f5e8; border-radius: 6px; font-weight: bold; color: #2e7d32;">
              干せるかどうかの判定は上記「経験ルール予測」をご参照ください
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 8px;">
              ※ 風向・風速は朝の作業時間帯、日射・雲量は乾燥時間帯を重視
            </div>
          </div>
        </div>
      `;

      html += `</div>`;
      
      return html;
    }

    // 地形情報と地形補正効果表示を生成
    function generateTerrainInfoDisplay(terrainInfo, terrainCorrections) {
      let html = `
        <div style="background: #fff8e1; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ff9800;">
          <h3 style="color: #e65100; margin-bottom: 15px; text-align: center;">🏔️ 地形条件と気象補正効果</h3>
      `;

      // 地形情報表示
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #ffcc02; padding: 10px; font-weight: bold; color: #bf360c;">
            📍 この地点の地形特性
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">標高</div>
                <div style="color: #d32f2f; font-size: 16px; font-weight: bold;">${terrainInfo.elevation?.toFixed(1) || '--'}m</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">土地利用</div>
                <div style="color: #2e7d32; font-size: 14px; font-weight: bold;">${terrainInfo.land_use || '--'}</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">海岸距離</div>
                <div style="color: #1976d2;">${terrainInfo.distance_to_coast?.toFixed(1) || '--'}km</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">傾斜角度</div>
                <div style="color: #f57c00;">${terrainInfo.slope?.toFixed(1) || '--'}°</div>
              </div>
            </div>
          </div>
        </div>
      `;

      // 地形補正効果表示
      if (terrainCorrections) {
        const forestEffect = terrainCorrections.forest_effect;
        const coastalEffect = terrainCorrections.coastal_effect;
        
        html += `
          <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
            <div style="background: #e8f5e8; padding: 10px; font-weight: bold; color: #2e7d32;">
              🔧 地形による気象補正（予報に自動適用済み）
            </div>
            <div style="padding: 15px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px;">
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">気温補正</div>
                  <div style="color: ${terrainCorrections.temperature_correction >= 0 ? '#d32f2f' : '#1976d2'};">
                    ${terrainCorrections.temperature_correction >= 0 ? '+' : ''}${terrainCorrections.temperature_correction?.toFixed(2) || '0.0'}°C
                  </div>
                  <div style="font-size: 10px; color: #666;">標高による気温低下</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">湿度補正</div>
                  <div style="color: ${terrainCorrections.humidity_correction >= 0 ? '#f57c00' : '#2e7d32'};">
                    ${terrainCorrections.humidity_correction >= 0 ? '+' : ''}${terrainCorrections.humidity_correction?.toFixed(1) || '0.0'}%
                  </div>
                  <div style="font-size: 10px; color: #666;">${forestEffect ? '森林効果含む' : '標高効果のみ'}</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">風速補正</div>
                  <div style="color: ${terrainCorrections.wind_correction >= 0 ? '#2e7d32' : '#d32f2f'};">
                    ${terrainCorrections.wind_correction >= 0 ? '+' : ''}${terrainCorrections.wind_correction?.toFixed(1) || '0.0'}m/s
                  </div>
                  <div style="font-size: 10px; color: #666;">${forestEffect ? '森林による減風' : '地形効果'}</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">日射量補正</div>
                  <div style="color: #2e7d32;">
                    ${terrainCorrections.solar_reduction > 0 ? '-' : ''}${(terrainCorrections.solar_reduction * 100)?.toFixed(0) || '0'}%
                  </div>
                  <div style="font-size: 10px; color: #666;">干場は日射遮蔽なし</div>
                </div>
              </div>
        `;

        // 特別な警告表示
        if (forestEffect) {
          html += `
              <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 6px; padding: 12px; margin-top: 15px;">
                <div style="font-weight: bold; color: #d32f2f; margin-bottom: 8px;">⚠️ 森林地帯による重要な影響</div>
                <div style="font-size: 12px; color: #333; line-height: 1.4;">
                  • <strong>風速大幅減少</strong>：周囲の森林による風の遮蔽で昆布乾燥に必要な風通しが悪化<br>
                  • <strong>湿度上昇</strong>：森林地帯の湿潤な空気により乾燥効率が低下<br>
                  • <strong>日射量</strong>：干場自体は整地された砂利の場なので日射遮蔽はなし
                </div>
                <div style="font-size: 11px; color: #d32f2f; margin-top: 8px; font-weight: bold;">
                  → この地点では乾燥条件が悪化する可能性があります
                </div>
              </div>
          `;
        }

        if (coastalEffect) {
          html += `
              <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-top: 10px;">
                <div style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">🌊 海岸効果</div>
                <div style="font-size: 12px; color: #333;">
                  海風による湿度上昇と風速増加の影響があります
                </div>
              </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      }

      html += `</div>`;
      
      return html;
    }

    // 記録入力
    recordButton.addEventListener('click', () => {
      if (!selectedSpot) return;
      
      recordPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      recordStatus.innerHTML = '';
    });

    // 自動学習パネル
    const adaptiveLearningButton = document.getElementById('adaptiveLearningButton');
    adaptiveLearningButton.addEventListener('click', () => {
      const adaptiveLearningPanel = document.getElementById('adaptiveLearningPanel');
      adaptiveLearningPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('adaptiveStatus').innerHTML = '';
    });

    // 漁期管理パネル
    const seasonButton = document.getElementById('seasonButton');
    seasonButton.addEventListener('click', () => {
      const seasonPanel = document.getElementById('seasonPanel');
      seasonPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      loadSeasonStatus();
    });

    // 通知設定パネル
    const notificationButton = document.getElementById('notificationButton');
    notificationButton.addEventListener('click', () => {
      const notificationPanel = document.getElementById('notificationPanel');
      notificationPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadNotificationStatus();
    });

    // 海霧予測パネル
    const seaFogButton = document.getElementById('seaFogButton');
    seaFogButton.addEventListener('click', () => {
      const seaFogPanel = document.getElementById('seaFogPanel');
      seaFogPanel.style.display = 'block';
      
      // 海霧データの自動読み込み
      if (selectedSpot) {
        loadSeaFogStatus();
      }
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadSeaFogStatus();
    });

    // システム監視パネル
    const systemMonitorButton = document.getElementById('systemMonitorButton');
    systemMonitorButton.addEventListener('click', () => {
      const systemMonitorPanel = document.getElementById('systemMonitorPanel');
      systemMonitorPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadSystemMonitorStatus();
    });

    // お気に入りパネル
    const favoritesButton = document.getElementById('favoritesButton');
    favoritesButton.addEventListener('click', () => {
      const favoritesPanel = document.getElementById('favoritesPanel');
      favoritesPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadFavoritesStatus();
    });
    
    // バックアップパネル
    const backupButton = document.getElementById('backupButton');
    backupButton.addEventListener('click', () => {
      const backupPanel = document.getElementById('backupPanel');
      backupPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadBackupStatus();
    });

    // ヘルプパネル
    const helpButton = document.getElementById('helpButton');
    helpButton.addEventListener('click', () => {
      const helpPanel = document.getElementById('helpPanel');
      helpPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      loadHelpContent();
    });

    // 記録保存
    document.querySelectorAll('#recordPanel .btn[data-result]').forEach(button => {
      button.addEventListener('click', () => {
        if (!selectedSpot) return;
        
        const result = button.dataset.result;
        const date = recordDate.value;
        
        if (!date) {
          alert('日付を選択してください');
          return;
        }
        
        const recordData = {
          name: selectedSpot.name,
          date: date,
          result: result
        };
        
        fetch(`${API_BASE}/record`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(recordData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            recordStatus.innerHTML = '<div style="color: green;">✓ 記録が保存されました</div>';
          } else {
            recordStatus.innerHTML = '<div style="color: red;">✗ 記録の保存に失敗しました</div>';
          }
        })
        .catch(err => {
          console.error('記録保存エラー:', err);
          recordStatus.innerHTML = '<div style="color: red;">✗ 記録の保存に失敗しました</div>';
        });
      });
    });

    // 自動学習システム
    document.getElementById('processLearningButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">🔄 学習処理中...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/process`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            adaptiveStatus.innerHTML = `
              <div style="color: green;">✓ 学習処理完了</div>
              <div>新データ追加: ${data.new_data_added ? 'あり' : 'なし'}</div>
              ${data.model_retrained ? '<div>モデル再訓練: 完了</div>' : ''}
            `;
          } else {
            adaptiveStatus.innerHTML = `<div style="color: red;">✗ エラー: ${data.message}</div>`;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">✗ 通信エラー</div>';
        });
    });

    document.getElementById('qualityReportButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">📊 品質レポート取得中...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/quality`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            adaptiveStatus.innerHTML = `<div style="color: red;">✗ ${data.error}</div>`;
          } else {
            let html = '<div style="color: green;">📊 データ品質レポート</div>';
            html += `<div>総記録数: ${data.total_records}</div>`;
            if (data.quality_distribution) {
              html += '<div>品質分布:</div>';
              Object.entries(data.quality_distribution).forEach(([key, value]) => {
                html += `<div style="margin-left: 10px;">${key}: ${value}</div>`;
              });
            }
            if (data.result_statistics) {
              html += '<div>結果統計:</div>';
              Object.entries(data.result_statistics).forEach(([result, stats]) => {
                html += `<div style="margin-left: 10px;">${result}: ${stats.count}件 (品質: ${stats.avg_quality.toFixed(1)})</div>`;
              });
            }
            adaptiveStatus.innerHTML = html;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">✗ 通信エラー</div>';
        });
    });

    document.getElementById('retrainModelButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">🧠 モデル再訓練中...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/retrain`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            adaptiveStatus.innerHTML = `
              <div style="color: green;">✓ モデル再訓練完了</div>
              <div>特徴量: ${data.features ? data.features.join(', ') : '不明'}</div>
              <div>訓練サイズ: ${data.training_size}</div>
            `;
          } else {
            adaptiveStatus.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">✗ 通信エラー</div>';
        });
    });

    // キャンセルボタン
    cancelSpot.addEventListener('click', cancelAddMode);
    
    // 更新ボタン
    refreshButton.addEventListener('click', loadSpots);

    // ナビゲーション機能
    const townSelect = document.getElementById('townSelect');
    const districtSelect = document.getElementById('districtSelect');
    const areaSelect = document.getElementById('areaSelect');
    const districtStep = document.getElementById('districtStep');
    const areaStep = document.getElementById('areaStep');
    const resetNavButton = document.getElementById('resetNavButton');
    const currentLocation = document.getElementById('currentLocation');
    const currentLocationText = document.getElementById('currentLocationText');

    // 町選択
    townSelect.addEventListener('change', (e) => {
      const townId = e.target.value;
      
      if (!townId) {
        districtStep.style.display = 'none';
        areaStep.style.display = 'none';
        resetNavButton.style.display = 'none';
        return;
      }

      const town = rishiriGeography[townId];
      
      // 地図を町にズーム
      map.setView(town.center, town.zoom);
      
      // 町の境界を表示
      clearTownBoundaries();
      showTownBoundary(townId, town);
      
      // 地区選択肢を更新
      districtSelect.innerHTML = '<option value="">-- 地区を選択 --</option>';
      Object.entries(town.districts).forEach(([districtId, district]) => {
        const option = document.createElement('option');
        option.value = districtId;
        option.textContent = district.name;
        districtSelect.appendChild(option);
      });
      
      districtStep.style.display = 'block';
      areaStep.style.display = 'none';
      resetNavButton.style.display = 'inline-block';
      
      // 現在地表示を更新
      currentLocationText.textContent = town.name;
      currentLocation.style.display = 'block';
    });

    // 地区選択
    districtSelect.addEventListener('change', (e) => {
      const districtId = e.target.value;
      const townId = townSelect.value;
      
      if (!districtId || !townId) {
        areaStep.style.display = 'none';
        return;
      }

      const district = rishiriGeography[townId].districts[districtId];
      
      // 地図を地区にズーム
      map.setView(district.center, district.zoom);
      
      // 地域選択肢を更新
      areaSelect.innerHTML = '<option value="">-- 地域を選択 --</option>';
      Object.entries(district.areas).forEach(([areaId, area]) => {
        const option = document.createElement('option');
        option.value = areaId;
        option.textContent = area.name;
        areaSelect.appendChild(option);
      });
      
      areaStep.style.display = 'block';
      
      // 現在地表示を更新
      const townName = rishiriGeography[townId].name;
      currentLocationText.textContent = `${townName} > ${district.name}`;
      currentLocation.style.display = 'block';
    });

    // 地域選択
    areaSelect.addEventListener('change', (e) => {
      const areaId = e.target.value;
      const districtId = districtSelect.value;
      const townId = townSelect.value;
      
      if (!areaId || !districtId || !townId) return;

      const area = rishiriGeography[townId].districts[districtId].areas[areaId];
      
      // 地図を地域にズーム
      map.setView(area.center, area.zoom);
      
      // 現在地表示を更新
      const townName = rishiriGeography[townId].name;
      const districtName = rishiriGeography[townId].districts[districtId].name;
      currentLocationText.textContent = `${townName} > ${districtName} > ${area.name}`;
      currentLocation.style.display = 'block';
    });

    // 境界表示機能
    function showTownBoundary(townId, town) {
      const boundaries = {
        'rishiri-town': [
          [45.120, 141.180], [45.178, 141.180], [45.178, 141.225], 
          [45.165, 141.240], [45.145, 141.235], [45.130, 141.220], [45.120, 141.200]
        ],
        'rishiri-fuji-town': [
          [45.178, 141.225], [45.260, 141.225], [45.260, 141.280], 
          [45.200, 141.280], [45.165, 141.240], [45.178, 141.225]
        ]
      };

      if (boundaries[townId]) {
        const polygon = L.polygon(boundaries[townId], {
          color: townId === 'rishiri-town' ? '#28a745' : '#007bff',
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.1
        }).addTo(map);
        
        polygon.bindPopup(`📍 ${town.name}エリア`);
        townBoundaries[townId] = polygon;
      }
    }

    function clearTownBoundaries() {
      Object.values(townBoundaries).forEach(boundary => {
        if (boundary) map.removeLayer(boundary);
      });
      townBoundaries = {};
    }

    // 全島表示リセット
    resetNavButton.addEventListener('click', () => {
      map.setView([45.178269, 141.228528], 11);
      
      townSelect.value = '';
      districtSelect.value = '';
      areaSelect.value = '';
      
      districtStep.style.display = 'none';
      areaStep.style.display = 'none';
      resetNavButton.style.display = 'none';
      currentLocation.style.display = 'none';
      
      clearTownBoundaries();
    });

    // 漁期管理機能
    function loadSeasonStatus() {
      const seasonStatus = document.getElementById('seasonStatus');
      const seasonDetails = document.getElementById('seasonDetails');
      
      seasonStatus.innerHTML = '<div style="color: blue;">📅 漁期情報を読み込み中...</div>';
      
      fetch(`${API_BASE}/fishing_season/status`)
        .then(res => res.json())
        .then(data => {
          seasonStatus.className = `season-status ${data.status}`;
          
          let html = `<strong>${data.message}</strong><br>`;
          
          if (data.status === 'in_season') {
            html += `進捗: ${data.progress}% (残り${data.days_remaining}日)`;
          } else if (data.status === 'pre_season') {
            html += `開始まで: ${data.days_until_start}日`;
          } else if (data.status === 'post_season') {
            html += `次期開始まで: ${data.days_until_next}日`;
          }
          
          seasonStatus.innerHTML = html;
          seasonDetails.innerHTML = '';
        })
        .catch(err => {
          seasonStatus.innerHTML = '<div style="color: red;">✗ 漁期情報の取得に失敗しました</div>';
        });
    }

    // 週間スケジュール表示
    document.getElementById('weeklyScheduleButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">📋 週間スケジュールを読み込み中...</div>';
      
      fetch(`${API_BASE}/fishing_season/schedule?type=weekly`)
        .then(res => res.json())
        .then(data => {
          let html = '<div><strong>📋 今週のスケジュール</strong></div>';
          
          data.forEach(day => {
            const workStatus = day.work_permitted ? '作業可能' : '作業不可';
            const cssClass = day.work_permitted ? 'work-day' : 'rest-day';
            const icon = day.work_permitted ? '✓' : '×';
            
            html += `
              <div class="schedule-item ${cssClass}">
                <strong>${day.date} (${day.day_of_week.substring(0,3)})</strong>
                <span style="float: right;">${icon} ${workStatus}</span>
                <br>
                <small>${day.note || '4:00-16:00 昆布干し作業'}</small>
              </div>
            `;
          });
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">✗ スケジュールの取得に失敗しました</div>';
        });
    });

    // 休漁日管理
    document.getElementById('restDaysButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">🚫 休漁日情報を読み込み中...</div>';
      
      fetch(`${API_BASE}/fishing_season/rest_days`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>🚫 休漁日管理</strong></div>
            <div style="margin: 10px 0;">
              <input type="date" id="newRestDate" style="padding: 5px; margin-right: 10px;">
              <button onclick="addRestDay()" class="btn" style="padding: 5px 10px;">休漁日追加</button>
            </div>
            <div><strong>現在の休漁日 (${data.count}日):</strong></div>
          `;
          
          if (data.rest_days.length === 0) {
            html += '<div style="color: #666; font-style: italic;">休漁日は設定されていません</div>';
          } else {
            data.rest_days.forEach(restDay => {
              html += `
                <div class="schedule-item rest-day">
                  <span>${restDay}</span>
                  <button onclick="removeRestDay('${restDay}')" style="float: right; background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">削除</button>
                </div>
              `;
            });
          }
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">✗ 休漁日情報の取得に失敗しました</div>';
        });
    });

    // 漁期設定
    document.getElementById('seasonConfigButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">⚙️ 漁期設定を読み込み中...</div>';
      
      fetch(`${API_BASE}/fishing_season/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>⚙️ 漁期設定</strong></div>
            <div class="schedule-item">
              <strong>漁期期間:</strong> ${data.season_period}<br>
              <strong>作業時間:</strong> ${data.work_hours}<br>
              <strong>休漁日数:</strong> ${data.rest_days_count}日<br>
              <strong>通知設定:</strong> ${data.notifications_enabled.daily_forecast_time ? '有効' : '無効'}
            </div>
          `;
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">✗ 設定情報の取得に失敗しました</div>';
        });
    });

    // 休漁日追加関数
    function addRestDay() {
      const dateInput = document.getElementById('newRestDate');
      const date = dateInput.value;
      
      if (!date) {
        alert('日付を選択してください');
        return;
      }
      
      fetch(`${API_BASE}/fishing_season/rest_days`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: date })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('休漁日を追加しました');
          document.getElementById('restDaysButton').click(); // 再読み込み
          dateInput.value = '';
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('休漁日の追加に失敗しました');
      });
    }

    // 休漁日削除関数
    function removeRestDay(dateStr) {
      if (!confirm(`${dateStr}の休漁日を削除しますか？`)) return;
      
      fetch(`${API_BASE}/fishing_season/rest_days`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: `2024-${dateStr}` })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('休漁日を削除しました');
          document.getElementById('restDaysButton').click(); // 再読み込み
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('休漁日の削除に失敗しました');
      });
    }

    // 通知システム機能
    function loadNotificationStatus() {
      const notificationStatus = document.getElementById('notificationStatus');
      const notificationDetails = document.getElementById('notificationDetails');
      
      notificationStatus.innerHTML = '<div style="color: blue;">🔔 通知システム状況を読み込み中...</div>';
      
      fetch(`${API_BASE}/notifications/scheduler`)
        .then(res => res.json())
        .then(data => {
          const status = data.running ? '🟢 稼働中' : '🔴 停止中';
          const config = data.config;
          
          let html = `
            <div><strong>システム状況:</strong> ${status}</div>
            <div><strong>通知対象者:</strong> ${config.subscriber_count}名</div>
            <div><strong>通知時刻:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>翌日予報: ${config.notification_times.daily_forecast}</li>
              <li>朝の警報: ${config.notification_times.morning_alert}</li>
              <li>夕方まとめ: ${config.notification_times.evening_summary}</li>
            </ul>
          `;
          
          notificationStatus.innerHTML = html;
          notificationDetails.innerHTML = '';
        })
        .catch(err => {
          notificationStatus.innerHTML = '<div style="color: red;">✗ 通知システム状況の取得に失敗しました</div>';
        });
    }

    document.getElementById('notificationConfigButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">⚙️ 通知設定を読み込み中...</div>';
      
      fetch(`${API_BASE}/notifications/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>⚙️ 通知時刻設定</strong></div>
            <div style="margin: 10px 0;">
              <div>翌日予報通知: 
                <input type="time" id="dailyForecastTime" value="${data.notification_times.daily_forecast}">
                <button onclick="updateNotificationTime('daily_forecast', document.getElementById('dailyForecastTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">更新</button>
              </div>
              <div style="margin-top: 5px;">朝の警報通知: 
                <input type="time" id="morningAlertTime" value="${data.notification_times.morning_alert}">
                <button onclick="updateNotificationTime('morning_alert', document.getElementById('morningAlertTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">更新</button>
              </div>
              <div style="margin-top: 5px;">夕方まとめ通知: 
                <input type="time" id="eveningSummaryTime" value="${data.notification_times.evening_summary}">
                <button onclick="updateNotificationTime('evening_summary', document.getElementById('eveningSummaryTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">更新</button>
              </div>
            </div>
            <div style="margin-top: 15px;"><strong>📊 配信方法:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>コンソール出力: ${data.delivery_methods.console ? '✓' : '✗'}</li>
              <li>ファイル出力: ${data.delivery_methods.file ? '✓' : '✗'}</li>
              <li>メール送信: ${data.delivery_methods.email ? '✓' : '✗'}</li>
              <li>Webhook送信: ${data.delivery_methods.webhook ? '✓' : '✗'}</li>
            </ul>
          `;
          
          notificationDetails.innerHTML = html;
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">✗ 設定情報の取得に失敗しました</div>';
        });
    });

    document.getElementById('subscribersButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">👥 通知対象者を読み込み中...</div>';
      
      fetch(`${API_BASE}/notifications/subscribers`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>👥 通知対象者管理</strong></div>
            <div style="margin: 10px 0;">
              <input type="text" id="newSubscriberName" placeholder="名前" style="padding: 5px; margin-right: 5px;">
              <input type="email" id="newSubscriberEmail" placeholder="メールアドレス（任意）" style="padding: 5px; margin-right: 5px;">
              <button onclick="addSubscriber()" class="btn" style="padding: 5px 10px;">追加</button>
            </div>
            <div><strong>現在の通知対象者 (${data.subscribers.length}名):</strong></div>
          `;
          
          if (data.subscribers.length === 0) {
            html += '<div style="color: gray; font-style: italic;">まだ通知対象者が登録されていません</div>';
          } else {
            html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            data.subscribers.forEach(subscriber => {
              const activeStatus = subscriber.active ? '🟢' : '🔴';
              html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee;">
                  <span>${activeStatus} ${subscriber.name} ${subscriber.email ? `(${subscriber.email})` : ''}</span>
                  <button onclick="removeSubscriber(${subscriber.id})" class="btn btn-danger" style="padding: 2px 6px; font-size: 11px;">削除</button>
                </div>
              `;
            });
            html += '</div>';
          }
          
          notificationDetails.innerHTML = html;
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">✗ 通知対象者の取得に失敗しました</div>';
        });
    });

    document.getElementById('testNotificationButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">🧪 テスト通知を送信中...</div>';
      
      fetch(`${API_BASE}/notifications/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          notificationDetails.innerHTML = '<div style="color: green;">✓ テスト通知を送信しました</div>';
        } else {
          notificationDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
        }
      })
      .catch(err => {
        notificationDetails.innerHTML = '<div style="color: red;">✗ テスト通知の送信に失敗しました</div>';
      });
    });

    document.getElementById('schedulerButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      
      fetch(`${API_BASE}/notifications/scheduler`)
        .then(res => res.json())
        .then(data => {
          const isRunning = data.running;
          const action = isRunning ? 'DELETE' : 'POST';
          const actionText = isRunning ? '停止' : '開始';
          
          if (confirm(`通知スケジューラーを${actionText}しますか？`)) {
            notificationDetails.innerHTML = `<div style="color: blue;">🎯 スケジューラーを${actionText}中...</div>`;
            
            fetch(`${API_BASE}/notifications/scheduler`, { method: action })
              .then(res => res.json())
              .then(result => {
                if (result.status === 'success') {
                  notificationDetails.innerHTML = `<div style="color: green;">✓ ${result.message}</div>`;
                  loadNotificationStatus(); // 状態更新
                } else {
                  notificationDetails.innerHTML = `<div style="color: red;">✗ ${result.message}</div>`;
                }
              })
              .catch(err => {
                notificationDetails.innerHTML = `<div style="color: red;">✗ スケジューラー${actionText}に失敗しました</div>`;
              });
          }
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">✗ スケジューラー状態の取得に失敗しました</div>';
        });
    });

    // 通知時刻更新関数
    function updateNotificationTime(notificationType, newTime) {
      if (!newTime) {
        alert('時刻を選択してください');
        return;
      }
      
      fetch(`${API_BASE}/notifications/config`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          notification_type: notificationType, 
          new_time: newTime 
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          loadNotificationStatus(); // 状態更新
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('通知時刻の更新に失敗しました');
      });
    }

    // 通知対象者追加関数
    function addSubscriber() {
      const nameInput = document.getElementById('newSubscriberName');
      const emailInput = document.getElementById('newSubscriberEmail');
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      
      if (!name) {
        alert('名前を入力してください');
        return;
      }
      
      fetch(`${API_BASE}/notifications/subscribers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email: email || null })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          nameInput.value = '';
          emailInput.value = '';
          document.getElementById('subscribersButton').click(); // リロード
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('通知対象者の追加に失敗しました');
      });
    }

    // 通知対象者削除関数
    function removeSubscriber(subscriberId) {
      if (!confirm('この通知対象者を削除しますか？')) return;
      
      fetch(`${API_BASE}/notifications/subscribers`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriber_id: subscriberId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('subscribersButton').click(); // リロード
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('通知対象者の削除に失敗しました');
      });
    }

    // システム監視機能
    function loadSystemMonitorStatus() {
      const systemMonitorStatus = document.getElementById('systemMonitorStatus');
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      
      systemMonitorStatus.innerHTML = '<div style="color: blue;">🔍 システム監視状況を読み込み中...</div>';
      
      fetch(`${API_BASE}/system/monitor`)
        .then(res => res.json())
        .then(data => {
          const monitor = data.monitor_status;
          const health = data.latest_health;
          
          const statusIcon = monitor.running ? '🟢' : '🔴';
          const statusText = monitor.running ? '稼働中' : '停止中';
          
          let healthIcon = '❓';
          let healthColor = 'gray';
          if (health.overall_status === 'healthy') {
            healthIcon = '💚';
            healthColor = 'green';
          } else if (health.overall_status === 'warning') {
            healthIcon = '⚠️';
            healthColor = 'orange';
          } else if (health.overall_status === 'error') {
            healthIcon = '🔴';
            healthColor = 'red';
          }
          
          let html = `
            <div><strong>監視状況:</strong> ${statusIcon} ${statusText}</div>
            <div><strong>システムヘルス:</strong> <span style="color: ${healthColor};">${healthIcon} ${health.overall_status}</span></div>
            <div><strong>最終チェック:</strong> ${monitor.last_check ? new Date(monitor.last_check).toLocaleString() : 'なし'}</div>
            <div><strong>監視間隔:</strong> ${monitor.config.interval}秒</div>
          `;
          
          if (health.issues && health.issues.length > 0) {
            html += `<div style="margin-top: 5px;"><strong>⚠️ 問題:</strong></div>`;
            html += `<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px;">`;
            health.issues.forEach(issue => {
              html += `<li style="color: red;">${issue}</li>`;
            });
            html += `</ul>`;
          }
          
          systemMonitorStatus.innerHTML = html;
          systemMonitorDetails.innerHTML = '';
          
          // ボタンテキストを更新
          const toggleButton = document.getElementById('monitorToggleButton');
          if (monitor.running) {
            toggleButton.textContent = '⏸️ 監視停止';
            toggleButton.className = 'btn btn-danger';
          } else {
            toggleButton.textContent = '▶️ 監視開始';
            toggleButton.className = 'btn btn-secondary';
          }
        })
        .catch(err => {
          systemMonitorStatus.innerHTML = '<div style="color: red;">✗ システム監視状況の取得に失敗しました</div>';
        });
    }

    document.getElementById('healthCheckButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">💚 ヘルスチェック実行中...</div>';
      
      fetch(`${API_BASE}/system/health`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>💚 システムヘルスチェック結果</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>総合ステータス:</strong> <span style="color: ${data.overall_status === 'healthy' ? 'green' : data.overall_status === 'warning' ? 'orange' : 'red'};">${data.overall_status}</span></div>
              <div><strong>チェック時刻:</strong> ${new Date(data.timestamp).toLocaleString()}</div>
            </div>
          `;
          
          // メトリクス表示
          if (data.metrics) {
            html += `<div><strong>📊 システムメトリクス:</strong></div>`;
            html += `<ul style="margin: 5px 0; padding-left: 15px; font-size: 11px;">`;
            html += `<li>CPU使用率: ${data.metrics.cpu_usage?.toFixed(1)}%</li>`;
            html += `<li>メモリ使用率: ${data.metrics.memory_usage?.toFixed(1)}% (空き: ${data.metrics.memory_available_gb?.toFixed(1)}GB)</li>`;
            html += `<li>ディスク使用率: ${data.metrics.disk_usage?.toFixed(1)}% (空き: ${data.metrics.disk_free_gb?.toFixed(1)}GB)</li>`;
            if (data.metrics.process_memory_mb) {
              html += `<li>アプリメモリ: ${data.metrics.process_memory_mb?.toFixed(1)}MB</li>`;
            }
            html += `</ul>`;
          }
          
          // エンドポイント状況
          if (data.endpoints) {
            html += `<div style="margin-top: 10px;"><strong>🌐 エンドポイント状況:</strong></div>`;
            data.endpoints.forEach(endpoint => {
              const statusIcon = endpoint.status === 'healthy' ? '✅' : endpoint.status === 'slow' ? '⚠️' : '❌';
              const responseTime = endpoint.response_time ? ` (${(endpoint.response_time * 1000).toFixed(0)}ms)` : '';
              html += `<div style="font-size: 11px;">${statusIcon} ${endpoint.endpoint.replace('http://localhost:8000', '')}${responseTime}</div>`;
            });
          }
          
          // ファイル状況
          if (data.files) {
            html += `<div style="margin-top: 10px;"><strong>📁 重要ファイル状況:</strong></div>`;
            data.files.forEach(file => {
              const statusIcon = file.status === 'ok' ? '✅' : '❌';
              const sizeInfo = file.size_mb ? ` (${file.size_mb.toFixed(1)}MB)` : '';
              html += `<div style="font-size: 11px;">${statusIcon} ${file.file}${sizeInfo}</div>`;
            });
          }
          
          // 問題がある場合
          if (data.issues && data.issues.length > 0) {
            html += `<div style="margin-top: 10px;"><strong>⚠️ 検出された問題:</strong></div>`;
            html += `<ul style="margin: 5px 0; padding-left: 15px; font-size: 11px;">`;
            data.issues.forEach(issue => {
              html += `<li style="color: red;">${issue}</li>`;
            });
            html += `</ul>`;
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">✗ ヘルスチェックに失敗しました</div>';
        });
    });

    document.getElementById('healthHistoryButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">📈 ヘルス履歴を読み込み中...</div>';
      
      fetch(`${API_BASE}/system/health/history?hours=24`)
        .then(res => res.json())
        .then(data => {
          let html = `<div><strong>📈 24時間ヘルス履歴 (${data.history.length}件)</strong></div>`;
          
          if (data.history.length === 0) {
            html += '<div style="color: gray; font-style: italic;">履歴データがありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            // 最新の10件を表示
            const recentHistory = data.history.slice(-10).reverse();
            recentHistory.forEach(record => {
              const time = new Date(record.timestamp).toLocaleString();
              const statusColor = record.overall_status === 'healthy' ? 'green' : record.overall_status === 'warning' ? 'orange' : 'red';
              const statusIcon = record.overall_status === 'healthy' ? '💚' : record.overall_status === 'warning' ? '⚠️' : '🔴';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div><strong>${time}</strong> <span style="color: ${statusColor};">${statusIcon} ${record.overall_status}</span></div>
              `;
              
              if (record.metrics) {
                html += `<div style="margin-left: 10px; color: #666;">CPU: ${record.metrics.cpu_usage?.toFixed(1)}%, メモリ: ${record.metrics.memory_usage?.toFixed(1)}%, ディスク: ${record.metrics.disk_usage?.toFixed(1)}%</div>`;
              }
              
              if (record.issues && record.issues.length > 0) {
                html += `<div style="margin-left: 10px; color: red;">問題: ${record.issues.length}件</div>`;
              }
              
              html += `</div>`;
            });
            
            html += '</div>';
            
            if (data.history.length > 10) {
              html += `<div style="font-size: 11px; color: #666; margin-top: 5px;">最新10件を表示中 (全${data.history.length}件)</div>`;
            }
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">✗ ヘルス履歴の取得に失敗しました</div>';
        });
    });

    document.getElementById('alertHistoryButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">🚨 アラート履歴を読み込み中...</div>';
      
      fetch(`${API_BASE}/system/alerts?hours=24`)
        .then(res => res.json())
        .then(data => {
          let html = `<div><strong>🚨 24時間アラート履歴 (${data.alerts.length}件)</strong></div>`;
          
          if (data.alerts.length === 0) {
            html += '<div style="color: green; font-style: italic;">アラートはありません 👍</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            data.alerts.reverse().forEach(alert => {
              const time = new Date(alert.timestamp).toLocaleString();
              const severityColor = alert.severity === 'critical' ? 'red' : alert.severity === 'warning' ? 'orange' : 'blue';
              const severityIcon = alert.severity === 'critical' ? '🔴' : alert.severity === 'warning' ? '⚠️' : 'ℹ️';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div><strong>${time}</strong> <span style="color: ${severityColor};">${severityIcon} ${alert.severity}</span></div>
                  <div style="margin-left: 10px;">${alert.message}</div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">✗ アラート履歴の取得に失敗しました</div>';
        });
    });

    document.getElementById('monitorConfigButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">⚙️ 監視設定を読み込み中...</div>';
      
      fetch(`${API_BASE}/system/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>⚙️ 監視設定</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>監視間隔:</strong> ${data.monitoring_interval}秒</div>
              <div><strong>監視エンドポイント数:</strong> ${data.endpoints_to_monitor.length}個</div>
              <div><strong>監視ファイル数:</strong> ${data.files_to_monitor.length}個</div>
            </div>
            <div><strong>📊 警告しきい値:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>CPU使用率: ${data.alert_thresholds.cpu_usage_max}%以上</li>
              <li>メモリ使用率: ${data.alert_thresholds.memory_usage_max}%以上</li>
              <li>ディスク使用率: ${data.alert_thresholds.disk_usage_max}%以上</li>
              <li>レスポンス時間: ${data.alert_thresholds.response_time_max}秒以上</li>
              <li>エラー回数: ${data.alert_thresholds.error_count_max}回/時間以上</li>
            </ul>
            <div style="margin-top: 10px;"><strong>🔔 アラート方法:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>コンソール出力: ${data.alert_methods.console ? '✓' : '✗'}</li>
              <li>ファイル出力: ${data.alert_methods.file ? '✓' : '✗'}</li>
              <li>メール送信: ${data.alert_methods.email ? '✓' : '✗'}</li>
              <li>Webhook送信: ${data.alert_methods.webhook ? '✓' : '✗'}</li>
            </ul>
          `;
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">✗ 監視設定の取得に失敗しました</div>';
        });
    });

    document.getElementById('monitorToggleButton').addEventListener('click', () => {
      const button = document.getElementById('monitorToggleButton');
      const isStarting = button.textContent.includes('開始');
      const method = isStarting ? 'POST' : 'DELETE';
      const action = isStarting ? '開始' : '停止';
      
      if (confirm(`システム監視を${action}しますか？`)) {
        const systemMonitorDetails = document.getElementById('systemMonitorDetails');
        systemMonitorDetails.innerHTML = `<div style="color: blue;">🔍 監視を${action}中...</div>`;
        
        fetch(`${API_BASE}/system/monitor`, { method: method })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              systemMonitorDetails.innerHTML = `<div style="color: green;">✓ ${data.message}</div>`;
              loadSystemMonitorStatus(); // 状態更新
            } else {
              systemMonitorDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
            }
          })
          .catch(err => {
            systemMonitorDetails.innerHTML = `<div style="color: red;">✗ 監視${action}に失敗しました</div>`;
          });
      }
    });

    // バックアップシステム機能
    function loadBackupStatus() {
      const backupStatus = document.getElementById('backupStatus');
      const backupDetails = document.getElementById('backupDetails');
      
      backupStatus.innerHTML = '<div style="color: blue;">💾 バックアップ状況を読み込み中...</div>';
      
      fetch(`${API_BASE}/backup`)
        .then(res => res.json())
        .then(data => {
          const status = data.status;
          
          const autoStatus = status.auto_backup_running ? '🟢 稼働中' : '🔴 停止中';
          const lastBackup = status.last_backup ? new Date(status.last_backup).toLocaleString() : 'なし';
          
          let html = `
            <div><strong>自動バックアップ:</strong> ${autoStatus}</div>
            <div><strong>バックアップ数:</strong> ${status.backup_count}個</div>
            <div><strong>総サイズ:</strong> ${status.total_size_mb.toFixed(1)}MB</div>
            <div><strong>最終バックアップ:</strong> ${lastBackup}</div>
          `;
          
          backupStatus.innerHTML = html;
          backupDetails.innerHTML = '';
          
          // 自動バックアップボタンの更新
          const autoToggleButton = document.getElementById('autoBackupToggleButton');
          if (status.auto_backup_running) {
            autoToggleButton.textContent = '⏸️ 自動停止';
            autoToggleButton.className = 'btn btn-danger';
          } else {
            autoToggleButton.textContent = '▶️ 自動開始';
            autoToggleButton.className = 'btn btn-secondary';
          }
        })
        .catch(err => {
          backupStatus.innerHTML = '<div style="color: red;">✗ バックアップ状況の取得に失敗しました</div>';
        });
    }

    document.getElementById('createBackupButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      
      if (confirm('新しいバックアップを作成しますか？')) {
        backupDetails.innerHTML = '<div style="color: blue;">📦 バックアップを作成中...</div>';
        
        fetch(`${API_BASE}/backup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ include_logs: true })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            const info = data.backup_info;
            let html = `
              <div style="color: green;"><strong>✓ バックアップ作成完了</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>バックアップ名:</strong> ${info.backup_name}</div>
                <div><strong>作成時刻:</strong> ${new Date(info.created_at).toLocaleString()}</div>
                <div><strong>サイズ:</strong> ${info.size_mb}MB</div>
                <div><strong>ファイル数:</strong> ${info.files.length}個</div>
              </div>
            `;
            
            // ファイル別詳細
            const categories = ['critical', 'config', 'logs'];
            categories.forEach(category => {
              const categoryFiles = info.files.filter(f => f.category === category);
              if (categoryFiles.length > 0) {
                html += `<div style="margin-top: 5px;"><strong>${category}:</strong> ${categoryFiles.filter(f => f.backed_up).length}/${categoryFiles.length}ファイル</div>`;
              }
            });
            
            backupDetails.innerHTML = html;
            loadBackupStatus(); // 状態更新
          } else {
            backupDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
          }
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">✗ バックアップ作成に失敗しました</div>';
        });
      }
    });

    document.getElementById('backupListButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">📋 バックアップ一覧を読み込み中...</div>';
      
      fetch(`${API_BASE}/backup`)
        .then(res => res.json())
        .then(data => {
          const backups = data.backups;
          
          let html = `<div><strong>📋 バックアップ一覧 (${backups.length}個)</strong></div>`;
          
          if (backups.length === 0) {
            html += '<div style="color: gray; font-style: italic;">バックアップがありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            backups.forEach(backup => {
              const createdAt = new Date(backup.created_at).toLocaleString();
              const compressionIcon = backup.is_compressed ? '📦' : '📁';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong>${compressionIcon} ${backup.name}</strong><br>
                      <span style="color: #666;">${createdAt} (${backup.size_mb}MB)</span>
                    </div>
                    <div>
                      <button onclick="restoreBackup('${backup.name}')" class="btn" style="padding: 2px 6px; font-size: 10px; margin-right: 5px;">復元</button>
                      <button onclick="deleteBackup('${backup.name}')" class="btn btn-danger" style="padding: 2px 6px; font-size: 10px;">削除</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          backupDetails.innerHTML = html;
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">✗ バックアップ一覧の取得に失敗しました</div>';
        });
    });

    document.getElementById('autoBackupToggleButton').addEventListener('click', () => {
      const button = document.getElementById('autoBackupToggleButton');
      const isStarting = button.textContent.includes('開始');
      const method = isStarting ? 'POST' : 'DELETE';
      const action = isStarting ? '開始' : '停止';
      
      if (confirm(`自動バックアップを${action}しますか？`)) {
        const backupDetails = document.getElementById('backupDetails');
        backupDetails.innerHTML = `<div style="color: blue;">⏰ 自動バックアップを${action}中...</div>`;
        
        fetch(`${API_BASE}/backup/auto`, { method: method })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              backupDetails.innerHTML = `<div style="color: green;">✓ ${data.message}</div>`;
              loadBackupStatus(); // 状態更新
            } else {
              backupDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
            }
          })
          .catch(err => {
            backupDetails.innerHTML = `<div style="color: red;">✗ 自動バックアップ${action}に失敗しました</div>`;
          });
      }
    });

    document.getElementById('backupConfigButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">⚙️ バックアップ設定を読み込み中...</div>';
      
      fetch(`${API_BASE}/backup/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>⚙️ バックアップ設定</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>自動バックアップ:</strong> ${data.auto_backup_enabled ? '有効' : '無効'}</div>
              <div><strong>バックアップ時刻:</strong> ${data.backup_time}</div>
              <div><strong>最大保持数:</strong> ${data.max_backups}個</div>
              <div><strong>圧縮:</strong> ${data.compress_backups ? '有効' : '無効'}</div>
            </div>
            <div><strong>📁 バックアップ対象:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>重要ファイル: ${data.backup_targets.critical_files.length}個</li>
              <li>設定ファイル: ${data.backup_targets.config_files.length}個</li>
              <li>ログファイル: ${data.backup_targets.log_files.length}個</li>
            </ul>
            <div style="margin-top: 10px;"><strong>🔔 通知設定:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>バックアップ完了通知: ${data.notification_on_backup ? '✓' : '✗'}</li>
              <li>エラー通知: ${data.notification_on_error ? '✓' : '✗'}</li>
            </ul>
          `;
          
          backupDetails.innerHTML = html;
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">✗ バックアップ設定の取得に失敗しました</div>';
        });
    });

    // バックアップ復元関数
    function restoreBackup(backupName) {
      if (!confirm(`バックアップ「${backupName}」から復元しますか？\n\n⚠️ 現在のファイルは上書きされます。\n既存ファイルは .backup 拡張子付きでバックアップされます。`)) {
        return;
      }
      
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">🔄 バックアップを復元中...</div>';
      
      fetch(`${API_BASE}/backup/restore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          backup_name: backupName,
          target_files: ['critical', 'config'] // ログは復元しない
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          const info = data.restore_info;
          let html = `
            <div style="color: green;"><strong>✓ 復元完了</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>復元ファイル数:</strong> ${info.restored_files.length}個</div>
              <div><strong>エラー数:</strong> ${info.errors.length}個</div>
            </div>
          `;
          
          if (info.restored_files.length > 0) {
            html += '<div style="margin-top: 5px;"><strong>復元されたファイル:</strong></div>';
            html += '<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px;">';
            info.restored_files.forEach(file => {
              const actionText = file.action === 'replaced' ? '置換' : '作成';
              html += `<li>${file.file} (${actionText})</li>`;
            });
            html += '</ul>';
          }
          
          if (info.errors.length > 0) {
            html += '<div style="margin-top: 5px;"><strong style="color: red;">エラー:</strong></div>';
            html += '<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px; color: red;">';
            info.errors.forEach(error => {
              html += `<li>${error.file}: ${error.error}</li>`;
            });
            html += '</ul>';
          }
          
          html += '<div style="margin-top: 10px; color: orange;"><strong>⚠️ システムの再起動を推奨します</strong></div>';
          
          backupDetails.innerHTML = html;
        } else {
          backupDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
        }
      })
      .catch(err => {
        backupDetails.innerHTML = '<div style="color: red;">✗ 復元に失敗しました</div>';
      });
    }

    // バックアップ削除関数
    function deleteBackup(backupName) {
      if (!confirm(`バックアップ「${backupName}」を削除しますか？\n\nこの操作は取り消せません。`)) {
        return;
      }
      
      fetch(`${API_BASE}/backup/${encodeURIComponent(backupName)}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('バックアップを削除しました');
          document.getElementById('backupListButton').click(); // リロード
          loadBackupStatus(); // 状態更新
        } else {
          alert(`削除に失敗しました: ${data.message}`);
        }
      })
      .catch(err => {
        alert('削除に失敗しました');
      });
    }

    // お気に入り管理機能
    function loadFavoritesStatus() {
      const favoritesStatus = document.getElementById('favoritesStatus');
      const favoritesDetails = document.getElementById('favoritesDetails');
      
      favoritesStatus.innerHTML = '<div style="color: blue;">⭐ お気に入り状況を読み込み中...</div>';
      
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const summary = data.summary;
          
          let html = `
            <div><strong>お気に入り干場:</strong> ${summary.total_count}/${summary.max_favorites}個</div>
            <div><strong>クイックアクセス:</strong> ${summary.quick_access_count}/${summary.max_quick_access}個</div>
            <div><strong>総アクセス数:</strong> ${summary.total_access_count}回</div>
            <div><strong>平均アクセス数:</strong> ${summary.average_access_count}回/場所</div>
          `;
          
          favoritesStatus.innerHTML = html;
          favoritesDetails.innerHTML = '';
          
          // 現在選択中の干場がお気に入りかチェック
          updateFavoriteButton();
        })
        .catch(err => {
          favoritesStatus.innerHTML = '<div style="color: red;">✗ お気に入り状況の取得に失敗しました</div>';
        });
    }

    function updateFavoriteButton() {
      const addButton = document.getElementById('addFavoriteButton');
      if (!currentSelectedSpot) {
        addButton.textContent = '⭐ 干場を選択してください';
        addButton.disabled = true;
        return;
      }

      // お気に入り状態をチェック
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const isFavorite = data.favorites.some(fav => fav.name === currentSelectedSpot);
          if (isFavorite) {
            addButton.textContent = '❌ お気に入りから削除';
            addButton.className = 'btn btn-danger';
          } else {
            addButton.textContent = '⭐ お気に入りに追加';
            addButton.className = 'btn';
          }
          addButton.disabled = false;
        })
        .catch(err => {
          console.error('Favorites check error:', err);
        });
    }

    document.getElementById('addFavoriteButton').addEventListener('click', () => {
      if (!currentSelectedSpot) {
        alert('干場を選択してください');
        return;
      }

      const favoritesDetails = document.getElementById('favoritesDetails');
      
      // 現在のお気に入り状態をチェック
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const isFavorite = data.favorites.some(fav => fav.name === currentSelectedSpot);
          
          if (isFavorite) {
            // 削除
            if (confirm(`「${currentSelectedSpot}」をお気に入りから削除しますか？`)) {
              favoritesDetails.innerHTML = '<div style="color: blue;">❌ お気に入りから削除中...</div>';
              
              fetch(`${API_BASE}/favorites`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spot_name: currentSelectedSpot })
              })
              .then(res => res.json())
              .then(data => {
                if (data.status === 'success') {
                  favoritesDetails.innerHTML = `<div style="color: green;">✓ ${data.message}</div>`;
                  loadFavoritesStatus();
                  updateFavoriteButton();
                } else {
                  favoritesDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
                }
              })
              .catch(err => {
                favoritesDetails.innerHTML = '<div style="color: red;">✗ 削除に失敗しました</div>';
              });
            }
          } else {
            // 追加
            favoritesDetails.innerHTML = '<div style="color: blue;">⭐ お気に入りに追加中...</div>';
            
            const spotData = {
              lat: map.getCenter().lat,
              lon: map.getCenter().lng
            };
            
            fetch(`${API_BASE}/favorites`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                spot_name: currentSelectedSpot,
                spot_data: spotData
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                favoritesDetails.innerHTML = `<div style="color: green;">✓ ${data.message}</div>`;
                loadFavoritesStatus();
                updateFavoriteButton();
              } else {
                favoritesDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
              }
            })
            .catch(err => {
              favoritesDetails.innerHTML = '<div style="color: red;">✗ 追加に失敗しました</div>';
            });
          }
        });
    });

    document.getElementById('quickAccessButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">🚀 クイックアクセス一覧を読み込み中...</div>';
      
      fetch(`${API_BASE}/favorites/quick`)
        .then(res => res.json())
        .then(data => {
          const quickFavorites = data.quick_favorites;
          
          let html = `<div><strong>🚀 クイックアクセス (${quickFavorites.length}個)</strong></div>`;
          
          if (quickFavorites.length === 0) {
            html += '<div style="color: gray; font-style: italic;">クイックアクセス登録がありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            quickFavorites.forEach(fav => {
              const lastAccessed = fav.last_accessed ? new Date(fav.last_accessed).toLocaleString() : 'なし';
              const colorTag = fav.color_tag !== 'default' ? `🏷️${fav.color_tag}` : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 12px;">
                  <div style="display: flex; justify-content: between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">アクセス数: ${fav.access_count}回 | 最終: ${lastAccessed}</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 4px 8px; font-size: 11px;">移動</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">✗ クイックアクセス一覧の取得に失敗しました</div>';
        });
    });

    document.getElementById('favoritesListButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">📋 お気に入り一覧を読み込み中...</div>';
      
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const favorites = data.favorites;
          
          let html = `<div><strong>📋 お気に入り一覧 (${favorites.length}個)</strong></div>`;
          
          if (favorites.length === 0) {
            html += '<div style="color: gray; font-style: italic;">お気に入りがありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            favorites.forEach(fav => {
              const addedAt = new Date(fav.added_at).toLocaleString();
              const lastAccessed = fav.last_accessed ? new Date(fav.last_accessed).toLocaleString() : 'なし';
              const colorTag = fav.color_tag !== 'default' ? `🏷️${fav.color_tag}` : '';
              const quickIcon = fav.quick_access ? '🚀' : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${quickIcon}${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">追加: ${addedAt}</span><br>
                      <span style="color: #666;">アクセス: ${fav.access_count}回 | 最終: ${lastAccessed}</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 2px 6px; font-size: 10px; margin-right: 3px;">移動</button>
                      <button onclick="toggleQuickAccess('${fav.name}')" class="btn btn-secondary" style="padding: 2px 6px; font-size: 10px; margin-right: 3px;">${fav.quick_access ? 'QA解除' : 'QA設定'}</button>
                      <button onclick="removeFavorite('${fav.name}')" class="btn btn-danger" style="padding: 2px 6px; font-size: 10px;">削除</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">✗ お気に入り一覧の取得に失敗しました</div>';
        });
    });

    document.getElementById('searchFavoritesButton').addEventListener('click', () => {
      const query = prompt('検索キーワードを入力してください:');
      if (!query || query.trim() === '') {
        return;
      }

      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">🔍 検索中...</div>';
      
      fetch(`${API_BASE}/favorites/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const results = data.results;
          
          let html = `<div><strong>🔍 検索結果 "${query}" (${results.length}件)</strong></div>`;
          
          if (results.length === 0) {
            html += '<div style="color: gray; font-style: italic;">該当するお気に入りが見つかりませんでした</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            results.forEach(fav => {
              const colorTag = fav.color_tag !== 'default' ? `🏷️${fav.color_tag}` : '';
              const quickIcon = fav.quick_access ? '🚀' : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${quickIcon}${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">アクセス数: ${fav.access_count}回</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 4px 8px; font-size: 11px;">移動</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">✗ 検索に失敗しました</div>';
        });
    });

    document.getElementById('favoritesExportButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">📤 エクスポート中...</div>';
      
      fetch(`${API_BASE}/favorites/export`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            favoritesDetails.innerHTML = `
              <div style="color: green;"><strong>✓ エクスポート完了</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>ファイル名:</strong> ${data.filename}</div>
                <div><strong>お気に入り数:</strong> ${data.count}個</div>
              </div>
              <div style="color: #666; font-size: 11px;">ファイルはアプリケーションディレクトリに保存されました</div>
            `;
          } else {
            favoritesDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
          }
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">✗ エクスポートに失敗しました</div>';
        });
    });

    document.getElementById('favoritesImportButton').addEventListener('click', () => {
      const filename = prompt('インポートするファイル名を入力してください\n(例: konbu_favorites_export_20241201_120000.json):');
      if (!filename || filename.trim() === '') {
        return;
      }

      const mergeMode = confirm('既存のお気に入りとマージしますか？\n\n「OK」: マージ（重複は追加しない）\n「キャンセル」: 置換（既存を削除）');

      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">📥 インポート中...</div>';
      
      fetch(`${API_BASE}/favorites/import`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          import_file: filename.trim(),
          merge_mode: mergeMode
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          favoritesDetails.innerHTML = `
            <div style="color: green;"><strong>✓ インポート完了</strong></div>
            <div style="margin: 10px 0;">
              <div>${data.message}</div>
              <div><strong>インポート数:</strong> ${data.imported_count}個</div>
              <div><strong>現在の総数:</strong> ${data.current_count}個</div>
            </div>
          `;
          loadFavoritesStatus();
        } else {
          favoritesDetails.innerHTML = `<div style="color: red;">✗ ${data.message}</div>`;
        }
      })
      .catch(err => {
        favoritesDetails.innerHTML = '<div style="color: red;">✗ インポートに失敗しました</div>';
      });
    });

    // お気に入り関連のグローバル関数
    function jumpToFavorite(spotName, lat, lon) {
      // 地図を移動
      map.setView([lat, lon], 15);
      
      // 干場を選択状態にする
      currentSelectedSpot = spotName;
      updateSelectedSpotInfo();
      updateFavoriteButton();
      
      // アクセス数を更新
      fetch(`${API_BASE}/favorites/${encodeURIComponent(spotName)}/access`, {
        method: 'POST'
      })
      .then(() => {
        console.log(`Access count updated for ${spotName}`);
      })
      .catch(err => {
        console.error('Access count update failed:', err);
      });
    }

    function toggleQuickAccess(spotName) {
      if (!confirm(`「${spotName}」のクイックアクセス設定を切り替えますか？`)) {
        return;
      }

      fetch(`${API_BASE}/favorites/${encodeURIComponent(spotName)}/quick`, {
        method: 'PUT'
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('favoritesListButton').click(); // リロード
          loadFavoritesStatus();
        } else {
          alert(`エラー: ${data.message}`);
        }
      })
      .catch(err => {
        alert('クイックアクセス設定の変更に失敗しました');
      });
    }

    function removeFavorite(spotName) {
      if (!confirm(`「${spotName}」をお気に入りから削除しますか？`)) {
        return;
      }

      fetch(`${API_BASE}/favorites`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spot_name: spotName })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('favoritesListButton').click(); // リロード
          loadFavoritesStatus();
          updateFavoriteButton();
        } else {
          alert(`エラー: ${data.message}`);
        }
      })
      .catch(err => {
        alert('お気に入りの削除に失敗しました');
      });
    }

    // ヘルプ・マニュアル機能
    function loadHelpContent() {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <h3>📖 利尻島昆布干場予報システム</h3>
          <p>ようこそ！各機能の詳細については下のボタンからアクセスしてください。</p>
        </div>
      `;
    }

    // チュートリアル機能
    document.getElementById('tutorialButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>🎯 システム使用チュートリアル</strong></div>
        <div style="margin: 15px 0;">
          <h4>📍 ステップ1: 干場の選択</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>地図上の📍マーカーをクリックして干場を選択</li>
            <li>または「📍 地区選択ナビゲーション」でエリアを絞り込み</li>
            <li>選択した干場の情報が右側に表示されます</li>
          </ol>
          
          <h4>📊 ステップ2: 天気予報の確認</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>干場選択後、「📊 予報を見る」ボタンをクリック</li>
            <li>5日間の詳細予報と干し適合度が表示されます</li>
            <li>🟢良好 🟡注意 🟠難しい 🔴不適 で判定されます</li>
          </ol>
          
          <h4>📝 ステップ3: 実績の記録</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>「📝 記録を入力」ボタンをクリック</li>
            <li>実際の干し結果を「良好」「普通」「不良」から選択</li>
            <li>記録データは自動学習に活用されます</li>
          </ol>
          
          <h4>⭐ ステップ4: お気に入り機能の活用</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>よく使う干場は「⭐ お気に入り」に登録</li>
            <li>クイックアクセスで素早く移動可能</li>
            <li>使用頻度に応じて自動ソートされます</li>
          </ol>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>💡 ヒント:</strong> モバイルでは地図を2秒長押しで詳細メニューが表示されます
          </div>
        </div>
      `;
    });

    // FAQ機能
    document.getElementById('faqButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>❓ よくある質問（FAQ）</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: 天気予報の精度はどの程度ですか？</h4>
            <p><strong>A:</strong> Open-Meteo APIを使用し、利尻島の地域特性を考慮したアルゴリズムで判定しています。実際の記録データを学習することで精度が向上します。</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: 新しい干場を追加するには？</h4>
            <p><strong>A:</strong> モバイルでは地図を長押し（2秒）→「この位置を記録」を選択。PCでは地図をクリック後、座標を確認して手動で追加してください。</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: 漁期以外でも使用できますか？</h4>
            <p><strong>A:</strong> はい。システムは年中利用可能ですが、昆布漁期（6-9月）の管理機能が最適化されています。漁期設定は「📅 漁期管理」で変更可能です。</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: データのバックアップは必要ですか？</h4>
            <p><strong>A:</strong> 「💾 バックアップ」機能で定期的なデータ保存を推奨します。自動バックアップも設定可能で、重要なデータ保護に役立ちます。</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: 複数の人で同じデータを共有できますか？</h4>
            <p><strong>A:</strong> エクスポート・インポート機能を使用してデータ共有が可能です。お気に入りやバックアップファイルを他の利用者と共有できます。</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: 通知機能の設定方法は？</h4>
            <p><strong>A:</strong> 「🔔 通知設定」から時刻や条件を設定できます。漁師のスケジュールに合わせて柔軟に調整可能です。</p>
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>📞 その他のご質問:</strong> 下記の「📞 お問い合わせ」からご連絡ください
          </div>
        </div>
      `;
    });

    // 機能ガイド
    document.getElementById('featuresGuideButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>🛠️ 機能詳細ガイド</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">📊 天気予報機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>5日間予報:</strong> 気温、湿度、風速、降水量の詳細情報</li>
              <li><strong>干し適合度判定:</strong> 気象条件から昆布干しの適性を自動判定</li>
              <li><strong>アルゴリズム:</strong> 気温22-28℃、湿度50-70%、風速1-3m/s、降水量0mmを理想条件として評価</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">📝 記録・学習機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>実績記録:</strong> 良好・普通・不良の3段階評価で記録</li>
              <li><strong>自動学習:</strong> 記録データから地域特性を学習し予測精度を向上</li>
              <li><strong>データ品質管理:</strong> 異常値の検出と除外で学習品質を維持</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">📅 漁期管理機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>作業スケジュール:</strong> 6-9月の漁期スケジュール管理</li>
              <li><strong>休漁日設定:</strong> 定期休日や臨時休業日の登録</li>
              <li><strong>進捗追跡:</strong> 現在の漁期進捗と残り期間の表示</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">🔔 通知システム</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>カスタム時刻:</strong> 漁師のスケジュールに合わせた通知時刻設定</li>
              <li><strong>条件通知:</strong> 良好な気象条件時の自動アラート</li>
              <li><strong>配信方法:</strong> コンソール、ファイル、メール、Webhook対応</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">⭐ お気に入り機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>クイックアクセス:</strong> 最大5つまでの高速アクセス設定</li>
              <li><strong>使用統計:</strong> アクセス回数と最終利用日の追跡</li>
              <li><strong>色分けタグ:</strong> 視覚的な分類管理（7色対応）</li>
              <li><strong>検索・フィルタ:</strong> 名前やメモでの高速検索</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">🔍 システム監視</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ヘルスチェック:</strong> CPU、メモリ、ディスク使用量の監視</li>
              <li><strong>エンドポイント監視:</strong> APIの応答時間と可用性チェック</li>
              <li><strong>アラート機能:</strong> 異常検出時の自動通知</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">💾 バックアップ機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>自動バックアップ:</strong> 毎日午前2時の定期実行</li>
              <li><strong>データ圧縮:</strong> ZIP形式での効率的な保存</li>
              <li><strong>選択復元:</strong> 必要なファイルのみの部分復元対応</li>
              <li><strong>保持期間管理:</strong> 最大30個までの自動削除</li>
            </ul>
          </div>
        </div>
      `;
    });

    // 操作早見表
    document.getElementById('quickRefButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>📋 操作早見表</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">🖱️ 基本操作</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <tr style="background: #e9ecef;"><th style="border: 1px solid #ddd; padding: 5px;">操作</th><th style="border: 1px solid #ddd; padding: 5px;">PC</th><th style="border: 1px solid #ddd; padding: 5px;">モバイル</th></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">干場選択</td><td style="border: 1px solid #ddd; padding: 5px;">📍マーカークリック</td><td style="border: 1px solid #ddd; padding: 5px;">📍マーカータップ</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">地図移動</td><td style="border: 1px solid #ddd; padding: 5px;">ドラッグ</td><td style="border: 1px solid #ddd; padding: 5px;">スワイプ</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">ズーム</td><td style="border: 1px solid #ddd; padding: 5px;">マウスホイール / +/-ボタン</td><td style="border: 1px solid #ddd; padding: 5px;">ピンチ / +/-ボタン</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">詳細メニュー</td><td style="border: 1px solid #ddd; padding: 5px;">右クリック</td><td style="border: 1px solid #ddd; padding: 5px;">2秒長押し</td></tr>
            </table>
          </div>
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">⚡ ショートカット</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <tr style="background: #e9ecef;"><th style="border: 1px solid #ddd; padding: 5px;">機能</th><th style="border: 1px solid #ddd; padding: 5px;">ボタン</th><th style="border: 1px solid #ddd; padding: 5px;">説明</th></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">予報確認</td><td style="border: 1px solid #ddd; padding: 5px;">📊</td><td style="border: 1px solid #ddd; padding: 5px;">5日間の天気予報と適合度</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">記録入力</td><td style="border: 1px solid #ddd; padding: 5px;">📝</td><td style="border: 1px solid #ddd; padding: 5px;">実際の干し結果を記録</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">お気に入り</td><td style="border: 1px solid #ddd; padding: 5px;">⭐</td><td style="border: 1px solid #ddd; padding: 5px;">よく使う干場の管理</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">漁期管理</td><td style="border: 1px solid #ddd; padding: 5px;">📅</td><td style="border: 1px solid #ddd; padding: 5px;">作業スケジュール設定</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">通知設定</td><td style="border: 1px solid #ddd; padding: 5px;">🔔</td><td style="border: 1px solid #ddd; padding: 5px;">アラート時刻の設定</td></tr>
            </table>
          </div>
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">📱 モバイル専用機能</h4>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li><strong>フローティングボタン:</strong> 右下の円形ボタンでクイックアクセス</li>
              <li><strong>長押しメニュー:</strong> 地図を2秒長押しで詳細オプション表示</li>
              <li><strong>自動レイアウト:</strong> 画面回転時に最適表示に自動調整</li>
              <li><strong>タッチフレンドリー:</strong> 44px以上のタッチターゲットサイズ</li>
            </ul>
          </div>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>💡 効率的な使い方:</strong>
            <ol style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>よく使う干場は最初にお気に入り登録</li>
              <li>クイックアクセス設定で素早いアクセス</li>
              <li>記録を残して予測精度を向上</li>
              <li>通知設定で見逃し防止</li>
            </ol>
          </div>
        </div>
      `;
    });

    // トラブルシューティング
    document.getElementById('troubleshootButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>🔧 トラブル対応ガイド</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">🚨 地図が表示されない場合</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>確認事項:</strong> インターネット接続を確認</li>
              <li><strong>対処法:</strong> ページをリロード（F5キー）</li>
              <li><strong>ブラウザ:</strong> Chrome、Firefox、Safari、Edge推奨</li>
              <li><strong>キャッシュ:</strong> ブラウザキャッシュをクリア</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">📊 天気データが取得できない場合</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>原因:</strong> Open-Meteo APIへの接続問題</li>
              <li><strong>対処法:</strong> 時間をおいて再試行</li>
              <li><strong>確認:</strong> システム監視画面でエンドポイント状態を確認</li>
              <li><strong>代替:</strong> 気象庁などの公式情報も併用推奨</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">📱 モバイルで操作しにくい場合</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ズーム問題:</strong> ブラウザ設定でズーム100%に設定</li>
              <li><strong>タッチ操作:</strong> 右下のフローティングボタンを活用</li>
              <li><strong>表示問題:</strong> 画面を回転させて最適表示に調整</li>
              <li><strong>動作重い:</strong> 他のアプリを終了してメモリを確保</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">💾 データ保存・読み込み問題</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>記録消失:</strong> バックアップ機能で定期保存を設定</li>
              <li><strong>インポート失敗:</strong> ファイル形式がJSONか確認</li>
              <li><strong>同期問題:</strong> エクスポート→インポートで手動同期</li>
              <li><strong>容量不足:</strong> 古いバックアップを削除</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">🔔 通知が届かない場合</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>設定確認:</strong> 通知時刻と条件を再確認</li>
              <li><strong>システム時刻:</strong> デバイスの時刻設定を確認</li>
              <li><strong>権限:</strong> ブラウザの通知許可設定を確認</li>
              <li><strong>手動確認:</strong> システム監視で動作状況を確認</li>
            </ul>
          </div>
          
          <div style="background: #dc3545; color: white; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>🆘 緊急時の対応:</strong>
            <ol style="margin: 5px 0; padding-left: 20px;">
              <li>データバックアップの確認・作成</li>
              <li>気象庁など公式情報源の併用</li>
              <li>システム監視画面でエラーログ確認</li>
              <li>必要に応じて管理者への連絡</li>
            </ol>
          </div>
        </div>
      `;
    });

    // お問い合わせ情報
    document.getElementById('contactButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>📞 お問い合わせ・サポート</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="background: #e8f5e8; border: 1px solid #4a8a5a; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #2c5f2d;">🌊 利尻島昆布干場予報システム</h4>
            <p><strong>システム名:</strong> 利尻島昆布干場予報システム</p>
            <p><strong>対象地域:</strong> 北海道利尻島（利尻町・利尻富士町）</p>
            <p><strong>対象産業:</strong> 昆布漁業・昆布加工業</p>
            <p><strong>開発目的:</strong> 昆布干場の効率的な管理と天候予測支援</p>
          </div>
          
          <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #495057;">🛠️ 技術サポート</h4>
            <p><strong>システム監視:</strong> 「🔍 システム監視」画面で状態確認</p>
            <p><strong>バックアップ:</strong> 「💾 バックアップ」でデータ保護</p>
            <p><strong>ログ確認:</strong> エラーメッセージをスクリーンショットで記録</p>
            <p><strong>ブラウザ:</strong> Chrome、Firefox、Safari、Edge推奨</p>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #856404;">📋 お問い合わせ時の情報</h4>
            <p>以下の情報をお知らせいただけるとスムーズです：</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>発生日時:</strong> 問題が発生した日時</li>
              <li><strong>操作内容:</strong> 何をしているときに問題が発生したか</li>
              <li><strong>エラーメッセージ:</strong> 表示されたエラーの内容</li>
              <li><strong>使用環境:</strong> デバイス（PC/スマートフォン/タブレット）</li>
              <li><strong>ブラウザ:</strong> 使用しているブラウザの種類</li>
              <li><strong>再現性:</strong> 同じ問題が再度発生するか</li>
            </ul>
          </div>
          
          <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #155724;">💡 改善提案・要望</h4>
            <p>システムの改善や新機能のご要望も歓迎します：</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>機能追加:</strong> こんな機能があれば便利</li>
              <li><strong>操作改善:</strong> もっと使いやすくするには</li>
              <li><strong>表示改善:</strong> 見た目や配置の改善案</li>
              <li><strong>モバイル対応:</strong> スマートフォンでの使い勝手</li>
              <li><strong>データ活用:</strong> 記録データの活用方法</li>
            </ul>
          </div>
          
          <div style="text-align: center; background: #f8f9fa; padding: 20px; border-radius: 5px; margin-top: 20px;">
            <h4 style="color: #2c5f2d;">🤝 利尻島の昆布漁業発展のために</h4>
            <p>このシステムは利尻島の昆布漁師の皆様の作業効率向上と<br>
            品質の高い昆布生産を支援することを目的としています。</p>
            <p><strong>皆様のご意見・ご要望をお聞かせください</strong></p>
          </div>
        </div>
      `;
    });

    // グローバル関数（ポップアップから呼び出し用）
    window.selectSpot = selectSpot;
    window.addRestDay = addRestDay;
    window.removeRestDay = removeRestDay;
    window.updateNotificationTime = updateNotificationTime;
    window.addSubscriber = addSubscriber;
    window.removeSubscriber = removeSubscriber;
    window.restoreBackup = restoreBackup;
    window.deleteBackup = deleteBackup;
    window.jumpToFavorite = jumpToFavorite;
    window.toggleQuickAccess = toggleQuickAccess;
    window.removeFavorite = removeFavorite;

    // モバイル対応機能
    function initMobileOptimizations() {
      // デバイス検出
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouch = 'ontouchstart' in window;
      
      if (isMobile || isTouch) {
        // モバイル向けマップ設定の調整
        map.options.zoomControl = false; // デフォルトズームコントロールを無効化
        
        // カスタムズームコントロールを追加（タッチフレンドリー）
        const customZoomControl = L.control.zoom({
          position: 'bottomright'
        });
        customZoomControl.addTo(map);
        
        // タップ時の遅延を削除
        map.options.tap = true;
        if (map.tap) {
          map.tap.enable();
        }
        
        // 地図のダブルタップズームを調整
        map.options.doubleClickZoom = true;
        
        // パンニングの慣性を有効化
        map.options.inertia = true;
        map.options.inertiaDeceleration = 2000;
        
        console.log('Mobile optimizations enabled');
      }
      
      // 画面サイズ変更時の処理
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          map.invalidateSize();
          adjustMapHeight();
        }, 250);
      });
      
      // 画面回転時の処理
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          map.invalidateSize();
          adjustMapHeight();
        }, 500);
      });
      
      // 初期マップ高さ調整
      adjustMapHeight();
    }

    function adjustMapHeight() {
      const mapElement = document.getElementById('map');
      const windowHeight = window.innerHeight;
      const windowWidth = window.innerWidth;
      
      // モバイルデバイスの場合、画面サイズに応じて地図の高さを動的調整
      if (windowWidth <= 480) {
        // 小画面（スマートフォン縦向き）
        const headerHeight = document.querySelector('.header').offsetHeight;
        const sidebarHeight = document.querySelector('.sidebar').offsetHeight;
        const availableHeight = windowHeight - headerHeight - sidebarHeight - 60;
        mapElement.style.height = Math.max(250, Math.min(400, availableHeight)) + 'px';
      } else if (windowWidth <= 768) {
        // 中画面（タブレット）
        mapElement.style.height = '350px';
      } else if (windowWidth <= 1024) {
        // 大画面（タブレット横向き）
        mapElement.style.height = '400px';
      }
      
      // 地図サイズの再計算
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    // タッチ改善：長押しでコンテキストメニュー風の機能
    function initTouchGestures() {
      let touchTimer;
      let touchStarted = false;
      
      map.on('touchstart', (e) => {
        touchStarted = true;
        touchTimer = setTimeout(() => {
          if (touchStarted) {
            // 長押し時の処理（2秒）
            showQuickActions(e.latlng);
          }
        }, 2000);
      });
      
      map.on('touchend touchcancel', () => {
        touchStarted = false;
        clearTimeout(touchTimer);
      });
      
      map.on('touchmove', () => {
        // ドラッグ開始時は長押しをキャンセル
        touchStarted = false;
        clearTimeout(touchTimer);
      });
    }

    function showQuickActions(latlng) {
      // 現在位置を記録
      const lat = latlng.lat.toFixed(6);
      const lon = latlng.lng.toFixed(6);
      
      // モバイル向けクイックアクションメニュー
      const actions = [
        '📍 この位置を記録',
        '⭐ お気に入りに追加',
        '🔍 詳細を表示',
        '❌ キャンセル'
      ];
      
      const choice = prompt(`位置: ${lat}, ${lon}\n\n選択してください：\n1. ${actions[0]}\n2. ${actions[1]}\n3. ${actions[2]}\n4. ${actions[3]}\n\n番号を入力してください (1-4):`);
      
      switch(choice) {
        case '1':
          // 地形チェック後に新しい干場として追加
          if (confirm(`新しい干場を追加しますか？\n緯度: ${lat}\n経度: ${lon}`)) {
            addNewSpotWithValidation(lat, lon);
          }
          break;
        case '2':
          // お気に入りに追加（近い干場があれば）
          findNearestSpotAndAddToFavorites(latlng);
          break;
        case '3':
          // 詳細表示
          showLocationDetails(latlng);
          break;
        default:
          // キャンセルまたは無効な入力
          break;
      }
    }

    function findNearestSpotAndAddToFavorites(latlng) {
      let nearest = null;
      let minDistance = Infinity;
      
      spots.forEach(spot => {
        const distance = map.distance(latlng, [spot.lat, spot.lon]);
        if (distance < minDistance) {
          minDistance = distance;
          nearest = spot;
        }
      });
      
      if (nearest && minDistance < 1000) { // 1km以内
        const distanceText = Math.round(minDistance) + 'm';
        if (confirm(`最寄りの干場「${nearest.name}」(${distanceText}先) をお気に入りに追加しますか？`)) {
          currentSelectedSpot = nearest.name;
          selectSpot(nearest.name);
          // お気に入りパネルを開く
          document.getElementById('favoritesButton').click();
        }
      } else {
        alert('近くに登録済みの干場がありません。\n新しい干場として追加を検討してください。');
      }
    }

    function showLocationDetails(latlng) {
      const lat = latlng.lat.toFixed(6);
      const lon = latlng.lng.toFixed(6);
      
      // 天気予報を取得して表示
      fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}&start_date=${new Date().toISOString().split('T')[0]}`)
        .then(res => res.json())
        .then(data => {
          if (data.forecast && data.forecast.length > 0) {
            const today = data.forecast[0];
            const temp = today.temperature || 'データなし';
            const humidity = today.humidity || 'データなし';
            const wind = today.wind_speed || 'データなし';
            
            alert(`📍 位置の天気情報\n緯度: ${lat}\n経度: ${lon}\n\n🌡️ 気温: ${temp}°C\n💧 湿度: ${humidity}%\n💨 風速: ${wind}m/s`);
          } else {
            alert(`📍 位置情報\n緯度: ${lat}\n経度: ${lon}\n\n天気データを取得できませんでした。`);
          }
        })
        .catch(err => {
          alert(`📍 位置情報\n緯度: ${lat}\n経度: ${lon}\n\n天気データの取得に失敗しました。`);
        });
    }

    function addNewSpot(lat, lon) {
      const spotName = prompt('新しい干場の名前を入力してください:');
      if (!spotName || spotName.trim() === '') {
        return;
      }
      
      // 新しい干場を追加
      const newSpotData = {
        name: spotName.trim(),
        lat: parseFloat(lat),
        lon: parseFloat(lon)
      };
      
      fetch(`${API_BASE}/spots`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newSpotData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.message && data.message.includes('成功')) {
          alert('✅ 新しい干場を追加しました！');
          loadSpots(); // 干場リストを再読み込み
        } else {
          alert('❌ 干場の追加に失敗しました');
        }
      })
      .catch(err => {
        console.error('Error adding spot:', err);
        showMobileMessage('❌ ネットワークエラーが発生しました', 'warning', 3000);
        // オフライン用の仮保存
        saveOfflineSpot(lat, lon);
      });
    }

    function saveOfflineSpot(lat, lon) {
      // オフライン時の仮保存
      try {
        const offlineSpots = JSON.parse(localStorage.getItem('offlineSpots') || '[]');
        const newSpot = {
          lat: lat,
          lon: lon,
          timestamp: Date.now(),
          type: 'add'
        };
        offlineSpots.push(newSpot);
        localStorage.setItem('offlineSpots', JSON.stringify(offlineSpots));

        showMobileMessage('📱 オフライン保存しました。オンライン時に自動反映されます。', 'info', 4000);
      } catch (e) {
        console.error('Offline save failed:', e);
      }
    }

    // オフライン同期機能
    function checkAndSyncOfflineData() {
      if (!navigator.onLine) return;

      const offlineSpots = JSON.parse(localStorage.getItem('offlineSpots') || '[]');
      if (offlineSpots.length === 0) return;

      showMobileMessage('🔄 オフラインデータを同期中...', 'info', 2000);

      offlineSpots.forEach((spot, index) => {
        if (spot.type === 'add') {
          fetch(`${API_BASE}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: spot.lat, lon: spot.lon })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              console.log(`Offline spot ${index} synced successfully`);
            }
          })
          .catch(error => console.error(`Offline sync failed for spot ${index}:`, error));
        }
      });

      // 同期完了後にオフラインデータをクリア
      localStorage.removeItem('offlineSpots');
      showMobileMessage('✅ オフラインデータの同期が完了しました', 'success', 3000);
    }

    // ページ読み込み時とオンライン復帰時に同期チェック
    window.addEventListener('load', checkAndSyncOfflineData);
    window.addEventListener('online', checkAndSyncOfflineData);

    // プルダウンメニューのモバイル最適化
    function initMobileNavigation() {
      // セレクトボックスにタッチフレンドリーなスタイルを追加
      const selects = document.querySelectorAll('select');
      selects.forEach(select => {
        select.addEventListener('focus', function() {
          this.style.fontSize = '16px'; // iOS Safari のズーム防止
        });
      });
      
      // フォーカス時のスクロール位置調整
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    }

    // パネル切り替えの改善（モバイル向け）
    function initMobilePanelSwitching() {
      // 現在開いているパネルを追跡
      let currentPanel = null;
      
      // パネル切り替え時のスムーズスクロール
      const panelButtons = document.querySelectorAll('#forecastButton, #recordButton, #adaptiveLearningButton, #seasonButton, #notificationButton, #favoritesButton, #systemMonitorButton, #backupButton');
      
      panelButtons.forEach(button => {
        const originalClick = button.onclick;
        button.addEventListener('click', function(e) {
          // 元のクリック処理を実行
          if (originalClick) {
            originalClick.call(this, e);
          }
          
          // モバイルではパネルまでスクロール
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              const activePanel = document.querySelector('.forecast-panel[style*="block"], .record-panel[style*="block"]');
              if (activePanel) {
                activePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          }
        });
      });
    }

    // 初期読み込み時にモバイル最適化を有効化
    function initAllMobileFeatures() {
      initMobileOptimizations();
      initTouchGestures();
      initMobileNavigation();
      initMobilePanelSwitching();
      
      // デバイス情報をコンソールに出力（デバッグ用）
      console.log('Device info:', {
        userAgent: navigator.userAgent,
        screenWidth: window.screen.width,
        screenHeight: window.screen.height,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        devicePixelRatio: window.devicePixelRatio,
        isTouch: 'ontouchstart' in window
      });
    }

    // 天気予報取得関数を先に定義
    function getWeatherForecast(lat, lon) {
      console.log('天気予報取得開始:', lat, lon);
      
      // 天気予報ダイアログを作成・表示
      createWeatherForecastDialog(lat, lon);
    }

    function createWeatherForecastDialog(lat, lon) {
      // 既存のダイアログがあれば削除
      const existingDialog = document.getElementById('weatherForecastDialog');
      if (existingDialog) {
        existingDialog.remove();
      }

      const dialog = document.createElement('div');
      dialog.id = 'weatherForecastDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #2c5f2d;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      `;

      dialog.innerHTML = `
        <div style="margin-bottom: 20px; border-bottom: 2px solid #2c5f2d; padding-bottom: 15px;">
          <h3 style="margin: 0; color: #2c5f2d; display: flex; align-items: center; justify-content: space-between;">
            <span>🌤️ 天気予報</span>
            <button onclick="closeWeatherForecastDialog()" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">×</button>
          </h3>
          <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">座標: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
        </div>

        <!-- 日付タブ -->
        <div style="margin-bottom: 20px;">
          <div id="dateTabsContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;">
            <!-- タブは動的に生成 -->
          </div>
        </div>

        <!-- 予報内容表示エリア -->
        <div id="forecastContentContainer" style="min-height: 400px;">
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 10px;">📊</div>
            <p>予報データを読み込み中...</p>
          </div>
        </div>

        <!-- 閉じるボタン -->
        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          <button onclick="closeWeatherForecastDialog()" style="background: #2c5f2d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">閉じる</button>
        </div>
      `;

      document.body.appendChild(dialog);

      // 予報データを取得・表示
      loadWeatherForecastData(lat, lon);
    }

    function closeWeatherForecastDialog() {
      const dialog = document.getElementById('weatherForecastDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    async function loadWeatherForecastData(lat, lon) {
      try {
        // 日付タブを生成（翌日から1週間）
        generateDateTabs();
        
        // APIから天気データを取得
        const response = await fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}`);
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        console.log('予報データ:', data);
        
        // 予報データを保存（タブ切り替え時に再利用）
        window.currentForecastData = data;
        window.currentLat = lat;
        window.currentLon = lon;
        
        // 最初のタブ（翌日）を選択状態にして表示
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        displayForecastForDate(data, tomorrowStr, lat, lon);
        setActiveTab(tomorrowStr);
        
      } catch (error) {
        console.error('天気予報取得エラー:', error);
        document.getElementById('forecastContentContainer').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #f44336;">
            <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
            <p><strong>予報データの取得に失敗しました</strong></p>
            <p style="font-size: 14px; color: #666;">エラー: ${error.message}</p>
            <p style="font-size: 12px; color: #999; margin-top: 15px;">※ 実際のAPIキーが設定されていない可能性があります</p>
          </div>
        `;
      }
    }

    function generateDateTabs() {
      const tabsContainer = document.getElementById('dateTabsContainer');
      const today = new Date();
      
      let tabsHTML = '';
      
      for (let i = 1; i <= 6; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        const dateStr = date.toISOString().split('T')[0];
        const displayDate = `${date.getMonth() + 1}/${date.getDate()}`;
        const dayName = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
        
        const isFirst = i === 1;
        
        tabsHTML += `
          <button 
            id="tab-${dateStr}" 
            onclick="selectForecastDate('${dateStr}')"
            style="
              padding: 8px 12px;
              border: 2px solid #2c5f2d;
              background: ${isFirst ? '#2c5f2d' : 'white'};
              color: ${isFirst ? 'white' : '#2c5f2d'};
              border-radius: 20px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
              transition: all 0.3s ease;
            "
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'"
          >
            ${i === 1 ? '明日' : `${i}日後`}<br>
            <small style="font-size: 11px;">${displayDate}(${dayName})</small>
          </button>
        `;
      }
      
      tabsContainer.innerHTML = tabsHTML;
    }

    function selectForecastDate(dateStr) {
      // タブの選択状態を更新
      setActiveTab(dateStr);
      
      const contentContainer = document.getElementById('forecastContentContainer');
      
      // 最初の日付（翌日）以外は制限版を表示
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      
      if (dateStr === tomorrowStr) {
        // 翌日の場合は保存されたデータを表示
        if (window.currentForecastData) {
          displayForecastForDate(window.currentForecastData, dateStr, window.currentLat, window.currentLon);
          return;
        }
      }
      
      // 2日後以降もAPIデータを使用して段階別分析を表示
      // まず予報データを取得
      if (window.currentForecastData && window.currentForecastData.forecasts) {
        displayForecastForDate(window.currentForecastData, dateStr, window.currentLat, window.currentLon);
        return;
      }

      // APIデータがない場合は新しく取得
      fetch(`/api/forecast?lat=${window.currentLat}&lon=${window.currentLon}`)
        .then(response => response.json())
        .then(data => {
          window.currentForecastData = data;
          displayForecastForDate(data, dateStr, window.currentLat, window.currentLon);
        })
        .catch(error => {
          console.error('予報データ取得エラー:', error);

          // エラー時は簡易表示
          const dayOffset = Math.ceil((new Date(dateStr) - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
          let reliabilityInfo = '';

          if (dayOffset === 2) {
            reliabilityInfo = '信頼度: 95% (高精度)';
          } else if (dayOffset === 3) {
            reliabilityInfo = '信頼度: 85% (良好)';
          } else if (dayOffset <= 5) {
            reliabilityInfo = '信頼度: 70% (中程度)';
          } else {
            reliabilityInfo = '信頼度: 50% (参考程度)';
          }

          contentContainer.innerHTML = `
            <div style="padding: 20px;">
              <h4 style="color: #2c5f2d; margin-bottom: 20px; text-align: center;">
                📅 ${dateStr} の予報
              </h4>

              <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h5 style="color: #856404; margin-bottom: 10px;">📊 ${dayOffset}日後予報</h5>
                <div style="color: #856404;">
                  ${reliabilityInfo}<br>
                  ${dayOffset > 3 ? '※ 計画の参考程度にご活用ください' : '※ 作業計画の検討にご活用ください'}
                </div>
              </div>

              <div style="background: #ffebee; border-radius: 8px; padding: 15px; border: 1px solid #f44336;">
                <h5 style="color: #d32f2f; margin-bottom: 10px;">⚠️ データ取得エラー</h5>
                <div style="color: #d32f2f;">
                  予報データの取得に失敗しました。しばらくしてから再度お試しください。
                </div>
              </div>

              <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                <p style="font-size: 12px; color: #666; margin: 0;">
                  💡 高精度予報は翌日・2日後がおすすめです | 📊 利尻島昆布干し特化予報
                </p>
              </div>
            </div>
          `;
        });
    }

    function setActiveTab(activeDate) {
      // すべてのタブを非選択状態にする
      const allTabs = document.querySelectorAll('[id^="tab-"]');
      allTabs.forEach(tab => {
        tab.style.background = 'white';
        tab.style.color = '#2c5f2d';
      });
      
      // 選択されたタブを選択状態にする
      const activeTab = document.getElementById(`tab-${activeDate}`);
      if (activeTab) {
        activeTab.style.background = '#2c5f2d';
        activeTab.style.color = 'white';
      }
    }

    function displayForecastForDate(data, dateStr, lat, lon) {
      const contentContainer = document.getElementById('forecastContentContainer');
      
      console.log('表示中のデータ:', data);
      
      // 新しいAPIレスポンス形式に対応
      if (!data || !data.forecasts) {
        contentContainer.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">予報データがありません</div>';
        return;
      }

      // 指定した日付の予報データを検索
      const targetForecast = data.forecasts.find(f => f.date === dateStr);
      if (!targetForecast) {
        contentContainer.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">指定された日付のデータがありません</div>';
        return;
      }

      // 長期予報の場合の信頼度警告
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      const dayOffset = Math.ceil((new Date(dateStr) - tomorrow) / (1000 * 60 * 60 * 24)) + 1;

      let longTermWarningHTML = '';
      if (dateStr !== tomorrowStr) {
        let reliabilityInfo = '';
        let warningColor = '#fff3cd';
        let borderColor = '#ffeaa7';
        let textColor = '#856404';

        if (dayOffset === 2) {
          reliabilityInfo = '信頼度: 95% (高精度)';
        } else if (dayOffset === 3) {
          reliabilityInfo = '信頼度: 85% (良好)';
        } else if (dayOffset <= 5) {
          reliabilityInfo = '信頼度: 70% (中程度)';
          warningColor = '#fff3e0';
          borderColor = '#ffcc02';
          textColor = '#e65100';
        } else {
          reliabilityInfo = '信頼度: 50% (参考程度)';
          warningColor = '#ffebee';
          borderColor = '#f44336';
          textColor = '#d32f2f';
        }

        longTermWarningHTML = `
          <div style="background: ${warningColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h5 style="color: ${textColor}; margin-bottom: 10px;">📊 ${dayOffset}日後予報</h5>
            <div style="color: ${textColor};">
              ${reliabilityInfo}<br>
              ${dayOffset > 3 ? '※ 計画の参考程度にご活用ください' : '※ 作業計画の検討にご活用ください'}
            </div>
          </div>
        `;
      }

      // 換気重視期間（4:00-10:00）の風速を計算
      const ventilationHours = targetForecast.hourly_details.filter(h => {
        const hour = parseInt(h.time.split(':')[0]);
        return hour >= 4 && hour <= 10;
      });
      const avgVentilationWind = ventilationHours.length > 0 ?
        ventilationHours.reduce((sum, h) => sum + (h.wind_speed || 0), 0) / ventilationHours.length : 0;

      // 熱供給重視期間（10:00-16:00）の湿度を計算
      const solarHours = targetForecast.hourly_details.filter(h => {
        const hour = parseInt(h.time.split(':')[0]);
        return hour >= 10 && hour <= 16;
      });
      const avgSolarHumidity = solarHours.length > 0 ?
        solarHours.reduce((sum, h) => sum + (h.humidity || 0), 0) / solarHours.length : 0;

      // 基本気象情報のHTML生成
      const tempHumidityHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">🌡️ 基本気象情報</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>平均湿度: ${targetForecast.daily_summary.humidity.toFixed(1)}%</div>
            <div>平均風速: ${targetForecast.daily_summary.wind_speed.toFixed(1)} m/s</div>
          </div>
        </div>
      `;

      const windHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">🌬️ 換気重視期間（午前4時〜10時）</h5>
          <div>風速: ${avgVentilationWind.toFixed(1)} m/s</div>
          <div style="margin-top: 8px; padding: 8px; background: ${avgVentilationWind > 1.5 ? '#e8f5e8' : '#fff3cd'}; border-radius: 4px;">
            ${avgVentilationWind > 1.5 ? '✓ 換気条件良好' : '⚠ 風が弱め - 換気注意'}
          </div>
        </div>
      `;

      const solarHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">☀️ 熱供給重視期間（午前10時〜午後4時）</h5>
          <div>湿度: ${avgSolarHumidity.toFixed(1)}%</div>
          <div style="margin-top: 8px; padding: 8px; background: ${avgSolarHumidity < 80 ? '#e8f5e8' : '#fff3cd'}; border-radius: 4px;">
            ${avgSolarHumidity < 80 ? '✓ 乾燥条件良好' : '⚠ 高湿度 - 乾燥注意'}
          </div>
        </div>
      `;
      
      // 乾燥判定結果の処理
      const reliabilityData = targetForecast.reliability || {};
      const suitabilityColor = targetForecast.daily_summary.suitability === 'excellent' ? '#2e7d32' :
                              targetForecast.daily_summary.suitability === 'good' ? '#388e3c' :
                              targetForecast.daily_summary.suitability === 'fair' ? '#f57c00' : '#d32f2f';
      const dryingHTML = `
        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">🎯 総合判定</h5>
          <div style="font-size: 16px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 8px;">
            ${targetForecast.daily_summary.estimated_drying_time}
          </div>
          <div>信頼度: ${reliabilityData.accuracy || '--'}%</div>
          <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">乾燥適性: ${targetForecast.daily_summary.suitability}</div>
        </div>
      `;
      
      // 安全警告の処理
      let safetyWarningsHTML = '';
      if (data.safety_warnings && data.safety_warnings.length > 0) {
        const warningsList = data.safety_warnings.map(warning => `<li>${warning}</li>`).join('');
        safetyWarningsHTML = `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h5 style="color: #856404; margin-bottom: 10px;">⚠️ 安全警告</h5>
            <ul style="color: #856404; margin: 0; padding-left: 20px;">
              ${warningsList}
            </ul>
          </div>
        `;
      }
      
      // 段階別分析データの処理
      const stageAnalysis = targetForecast.daily_summary.stage_analysis || {};

      // PWV/PBLH分析データの処理
      const pwvPblhAnalysis = stageAnalysis.pwv_pblh_analysis || {};


      // 1時間刻み推移表示用データの準備
      const hourlyData = targetForecast.hourly_details || [];

      // 利尻島伝統風名変換関数（16方位）
      function getRishiriWindName(windDirection) {
        if (windDirection === null || windDirection === undefined) return { name: '--', cardinal: '--' };

        const windNames = [
          { dir: 0, name: 'アイ', cardinal: '北' }, { dir: 22.5, name: 'アイシモ', cardinal: '北北東' },
          { dir: 45, name: 'シモ', cardinal: '北東' }, { dir: 67.5, name: 'シモヤマセ', cardinal: '東北東' },
          { dir: 90, name: 'ホンヤマセ', cardinal: '東' }, { dir: 112.5, name: 'ヤマセ', cardinal: '東南東' },
          { dir: 135, name: 'ミナミヤマセ', cardinal: '南東' }, { dir: 157.5, name: 'ミナミヤマ', cardinal: '南南東' },
          { dir: 180, name: 'クダリ', cardinal: '南' }, { dir: 202.5, name: 'クダリヒカタ', cardinal: '南南西' },
          { dir: 225, name: 'ヒカタ', cardinal: '南西' }, { dir: 247.5, name: 'ニシヒカタ', cardinal: '西南西' },
          { dir: 270, name: 'ニシ', cardinal: '西' }, { dir: 292.5, name: 'ニシタマ', cardinal: '西北西' },
          { dir: 315, name: 'タマ', cardinal: '北西' }, { dir: 337.5, name: 'アイタマ', cardinal: '北北西' }
        ];

        const normalizedDir = ((windDirection % 360) + 360) % 360;
        let minDiff = 360;
        let closestWind = windNames[0];

        for (const wind of windNames) {
          let diff = Math.abs(normalizedDir - wind.dir);
          diff = Math.min(diff, 360 - diff);
          if (diff < minDiff) {
            minDiff = diff;
            closestWind = wind;
          }
        }
        return closestWind;
      }

      // 1時間刻みデータの準備（全気象データ）
      const hourlyAllData = hourlyData.map(hour => {
        const time = hour.time || '--';

        // 基本気象データ
        const temperature = hour.temperature !== null && hour.temperature !== undefined ?
          hour.temperature.toFixed(1) : '--';
        const humidity = hour.humidity !== null && hour.humidity !== undefined ?
          hour.humidity.toFixed(0) : '--';
        const windSpeed = hour.wind_speed !== null && hour.wind_speed !== undefined ?
          hour.wind_speed.toFixed(1) : '--';
        const windInfo = hour.wind_direction !== null && hour.wind_direction !== undefined ?
          getRishiriWindName(hour.wind_direction) : { name: '--', arrow: '--' };
        const solarRadiation = hour.solar_radiation !== null && hour.solar_radiation !== undefined ?
          hour.solar_radiation.toFixed(0) : '--';
        const precipitation = hour.precipitation !== null && hour.precipitation !== undefined ?
          hour.precipitation.toFixed(1) : '--';
        const cloudCover = hour.cloud_cover !== null && hour.cloud_cover !== undefined ?
          hour.cloud_cover.toFixed(0) : '--';

        // 高度気象データ
        const verticalVel = hour.vertical_p_velocity !== null && hour.vertical_p_velocity !== undefined ?
          hour.vertical_p_velocity.toFixed(3) : '--';
        const ssi = hour.ssi !== null && hour.ssi !== undefined ?
          hour.ssi.toFixed(1) : '--';
        const ssiCategory = hour.ssi !== null && hour.ssi !== undefined ?
          (hour.ssi >= 3 ? '安定' : hour.ssi >= 0 ? '中性' : hour.ssi >= -3 ? 'やや不安定' : '不安定') : '--';
        const equivTemp = hour.equivalent_potential_temperature !== null && hour.equivalent_potential_temperature !== undefined ?
          hour.equivalent_potential_temperature.toFixed(1) : '--';

        // 500hPa渦度データ
        const vorticity = hour.vorticity_500hpa !== null && hour.vorticity_500hpa !== undefined ?
          (hour.vorticity_500hpa * 100000).toFixed(1) : '--'; // Convert to 10^-5 s^-1 units

        // PWV and PBLH data
        const pwv = hour.precipitable_water !== null && hour.precipitable_water !== undefined ?
          hour.precipitable_water.toFixed(1) : '--';
        const pblh = hour.boundary_layer_height !== null && hour.boundary_layer_height !== undefined ?
          hour.boundary_layer_height.toFixed(0) : '--';

        const pwvCategory = hour.pwv_pblh_analysis?.pwv_category || '--';
        const pblhCategory = hour.pwv_pblh_analysis?.pblh_category || '--';

        return {
          time, temperature, humidity, windSpeed, windInfo, solarRadiation, precipitation, cloudCover,
          verticalVel, ssi, ssiCategory, equivTemp, vorticity,
          pwv, pblh, pwvCategory, pblhCategory
        };
      });

      // 基本気象データテーブルの定義
      const basicWeatherTableHTML = `
        <div style="margin-top: 15px;">
          <h6 style="color: #2e7d32; margin: 0 0 12px 0;">🌤️ 基本気象データ (1時間刻み推移)</h6>
          <div style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
            <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
              <thead style="background: #f5f5f5; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 40px;">時刻</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">気温<br>(°C)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">湿度<br>(%)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">風速<br>(m/s)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 55px;">風向<br>(伝統風名/16方位)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">日射<br>(W/m²)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">降水量<br>(mm)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">雲量<br>(%)</th>
                </tr>
              </thead>
              <tbody>
                ${hourlyAllData.map(hour => `
                  <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 4px 2px; text-align: center; font-weight: bold; background: #f9f9f9;">${hour.time}</td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.temperature !== '--' && parseFloat(hour.temperature) > 20 ? '#d32f2f' : hour.temperature !== '--' && parseFloat(hour.temperature) < 10 ? '#1976d2' : '#333'};">
                      ${hour.temperature}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.humidity !== '--' && parseFloat(hour.humidity) > 80 ? '#d32f2f' : hour.humidity !== '--' && parseFloat(hour.humidity) < 60 ? '#4caf50' : '#333'};">
                      ${hour.humidity}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.windSpeed !== '--' && parseFloat(hour.windSpeed) > 3 ? '#4caf50' : hour.windSpeed !== '--' && parseFloat(hour.windSpeed) < 1.5 ? '#d32f2f' : '#333'};">
                      ${hour.windSpeed}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; font-weight: bold; color: #1976d2;">
                      <div style="font-size: 10px;">${hour.windInfo.name}</div>
                      <div style="font-size: 8px; color: #666;">${hour.windInfo.cardinal}</div>
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.solarRadiation !== '--' && parseFloat(hour.solarRadiation) > 600 ? '#ff9800' : '#333'};">
                      ${hour.solarRadiation}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.precipitation !== '--' && parseFloat(hour.precipitation) > 0.1 ? '#f44336' : '#4caf50'};">
                      ${hour.precipitation}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.cloudCover !== '--' && parseFloat(hour.cloudCover) > 80 ? '#666' : hour.cloudCover !== '--' && parseFloat(hour.cloudCover) < 30 ? '#4caf50' : '#ff9800'};">
                      ${hour.cloudCover}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div style="font-size: 9px; color: #666; margin-top: 8px; text-align: center;">
            ※ 基本気象データ (4:00-16:00) | 🔴高温・高湿度・降雨 🔵低温 🟢好条件風速・低湿度・乾燥・晴天 🟠強日射・部分曇り ⚫高雲量
          </div>
        </div>
      `;

      // 一般漁師向け簡易表示
      const fisherHTML = `
        <div style="background: #e8f5e8; border-radius: 8px; padding: 15px; border: 1px solid #4caf50;">
          <h5 style="color: #2e7d32; margin-bottom: 10px;">🎣 一般漁師向け予報</h5>
          <div style="font-size: 18px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 10px;">
            ${stageAnalysis.predicted_completion_time || targetForecast.daily_summary.estimated_drying_time}
          </div>
          <div style="font-size: 14px; color: #2e7d32; margin-bottom: 10px;">
            総合スコア: ${stageAnalysis.overall_score || '--'}/100
          </div>
          ${pwvPblhAnalysis.avg_pwv || pwvPblhAnalysis.avg_pblh ? `
            <div style="background: #e8f5e9; border-radius: 6px; padding: 10px; margin-bottom: 10px; border: 1px solid #66bb6a;">
              <div style="font-size: 12px; font-weight: bold; color: #2e7d32; margin-bottom: 6px;">💧 大気湿潤・境界層状態</div>
              <div style="font-size: 11px; line-height: 1.6;">
                ${pwvPblhAnalysis.avg_pwv ? `<div>可降水量(PWV): <strong>${pwvPblhAnalysis.avg_pwv}mm</strong> <span style="color: ${
                  pwvPblhAnalysis.pwv_category === '非常に乾燥' || pwvPblhAnalysis.pwv_category === '乾燥' ? '#4caf50' :
                  pwvPblhAnalysis.pwv_category === 'やや乾燥' || pwvPblhAnalysis.pwv_category === '普通' ? '#ff9800' :
                  '#d32f2f'
                };">(${pwvPblhAnalysis.pwv_category})</span></div>` : ''}
                ${pwvPblhAnalysis.avg_pblh ? `<div>境界層高度(PBLH): <strong>${pwvPblhAnalysis.avg_pblh}m</strong> <span style="color: ${
                  pwvPblhAnalysis.pblh_category === '非常に良好' || pwvPblhAnalysis.pblh_category === '良好' ? '#4caf50' :
                  pwvPblhAnalysis.pblh_category === 'やや良好' || pwvPblhAnalysis.pblh_category === '普通' ? '#ff9800' :
                  '#d32f2f'
                };">(${pwvPblhAnalysis.pblh_category})</span></div>` : ''}
                ${pwvPblhAnalysis.risk_level ? `<div style="margin-top: 4px; padding: 4px 8px; background: ${
                  pwvPblhAnalysis.risk_level === '理想的条件' ? '#c8e6c9' :
                  pwvPblhAnalysis.risk_level === '良好な条件' ? '#dcedc8' :
                  pwvPblhAnalysis.risk_level.includes('海霧') ? '#ffcdd2' :
                  '#fff9c4'
                }; border-radius: 4px; font-weight: bold;">
                  ${pwvPblhAnalysis.sea_fog_risk ? '⚠️ ' : ''}${pwvPblhAnalysis.risk_level}
                </div>` : ''}
              </div>
            </div>
          ` : ''}
          ${basicWeatherTableHTML}
        </div>
      `;

      // 専門家向け詳細表示
      const expertHTML = `
        <div style="background: #f3e5f5; border-radius: 8px; padding: 15px; border: 1px solid #9c27b0;">
          <h5 style="color: #7b1fa2; margin-bottom: 15px;">🔬 専門家向け段階別分析</h5>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div style="background: white; padding: 12px; border-radius: 6px;">
              <h6 style="color: #1976d2; margin: 0 0 8px 0;">換気段階 (4:00-10:00)</h6>
              <div>スコア: ${stageAnalysis.ventilation_stage_score || '--'}/100</div>
              <div style="font-size: 12px; color: #666;">
                平均風速: ${stageAnalysis.stage_breakdown?.ventilation_period?.avg_wind_speed || '--'} m/s
              </div>
            </div>

            <div style="background: white; padding: 12px; border-radius: 6px;">
              <h6 style="color: #f57c00; margin: 0 0 8px 0;">熱供給段階 (10:00-16:00)</h6>
              <div>スコア: ${stageAnalysis.heat_supply_stage_score || '--'}/100</div>
              <div style="font-size: 12px; color: #666;">
                平均気温: ${stageAnalysis.stage_breakdown?.heat_supply_period?.avg_temperature || '--'}°C
              </div>
            </div>
          </div>

          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h6 style="color: #7b1fa2; margin: 0 0 8px 0;">重み付け設定</h6>
            <div style="font-size: 12px;">
              風重視: ${Math.round((stageAnalysis.time_weights?.wind_weight || 0.7) * 100)}% |
              熱重視: ${Math.round((stageAnalysis.time_weights?.solar_weight || 0.3) * 100)}%
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
              予測時間: ${stageAnalysis.estimated_drying_hours || '--'}時間
            </div>
          </div>

          <div style="background: #fff8e1; padding: 12px; border-radius: 6px; border: 1px solid #ffcc02;">
            <h6 style="color: #e65100; margin: 0 0 12px 0;">🌪️ 高度気象パラメータ (1時間刻み推移)</h6>

            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
              <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                <thead style="background: #f5f5f5; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">時刻</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">PWV<br>(mm)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">PBLH<br>(m)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">鉛直p速度<br>(700hPa)<br>(Pa/s)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">SSI</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">相当温位<br>(850hPa)<br>(K)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">相対渦度<br>(500hPa)<br>(×10⁻⁵ s⁻¹)</th>
                  </tr>
                </thead>
                <tbody>
                  ${hourlyAllData.map(hour => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 4px; text-align: center; font-weight: bold;">${hour.time}</td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.pwv}</div>
                        <div style="font-size: 8px; color: ${
                          hour.pwvCategory === '非常に乾燥' || hour.pwvCategory === '乾燥' ? '#4caf50' :
                          hour.pwvCategory === 'やや乾燥' || hour.pwvCategory === '普通' ? '#ff9800' :
                          hour.pwvCategory === 'やや湿潤' || hour.pwvCategory === '湿潤' ? '#f44336' :
                          hour.pwvCategory === '非常に湿潤' ? '#d32f2f' : '#666'
                        };">${hour.pwvCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.pblh}</div>
                        <div style="font-size: 8px; color: ${
                          hour.pblhCategory === '非常に良好' || hour.pblhCategory === '良好' ? '#4caf50' :
                          hour.pblhCategory === 'やや良好' || hour.pblhCategory === '普通' ? '#ff9800' :
                          hour.pblhCategory === 'やや不良' || hour.pblhCategory === '不良' ? '#f44336' :
                          hour.pblhCategory === '海霧リスク' ? '#d32f2f' : '#666'
                        };">${hour.pblhCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center; color: ${hour.verticalVel !== '--' && parseFloat(hour.verticalVel) > 0 ? '#d32f2f' : '#1976d2'};">
                        ${hour.verticalVel}
                      </td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.ssi}</div>
                        <div style="font-size: 8px; color: ${
                          hour.ssiCategory === '安定' ? '#4caf50' :
                          hour.ssiCategory === '中性' ? '#ff9800' :
                          hour.ssiCategory === 'やや不安定' ? '#f44336' :
                          hour.ssiCategory === '不安定' ? '#d32f2f' : '#666'
                        };">${hour.ssiCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center;">${hour.equivTemp}</td>
                      <td style="padding: 4px; text-align: center; color: ${hour.vorticity !== '--' && parseFloat(hour.vorticity) > 0 ? '#d32f2f' : hour.vorticity !== '--' && parseFloat(hour.vorticity) < 0 ? '#1976d2' : '#333'};">
                        ${hour.vorticity}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div style="font-size: 9px; color: #666; margin-top: 8px; text-align: center;">
              ※ 高層大気解析データ (4:00-16:00) | 🔴正値=下降気流・サイクロン性 🔵負値=上昇気流・アンチサイクロン性
            </div>
          </div>
        </div>
      `;

      // 仕様書に従った予報表示を作成
      contentContainer.innerHTML = `
        <div style="padding: 20px;">
          <h4 style="color: #2c5f2d; margin-bottom: 20px; text-align: center;">
            📅 ${dateStr} の詳細予報
          </h4>

          ${safetyWarningsHTML}

          ${longTermWarningHTML}

          <!-- タブ切り替えナビゲーション -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; border-bottom: 2px solid #e0e0e0;">
              <button
                id="fisher-tab"
                onclick="switchForecastTab('fisher')"
                style="flex: 1; padding: 12px; border: none; background: #4caf50; color: white; cursor: pointer; border-radius: 8px 0 0 0; font-weight: bold;">
                🎣 一般漁師向け
              </button>
              <button
                id="expert-tab"
                onclick="switchForecastTab('expert')"
                style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 0 8px 0 0; font-weight: bold;">
                🔬 専門家向け
              </button>
            </div>
          </div>

          <!-- タブコンテンツ -->
          <div id="fisher-content" style="display: block;">
            ${fisherHTML}
          </div>

          <div id="expert-content" style="display: none;">
            ${expertHTML}
          </div>


          <!-- 総合判定セクション -->
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
            <h5 style="color: #2c5f2d; margin-bottom: 10px;">🎯 総合判定</h5>
            <div style="font-size: 16px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 8px;">
              ${targetForecast.daily_summary.estimated_drying_time}
            </div>
            <div>信頼度: ${reliabilityData.accuracy || '--'}%</div>
            <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">乾燥適性: ${targetForecast.daily_summary.suitability}</div>
          </div>

          <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
            <p style="font-size: 12px; color: #666; margin: 0;">
              ✅ 地形補正・段階別乾燥判定システム適用済み | 📊 利尻島昆布干し特化予報
            </p>
          </div>
        </div>
      `;
    }

    // タブ切り替え関数
    function switchForecastTab(tabType) {
      // タブボタンのスタイルを更新
      const fisherTab = document.getElementById('fisher-tab');
      const expertTab = document.getElementById('expert-tab');
      const fisherContent = document.getElementById('fisher-content');
      const expertContent = document.getElementById('expert-content');

      if (tabType === 'fisher') {
        // 一般漁師向けタブを有効化
        fisherTab.style.background = '#4caf50';
        fisherTab.style.color = 'white';
        expertTab.style.background = '#e0e0e0';
        expertTab.style.color = '#666';

        // コンテンツの表示/非表示
        fisherContent.style.display = 'block';
        expertContent.style.display = 'none';
      } else if (tabType === 'expert') {
        // 専門家向けタブを有効化
        expertTab.style.background = '#9c27b0';
        expertTab.style.color = 'white';
        fisherTab.style.background = '#e0e0e0';
        fisherTab.style.color = '#666';

        // コンテンツの表示/非表示
        expertContent.style.display = 'block';
        fisherContent.style.display = 'none';
      }
    }

    function generateTempHumiditySection(hourlyData, dateStr) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">🌡️ 基本気象情報 (4:00〜16:00)</h5>
            <p style="color: #666; text-align: center;">データ取得中...</p>
          </div>
        `;
      }
      
      // 4:00-16:00のデータを抽出
      const targetHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 4 && hour <= 16) {
          targetHours.push({
            time: timeStr,
            hour: hour,
            temp: hourlyData.temperature_2m ? hourlyData.temperature_2m[i] : null,
            humidity: hourlyData.relative_humidity_2m ? hourlyData.relative_humidity_2m[i] : null
          });
        }
      }
      
      let tempChartHTML = '';
      let humidityChartHTML = '';
      
      if (targetHours.length > 0) {
        // 気温チャート作成
        const tempValues = targetHours.map(h => h.temp).filter(t => t !== null);
        const minTemp = Math.min(...tempValues);
        const maxTemp = Math.max(...tempValues);
        
        tempChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>4:00</span><span>8:00</span><span>12:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #ff9800, #ffc107); height: ${h.temp ? ((h.temp - minTemp) / (maxTemp - minTemp + 1)) * 100 : 0}%; min-height: 3px; border-radius: 2px;" title="${h.temp}°C"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #333; margin-top: 3px;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `<span>${h.temp || '--'}°C</span>`).join('')}
            </div>
          </div>
        `;
        
        // 湿度チャート作成
        const humidityValues = targetHours.map(h => h.humidity).filter(h => h !== null);
        const avgHumidity = humidityValues.reduce((a, b) => a + b, 0) / humidityValues.length;
        const maxHumidity = Math.max(...humidityValues);
        
        const humidityRisk = maxHumidity >= 85 ? '⚠️ 高湿度警報' : 
                           avgHumidity >= 80 ? '⚡ 注意' : '✅ 良好';
        const humidityColor = maxHumidity >= 85 ? '#f44336' :
                            avgHumidity >= 80 ? '#ff9800' : '#4caf50';
        
        humidityChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>4:00</span><span>8:00</span><span>12:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #2196f3, #03a9f4); height: ${h.humidity || 0}%; min-height: 3px; border-radius: 2px;" title="${h.humidity}%"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #333; margin-top: 3px;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `<span>${h.humidity || '--'}%</span>`).join('')}
            </div>
            <div style="margin-top: 8px; padding: 5px; background: ${humidityColor}22; border-left: 3px solid ${humidityColor}; border-radius: 3px;">
              <span style="color: ${humidityColor}; font-weight: bold; font-size: 12px;">${humidityRisk}</span>
              <span style="color: #666; font-size: 11px; margin-left: 8px;">平均: ${Math.round(avgHumidity)}%</span>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">🌡️ 基本気象情報 (4:00〜16:00)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>気温推移</strong>
              ${tempChartHTML}
            </div>
            <div>
              <strong>湿度推移</strong>
              ${humidityChartHTML}
            </div>
          </div>
        </div>
      `;
    }

    function generateWindSection(hourlyData, dateStr, lat, lon) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #e8f5e8;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">💨 換気重視期間 (4:00〜10:00)</h5>
            <p style="color: #666; text-align: center;">データ取得中...</p>
          </div>
        `;
      }
      
      // 4:00-10:00のデータを抽出
      const windHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 4 && hour <= 10) {
          const windDirection = hourlyData.wind_direction_10m ? hourlyData.wind_direction_10m[i] : null;
          const windSpeed = hourlyData.wind_speed_10m ? hourlyData.wind_speed_10m[i] : null;
          
          windHours.push({
            time: timeStr,
            hour: hour,
            direction: windDirection,
            speed: windSpeed,
            traditionName: getTraditionalWindName(windDirection),
            angleFromSpot: calculateAngleFromSpot(windDirection, lat, lon)
          });
        }
      }
      
      let windChartHTML = '';
      let windAnalysisHTML = '';
      
      if (windHours.length > 0) {
        // 風速の評価
        const avgWindSpeed = windHours.reduce((sum, h) => sum + (h.speed || 0), 0) / windHours.length;
        const goodWindCount = windHours.filter(h => h.speed >= 1.5).length;
        const windQuality = goodWindCount >= windHours.length * 0.7 ? '✅ 良好' : 
                          goodWindCount >= windHours.length * 0.4 ? '⚡ 普通' : '⚠️ 弱風';
        const windColor = goodWindCount >= windHours.length * 0.7 ? '#4caf50' :
                        goodWindCount >= windHours.length * 0.4 ? '#ff9800' : '#f44336';
        
        // 風向・風速チャート
        windChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `<span>${h.hour}:00</span>`).join('')}
            </div>
            <div style="display: flex; gap: 3px; height: 40px; align-items: end; margin-bottom: 5px;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="background: ${h.speed >= 1.5 ? '#4caf50' : '#ff5722'}; height: ${Math.min((h.speed || 0) * 8, 40)}px; width: 100%; min-height: 3px; border-radius: 2px; margin-bottom: 2px;" title="${h.speed}m/s"></div>
                  <span style="font-size: 9px; transform: rotate(${h.direction || 0}deg);">↑</span>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `<span>${h.speed || '--'}m/s</span>`).join('')}
            </div>
          </div>
        `;
        
        // 利尻島伝統風名表示
        const uniqueWindNames = [...new Set(windHours.map(h => h.traditionName).filter(n => n))];
        const windNameHTML = uniqueWindNames.length > 0 ? uniqueWindNames.join('、') : '不明';
        
        windAnalysisHTML = `
          <div style="margin-top: 10px; padding: 8px; background: ${windColor}22; border-left: 3px solid ${windColor}; border-radius: 3px;">
            <div style="color: ${windColor}; font-weight: bold; font-size: 12px; margin-bottom: 3px;">${windQuality}</div>
            <div style="font-size: 11px; color: #666;">
              <div>平均風速: ${avgWindSpeed.toFixed(1)}m/s</div>
              <div>主風向: ${windNameHTML}</div>
              <div>適正時間: ${goodWindCount}/${windHours.length}時間</div>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #e8f5e8;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">💨 換気重視期間 (4:00〜10:00)</h5>
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div>
              <strong>風速・風向推移</strong>
              ${windChartHTML}
            </div>
            <div>
              <strong>風況評価</strong>
              ${windAnalysisHTML}
            </div>
          </div>
        </div>
      `;
    }

    function getTraditionalWindName(direction) {
      if (direction === null || direction === undefined) return '不明';
      
      // 利尻島伝統風名マッピング（仕様書準拠）
      const windNames = [
        { min: 348.75, max: 11.25, name: 'アイ' },
        { min: 11.25, max: 33.75, name: 'アイシモ・シモ' },
        { min: 33.75, max: 56.25, name: 'シモ' },
        { min: 56.25, max: 78.75, name: 'シモヤマセ' },
        { min: 78.75, max: 101.25, name: 'ホンヤマセ' },
        { min: 101.25, max: 123.75, name: 'ヤマセ' },
        { min: 123.75, max: 146.25, name: 'ミナミヤマセ' },
        { min: 146.25, max: 168.75, name: 'ミナミヤマ' },
        { min: 168.75, max: 191.25, name: 'クダリ' },
        { min: 191.25, max: 213.75, name: 'クダリヒカタ' },
        { min: 213.75, max: 236.25, name: 'ヒカタ' },
        { min: 236.25, max: 258.75, name: 'ニシヒカタ' },
        { min: 258.75, max: 281.25, name: 'ニシ' },
        { min: 281.25, max: 303.75, name: 'ニシタマ' },
        { min: 303.75, max: 326.25, name: 'タマ' },
        { min: 326.25, max: 348.75, name: 'アイタマ' }
      ];
      
      for (const wind of windNames) {
        if (wind.min > wind.max) { // 北風の場合（0度をまたぐ）
          if (direction >= wind.min || direction <= wind.max) {
            return wind.name;
          }
        } else {
          if (direction >= wind.min && direction <= wind.max) {
            return wind.name;
          }
        }
      }
      
      return '不明';
    }

    function calculateAngleFromSpot(windDirection, lat, lon) {
      if (windDirection === null || windDirection === undefined) return null;
      
      // 利尻山の座標（θ値計算用）
      const RISHIRI_SAN_LAT = 45.1821;
      const RISHIRI_SAN_LON = 141.2421;
      
      // 簡易的な干場θ値計算
      const deltaLon = lon - RISHIRI_SAN_LON;
      const deltaLat = lat - RISHIRI_SAN_LAT;
      let spotTheta = Math.atan2(deltaLon, deltaLat) * 180 / Math.PI;
      if (spotTheta < 0) spotTheta += 360;
      
      // 風向との角度差を計算
      let angleDiff = Math.abs(windDirection - spotTheta);
      if (angleDiff > 180) angleDiff = 360 - angleDiff;
      
      return Math.round(angleDiff);
    }

    function generateSolarSection(hourlyData, dateStr) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff3e0;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">☀️ 熱供給重視期間 (10:00〜16:00)</h5>
            <p style="color: #666; text-align: center;">データ取得中...</p>
          </div>
        `;
      }
      
      // 10:00-16:00のデータを抽出
      const solarHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 10 && hour <= 16) {
          solarHours.push({
            time: timeStr,
            hour: hour,
            solar: hourlyData.shortwave_radiation ? hourlyData.shortwave_radiation[i] : null,
            cloud: hourlyData.cloud_cover ? hourlyData.cloud_cover[i] : null,
            temp: hourlyData.temperature_2m ? hourlyData.temperature_2m[i] : null
          });
        }
      }
      
      let solarChartHTML = '';
      let cloudChartHTML = '';
      
      if (solarHours.length > 0) {
        // 日射量評価
        const avgSolar = solarHours.reduce((sum, h) => sum + (h.solar || 0), 0) / solarHours.length;
        const avgCloud = solarHours.reduce((sum, h) => sum + (h.cloud || 0), 0) / solarHours.length;
        
        const solarQuality = avgSolar >= 600 ? '✅ 強い' :
                           avgSolar >= 300 ? '⚡ 普通' : '⚠️ 弱い';
        const solarColor = avgSolar >= 600 ? '#ff9800' :
                         avgSolar >= 300 ? '#ffc107' : '#757575';
        
        // 日射量チャート
        solarChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>10:00</span><span>12:00</span><span>14:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #ff9800, #ffc107); height: ${Math.min((h.solar || 0) / 10, 30)}px; min-height: 3px; border-radius: 2px;" title="${h.solar}W/m²"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-top: 3px;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `<span>${h.solar || '--'}</span>`).join('')}
            </div>
          </div>
        `;
        
        // 雲量チャート
        cloudChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #78909c, #90a4ae); height: ${h.cloud || 0}%; min-height: 3px; border-radius: 2px;" title="${h.cloud}%"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-top: 3px;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `<span>${h.cloud || '--'}%</span>`).join('')}
            </div>
            <div style="margin-top: 8px; padding: 5px; background: ${solarColor}22; border-left: 3px solid ${solarColor}; border-radius: 3px;">
              <span style="color: ${solarColor}; font-weight: bold; font-size: 12px;">${solarQuality}</span>
              <span style="color: #666; font-size: 11px; margin-left: 8px;">平均雲量: ${Math.round(avgCloud)}%</span>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff3e0;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">☀️ 熱供給重視期間 (10:00〜16:00)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>日射量 (W/m²)</strong>
              ${solarChartHTML}
            </div>
            <div>
              <strong>雲量 (%)</strong>
              ${cloudChartHTML}
            </div>
          </div>
        </div>
      `;
    }

    function generateDryingAnalysis(analysisData, hourlyData, dateStr) {
      // 乾燥適合度を総合的に判定
      let dryingScore = 0;
      let analysisText = [];
      let completionTime = '不明';
      let riskFactors = [];
      
      if (hourlyData && hourlyData.time) {
        // 湿度リスク評価
        const humidityValues = [];
        const windValues = [];
        const solarValues = [];
        
        for (let i = 0; i < hourlyData.time.length; i++) {
          const timeStr = hourlyData.time[i];
          if (timeStr.includes(dateStr)) {
            const hour = new Date(timeStr).getHours();
            if (hour >= 4 && hour <= 16) {
              if (hourlyData.relative_humidity_2m && hourlyData.relative_humidity_2m[i] !== null) {
                humidityValues.push(hourlyData.relative_humidity_2m[i]);
              }
              if (hourlyData.wind_speed_10m && hourlyData.wind_speed_10m[i] !== null) {
                windValues.push(hourlyData.wind_speed_10m[i]);
              }
              if (hour >= 10 && hourlyData.shortwave_radiation && hourlyData.shortwave_radiation[i] !== null) {
                solarValues.push(hourlyData.shortwave_radiation[i]);
              }
            }
          }
        }
        
        // 湿度評価（40点満点）
        const maxHumidity = humidityValues.length > 0 ? Math.max(...humidityValues) : 100;
        const avgHumidity = humidityValues.length > 0 ? humidityValues.reduce((a, b) => a + b) / humidityValues.length : 100;
        
        if (maxHumidity < 70) {
          dryingScore += 40;
          analysisText.push('✅ 湿度条件良好');
        } else if (maxHumidity < 85) {
          dryingScore += 25;
          analysisText.push('⚡ 湿度条件普通');
        } else {
          dryingScore += 5;
          analysisText.push('⚠️ 高湿度リスク');
          riskFactors.push('高湿度');
        }
        
        // 風速評価（30点満点）
        const avgWind = windValues.length > 0 ? windValues.reduce((a, b) => a + b) / windValues.length : 0;
        const goodWindHours = windValues.filter(w => w >= 1.5).length;
        
        if (avgWind >= 2.0 && goodWindHours >= windValues.length * 0.7) {
          dryingScore += 30;
          analysisText.push('✅ 風況良好');
        } else if (avgWind >= 1.5) {
          dryingScore += 20;
          analysisText.push('⚡ 風況普通');
        } else {
          dryingScore += 5;
          analysisText.push('⚠️ 弱風');
          riskFactors.push('風速不足');
        }
        
        // 日射評価（30点満点）
        const avgSolar = solarValues.length > 0 ? solarValues.reduce((a, b) => a + b) / solarValues.length : 0;
        
        if (avgSolar >= 500) {
          dryingScore += 30;
          analysisText.push('✅ 日射量良好');
          completionTime = '午後2時頃';
        } else if (avgSolar >= 300) {
          dryingScore += 20;
          analysisText.push('⚡ 日射量普通');
          completionTime = '午後3時頃';
        } else {
          dryingScore += 10;
          analysisText.push('⚠️ 日射量不足');
          completionTime = '夕方以降';
          riskFactors.push('日射量不足');
        }
      }
      
      // 総合判定
      let overallStatus = '';
      let statusIcon = '';
      let statusColor = '';
      
      if (dryingScore >= 80) {
        overallStatus = '非常に良好';
        statusIcon = '🌟';
        statusColor = '#4caf50';
      } else if (dryingScore >= 60) {
        overallStatus = '良好';
        statusIcon = '✅';
        statusColor = '#8bc34a';
      } else if (dryingScore >= 40) {
        overallStatus = '要注意';
        statusIcon = '⚡';
        statusColor = '#ff9800';
      } else {
        overallStatus = '不適';
        statusIcon = '⚠️';
        statusColor = '#f44336';
      }
      
      const riskText = riskFactors.length > 0 ? 
        `<div style="margin-top: 8px; padding: 5px; background: #ffebee; border-left: 3px solid #f44336; border-radius: 3px;">
          <span style="color: #f44336; font-size: 11px;">⚠️ リスク要因: ${riskFactors.join('、')}</span>
        </div>` : '';
      
      return `
        <div style="border: 2px solid ${statusColor}; border-radius: 8px; padding: 15px; background: ${statusColor}11;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">🎯 科学的乾燥予測</h5>
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${statusIcon}</div>
            <p style="font-size: 20px; font-weight: bold; color: #2c5f2d; margin-bottom: 10px;">
              乾燥適合度: <span style="color: ${statusColor};">${overallStatus}</span>
            </p>
            <p style="font-size: 16px; color: ${statusColor}; margin-bottom: 5px;">
              スコア: ${dryingScore}/100点
            </p>
            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
              予測完了時間: ${completionTime}
            </p>
            <div style="text-align: left; margin-top: 15px;">
              ${analysisText.map(text => `<div style="font-size: 12px; color: #333; margin: 2px 0;">• ${text}</div>`).join('')}
            </div>
            ${riskText}
          </div>
        </div>
      `;
    }

    // 記録ダイアログを開く関数（仕様書準拠）
    function openRecordDialog(spotName) {
      console.log('記録ダイアログを開く:', spotName);
      
      // Step 1: 日付選択ダイアログ
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">${spotName} の記録</h3>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 10px 0; color: #856404;">
              <strong>⚠️ 注意:</strong> 日付の入力間違いは機械学習に負の影響を及ぼすので注意してください
            </div>
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">日付を選択:</label>
            
            <!-- 年選択 -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">年:</label>
              <div id="yearContainer" style="display: flex; gap: 5px; flex-wrap: wrap;">
                <!-- 年ボタンが動的に生成されます -->
              </div>
            </div>
            
            <!-- 月選択 -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">月:</label>
              <div id="monthContainer" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;">
                <!-- 月ボタンが動的に生成されます -->
              </div>
            </div>
            
            <!-- 日選択 -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">日:</label>
              <div id="dayContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; max-height: 120px; overflow-y: auto;">
                <!-- 日ボタンが動的に生成されます -->
              </div>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 10px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 4px;">
              選択された日付: <span id="selectedDateDisplay">未選択</span>
            </div>
            <button onclick="window.checkExistingRecord('${spotName}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">次へ</button>
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 5px 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">キャンセル</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
      
      // 日付ボタンを生成
      generateDateButtons();
      
      // 日付入力のイベントリスナーを設定
      setTimeout(() => {
        const dateInput = document.getElementById('recordDate');
        const nextButton = document.querySelector('#recordDialog button[onclick*="checkExistingRecord"]');
        
        if (dateInput && nextButton) {
          // 日付フィールドを完全にクリア
          dateInput.value = '';
          nextButton.disabled = true;
          nextButton.style.background = '#ccc';
          nextButton.textContent = '日付を選択してください';
          
          console.log('日付入力フィールドが準備されました（初期値クリア）');
          console.log('初期状態の日付値:', dateInput.value);
          
          // 今日の日付を取得
          const today = new Date();
          const todayString = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
          
          console.log('今日の日付基準:', todayString);
          
          // 日付変更時のイベントリスナーを追加
          function updateButton() {
            console.log('updateButton呼び出し - 現在の値:', dateInput.value);
            console.log('値の存在チェック:', !!dateInput.value);
            console.log('値の長さ:', dateInput.value.length);
            
            if (dateInput.value && dateInput.value.length > 0) {
              // 未来の日付チェック
              if (dateInput.value > todayString) {
                nextButton.disabled = true;
                nextButton.style.background = '#ff5722';
                nextButton.textContent = '未来の日付は選択できません';
                console.log('未来の日付が選択されました:', dateInput.value);
              } else {
                nextButton.disabled = false;
                nextButton.style.background = '#4caf50';
                nextButton.textContent = '次へ';
                console.log('有効な日付が選択されました:', dateInput.value);
              }
            } else {
              nextButton.disabled = true;
              nextButton.style.background = '#ccc';
              nextButton.textContent = '日付を選択してください';
              console.log('日付が空です');
            }
          }
          
          dateInput.addEventListener('change', function(e) {
            console.log('change イベント発生:', e.target.value);
            updateButton();
          });
          
          dateInput.addEventListener('input', function(e) {
            console.log('input イベント発生:', e.target.value);
            updateButton();
          });
          
          // 追加のイベントリスナー
          dateInput.addEventListener('blur', function(e) {
            console.log('blur イベント発生:', e.target.value);
            updateButton();
          });
          
          dateInput.addEventListener('keyup', function(e) {
            console.log('keyup イベント発生:', e.target.value);
            updateButton();
          });
          
          // ポーリングで値の変化を監視（より頻繁に）
          let lastValue = '';
          const checkValue = setInterval(() => {
            if (dateInput.value !== lastValue) {
              console.log('ポーリング検知 - 値変更:', lastValue, '->', dateInput.value);
              lastValue = dateInput.value;
              updateButton();
            }
          }, 100); // 500ms -> 100msに変更
          
          // ダイアログが閉じられた時にポーリングを停止
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList') {
                mutation.removedNodes.forEach((node) => {
                  if (node.id === 'recordDialog') {
                    clearInterval(checkValue);
                    observer.disconnect();
                  }
                });
              }
            });
          });
          observer.observe(document.body, { childList: true });
          
          // 初期状態をチェック
          updateButton();
        }
      }, 10);
    }
    
    // 既存記録をチェックする関数
    function checkExistingRecord(spotName) {
      const selectedDate = window.selectedRecordDate;
      console.log('選択された日付:', selectedDate);
      
      if (!selectedDate) {
        alert('日付を選択してください');
        console.log('日付が選択されていません');
        return;
      }
      
      // 未来の日付チェック
      const today = new Date();
      const todayString = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
      
      if (selectedDate > todayString) {
        alert('未来の日付は記録できません。過去または今日の日付を選択してください。');
        console.log('未来の日付が選択されました:', selectedDate);
        return;
      }
      
      console.log('既存記録チェック:', spotName, selectedDate);
      console.log('選択された日付の詳細確認:', selectedDate);
      
      // 既存記録をチェック
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}&date=${selectedDate}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.record) {
            // 既存記録が存在する場合
            showExistingRecordDialog(spotName, selectedDate, data.record.result);
          } else {
            // 新規記録の場合
            showRecordOptionsDialog(spotName, selectedDate);
          }
        })
        .catch(error => {
          console.error('記録チェックエラー:', error);
          // エラーの場合も新規記録として進める
          showRecordOptionsDialog(spotName, selectedDate);
        });
    }
    
    // 既存記録確認ダイアログ
    function showExistingRecordDialog(spotName, date, existingResult) {
      closeRecordDialog();
      
      console.log('showExistingRecordDialog呼び出し - 受信した日付:', date);
      
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">記録が存在します</h3>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 10px; margin: 10px 0;">
              <strong>地点:</strong> ${spotName}<br>
              <strong>日付:</strong> ${date}<br>
              <strong>既存記録:</strong> ${existingResult}
            </div>
            <p style="font-size: 12px; color: #666;">デバッグ: 受信した日付 = ${date}</p>
            <button onclick="window.showRecordOptionsDialog('${spotName}', '${date}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">記録を変更</button>
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 5px 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">キャンセル</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // 記録選択肢ダイアログ（仕様書準拠の3択）
    function showRecordOptionsDialog(spotName, date) {
      closeRecordDialog();
      
      console.log('showRecordOptionsDialog呼び出し - 受信した日付:', date);
      
      const recordOptions = [
        '完全乾燥',
        '中止',
        '干したが完全には乾かせなかった（泣）'
      ];
      
      let optionsHtml = '';
      recordOptions.forEach((option) => {
        optionsHtml += `<button onclick="window.submitRecord('${spotName}', '${date}', '${option}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">${option}</button>`;
      });
      
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">${spotName} の記録</h3>
            <p><strong>日付:</strong> ${date}</p>
            <p style="font-size: 12px; color: #666;">デバッグ: 受信した日付 = ${date}</p>
            <p>乾燥結果を選択してください：</p>
            ${optionsHtml}
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 10px 0 0 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">キャンセル</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // 記録を送信する関数
    function submitRecord(spotName, date, result) {
      console.log('記録送信:', spotName, date, result);
      console.log('送信される日付の確認:', date);
      console.log('日付のタイプ:', typeof date);
      
      fetch(`${API_BASE}/record`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          date: date,
          name: spotName,
          result: result
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('記録送信結果:', data);
        if (data.status === 'success') {
          alert(`記録が保存されました！\n\n地点: ${spotName}\n日付: ${date}\n結果: ${result}\n\n機械学習モデルが自動でアップデートされました。`);
        } else {
          alert('記録の保存に失敗しました: ' + data.message);
        }
        closeRecordDialog();
      })
      .catch(error => {
        console.error('記録送信エラー:', error);
        alert('記録の送信中にエラーが発生しました');
        closeRecordDialog();
      });
    }
    
    // 日付選択UI変数
    let selectedYear = null;
    let selectedMonth = null;
    let selectedDay = null;

    // 日付選択UIを生成する関数
    function generateDateButtons() {
      generateYearButtons();
      generateMonthButtons();
      updateDateDisplay();
    }
    
    // 年ボタンを生成
    function generateYearButtons() {
      const container = document.getElementById('yearContainer');
      if (!container) return;
      
      const currentYear = new Date().getFullYear();
      const years = [currentYear - 1, currentYear]; // 昨年と今年
      
      const buttons = years.map(year => 
        `<button type="button" onclick="window.selectYear(${year})" id="year-${year}"
                 style="padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
           ${year}年
         </button>`
      ).join('');
      
      container.innerHTML = buttons;
    }
    
    // 月ボタンを生成
    function generateMonthButtons() {
      const container = document.getElementById('monthContainer');
      if (!container) return;
      
      const months = Array.from({length: 12}, (_, i) => i + 1);
      
      const buttons = months.map(month => 
        `<button type="button" onclick="window.selectMonth(${month})" id="month-${month}"
                 style="padding: 6px; background: #666; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
           ${month}月
         </button>`
      ).join('');
      
      container.innerHTML = buttons;
    }
    
    // 日ボタンを生成
    function generateDayButtons() {
      const container = document.getElementById('dayContainer');
      if (!container || !selectedYear || !selectedMonth) return;
      
      // 該当月の日数を取得
      const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
      const today = new Date();
      
      const buttons = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(selectedYear, selectedMonth - 1, day);
        const isValidDate = dateObj <= today; // 未来の日付は無効
        
        const buttonStyle = isValidDate 
          ? "padding: 6px; background: #666; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;"
          : "padding: 6px; background: #ccc; color: #999; border: none; border-radius: 3px; font-size: 11px; cursor: not-allowed;";
        
        const onClick = isValidDate ? `onclick="window.selectDay(${day})"` : '';
        
        buttons.push(
          `<button type="button" ${onClick} id="day-${day}" style="${buttonStyle}">
             ${day}
           </button>`
        );
      }
      
      container.innerHTML = buttons.join('');
    }
    
    // 年を選択
    function selectYear(year) {
      selectedYear = year;
      
      // 年ボタンの色をリセット・更新
      document.querySelectorAll('[id^="year-"]').forEach(btn => btn.style.background = '#666');
      document.getElementById(`year-${year}`).style.background = '#2196f3';
      
      console.log('年が選択されました:', year);
      generateDayButtons();
      updateDateDisplay();
    }
    
    // 月を選択
    function selectMonth(month) {
      selectedMonth = month;
      
      // 月ボタンの色をリセット・更新
      document.querySelectorAll('[id^="month-"]').forEach(btn => btn.style.background = '#666');
      document.getElementById(`month-${month}`).style.background = '#4caf50';
      
      console.log('月が選択されました:', month);
      generateDayButtons();
      updateDateDisplay();
    }
    
    // 日を選択
    function selectDay(day) {
      selectedDay = day;
      
      // 日ボタンの色をリセット・更新
      document.querySelectorAll('[id^="day-"]').forEach(btn => {
        if (btn.style.background !== 'rgb(204, 204, 204)') { // 無効な日付でなければ
          btn.style.background = '#666';
        }
      });
      document.getElementById(`day-${day}`).style.background = '#ff9800';
      
      console.log('日が選択されました:', day);
      updateDateDisplay();
    }
    
    // 日付表示を更新
    function updateDateDisplay() {
      const displayElement = document.getElementById('selectedDateDisplay');
      const nextButton = document.querySelector('#recordDialog button[onclick*="checkExistingRecord"]');
      
      if (selectedYear && selectedMonth && selectedDay) {
        const year = selectedYear;
        const month = String(selectedMonth).padStart(2, '0');
        const day = String(selectedDay).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        // 表示更新
        displayElement.textContent = `${selectedYear}年${selectedMonth}月${selectedDay}日`;
        displayElement.style.color = '#2c5f2d';
        displayElement.style.fontWeight = 'bold';
        
        // 内部的に日付を保存
        window.selectedRecordDate = dateString;
        console.log('完全な日付が選択されました:', dateString);
        
        // 次へボタンを有効化
        if (nextButton) {
          nextButton.disabled = false;
          nextButton.style.background = '#4caf50';
          nextButton.textContent = '次へ';
        }
      } else {
        displayElement.textContent = '未選択';
        displayElement.style.color = '#666';
        displayElement.style.fontWeight = 'normal';
        
        // 次へボタンを無効化
        if (nextButton) {
          nextButton.disabled = true;
          nextButton.style.background = '#ccc';
          nextButton.textContent = '年・月・日を選択してください';
        }
      }
    }
    
    // 干場削除確認ダイアログ
    function confirmDeleteSpot(spotName, lat, lon) {
      console.log('削除確認ダイアログを開く:', spotName);
      
      // まず記録の存在をチェック
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}`)
        .then(response => response.json())
        .then(data => {
          if (data.has_records) {
            // 記録がある場合は削除不可のダイアログを表示
            showCannotDeleteDialog(spotName, lat, lon);
          } else {
            // 記録がない場合は削除確認ダイアログを表示
            showDeleteConfirmDialog(spotName, lat, lon);
          }
        })
        .catch(error => {
          console.error('記録チェックエラー:', error);
          // エラーの場合も削除確認ダイアログを表示
          showDeleteConfirmDialog(spotName, lat, lon);
        });
    }
    
    // 削除不可ダイアログ
    function showCannotDeleteDialog(spotName, lat, lon) {
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="deleteDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #f44336;">❌ 削除できません</h3>
            <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0;">
              <p style="margin: 0; color: #c62828;"><strong>対象干場:</strong></p>
              <p style="margin: 5px 0 0 0; font-weight: bold;">${spotName}</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">座標: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
            </div>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 15px; margin: 15px 0; color: #1976d2;">
              <strong>削除できない理由:</strong><br>
              この干場にはhoshiba_records.csv内に記録が存在します。<br><br>
              記録がある干場は削除できません。
            </div>
            <button onclick="window.closeDeleteDialog()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">了解</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // 削除確認ダイアログ
    function showDeleteConfirmDialog(spotName, lat, lon) {
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="deleteDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #f44336;">⚠️ 干場削除の確認</h3>
            <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0;">
              <p style="margin: 0; color: #c62828;"><strong>削除対象:</strong></p>
              <p style="margin: 5px 0 0 0; font-weight: bold;">${spotName}</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">座標: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
            </div>
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 15px 0; color: #2e7d32;">
              ✅ <strong>削除可能:</strong> この干場には記録がありません
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin: 15px 0; color: #856404;">
              <strong>注意:</strong> 削除された干場は以下のファイルから完全に除去されます：
              <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                <li>hoshiba_spots.csv</li>
                <li>hoshiba_spots_named.kml</li>
              </ul>
              この操作は取り消せません。
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button onclick="window.deleteSpot('${spotName}')" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">削除実行</button>
              <button onclick="window.closeDeleteDialog()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">キャンセル</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // 干場削除実行
    function deleteSpot(spotName) {
      console.log('干場削除実行:', spotName);
      
      fetch(`${API_BASE}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: spotName
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('削除結果:', data);
        if (data.status === 'success') {
          alert(`干場「${spotName}」を削除しました。\n\n関連する記録データも削除されました。\n地図を更新します。`);
          closeDeleteDialog();
          
          // 地図を更新
          loadSpots();
        } else {
          alert('干場の削除に失敗しました: ' + (data.message || 'エラーが発生しました'));
        }
      })
      .catch(error => {
        console.error('削除エラー:', error);
        alert('削除中にエラーが発生しました');
      });
    }
    
    // 削除ダイアログを閉じる
    function closeDeleteDialog() {
      const dialog = document.getElementById('deleteDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // お気に入り機能
    function toggleFavorite(spotName, lat, lon) {
      console.log('お気に入り切り替え:', spotName);
      
      // まず現在の状態をチェック
      fetch(`${API_BASE}/favorites/check?name=${encodeURIComponent(spotName)}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            if (data.is_favorite) {
              // お気に入りから削除
              removeFavorite(spotName);
            } else {
              // お気に入りに追加
              addFavorite(spotName, lat, lon);
            }
          }
        })
        .catch(error => {
          console.error('お気に入り状態チェックエラー:', error);
          alert('お気に入りの状態確認に失敗しました');
        });
    }

    function addFavorite(spotName, lat, lon) {
      const data = {
        name: spotName,
        lat: lat,
        lon: lon
      };

      fetch(`${API_BASE}/favorites/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          updateFavoriteButton(spotName, true);
          // マーカーの色を更新
          updateMarkerColor(spotName, true);
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('お気に入り追加エラー:', error);
        alert('お気に入りの追加に失敗しました');
      });
    }

    function removeFavorite(spotName) {
      const data = {
        name: spotName
      };

      fetch(`${API_BASE}/favorites/remove`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          updateFavoriteButton(spotName, false);
          // マーカーの色を更新
          updateMarkerColor(spotName, false);
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('お気に入り削除エラー:', error);
        alert('お気に入りの削除に失敗しました');
      });
    }

    function updateFavoriteButton(spotName, isFavorite) {
      const buttonId = `favorite-btn-${spotName.replace(/[^a-zA-Z0-9]/g, '_')}`;
      const button = document.getElementById(buttonId);
      
      if (button) {
        if (isFavorite) {
          button.textContent = 'お気に入りから外す';
          button.style.background = '#28a745';
        } else {
          button.textContent = 'お気に入りに追加';
          button.style.background = '#ffc107';
        }
      }
    }

    function updateMarkerColor(spotName, isFavorite) {
      // より確実な方法：現在表示されているスポットで再描画
      const currentDisplayedSpots = [];
      
      // 現在表示されているマーカーから対応するスポットを特定
      for (let marker of spotMarkers) {
        if (marker.options && marker.options.title) {
          const spot = spots.find(s => s.name === marker.options.title);
          if (spot) {
            currentDisplayedSpots.push(spot);
          }
        }
      }
      
      // 統一関数で再描画（お気に入り状態が正しく反映される）
      if (currentDisplayedSpots.length > 0) {
        createMarkersWithFavorites(currentDisplayedSpots);
      }
    }
    
    // 記録ダイアログを閉じる関数
    function closeRecordDialog() {
      const dialog = document.getElementById('recordDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // グローバル関数として設定
    window.getWeatherForecast = getWeatherForecast;
    window.openRecordDialog = openRecordDialog;
    window.checkExistingRecord = checkExistingRecord;
    window.showExistingRecordDialog = showExistingRecordDialog;
    window.showRecordOptionsDialog = showRecordOptionsDialog;
    window.submitRecord = submitRecord;
    window.generateDateButtons = generateDateButtons;
    window.selectYear = selectYear;
    window.selectMonth = selectMonth;
    window.selectDay = selectDay;
    window.confirmDeleteSpot = confirmDeleteSpot;
    window.showCannotDeleteDialog = showCannotDeleteDialog;
    window.showDeleteConfirmDialog = showDeleteConfirmDialog;
    window.deleteSpot = deleteSpot;
    window.closeDeleteDialog = closeDeleteDialog;
    window.closeRecordDialog = closeRecordDialog;
    window.toggleFavorite = toggleFavorite;
    window.addFavorite = addFavorite;
    window.removeFavorite = removeFavorite;
    window.closeWeatherForecastDialog = closeWeatherForecastDialog;
    window.selectForecastDate = selectForecastDate;

    // 初期読み込み
    loadSpots();
    
    // モバイル最適化の初期化
    initAllMobileFeatures();
    
    // ページ離脱時のクリーンアップ
    window.addEventListener('beforeunload', () => {
      stopSeaFogAutoUpdate();
    });
  </script>
  
  <!-- モバイル向けクイックアクションボタン -->
  <div class="mobile-quick-actions" id="mobileQuickActions">
    <button class="quick-action-btn" onclick="document.getElementById('helpButton').click()" title="ヘルプ">📖</button>
    <button class="quick-action-btn" onclick="document.getElementById('favoritesButton').click()" title="お気に入り">⭐</button>
    <button class="quick-action-btn" onclick="document.getElementById('forecastButton').click()" title="予報">📊</button>
    <button class="quick-action-btn primary" onclick="toggleQuickActions()" title="メニュー">☰</button>
  </div>
  
  <script>
    // クイックアクションメニューの制御
    function toggleQuickActions() {
      const quickActions = document.getElementById('mobileQuickActions');
      const isShow = quickActions.classList.contains('show');
      
      if (window.innerWidth <= 768) {
        if (isShow) {
          quickActions.classList.remove('show');
        } else {
          quickActions.classList.add('show');
          // 5秒後に自動で隠す
          setTimeout(() => {
            quickActions.classList.remove('show');
          }, 5000);
        }
      }
    }
    
    // モバイルデバイスでは自動でクイックアクションを表示
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        document.getElementById('mobileQuickActions').classList.add('show');
      }, 2000);
    }

    // 海霧予測関連機能
    function loadSeaFogStatus() {
      if (!selectedSpot) return;
      
      const seaFogStatus = document.getElementById('seaFogStatus');
      seaFogStatus.innerHTML = '<div class="loading">海霧予測データを読み込み中...</div>';
      
      fetch(`${API_BASE}/sea_fog/dashboard?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(data => {
          displaySeaFogStatus(data);
        })
        .catch(err => {
          console.error('海霧予測エラー:', err);
          seaFogStatus.innerHTML = '<div style="color: red;">海霧予測データの取得に失敗しました</div>';
        });
    }

    function displaySeaFogStatus(data) {
      const seaFogStatus = document.getElementById('seaFogStatus');
      
      if (data.error) {
        seaFogStatus.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
        return;
      }
      
      const summary = data.summary || {};
      const maxRisk = summary.max_probability || 0;
      const workRisk = summary.work_hours_average || 0;
      const recommendation = summary.work_recommendation || '不明';
      const trend = summary.trend || '不明';
      
      // リスク色の決定
      let riskColor = '#28a745'; // 緑
      if (maxRisk >= 0.8) riskColor = '#dc3545'; // 赤
      else if (maxRisk >= 0.6) riskColor = '#fd7e14'; // オレンジ
      else if (maxRisk >= 0.3) riskColor = '#ffc107'; // 黄
      
      seaFogStatus.innerHTML = `
        <div><strong>🌫️ 海霧リスク状況</strong></div>
        <div style="margin: 8px 0;">
          <strong>最大確率:</strong> 
          <span style="color: ${riskColor}; font-weight: bold;">${(maxRisk * 100).toFixed(1)}%</span>
        </div>
        <div style="margin: 8px 0;">
          <strong>作業時間平均:</strong> ${(workRisk * 100).toFixed(1)}%
        </div>
        <div style="margin: 8px 0;">
          <strong>推奨:</strong> ${recommendation}
        </div>
        <div style="margin: 8px 0;">
          <strong>傾向:</strong> ${trend}
        </div>
        <div style="font-size: 11px; color: #6c757d;">
          ${data.generated_at ? `更新: ${new Date(data.generated_at).toLocaleString()}` : ''}
        </div>
      `;
    }

    // 各ボタンのイベントリスナー追加
    document.addEventListener('DOMContentLoaded', () => {
      // ダッシュボードボタン
      const fogDashboardButton = document.getElementById('fogDashboardButton');
      if (fogDashboardButton) {
        fogDashboardButton.addEventListener('click', () => {
          loadSeaFogDashboard();
        });
      }

      // 時系列チャートボタン
      const fogTimelineButton = document.getElementById('fogTimelineButton');
      if (fogTimelineButton) {
        fogTimelineButton.addEventListener('click', () => {
          generateSeaFogTimeline();
        });
      }

      // リスクマップボタン
      const fogHeatmapButton = document.getElementById('fogHeatmapButton');
      if (fogHeatmapButton) {
        fogHeatmapButton.addEventListener('click', () => {
          generateSeaFogHeatmap();
        });
      }

      // 要因分析ボタン
      const fogFactorsButton = document.getElementById('fogFactorsButton');
      if (fogFactorsButton) {
        fogFactorsButton.addEventListener('click', () => {
          generateSeaFogFactors();
        });
      }

      // 地点比較ボタン
      const fogComparisonButton = document.getElementById('fogComparisonButton');
      if (fogComparisonButton) {
        fogComparisonButton.addEventListener('click', () => {
          generateSeaFogComparison();
        });
      }

      // 地図レイヤーボタン
      const fogMapLayerButton = document.getElementById('fogMapLayerButton');
      if (fogMapLayerButton) {
        fogMapLayerButton.addEventListener('click', () => {
          toggleSeaFogMapLayer();
        });
      }

      // アラートボタン
      const fogAlertsButton = document.getElementById('fogAlertsButton');
      if (fogAlertsButton) {
        fogAlertsButton.addEventListener('click', () => {
          showSeaFogAlerts();
        });
      }

      // 観測記録ボタン
      const fogObservationButton = document.getElementById('fogObservationButton');
      if (fogObservationButton) {
        fogObservationButton.addEventListener('click', () => {
          showSeaFogObservation();
        });
      }
    });

    function loadSeaFogDashboard() {
      if (!selectedSpot) {
        alert('干場を選択してください');
        return;
      }
      
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ダッシュボードデータを読み込み中...</div>';
      
      fetch(`${API_BASE}/sea_fog/dashboard?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          displaySeaFogDashboard(data);
        })
        .catch(err => {
          console.error('ダッシュボードエラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ダッシュボードの読み込みに失敗しました</div>';
        });
    }

    function displaySeaFogDashboard(data) {
      const seaFogDetails = document.getElementById('seaFogDetails');
      const timeline = data.timeline_data || [];
      const riskDistribution = data.risk_distribution || {};
      
      let html = '<div><strong>📊 海霧予測ダッシュボード</strong></div>';
      
      // リスク分布
      html += '<div style="margin: 10px 0;"><strong>リスク分布 (24時間):</strong></div>';
      html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 11px;">';
      Object.entries(riskDistribution).forEach(([level, count]) => {
        html += `<div>• ${level}: ${count}時間</div>`;
      });
      html += '</div>';
      
      // 作業時間帯のデータ
      const workHours = data.work_hours_data || [];
      if (workHours.length > 0) {
        html += '<div style="margin: 10px 0;"><strong>作業時間帯 (4-16時):</strong></div>';
        html += '<div style="max-height: 150px; overflow-y: auto; font-size: 11px;">';
        workHours.forEach(hour => {
          const riskColor = hour.probability >= 0.6 ? '#dc3545' : 
                           hour.probability >= 0.3 ? '#ffc107' : '#28a745';
          html += `<div style="margin: 2px 0;">
            ${hour.hour}時: <span style="color: ${riskColor}">${(hour.probability * 100).toFixed(1)}%</span>
          </div>`;
        });
        html += '</div>';
      }
      
      seaFogDetails.innerHTML = html;
    }

    function generateSeaFogTimeline() {
      if (!selectedSpot) {
        alert('干場を選択してください');
        return;
      }
      
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">時系列チャートを生成中...</div>';
      
      fetch(`${API_BASE}/sea_fog/predict?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(predictionData => {
          if (predictionData.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${predictionData.error}</div>`;
            return;
          }
          
          return fetch(`${API_BASE}/sea_fog/charts/timeline`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prediction_data: predictionData })
          });
        })
        .then(res => res.json())
        .then(chartResult => {
          if (chartResult.status === 'success') {
            seaFogDetails.innerHTML = `
              <div><strong>📈 時系列チャート生成完了</strong></div>
              <div style="margin: 10px 0;">
                <a href="${API_BASE}/sea_fog/charts/${chartResult.chart_path.split('/').pop()}" target="_blank" class="btn btn-secondary">
                  📊 チャートを表示
                </a>
              </div>
              <div style="font-size: 11px; color: #6c757d;">
                データポイント: ${chartResult.data_points}個
              </div>
            `;
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">チャート生成エラー: ${chartResult.error}</div>`;
          }
        })
        .catch(err => {
          console.error('チャート生成エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">チャートの生成に失敗しました</div>';
        });
    }

    function generateSeaFogHeatmap() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">リスクマップを生成中...</div>';
      
      fetch(`${API_BASE}/sea_fog/spots?hours=12`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          return fetch(`${API_BASE}/sea_fog/charts/heatmap`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ spot_predictions: data.spot_predictions })
          });
        })
        .then(res => res.json())
        .then(chartResult => {
          if (chartResult.status === 'success') {
            seaFogDetails.innerHTML = `
              <div><strong>🗺️ リスクマップ生成完了</strong></div>
              <div style="margin: 10px 0;">
                <a href="${API_BASE}/sea_fog/charts/${chartResult.chart_path.split('/').pop()}" target="_blank" class="btn btn-secondary">
                  🗺️ マップを表示
                </a>
              </div>
              <div style="font-size: 11px; color: #6c757d;">
                分析地点: ${chartResult.spots_analyzed}箇所
              </div>
            `;
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">マップ生成エラー: ${chartResult.error}</div>`;
          }
        })
        .catch(err => {
          console.error('マップ生成エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">リスクマップの生成に失敗しました</div>';
        });
    }

    // 海霧地図レイヤー機能
    function toggleSeaFogMapLayer() {
      const button = document.getElementById('fogMapLayerButton');
      
      if (seaFogLayer && map.hasLayer(seaFogLayer)) {
        // レイヤーを削除
        map.removeLayer(seaFogLayer);
        if (seaFogLayerControl) {
          map.removeControl(seaFogLayerControl);
          seaFogLayerControl = null;
        }
        seaFogLayer = null;
        button.textContent = '🗺️ 地図レイヤー';
        button.style.backgroundColor = '';
      } else {
        // レイヤーを追加
        loadSeaFogMapLayer();
      }
    }

    function loadSeaFogMapLayer() {
      const button = document.getElementById('fogMapLayerButton');
      button.textContent = '⏳ 読み込み中...';
      button.disabled = true;
      
      // 利尻島周辺の主要地点の海霧データを取得
      const keyPoints = [
        { name: '鴛泊港', lat: 45.242, lon: 141.231 },
        { name: '仙法志港', lat: 45.136, lon: 141.211 },
        { name: '沓形', lat: 45.210, lon: 141.200 },
        { name: '鬼脇', lat: 45.180, lon: 141.270 },
        { name: '利尻山麓', lat: 45.178, lon: 141.228 }
      ];
      
      Promise.all(
        keyPoints.map(point => 
          fetch(`${API_BASE}/sea_fog/dashboard?lat=${point.lat}&lon=${point.lon}&hours=12`)
            .then(res => res.json())
            .then(data => ({ ...point, fogData: data }))
            .catch(err => ({ ...point, fogData: { error: err.message } }))
        )
      )
      .then(results => {
        createSeaFogOverlay(results);
        button.textContent = '🌫️ レイヤーON';
        button.style.backgroundColor = '#007bff';
        button.style.color = 'white';
        button.disabled = false;
      })
      .catch(err => {
        console.error('海霧データ取得エラー:', err);
        alert('海霧データの取得に失敗しました');
        button.textContent = '🗺️ 地図レイヤー';
        button.disabled = false;
      });
    }

    function createSeaFogOverlay(fogPoints) {
      seaFogLayer = L.layerGroup();
      
      fogPoints.forEach(point => {
        if (point.fogData && !point.fogData.error) {
          const summary = point.fogData.summary || {};
          const maxRisk = summary.max_probability || 0;
          const workRisk = summary.work_hours_average || 0;
          
          // リスクレベルに応じた色とサイズ
          let color, opacity, radius;
          if (maxRisk >= 0.8) {
            color = '#dc3545'; // 赤
            opacity = 0.8;
            radius = 2000;
          } else if (maxRisk >= 0.6) {
            color = '#fd7e14'; // オレンジ
            opacity = 0.7;
            radius = 1500;
          } else if (maxRisk >= 0.3) {
            color = '#ffc107'; // 黄
            opacity = 0.6;
            radius = 1000;
          } else {
            color = '#28a745'; // 緑
            opacity = 0.4;
            radius = 800;
          }
          
          // 円形オーバーレイを作成
          const circle = L.circle([point.lat, point.lon], {
            color: color,
            fillColor: color,
            fillOpacity: opacity * 0.3,
            opacity: opacity,
            radius: radius,
            weight: 2
          });
          
          // ポップアップ情報
          const popupContent = `
            <div style="font-size: 12px;">
              <strong>🌫️ ${point.name} 海霧予測</strong><br>
              <strong>最大確率:</strong> <span style="color: ${color}">${(maxRisk * 100).toFixed(1)}%</span><br>
              <strong>作業時間平均:</strong> ${(workRisk * 100).toFixed(1)}%<br>
              <strong>推奨:</strong> ${summary.work_recommendation || '不明'}<br>
              <strong>傾向:</strong> ${summary.trend || '不明'}
            </div>
          `;
          
          circle.bindPopup(popupContent);
          
          // 中心にマーカーを配置
          const fogIcon = L.divIcon({
            html: `<div style="
              background: ${color};
              border: 2px solid white;
              border-radius: 50%;
              width: 16px;
              height: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 10px;
              font-weight: bold;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">${Math.round(maxRisk * 100)}</div>`,
            iconSize: [16, 16],
            className: 'fog-risk-marker'
          });
          
          const marker = L.marker([point.lat, point.lon], { icon: fogIcon });
          marker.bindPopup(popupContent);
          
          seaFogLayer.addLayer(circle);
          seaFogLayer.addLayer(marker);
        }
      });
      
      // 地図にレイヤーを追加
      seaFogLayer.addTo(map);
      
      // レイヤーコントロールを追加
      createSeaFogLayerControl();
      
      // データをキャッシュ
      seaFogDataCache = fogPoints;
    }

    function createSeaFogLayerControl() {
      seaFogLayerControl = L.control({ position: 'topright' });
      
      seaFogLayerControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'sea-fog-control');
        div.style.cssText = `
          background: white;
          padding: 8px;
          border-radius: 4px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          font-size: 11px;
          min-width: 140px;
        `;
        
        div.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 4px;">🌫️ 海霧リスク</div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 4px;"></div>
            <span>危険 (80%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%; margin-right: 4px;"></div>
            <span>警戒 (60%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 50%; margin-right: 4px;"></div>
            <span>注意 (30%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 4px;"></div>
            <span>正常 (30%未満)</span>
          </div>
          <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #ddd; font-size: 10px; color: #666;">
            更新: ${new Date().toLocaleTimeString()}
          </div>
          <button onclick="refreshSeaFogLayer()" style="
            width: 100%;
            margin-top: 4px;
            padding: 2px 4px;
            font-size: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
          ">🔄 更新</button>
        `;
        
        // クリックイベントの伝播を停止
        L.DomEvent.disableClickPropagation(div);
        
        return div;
      };
      
      seaFogLayerControl.addTo(map);
    }

    function refreshSeaFogLayer() {
      if (seaFogLayer) {
        map.removeLayer(seaFogLayer);
        if (seaFogLayerControl) {
          map.removeControl(seaFogLayerControl);
          seaFogLayerControl = null;
        }
        seaFogLayer = null;
      }
      loadSeaFogMapLayer();
    }

    // グローバル関数として追加
    window.refreshSeaFogLayer = refreshSeaFogLayer;

    // 海霧アラートシステム関数
    function showSeaFogAlerts() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">アラートシステムを読み込み中...</div>';
      
      loadAlertSystemStatus();
    }

    function loadAlertSystemStatus() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      
      fetch(`${API_BASE}/sea_fog/alerts/status`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          displayAlertSystemStatus(data);
        })
        .catch(err => {
          console.error('アラートシステム状態エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">アラートシステム状態の取得に失敗しました</div>';
        });
    }

    function displayAlertSystemStatus(status) {
      const seaFogDetails = document.getElementById('seaFogDetails');
      
      const monitoringStatus = status.monitoring_active ? '🟢 稼働中' : '🔴 停止中';
      const lastCheck = status.last_check ? new Date(status.last_check).toLocaleString() : '未実行';
      
      let html = `
        <div><strong>🚨 海霧アラートシステム</strong></div>
        <div style="margin: 10px 0;">
          <div><strong>監視状況:</strong> ${monitoringStatus}</div>
          <div><strong>最終チェック:</strong> ${lastCheck}</div>
          <div><strong>アクティブアラート:</strong> ${status.active_alerts_count}件</div>
          <div><strong>購読者:</strong> ${status.subscribers_count}名</div>
          <div><strong>監視ゾーン:</strong> ${status.zones_monitored}箇所</div>
          <div><strong>チェック間隔:</strong> ${status.check_interval}分</div>
        </div>
        
        <div style="margin: 15px 0;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
            <button onclick="toggleAlertMonitoring()" class="btn" style="font-size: 11px; padding: 5px;">
              ${status.monitoring_active ? '⏹️ 監視停止' : '▶️ 監視開始'}
            </button>
            <button onclick="runManualAlertCheck()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              🔍 手動チェック
            </button>
            <button onclick="showActiveAlerts()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              🚨 現在のアラート
            </button>
            <button onclick="showAlertHistory()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              📋 履歴
            </button>
            <button onclick="showAlertSubscribers()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              👥 購読者管理
            </button>
            <button onclick="testAlertSystem()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              🧪 テスト
            </button>
          </div>
        </div>
      `;
      
      seaFogDetails.innerHTML = html;
    }

    function toggleAlertMonitoring() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">監視状態を変更中...</div>';
      
      // 現在の状態を取得して切り替え
      fetch(`${API_BASE}/sea_fog/alerts/monitoring`)
        .then(res => res.json())
        .then(status => {
          const method = status.monitoring_active ? 'DELETE' : 'POST';
          
          return fetch(`${API_BASE}/sea_fog/alerts/monitoring`, { method: method });
        })
        .then(res => res.json())
        .then(result => {
          if (result.status) {
            seaFogDetails.innerHTML = `<div style="color: green;">✓ ${result.message}</div>`;
            setTimeout(loadAlertSystemStatus, 2000);
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">✗ ${result.error || '操作に失敗しました'}</div>`;
          }
        })
        .catch(err => {
          console.error('監視状態変更エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">監視状態の変更に失敗しました</div>';
        });
    }

    function runManualAlertCheck() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">手動チェックを実行中...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/check`, { method: 'POST' })
        .then(res => res.json())
        .then(result => {
          if (result.status === 'completed') {
            let html = `
              <div style="color: green;"><strong>✓ チェック完了</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>チェック済みゾーン:</strong> ${result.zones_checked}箇所</div>
                <div><strong>生成されたアラート:</strong> ${result.alerts_generated}件</div>
                <div><strong>チェック時刻:</strong> ${new Date(result.check_time).toLocaleString()}</div>
              </div>
            `;
            
            if (result.alerts && result.alerts.length > 0) {
              html += '<div><strong>生成されたアラート:</strong></div>';
              result.alerts.forEach(alert => {
                html += `<div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                  <strong>${alert.zone}</strong>: ${alert.summary.message}
                </div>`;
              });
            }
            
            seaFogDetails.innerHTML = html;
            setTimeout(loadAlertSystemStatus, 3000);
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">✗ ${result.error || 'チェックに失敗しました'}</div>`;
          }
        })
        .catch(err => {
          console.error('手動チェックエラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">手動チェックに失敗しました</div>';
        });
    }

    function showActiveAlerts() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">アクティブアラートを読み込み中...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/active`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          let html = `<div><strong>🚨 アクティブアラート (${data.count}件)</strong></div>`;
          
          if (data.count === 0) {
            html += '<div style="color: green; margin: 10px 0;">現在アクティブなアラートはありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            data.alerts.forEach(alert => {
              const alertTime = new Date(alert.timestamp).toLocaleString();
              const riskLevel = alert.alert_level === 'danger' ? '🔴' : 
                              alert.alert_level === 'watch' ? '🟠' : '🟡';
              
              html += `
                <div style="margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 11px;">
                  <div><strong>${riskLevel} ${alert.zone}</strong></div>
                  <div>${alert.summary.message}</div>
                  <div style="color: #666; margin-top: 3px;">
                    ${alertTime} | 最大リスク: ${(alert.risk_assessment.max_probability * 100).toFixed(1)}%
                  </div>
                  <div style="margin-top: 5px;">
                    <strong>推奨事項:</strong><br>
                    ${alert.recommendations.slice(0, 2).join('<br>')}
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">戻る</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('アクティブアラート取得エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">アクティブアラートの取得に失敗しました</div>';
        });
    }

    function showAlertHistory() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">アラート履歴を読み込み中...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/history?days=7`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          let html = `<div><strong>📋 アラート履歴 (${data.period_days}日間・${data.count}件)</strong></div>`;
          
          if (data.count === 0) {
            html += '<div style="color: gray; margin: 10px 0;">アラート履歴がありません</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            data.alerts.reverse().forEach(alert => {
              const alertTime = new Date(alert.timestamp).toLocaleString();
              const riskLevel = alert.alert_level === 'danger' ? '🔴' : 
                              alert.alert_level === 'watch' ? '🟠' : '🟡';
              
              html += `
                <div style="margin: 3px 0; padding: 5px; border-bottom: 1px solid #eee; font-size: 10px;">
                  <strong>${riskLevel} ${alert.zone}</strong> - ${alertTime}<br>
                  ${alert.summary.message} (${(alert.risk_assessment.max_probability * 100).toFixed(1)}%)
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">戻る</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('アラート履歴取得エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">アラート履歴の取得に失敗しました</div>';
        });
    }

    function showAlertSubscribers() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">購読者情報を読み込み中...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">エラー: ${data.error}</div>`;
            return;
          }
          
          let html = `
            <div><strong>👥 アラート購読者管理 (${data.count}名)</strong></div>
            <div style="margin: 10px 0;">
              <input type="text" id="newSubscriberName" placeholder="名前" style="padding: 3px; font-size: 11px; margin-right: 5px;">
              <button onclick="addAlertSubscriber()" class="btn" style="font-size: 10px; padding: 3px 6px;">追加</button>
            </div>
          `;
          
          if (data.count === 0) {
            html += '<div style="color: gray; margin: 10px 0;">購読者がいません</div>';
          } else {
            html += '<div style="max-height: 200px; overflow-y: auto; margin: 10px 0;">';
            data.subscribers.forEach(subscriber => {
              const activeStatus = subscriber.alert_preferences?.active ? '🟢' : '🔴';
              const minLevel = subscriber.alert_preferences?.minimum_level || 'warning';
              
              html += `
                <div style="margin: 3px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${activeStatus} ${subscriber.name} (${minLevel})</span>
                    <button onclick="removeAlertSubscriber(${subscriber.id})" class="btn btn-danger" style="font-size: 9px; padding: 2px 4px;">削除</button>
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">戻る</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('購読者取得エラー:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">購読者情報の取得に失敗しました</div>';
        });
    }

    function addAlertSubscriber() {
      const name = document.getElementById('newSubscriberName').value.trim();
      if (!name) {
        alert('名前を入力してください');
        return;
      }
      
      const subscriberData = {
        name: name,
        contact_info: { type: 'manual' },
        alert_preferences: {
          minimum_level: 'warning',
          zones: ['oshidomari', 'senposhi'],
          notification_methods: ['console', 'file'],
          active: true
        }
      };
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(subscriberData)
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          alert('購読者を追加しました');
          showAlertSubscribers();
        } else {
          alert(result.error || '購読者の追加に失敗しました');
        }
      })
      .catch(err => {
        console.error('購読者追加エラー:', err);
        alert('購読者の追加に失敗しました');
      });
    }

    function removeAlertSubscriber(subscriberId) {
      if (!confirm('この購読者を削除しますか？')) return;
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriber_id: subscriberId })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          alert('購読者を削除しました');
          showAlertSubscribers();
        } else {
          alert(result.error || '購読者の削除に失敗しました');
        }
      })
      .catch(err => {
        console.error('購読者削除エラー:', err);
        alert('購読者の削除に失敗しました');
      });
    }

    function testAlertSystem() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">テストアラートを生成中...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zone: 'oshidomari' })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          seaFogDetails.innerHTML = `
            <div style="color: green;"><strong>✓ テストアラート生成完了</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>アラートID:</strong> ${result.alert.id}</div>
              <div><strong>メッセージ:</strong> ${result.alert.summary.message}</div>
              <div><strong>リスクレベル:</strong> ${result.alert.alert_level}</div>
            </div>
            <button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">戻る</button>
          `;
        } else {
          seaFogDetails.innerHTML = `<div style="color: red;">✗ ${result.error || 'テストに失敗しました'}</div>`;
        }
      })
      .catch(err => {
        console.error('テストアラートエラー:', err);
        seaFogDetails.innerHTML = '<div style="color: red;">テストアラートの生成に失敗しました</div>';
      });
    }

    // グローバル関数として追加
    window.toggleAlertMonitoring = toggleAlertMonitoring;
    window.runManualAlertCheck = runManualAlertCheck;
    window.showActiveAlerts = showActiveAlerts;
    window.showAlertHistory = showAlertHistory;
    window.showAlertSubscribers = showAlertSubscribers;
    window.addAlertSubscriber = addAlertSubscriber;
    window.removeAlertSubscriber = removeAlertSubscriber;
    window.testAlertSystem = testAlertSystem;
    window.loadAlertSystemStatus = loadAlertSystemStatus;

    function submitFogObservation() {
      if (!selectedSpot) return;
      
      const datetime = document.getElementById('fogObsDateTime').value;
      const fogRadios = document.getElementsByName('fogObserved');
      let fogObserved = null;
      
      for (let radio of fogRadios) {
        if (radio.checked) {
          fogObserved = radio.value === 'true';
          break;
        }
      }
      
      if (!datetime) {
        alert('観測日時を入力してください');
        return;
      }
      
      if (fogObserved === null) {
        alert('海霧の有無を選択してください');
        return;
      }
      
      const observationData = {
        lat: selectedSpot.lat,
        lon: selectedSpot.lon,
        datetime: datetime,
        fog_observed: fogObserved,
        conditions: {
          spot_name: selectedSpot.name,
          observer: 'manual_entry'
        }
      };
      
      fetch(`${API_BASE}/sea_fog/observation`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(observationData)
      })
      .then(res => res.json())
      .then(data => {
        const result = document.getElementById('fogObsResult');
        if (data.status === 'success') {
          result.innerHTML = '<div style="color: green;">✓ 観測記録を保存しました</div>';
          document.getElementById('fogObsDateTime').value = '';
          document.getElementsByName('fogObserved').forEach(r => r.checked = false);
        } else {
          result.innerHTML = `<div style="color: red;">✗ 保存に失敗しました: ${data.message}</div>`;
        }
      })
      .catch(err => {
        console.error('観測記録エラー:', err);
        document.getElementById('fogObsResult').innerHTML = '<div style="color: red;">✗ 保存に失敗しました</div>';
      });
    }

    // オフライン機能を簡素化
    function initializeOfflineHandlers() {
        // Handle online/offline status
        window.addEventListener('online', () => {
          updateOfflineStatus(true);
          console.log('Connection restored');
        });
        
        window.addEventListener('offline', () => {
          updateOfflineStatus(false);
          console.log('Connection lost');
        });
    }

    // Offline status indicator functions
    function showOfflineStatusIndicator() {
      // Create offline status indicator
      const indicator = document.createElement('div');
      indicator.id = 'offline-indicator';
      indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        z-index: 10000;
        transition: all 0.3s ease;
        display: none;
      `;
      document.body.appendChild(indicator);
      
      // Update initial status
      updateOfflineStatus(navigator.onLine);
    }

    function updateOfflineStatus(isOnline) {
      const indicator = document.getElementById('offline-indicator');
      if (!indicator) return;
      
      if (isOnline) {
        indicator.style.display = 'none';
      } else {
        indicator.style.display = 'block';
        indicator.style.background = 'rgba(244, 67, 54, 0.9)';
        indicator.style.color = 'white';
        indicator.innerHTML = '🔴 オフライン';
        
        // Show cached data status
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.ready.then(registration => {
            caches.open('rishiri-kelp-weather-v1').then(cache => {
              cache.keys().then(keys => {
                if (keys.length > 0) {
                  indicator.innerHTML = '💾 オフライン (キャッシュ利用可能)';
                  indicator.style.background = 'rgba(255, 193, 7, 0.9)';
                }
              });
            });
          });
        }
      }
    }
  </script>
</body>
</html>