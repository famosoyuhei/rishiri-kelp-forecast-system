<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Manifest -->
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="åˆ©å°»æ˜†å¸ƒäºˆå ±">
  
  <!-- Icons for PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-providers/leaflet-providers.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #2c5f2d, #4a8a5a);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 5px 0 0 0;
      opacity: 0.9;
    }
    
    .main-container {
      display: flex;
      gap: 20px;
    }
    
    .map-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .sidebar {
      width: 350px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: fit-content;
    }
    
    #map { 
      height: 600px; 
      border-radius: 8px;
    }
    
    .control-panel {
      margin-bottom: 20px;
    }
    
    .btn {
      background: #4a8a5a;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn:hover {
      background: #3d7349;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .new-spot-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    
    .forecast-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      display: none;
    }
    
    .forecast-day {
      border: 1px solid #dee2e6;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      background: white;
    }
    
    .forecast-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .recommendation {
      font-size: 16px;
      font-weight: bold;
      margin: 5px 0;
    }
    
    .recommendation.excellent {
      color: #28a745;
    }
    
    .recommendation.good {
      color: #007bff;
    }
    
    .recommendation.caution {
      color: #ffc107;
    }
    
    .recommendation.poor {
      color: #dc3545;
    }
    
    .reasons {
      font-size: 12px;
      margin: 5px 0;
    }
    
    .reasons .positive {
      color: #28a745;
    }
    
    .reasons .negative {
      color: #dc3545;
    }
    
    .record-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      display: none;
    }
    
    .record-buttons {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }
    
    .spot-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }
    
    .weather-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 12px;
      margin: 5px 0;
    }
    
    .weather-item {
      background: #f8f9fa;
      padding: 5px;
      border-radius: 3px;
    }
    
    
    .location-navigation {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .location-navigation h4 {
      margin: 0 0 10px 0;
      color: #2c5f2d;
    }

    /* åœ°å›³ä¸ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .map-location-button {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      color: #2c5f2d;
      border: 2px solid #2c5f2d;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: all 0.3s ease;
      white-space: nowrap;
      user-select: none;
    }

    .map-location-button:hover {
      background: #2c5f2d;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .map-location-button.active {
      background: #2c5f2d;
      color: white;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .map-location-button {
        padding: 10px 14px;
        font-size: 13px;
        border-radius: 16px;
      }
    }

    .map-navigation-info {
      background: #e8f5e8;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #2c5f2d;
    }

    .map-navigation-info h4 {
      margin: 0 0 8px 0;
      color: #2c5f2d;
      font-size: 14px;
    }

    .map-navigation-info p {
      margin: 0;
      font-size: 12px;
      color: #555;
    }
    
    .nav-step {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-step label {
      min-width: 80px;
      font-weight: bold;
      color: #495057;
    }
    
    .nav-step select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }
    
    .nav-step select:focus {
      outline: none;
      border-color: #4a8a5a;
      box-shadow: 0 0 0 2px rgba(74, 138, 90, 0.2);
    }
    
    .current-location {
      background: #e8f5e8;
      border: 1px solid #4a8a5a;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
      color: #2c5f2d;
    }
    
    .forecast-reliability {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      font-size: 13px;
    }
    
    .reliability-header {
      font-weight: bold;
      color: #495057;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .reliability-icon {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      background: #17a2b8;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
      font-weight: bold;
    }
    
    .reliability-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    
    .reliability-table th,
    .reliability-table td {
      padding: 4px 8px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 12px;
    }
    
    .reliability-table th {
      background: #f1f3f4;
      font-weight: bold;
      color: #495057;
    }
    
    .accuracy-excellent { color: #28a745; font-weight: bold; }
    .accuracy-good { color: #ffc107; font-weight: bold; }
    .accuracy-fair { color: #fd7e14; font-weight: bold; }
    .accuracy-poor { color: #dc3545; font-weight: bold; }
    
    .season-status {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .season-status.in-season {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .season-status.pre-season {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }
    
    .season-status.post-season {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .schedule-item {
      background: white;
      border: 1px solid #dee2e6;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    
    .schedule-item.work-day {
      border-left: 4px solid #28a745;
    }
    
    .schedule-item.rest-day {
      border-left: 4px solid #dc3545;
      background: #f8f9fa;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
    @media screen and (max-width: 1024px) {
      .main-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .sidebar {
        width: 100%;
        order: -1; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä¸Šã«ç§»å‹• */
      }
      
      .map-container {
        padding: 15px;
      }
      
      #map {
        height: 400px; /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã«åœ°å›³ã®é«˜ã•ã‚’èª¿æ•´ */
      }
    }

    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .sidebar {
        padding: 15px;
      }
      
      .map-container {
        padding: 10px;
      }
      
      #map {
        height: 350px;
      }
      
      /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã« */
      .btn {
        padding: 12px 16px;
        font-size: 15px;
        margin-right: 8px;
        margin-bottom: 12px;
        min-height: 44px; /* iOSæ¨å¥¨ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º */
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ */
      .control-panel {
        margin-bottom: 15px;
      }
      
      .record-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .record-buttons .btn {
        flex: 1;
        min-width: calc(50% - 4px);
        margin: 0;
      }
      
      /* ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ”¹å–„ */
      .nav-step select {
        padding: 12px;
        font-size: 16px; /* iOS ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        border-radius: 8px;
      }
      
      /* ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
      .forecast-panel,
      .record-panel {
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã®èª¿æ•´ */
      .forecast-day {
        padding: 12px;
        margin: 8px 0;
      }
      
      .weather-item {
        padding: 8px;
        margin: 5px 0;
      }
      
      /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®æ”¹å–„ */
      .location-navigation {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .nav-step {
        margin: 8px 0;
        flex-direction: column;
        align-items: stretch;
        gap: 5px;
      }
      
      .nav-step label {
        min-width: auto;
        margin-bottom: 5px;
      }
    }

    @media screen and (max-width: 480px) {
      .header h1 {
        font-size: 18px;
      }
      
      #map {
        height: 300px;
      }
      
      .btn {
        padding: 14px 12px;
        font-size: 14px;
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .record-buttons .btn {
        width: 100%;
        min-width: 100%;
      }
      
      /* å°ç”»é¢ã§ã¯å˜åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .main-container {
        gap: 10px;
      }
      
      .sidebar,
      .map-container {
        padding: 10px;
      }
      
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã®é«˜ã•èª¿æ•´ */
      .forecast-panel,
      .record-panel {
        max-height: 50vh;
      }
      
      /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®å¾®èª¿æ•´ */
      .forecast-header {
        font-size: 16px;
      }
      
      .recommendation {
        font-size: 15px;
      }
      
      /* è©³ç´°æƒ…å ±ã®è¡¨ç¤ºæ”¹å–„ */
      .favoritesDetails,
      .systemMonitorDetails,
      .backupDetails {
        font-size: 11px;
        line-height: 1.4;
      }
    }

    /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã®è¿½åŠ æœ€é©åŒ– */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        background: #4a8a5a; /* ãƒ›ãƒãƒ¼åŠ¹æœã‚’ç„¡åŠ¹åŒ– */
      }
      
      .btn-secondary:hover {
        background: #6c757d;
      }
      
      .btn-danger:hover {
        background: #dc3545;
      }
      
      /* ã‚¿ãƒƒãƒ—æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
      .btn:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }
      
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
      * {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* æ¨ªå‘ãè¡¨ç¤ºã®æœ€é©åŒ– */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      .header {
        padding: 10px 15px;
        margin-bottom: 10px;
      }
      
      .header h1 {
        font-size: 16px;
      }
      
      #map {
        height: 250px;
      }
      
      .forecast-panel,
      .record-panel {
        max-height: 40vh;
      }
    }

    /* è¿½åŠ ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
    .mobile-quick-actions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
    }

    .mobile-quick-actions.show {
      display: block;
    }

    .quick-action-btn {
      display: block;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #4a8a5a;
      color: white;
      border: none;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .quick-action-btn:active {
      transform: scale(0.95);
    }

    .quick-action-btn.primary {
      background: #007bff;
      width: 64px;
      height: 64px;
      font-size: 24px;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
    .mobile-help {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 12px;
      color: #856404;
    }

    @media screen and (max-width: 768px) {
      .mobile-help {
        display: block;
      }
      
      .mobile-quick-actions.show {
        display: block;
      }
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆwebkitç³»ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ */
    .forecast-panel::-webkit-scrollbar,
    .record-panel::-webkit-scrollbar {
      width: 8px;
    }

    .forecast-panel::-webkit-scrollbar-track,
    .record-panel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .forecast-panel::-webkit-scrollbar-thumb,
    .record-panel::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .forecast-panel::-webkit-scrollbar-thumb:hover,
    .record-panel::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-radius: 50%;
      border-top: 2px solid #4a8a5a;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è¡¨ç¤ºæ”¹å–„ */
    @media screen and (max-width: 768px) {
      input:focus,
      select:focus,
      textarea:focus {
        position: relative;
        z-index: 999;
        background: white;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸŒŠ åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>æ˜†å¸ƒæ¼å¸«ã®ãŸã‚ã®å¹²å ´ç®¡ç†ãƒ»æ°—è±¡äºˆå ±ãƒ»è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ </p>
  </div>

  <div class="main-container">
    <div class="map-container">
      <div class="control-panel">
        <div class="location-navigation" style="display: none;">
          <h4>ğŸ“ åœ°åŒºé¸æŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h4>
          <div class="mobile-help">
            ğŸ“± <strong>ãƒ¢ãƒã‚¤ãƒ«æ“ä½œã‚¬ã‚¤ãƒ‰:</strong><br>
            â€¢ åœ°å›³ã‚’é•·æŠ¼ã—ï¼ˆ2ç§’ï¼‰ã§è©³ç´°ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º<br>
            â€¢ ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—ã§å„æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹<br>
            â€¢ ç”»é¢å›è»¢ã§æœ€é©ãªè¡¨ç¤ºã«è‡ªå‹•èª¿æ•´
          </div>
          <div class="nav-step">
            <label>ç”ºé¸æŠ:</label>
            <select id="townSelect" class="btn">
              <option value="">-- ç”ºã‚’é¸æŠ --</option>
              <option value="rishiri-town">åˆ©å°»ç”ºï¼ˆè¥¿éƒ¨ï¼‰</option>
              <option value="rishiri-fuji-town">åˆ©å°»å¯Œå£«ç”ºï¼ˆæ±éƒ¨ï¼‰</option>
            </select>
          </div>
          <div class="nav-step" id="districtStep" style="display: none;">
            <label>åœ°åŒºé¸æŠ:</label>
            <select id="districtSelect" class="btn">
              <option value="">-- åœ°åŒºã‚’é¸æŠ --</option>
            </select>
          </div>
          <div class="nav-step" id="areaStep" style="display: none;">
            <label>åœ°åŸŸé¸æŠ:</label>
            <select id="areaSelect" class="btn">
              <option value="">-- åœ°åŸŸã‚’é¸æŠ --</option>
            </select>
          </div>
          <button id="resetNavButton" class="btn btn-secondary" style="display: none;">ğŸ”„ å…¨å³¶è¡¨ç¤º</button>
        </div>
        
        <div id="currentLocation" class="current-location" style="display: none;">
          <strong>ğŸ“ ç¾åœ¨è¡¨ç¤ºä¸­:</strong> <span id="currentLocationText"></span>
        </div>
        
        <!-- åœ°å›³ä¸ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜ -->
        <div class="map-navigation-info">
          <h4>ğŸ“ åœ°å›³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h4>
          <p>åœ°å›³ä¸Šã®åœ°åãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è©³ç´°ãªåœ°åŸŸã‚’è¡¨ç¤ºã§ãã¾ã™</p>
          <button id="resetMapViewButton" class="btn btn-secondary">ğŸ”„ å…¨å³¶è¡¨ç¤º</button>
        </div>
        
        <hr style="margin: 15px 0;">
        
        <button id="addModeButton" class="btn">ï¼‹ æ–°è¦å¹²å ´ã‚’è¿½åŠ </button>
        <button id="refreshButton" class="btn btn-secondary">ğŸ”„ å¹²å ´ã‚’æ›´æ–°</button>
        
        <div id="newSpotInfo" class="new-spot-info">
          <h4>æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ </h4>
          <p>åœ°å›³ä¸Šã®é™¸åœ°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¹²å ´ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
          <div id="newSpotDetails" style="display: none;">
            <p><strong>å¹²å ´å:</strong> <span id="newSpotName"></span></p>
            <p><strong>åº§æ¨™:</strong> <span id="newSpotCoords"></span></p>
            <button id="saveSpot" class="btn">âœ“ ä¿å­˜</button>
            <button id="cancelSpot" class="btn btn-secondary">âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>

    <div class="sidebar">
      <div id="spotInfo" class="spot-info">
        <h3 id="selectedSpotName">å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <p id="selectedSpotCoords"></p>
        
        <div class="record-buttons">
          <button id="forecastButton" class="btn">ğŸ“Š äºˆå ±ã‚’è¦‹ã‚‹</button>
          <button id="seaFogButton" class="btn">ğŸŒ«ï¸ æµ·éœ§äºˆæ¸¬</button>
          <button id="recordButton" class="btn">ğŸ“ è¨˜éŒ²ã‚’å…¥åŠ›</button>
          <button id="adaptiveLearningButton" class="btn btn-secondary">ğŸ¤– è‡ªå‹•å­¦ç¿’</button>
          <button id="seasonButton" class="btn btn-secondary">ğŸ“… æ¼æœŸç®¡ç†</button>
          <button id="notificationButton" class="btn btn-secondary">ğŸ”” é€šçŸ¥è¨­å®š</button>
          <button id="favoritesButton" class="btn btn-secondary">â­ ãŠæ°—ã«å…¥ã‚Š</button>
          <button id="systemMonitorButton" class="btn btn-secondary">ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–</button>
          <button id="backupButton" class="btn btn-secondary">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
          <button id="helpButton" class="btn btn-secondary">ğŸ“– ãƒ˜ãƒ«ãƒ—</button>
          <button id="deleteButton" class="btn btn-danger">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
      </div>

      <div id="forecastPanel" class="forecast-panel">
        <h4>ğŸ“Š 1é€±é–“ã®ä¹¾ç‡¥äºˆå ±</h4>
        <div id="forecastContent" class="loading">
          äºˆå ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </div>

      <div id="recordPanel" class="record-panel">
        <h4>ğŸ“ ä¹¾ç‡¥è¨˜éŒ²ã®å…¥åŠ›</h4>
        <p>æ—¥ä»˜: <input type="date" id="recordDate" /></p>
        <p>çµæœ:</p>
        <div class="record-buttons">
          <button id="recordSuccess" class="btn" data-result="å®Œå…¨ä¹¾ç‡¥">âœ“ å®Œå…¨ä¹¾ç‡¥</button>
          <button id="recordPartial" class="btn btn-secondary" data-result="å¹²ã—ãŸãŒå®Œå…¨ã«ã¯ä¹¾ã‹ã›ãªã‹ã£ãŸï¼ˆæ³£ï¼‰">â–³ éƒ¨åˆ†ä¹¾ç‡¥</button>
          <button id="recordCancel" class="btn btn-danger" data-result="ä¸­æ­¢">âœ— ä¸­æ­¢</button>
        </div>
        <div id="recordStatus" style="margin-top: 10px;"></div>
      </div>

      <div id="adaptiveLearningPanel" class="record-panel">
        <h4>ğŸ¤– è‡ªå‹•å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </h4>
        <div class="record-buttons">
          <button id="processLearningButton" class="btn">ğŸ”„ å­¦ç¿’å‡¦ç†å®Ÿè¡Œ</button>
          <button id="qualityReportButton" class="btn btn-secondary">ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆ</button>
          <button id="retrainModelButton" class="btn btn-secondary">ğŸ§  ãƒ¢ãƒ‡ãƒ«å†è¨“ç·´</button>
        </div>
        <div id="adaptiveStatus" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="seaFogPanel" class="record-panel">
        <h4>ğŸŒ«ï¸ æµ·éœ§äºˆæ¸¬ãƒ»å¯è¦–åŒ–</h4>
        <div id="seaFogStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
          <div class="loading">æµ·éœ§äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div class="record-buttons">
          <button id="fogDashboardButton" class="btn">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
          <button id="fogTimelineButton" class="btn btn-secondary">ğŸ“ˆ æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆ</button>
          <button id="fogHeatmapButton" class="btn btn-secondary">ğŸ—ºï¸ ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—</button>
          <button id="fogMapLayerButton" class="btn">ğŸ—ºï¸ åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
          <button id="fogAlertsButton" class="btn">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆ</button>
          <button id="fogFactorsButton" class="btn btn-secondary">ğŸ” è¦å› åˆ†æ</button>
          <button id="fogComparisonButton" class="btn btn-secondary">ğŸ“Š åœ°ç‚¹æ¯”è¼ƒ</button>
          <button id="fogObservationButton" class="btn btn-secondary">ğŸ‘ï¸ è¦³æ¸¬è¨˜éŒ²</button>
        </div>
        <div id="seaFogDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="seasonPanel" class="record-panel">
        <h4>ğŸ“… æ¼æœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h4>
        <div id="seasonStatus" class="season-status"></div>
        <div class="record-buttons">
          <button id="weeklyScheduleButton" class="btn">ğŸ“‹ é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
          <button id="restDaysButton" class="btn btn-secondary">ğŸš« ä¼‘æ¼æ—¥ç®¡ç†</button>
          <button id="seasonConfigButton" class="btn btn-secondary">âš™ï¸ æ¼æœŸè¨­å®š</button>
        </div>
        <div id="seasonDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="notificationPanel" class="record-panel">
        <h4>ğŸ”” é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h4>
        <div id="notificationStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="notificationConfigButton" class="btn">âš™ï¸ é€šçŸ¥è¨­å®š</button>
          <button id="subscribersButton" class="btn btn-secondary">ğŸ‘¥ é€šçŸ¥å¯¾è±¡è€…</button>
          <button id="testNotificationButton" class="btn btn-secondary">ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
          <button id="schedulerButton" class="btn btn-secondary">ğŸ¯ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</button>
        </div>
        <div id="notificationDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="systemMonitorPanel" class="record-panel">
        <h4>ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
        <div id="systemMonitorStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="healthCheckButton" class="btn">ğŸ’š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</button>
          <button id="healthHistoryButton" class="btn btn-secondary">ğŸ“ˆ å±¥æ­´è¡¨ç¤º</button>
          <button id="alertHistoryButton" class="btn btn-secondary">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´</button>
          <button id="monitorConfigButton" class="btn btn-secondary">âš™ï¸ ç›£è¦–è¨­å®š</button>
          <button id="monitorToggleButton" class="btn btn-secondary">â–¶ï¸ ç›£è¦–é–‹å§‹</button>
        </div>
        <div id="systemMonitorDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>

      <div id="backupPanel" class="record-panel">
        <h4>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h4>
        <div id="backupStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="createBackupButton" class="btn">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
          <button id="backupListButton" class="btn btn-secondary">ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§</button>
          <button id="autoBackupToggleButton" class="btn btn-secondary">â° è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
          <button id="backupConfigButton" class="btn btn-secondary">âš™ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</button>
        </div>
        <div id="backupDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
      <div id="favoritesPanel" class="record-panel">
        <h4>â­ ãŠæ°—ã«å…¥ã‚Šå¹²å ´ç®¡ç†</h4>
        <div id="favoritesStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
        <div class="record-buttons">
          <button id="addFavoriteButton" class="btn">â­ ãŠæ°—ã«å…¥ã‚Šè¿½åŠ </button>
          <button id="quickAccessButton" class="btn btn-secondary">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹</button>
          <button id="favoritesListButton" class="btn btn-secondary">ğŸ“‹ ä¸€è¦§è¡¨ç¤º</button>
          <button id="searchFavoritesButton" class="btn btn-secondary">ğŸ” æ¤œç´¢</button>
          <button id="favoritesImportButton" class="btn btn-secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button id="favoritesExportButton" class="btn btn-secondary">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
        <div id="favoritesDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
      <div id="helpPanel" class="record-panel">
        <h4>ğŸ“– ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ãƒ˜ãƒ«ãƒ—</h4>
        <div id="helpStatus" style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
          <div><strong>ğŸ“˜ ã‚·ã‚¹ãƒ†ãƒ ã‚¬ã‚¤ãƒ‰:</strong> åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ã„æ–¹</div>
          <div><strong>ğŸ¯ å¯¾è±¡:</strong> æ˜†å¸ƒæ¼å¸«ãƒ»å¹²å ´ç®¡ç†è€…ãƒ»é–¢ä¿‚è€…</div>
        </div>
        <div class="record-buttons">
          <button id="tutorialButton" class="btn">ğŸ¯ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
          <button id="faqButton" class="btn btn-secondary">â“ ã‚ˆãã‚ã‚‹è³ªå•</button>
          <button id="featuresGuideButton" class="btn btn-secondary">ğŸ› ï¸ æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰</button>
          <button id="quickRefButton" class="btn btn-secondary">ğŸ“‹ æ“ä½œæ—©è¦‹è¡¨</button>
          <button id="troubleshootButton" class="btn btn-secondary">ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ</button>
          <button id="contactButton" class="btn btn-secondary">ğŸ“ ãŠå•ã„åˆã‚ã›</button>
        </div>
        <div id="helpDetails" style="margin-top: 10px; font-size: 12px;"></div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    const map = L.map('map').setView([45.178269, 141.228528], 11);
    // å‹•çš„ã«APIãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®šï¼ˆã‚¹ãƒãƒ›ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œï¼‰
    const API_BASE = window.location.protocol + '//' + window.location.hostname + ':' + (window.location.port || '8000');
    
    let spots = [];
    let addMode = false;
    let tempMarker = null;
    let selectedSpot = null;
    let currentSelectedSpot = null;
    let spotMarkers = [];
    let townBoundaries = {};
    let seaFogLayer = null;
    let seaFogLayerControl = null;
    let seaFogDataCache = null;

    // åœ°å›³ä¸ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
    let currentNavigationLevel = 0; // 0: ç”ºãƒ¬ãƒ™ãƒ«, 1: åœ°åŒºãƒ¬ãƒ™ãƒ«, 2: åœ°åŸŸãƒ¬ãƒ™ãƒ«
    let currentTown = null;
    let currentDistrict = null;
    let mapLocationButtons = []; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒœã‚¿ãƒ³ã‚’è¨˜éŒ²

    // åˆ©å°»å³¶åœ°ç†ãƒ‡ãƒ¼ã‚¿
    const rishiriGeography = {
      'rishiri-town': {
        name: 'åˆ©å°»ç”º',
        center: [45.165, 141.200],
        zoom: 14,
        districts: {
          'kutsugata': {
            name: 'æ²“å½¢',
            center: [45.210, 141.200],
            zoom: 15,
            burakus: {
              'honcho': { name: 'æœ¬ç”º', center: [45.210, 141.200] },
              'motomachi': { name: 'å…ƒç”º', center: [45.205, 141.195] },
              'shinmachi': { name: 'æ–°ç”º', center: [45.215, 141.205] }
            },
            areas: {
              'kutsugata-minato': { name: 'æ²“å½¢æ¸¯å‘¨è¾º', center: [45.215, 141.205], zoom: 16 },
              'kutsugata-honcho': { name: 'æ²“å½¢æœ¬ç”º', center: [45.208, 141.198], zoom: 16 },
              'kutsugata-nishi': { name: 'æ²“å½¢è¥¿', center: [45.205, 141.192], zoom: 16 }
            }
          },
          'senposhi': {
            name: 'ä»™æ³•å¿—',
            center: [45.136, 141.211],
            zoom: 15,
            areas: {
              'senposhi-minato': { name: 'ä»™æ³•å¿—æ¸¯å‘¨è¾º', center: [45.136, 141.211], zoom: 16 },
              'senposhi-misaki': { name: 'ä»™æ³•å¿—å¾¡å´', center: [45.130, 141.215], zoom: 16 },
              'senposhi-honcho': { name: 'ä»™æ³•å¿—æœ¬ç”º', center: [45.138, 141.208], zoom: 16 }
            }
          }
        }
      },
      'rishiri-fuji-town': {
        name: 'åˆ©å°»å¯Œå£«ç”º',
        center: [45.215, 141.250],
        zoom: 14,
        districts: {
          'oshidomari': {
            name: 'é´›æ³Š',
            center: [45.242, 141.231],
            zoom: 15,
            areas: {
              'oshidomari-minato': { name: 'é´›æ³Šæ¸¯å‘¨è¾º', center: [45.242, 141.231], zoom: 16 },
              'oshidomari-onsen': { name: 'é´›æ³Šæ¸©æ³‰', center: [45.245, 141.228], zoom: 16 },
              'oshidomari-honcho': { name: 'é´›æ³Šæœ¬ç”º', center: [45.240, 141.233], zoom: 16 }
            }
          },
          'oniwaki': {
            name: 'é¬¼è„‡',
            center: [45.180, 141.270],
            zoom: 15,
            areas: {
              'oniwaki-minato': { name: 'é¬¼è„‡æ¸¯å‘¨è¾º', center: [45.180, 141.270], zoom: 16 },
              'oniwaki-honcho': { name: 'é¬¼è„‡æœ¬ç”º', center: [45.178, 141.268], zoom: 16 },
              'oniwaki-higashi': { name: 'é¬¼è„‡æ±', center: [45.182, 141.275], zoom: 16 }
            }
          }
        }
      }
    };

    // åœ°å›³ã®åˆæœŸåŒ–
    L.tileLayer.provider('Esri.WorldImagery').addTo(map);
    
    // åœ°å›³ä¸ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
    initializeMapNavigation();
    

    // åœ°å›³ä¸ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
    function initializeMapNavigation() {
      showTownButtons();
    }

    function showTownButtons() {
      clearMapLocationButtons();
      currentNavigationLevel = 0;
      
      // åˆ©å°»ç”ºãƒœã‚¿ãƒ³ï¼ˆæ²“å½¢ãƒ»ä»™æ³•å¿—ã‚¨ãƒªã‚¢ä¸­å¿ƒï¼‰
      createMapLocationButton('åˆ©å°»ç”º', [45.150, 141.210], () => {
        selectTown('rishiri-town');
      });
      
      // åˆ©å°»å¯Œå£«ç”ºãƒœã‚¿ãƒ³ï¼ˆé´›æ³Šãƒ»é¬¼è„‡ã‚¨ãƒªã‚¢ä¸­å¿ƒï¼‰
      createMapLocationButton('åˆ©å°»å¯Œå£«ç”º', [45.210, 141.270], () => {
        selectTown('rishiri-fuji-town');
      });
    }


    // çµ±ä¸€çš„ãªãƒãƒ¼ã‚«ãƒ¼ä½œæˆé–¢æ•°ï¼ˆãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹å¯¾å¿œï¼‰
    function createMarkersWithFavorites(spotsToShow, callback) {
      // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      spotMarkers.forEach(marker => map.removeLayer(marker));
      spotMarkers = [];

      // ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«å–å¾—
      fetch(`${API_BASE}/favorites`)
        .then(response => response.json())
        .then(favoritesData => {
          const favoriteNames = favoritesData.status === 'success' 
            ? new Set(favoritesData.favorites.map(fav => fav.name))
            : new Set();

          console.log('ãŠæ°—ã«å…¥ã‚Šå¹²å ´:', Array.from(favoriteNames));

          spotsToShow.forEach(spot => {
            const isFavorite = favoriteNames.has(spot.name);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
            const markerIcon = isFavorite 
              ? L.divIcon({
                  className: 'custom-div-icon favorite-marker',
                  html: `
                    <div style="
                      position: relative;
                      width: 32px;
                      height: 32px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
                      <div style="
                        background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
                        color: #d84315;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 18px;
                        border: 3px solid #ff6f00;
                        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3);
                        animation: pulse-favorite 2s infinite;
                        transform: scale(1.1);
                        z-index: 1000;
                      ">â­</div>
                    </div>
                    <style>
                      @keyframes pulse-favorite {
                        0% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3); }
                        50% { transform: scale(1.2); box-shadow: 0 6px 16px rgba(255, 193, 7, 0.8), 0 0 0 6px rgba(255, 235, 59, 0.5); }
                        100% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6), 0 0 0 4px rgba(255, 235, 59, 0.3); }
                      }
                    </style>
                  `,
                  iconSize: [32, 32],
                  iconAnchor: [16, 16]
                })
              : L.divIcon({
                  className: 'custom-div-icon',
                  html: '<div style="background-color: #2196f3; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold;">â—</div>',
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                });

            // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
            const favoriteButtonText = isFavorite ? 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å¤–ã™' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ';
            const favoriteButtonColor = isFavorite ? '#28a745' : '#ffc107';

            const marker = L.marker([spot.lat, spot.lon], { 
              icon: markerIcon,
              title: spot.name  // ãƒãƒ¼ã‚«ãƒ¼è­˜åˆ¥ç”¨
            })
              .bindPopup(`
                <div style="text-align: center;">
                  <b>${spot.name}</b><br>
                  <small>${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}</small><br>
                  <small>ç”º: ${spot.town}</small><br>
                  <small>åœ°åŒº: ${spot.district}</small><br>
                  <small>éƒ¨è½: ${spot.buraku}</small><br>
                  <button onclick="window.getWeatherForecast(${spot.lat}, ${spot.lon})" class="btn btn-sm">å¤©æ°—äºˆå ±</button><br>
                  <button onclick="window.openRecordDialog('${spot.name}')" class="btn btn-sm" style="margin-top: 5px; background: #ff9800; color: white;">è¨˜éŒ²</button><br>
                  <button onclick="window.toggleFavorite('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" id="favorite-btn-${spot.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-top: 5px; background: ${favoriteButtonColor}; color: white;">${favoriteButtonText}</button><br>
                  <button onclick="window.confirmDeleteSpot('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" style="margin-top: 5px; background: #f44336; color: white;">å‰Šé™¤</button>
                </div>
              `)
              .addTo(map);
            
            spotMarkers.push(marker);
          });

          // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒæä¾›ã•ã‚Œã¦ã„ã‚Œã°å®Ÿè¡Œ
          if (callback) {
            callback();
          }
        })
        .catch(error => {
          console.error('ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®ãƒãƒ¼ã‚«ãƒ¼ã§è¡¨ç¤º
          spotsToShow.forEach(spot => {
            const marker = L.marker([spot.lat, spot.lon], {
              title: spot.name
            })
              .bindPopup(`
                <div style="text-align: center;">
                  <b>${spot.name}</b><br>
                  <small>${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}</small><br>
                  <small>ç”º: ${spot.town}</small><br>
                  <small>åœ°åŒº: ${spot.district}</small><br>
                  <small>éƒ¨è½: ${spot.buraku}</small><br>
                  <button onclick="window.getWeatherForecast(${spot.lat}, ${spot.lon})" class="btn btn-sm">å¤©æ°—äºˆå ±</button><br>
                  <button onclick="window.openRecordDialog('${spot.name}')" class="btn btn-sm" style="margin-top: 5px; background: #ff9800; color: white;">è¨˜éŒ²</button><br>
                  <button onclick="window.toggleFavorite('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" id="favorite-btn-${spot.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-top: 5px; background: #ffc107; color: white;">ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ </button><br>
                  <button onclick="window.confirmDeleteSpot('${spot.name}', ${spot.lat}, ${spot.lon})" class="btn btn-sm" style="margin-top: 5px; background: #f44336; color: white;">å‰Šé™¤</button>
                </div>
              `)
              .addTo(map);
            
            spotMarkers.push(marker);
          });

          if (callback) {
            callback();
          }
        });
    }


    function createMapLocationButton(text, position, clickHandler) {
      // Leafletãƒãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä½œæˆ
      const button = L.marker(position, {
        icon: L.divIcon({
          className: 'map-location-button',
          html: `<div style="background: #4a8a5a; color: white; padding: 8px 12px; border-radius: 5px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; text-align: center; white-space: nowrap;">${text}</div>`,
          iconSize: [null, null], // è‡ªå‹•ã‚µã‚¤ã‚º
          iconAnchor: [null, null]
        })
      }).addTo(map);

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      button.on('click', function(e) {
        console.log('Button clicked:', text);
        clickHandler();
        e.originalEvent.stopPropagation();
      });
      
      // ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒˆã«è¿½åŠ 
      mapLocationButtons.push(button);
      
      return button;
    }

    function clearMapLocationButtons() {
      mapLocationButtons.forEach(button => {
        map.removeLayer(button);
      });
      mapLocationButtons = [];
    }

    function selectTown(townId) {
      console.log('selectTown called with:', townId);
      currentTown = townId;
      currentNavigationLevel = 1;
      
      const town = rishiriGeography[townId];
      console.log('Town data:', town);
      
      // å¢ƒç•Œç·šã‚’ã‚¯ãƒªã‚¢ï¼ˆç·‘æ ã¯éè¡¨ç¤ºï¼‰
      clearTownBoundaries();
      
      // é¸æŠã—ãŸç”ºã®åœ°ç‚¹ã®ã¿è¡¨ç¤º
      filterSpotsByTown(townId);
      
      // ç”ºã®åœ°ç‚¹å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«åœ°å›³ç¯„å›²ã‚’è‡ªå‹•èª¿æ•´
      setTimeout(() => {
        fitMapToTownSpots(townId);
        showDistrictButtons(townId);
      }, 100); // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«å®Ÿè¡Œ
    }

    function showDistrictButtons(townId) {
      clearMapLocationButtons();
      
      const town = rishiriGeography[townId];
      Object.entries(town.districts).forEach(([districtId, district]) => {
        createMapLocationButton(district.name, district.center, () => {
          selectDistrict(townId, districtId);
        });
      });
    }

    function selectDistrict(townId, districtId) {
      console.log('selectDistrict called with:', townId, districtId);
      currentDistrict = districtId;
      currentNavigationLevel = 2;
      
      const district = rishiriGeography[townId].districts[districtId];
      console.log('District data:', district);
      
      // é¸æŠã—ãŸåœ°åŒºã®åœ°ç‚¹ã®ã¿è¡¨ç¤º
      filterSpotsByDistrict(townId, districtId);
      
      // åœ°åŒºã®åœ°ç‚¹å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«åœ°å›³ç¯„å›²ã‚’è‡ªå‹•èª¿æ•´
      setTimeout(() => {
        fitMapToDistrictSpots(townId, districtId);
        showAreaButtons(townId, districtId);
      }, 100); // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«å®Ÿè¡Œ
    }

    function showAreaButtons(townId, districtId) {
      clearMapLocationButtons();
      
      const district = rishiriGeography[townId].districts[districtId];
      
      // éƒ¨è½ãƒœã‚¿ãƒ³ã‚’å®Ÿéš›ã®CSVãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½œæˆ
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      const districtNameMap = {
        'kutsugata': 'æ²“å½¢',
        'senposhi': 'ä»™æ³•å¿—', 
        'oshidomari': 'é´›æ³Š',
        'oniwaki': 'é¬¼è„‡'
      };
      const targetDistrict = districtNameMap[districtId];
      
      // è©²å½“åœ°åŒºã®éƒ¨è½ä¸€è¦§ã‚’å–å¾—
      const distinctBurakus = [...new Set(spots
        .filter(spot => spot.town === targetTown && spot.district === targetDistrict)
        .map(spot => spot.buraku)
      )];
      
      // å„éƒ¨è½ã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—ã—ã¦ãƒœã‚¿ãƒ³ã‚’é…ç½®
      distinctBurakus.forEach(buraku => {
        const burakuSpots = spots.filter(spot => 
          spot.town === targetTown && 
          spot.district === targetDistrict && 
          spot.buraku === buraku
        );
        
        if (burakuSpots.length > 0) {
          const centerLat = burakuSpots.reduce((sum, spot) => sum + spot.lat, 0) / burakuSpots.length;
          const centerLon = burakuSpots.reduce((sum, spot) => sum + spot.lon, 0) / burakuSpots.length;
          
          createMapLocationButton(buraku, [centerLat, centerLon], () => {
            selectBuraku(townId, districtId, buraku);
          });
        }
      });
    }

    function selectBuraku(townId, districtId, buraku) {
      console.log('selectBuraku called with:', townId, districtId, buraku);
      
      // éƒ¨è½ã®åœ°ç‚¹ã®ã¿è¡¨ç¤º
      filterSpotsByBuraku(townId, districtId, buraku);
      
      // éƒ¨è½ã®åœ°ç‚¹å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«åœ°å›³ç¯„å›²ã‚’è‡ªå‹•èª¿æ•´
      setTimeout(() => {
        fitMapToBurakuSpots(townId, districtId, buraku);
        clearMapLocationButtons(); // æœ€çµ‚éšå±¤ãªã®ã§ãƒœã‚¿ãƒ³ã¯æ¶ˆã™
      }, 100);
    }

    function filterSpotsByBuraku(townId, districtId, buraku) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      const districtNameMap = {
        'kutsugata': 'æ²“å½¢',
        'senposhi': 'ä»™æ³•å¿—', 
        'oshidomari': 'é´›æ³Š',
        'oniwaki': 'é¬¼è„‡'
      };
      const targetDistrict = districtNameMap[districtId];
      
      console.log(`éƒ¨è½ãƒ•ã‚£ãƒ«ã‚¿å¯¾è±¡: ${targetTown} - ${targetDistrict} - ${buraku}`);
      
      // é¸æŠã—ãŸéƒ¨è½ã®åœ°ç‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && 
        spot.district === targetDistrict && 
        spot.buraku === buraku
      );
      
      console.log(`${buraku}ã®åœ°ç‚¹æ•°: ${filteredSpots.length}`);
      
      // çµ±ä¸€é–¢æ•°ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆãŠæ°—ã«å…¥ã‚Šè‰²å¯¾å¿œï¼‰
      createMarkersWithFavorites(filteredSpots);
    }
    
    function fitMapToBurakuSpots(townId, districtId, buraku) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      const districtNameMap = {
        'kutsugata': 'æ²“å½¢',
        'senposhi': 'ä»™æ³•å¿—', 
        'oshidomari': 'é´›æ³Š',
        'oniwaki': 'é¬¼è„‡'
      };
      const targetDistrict = districtNameMap[districtId];
      
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && 
        spot.district === targetDistrict && 
        spot.buraku === buraku
      );
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // éƒ¨è½ãƒ¬ãƒ™ãƒ«ã§ã¯æœ€ã‚‚è©³ç´°ã«ã‚ºãƒ¼ãƒ 
        const fitOptions = {
          padding: [10, 10],
          maxZoom: 15 // éƒ¨è½ãƒ¬ãƒ™ãƒ«ã¯æœ€ã‚‚è¿‘ãã«ã‚ºãƒ¼ãƒ 
        };
        
        map.fitBounds(bounds, fitOptions);
      }
    }

    function resetMapNavigation() {
      clearMapLocationButtons();
      clearTownBoundaries();
      map.setView([45.178269, 141.228528], 11);
      showAllSpots(); // å…¨åœ°ç‚¹ã‚’å†è¡¨ç¤º
      showTownButtons();
    }

    // ç”ºåˆ¥åœ°ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
    function filterSpotsByTown(townId) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      
      // é¸æŠã—ãŸç”ºã®åœ°ç‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredSpots = spots.filter(spot => spot.town === targetTown);
      
      console.log(`${targetTown}ã®åœ°ç‚¹æ•°: ${filteredSpots.length}`);
      console.log('Filtered spots sample:', filteredSpots.slice(0, 3));
      
      // çµ±ä¸€é–¢æ•°ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆãŠæ°—ã«å…¥ã‚Šè‰²å¯¾å¿œï¼‰
      createMarkersWithFavorites(filteredSpots);
    }

    // åœ°åŒºåˆ¥åœ°ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
    function filterSpotsByDistrict(townId, districtId) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      
      // åœ°åŒºIDã‹ã‚‰å®Ÿéš›ã®åœ°åŒºåã«ãƒãƒƒãƒ”ãƒ³ã‚°
      const districtNameMap = {
        'kutsugata': 'æ²“å½¢',
        'senposhi': 'ä»™æ³•å¿—', 
        'oshidomari': 'é´›æ³Š',
        'oniwaki': 'é¬¼è„‡'
      };
      
      const targetDistrict = districtNameMap[districtId];
      console.log(`ãƒ•ã‚£ãƒ«ã‚¿å¯¾è±¡: ${targetTown} - ${targetDistrict}`);
      
      // é¸æŠã—ãŸç”ºãƒ»åœ°åŒºã®åœ°ç‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && spot.district === targetDistrict
      );
      
      console.log(`${targetDistrict}åœ°åŒºã®åœ°ç‚¹æ•°: ${filteredSpots.length}`);
      console.log('Filtered district spots sample:', filteredSpots.slice(0, 3));
      
      // çµ±ä¸€é–¢æ•°ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆãŠæ°—ã«å…¥ã‚Šè‰²å¯¾å¿œï¼‰
      createMarkersWithFavorites(filteredSpots);
    }

    // å…¨åœ°ç‚¹ã‚’è¡¨ç¤º
    function showAllSpots() {
      displaySpots(); // æ—¢å­˜ã®è¡¨ç¤ºé–¢æ•°ã‚’ä½¿ç”¨
    }

    // ç”ºã®åœ°ç‚¹ã«åˆã‚ã›ã¦åœ°å›³ç¯„å›²ã‚’è‡ªå‹•èª¿æ•´
    function fitMapToTownSpots(townId) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      const filteredSpots = spots.filter(spot => spot.town === targetTown);
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // ç”ºã”ã¨ã«æœ€é©ãªã‚ºãƒ¼ãƒ è¨­å®š
        let fitOptions;
        if (targetTown === 'åˆ©å°»å¯Œå£«ç”º') {
          // åˆ©å°»å¯Œå£«ç”ºã¯ç¯„å›²ãŒåºƒã„ã®ã§ã€ã‚ˆã‚Šç©æ¥µçš„ã«ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
          fitOptions = {
            padding: [10, 10],
            maxZoom: 12.5  // ã‚ˆã‚Šè¿‘ãã«ã‚ºãƒ¼ãƒ 
          };
        } else {
          // åˆ©å°»ç”ºã¯æ¯”è¼ƒçš„ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ
          fitOptions = {
            padding: [20, 20],
            maxZoom: 13
          };
        }
        
        map.fitBounds(bounds, fitOptions);
      }
    }

    // åœ°åŒºã®åœ°ç‚¹ã«åˆã‚ã›ã¦åœ°å›³ç¯„å›²ã‚’è‡ªå‹•èª¿æ•´
    function fitMapToDistrictSpots(townId, districtId) {
      const targetTown = townId === 'rishiri-town' ? 'åˆ©å°»ç”º' : 'åˆ©å°»å¯Œå£«ç”º';
      
      const districtNameMap = {
        'kutsugata': 'æ²“å½¢',
        'senposhi': 'ä»™æ³•å¿—', 
        'oshidomari': 'é´›æ³Š',
        'oniwaki': 'é¬¼è„‡'
      };
      
      const targetDistrict = districtNameMap[districtId];
      const filteredSpots = spots.filter(spot => 
        spot.town === targetTown && spot.district === targetDistrict
      );
      
      if (filteredSpots.length > 0) {
        const bounds = L.latLngBounds();
        filteredSpots.forEach(spot => {
          bounds.extend([spot.lat, spot.lon]);
        });
        
        // åœ°åŒºãƒ¬ãƒ™ãƒ«ã§ã¯ã‚ˆã‚Šè©³ç´°ã«ã‚ºãƒ¼ãƒ 
        const fitOptions = {
          padding: [15, 15],
          maxZoom: 14 // åœ°åŒºãƒ¬ãƒ™ãƒ«ã¯ã‚ˆã‚Šè¿‘ãã«ã‚ºãƒ¼ãƒ 
        };
        
        map.fitBounds(bounds, fitOptions);
        console.log(`${targetDistrict}åœ°åŒºã«ã‚ºãƒ¼ãƒ èª¿æ•´å®Œäº†`);
      }
    }

    // DOMè¦ç´ ã®å–å¾—
    const addModeButton = document.getElementById('addModeButton');
    const refreshButton = document.getElementById('refreshButton');
    const newSpotInfo = document.getElementById('newSpotInfo');
    const newSpotDetails = document.getElementById('newSpotDetails');
    const newSpotName = document.getElementById('newSpotName');
    const newSpotCoords = document.getElementById('newSpotCoords');
    const saveSpot = document.getElementById('saveSpot');
    const cancelSpot = document.getElementById('cancelSpot');
    
    const spotInfo = document.getElementById('spotInfo');
    const selectedSpotName = document.getElementById('selectedSpotName');
    const selectedSpotCoords = document.getElementById('selectedSpotCoords');
    const forecastButton = document.getElementById('forecastButton');
    const recordButton = document.getElementById('recordButton');
    const deleteButton = document.getElementById('deleteButton');
    
    const forecastPanel = document.getElementById('forecastPanel');
    const forecastContent = document.getElementById('forecastContent');
    const recordPanel = document.getElementById('recordPanel');
    const recordDate = document.getElementById('recordDate');
    const recordStatus = document.getElementById('recordStatus');

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
    recordDate.valueAsDate = new Date();

    // åœ°å›³ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const resetMapViewButton = document.getElementById('resetMapViewButton');
    resetMapViewButton.addEventListener('click', resetMapNavigation);

    // å¹²å ´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    function loadSpots() {
      fetch(`${API_BASE}/spots`)
        .then(res => res.json())
        .then(data => {
          spots = data;
          console.log('Loaded spots data:', spots.length, 'spots');
          console.log('Sample spot:', spots[0]);
          
          // ç”ºåˆ¥ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
          const rishiriTown = spots.filter(s => s.town === 'åˆ©å°»ç”º').length;
          const rishiriFujiTown = spots.filter(s => s.town === 'åˆ©å°»å¯Œå£«ç”º').length;
          console.log('åˆ©å°»ç”ºã®åœ°ç‚¹æ•°:', rishiriTown);
          console.log('åˆ©å°»å¯Œå£«ç”ºã®åœ°ç‚¹æ•°:', rishiriFujiTown);
          
          displaySpots();
          showTownButtons(); // åˆæœŸåŒ–æ™‚ã«ç”ºãƒœã‚¿ãƒ³ã‚‚è¡¨ç¤º
        })
        .catch(err => {
          console.error('å¹²å ´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
          alert('å¹²å ´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }

    // å¹²å ´ã‚’ãƒãƒƒãƒ—ã«è¡¨ç¤ºï¼ˆçµ±ä¸€é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    function displaySpots() {
      console.log('displaySpots: å…¨å¹²å ´ã‚’è¡¨ç¤º');
      createMarkersWithFavorites(spots);
    }

    // å¹²å ´é¸æŠ
    function selectSpot(spotName) {
      const spot = spots.find(s => s.name === spotName);
      if (!spot) return;

      selectedSpot = spot;
      currentSelectedSpot = spotName;
      selectedSpotName.textContent = spot.name;
      selectedSpotCoords.textContent = `${spot.lat.toFixed(4)}, ${spot.lon.toFixed(4)}`;
      
      spotInfo.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      
      // è¨˜éŒ²ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ¶å¾¡
      checkSpotRecords(spotName);
      
      // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      updateFavoriteButton();
      
      // åœ°å›³ã‚’é¸æŠã—ãŸå¹²å ´ã«ç§»å‹•
      map.setView([spot.lat, spot.lon], 15);
    }

    // å¹²å ´ã®è¨˜éŒ²æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
    function checkSpotRecords(spotName) {
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}`)
        .then(res => res.json())
        .then(data => {
          const deleteButton = document.getElementById('deleteButton');
          if (data.has_records) {
            // è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            deleteButton.style.display = 'none';
          } else {
            // è¨˜éŒ²ãŒãªã„å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            deleteButton.style.display = 'inline-block';
          }
        })
        .catch(err => {
          console.error('è¨˜éŒ²ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å®‰å…¨ã®ãŸã‚å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          document.getElementById('deleteButton').style.display = 'none';
        });
    }

    // æ–°è¦å¹²å ´è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    addModeButton.addEventListener('click', () => {
      if (!addMode) {
        addMode = true;
        addModeButton.textContent = 'âŒ è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        addModeButton.className = 'btn btn-danger';
        addModeButton.style.fontWeight = 'bold';
        newSpotInfo.style.display = 'block';
        spotInfo.style.display = 'none';
        forecastPanel.style.display = 'none';
        recordPanel.style.display = 'none';
        document.getElementById('adaptiveLearningPanel').style.display = 'none';
        document.getElementById('seasonPanel').style.display = 'none';
        document.getElementById('notificationPanel').style.display = 'none';

        // åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹å‰ã®è­¦å‘Š
        showMobileMessage('âš ï¸ é™¸åœ°ã®ã¿ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã™ã€‚æµ·ä¸Šã¯è¿½åŠ ã§ãã¾ã›ã‚“ã€‚', 'warning', 4000);

        // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®è¿½åŠ æŒ‡ç¤ºã‚’è¡¨ç¤º
        showAddModeInstructions();
      } else {
        cancelAddMode();
      }
    });

    // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆæ±ç”¨ï¼‰
    function showMobileMessage(message, type = 'info', duration = 3000) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'warning' ? '#ff6b35' : type === 'success' ? '#28a745' : '#007bff'};
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        z-index: 10001;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 90%;
        animation: slideInDown 0.3s ease-out;
      `;
      messageDiv.innerHTML = message;
      document.body.appendChild(messageDiv);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSS ã‚’å‹•çš„è¿½åŠ 
      if (!document.getElementById('mobileMessageStyles')) {
        const style = document.createElement('style');
        style.id = 'mobileMessageStyles';
        style.textContent = `
          @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
          }
          @keyframes slideOutUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      setTimeout(() => {
        messageDiv.style.animation = 'slideOutUp 0.3s ease-out';
        setTimeout(() => {
          if (document.body.contains(messageDiv)) {
            document.body.removeChild(messageDiv);
          }
        }, 300);
      }, duration);
    }

    // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘è¿½åŠ ãƒ¢ãƒ¼ãƒ‰æŒ‡ç¤ºè¡¨ç¤º
    function showAddModeInstructions() {
      // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
      
      if (isMobile) {
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        let instructionDiv = document.getElementById('mobileAddInstructions');
        if (!instructionDiv) {
          instructionDiv = document.createElement('div');
          instructionDiv.id = 'mobileAddInstructions';
          instructionDiv.style.cssText = `
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #007bff;
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 90%;
          `;
          instructionDiv.innerHTML = 'ğŸ‘† åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ ';
          document.body.appendChild(instructionDiv);
        }
        instructionDiv.style.display = 'block';
      }
    }

    // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelAddMode() {
      addMode = false;
      addModeButton.textContent = 'ï¼‹ æ–°è¦å¹²å ´ã‚’è¿½åŠ ';
      addModeButton.className = 'btn';
      addModeButton.style.fontWeight = 'normal';
      newSpotInfo.style.display = 'none';
      newSpotDetails.style.display = 'none';
      
      // ãƒ¢ãƒã‚¤ãƒ«æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const instructionDiv = document.getElementById('mobileAddInstructions');
      if (instructionDiv) {
        instructionDiv.style.display = 'none';
      }
      
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }

    // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¹²å ´è¿½åŠ ç”¨ï¼‰
    function handleMapClick(e) {
      if (!addMode) return;

      const lat = e.latlng.lat;
      const lon = e.latlng.lng;
      
      // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
      
      if (isMobile) {
        // ã‚¿ãƒƒãƒ—ä½ç½®ã«ä¸€æ™‚çš„ãªè¦–è¦šåŠ¹æœã‚’è¡¨ç¤º
        const tapIndicator = L.circleMarker([lat, lon], {
          radius: 15,
          color: '#007bff',
          fillColor: '#007bff',
          fillOpacity: 0.3,
          weight: 3
        }).addTo(map);
        
        setTimeout(() => {
          map.removeLayer(tapIndicator);
        }, 1000);
      }
      
      // åˆ©å°»å³¶ã‚¨ãƒªã‚¢å†…ã‹ãƒã‚§ãƒƒã‚¯
      if (lat < 45.120 || lat > 45.260 || lon < 141.180 || lon > 141.280) {
        if (isMobile) {
          showMobileMessage('å¹²å ´ã¯åˆ©å°»å³¶ã‚¨ãƒªã‚¢å†…ã«è¨­å®šã—ã¦ãã ã•ã„', 'warning');
        } else {
          alert('å¹²å ´ã¯åˆ©å°»å³¶ã‚¨ãƒªã‚¢å†…ï¼ˆ45.120-45.260Â°N, 141.180-141.280Â°Eï¼‰ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        }
        return;
      }
      
      // å¹²å ´åã®ç”Ÿæˆï¼ˆH_ç·¯åº¦4æ¡_çµŒåº¦4æ¡ï¼‰
      const latPart = Math.round((lat - Math.floor(lat)) * 10000);
      const lonPart = Math.round((lon - Math.floor(lon)) * 10000);
      const spotName = `H_${latPart}_${lonPart}`;

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (spots.find(s => s.name === spotName)) {
        if (isMobile) {
          showMobileMessage('ã“ã®å ´æ‰€ã«ã¯æ—¢ã«å¹²å ´ãŒå­˜åœ¨ã—ã¾ã™', 'warning');
        } else {
          alert('ã“ã®å ´æ‰€ã«ã¯æ—¢ã«å¹²å ´ãŒå­˜åœ¨ã—ã¾ã™');
        }
        return;
      }

      // ä»®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
      if (tempMarker) {
        map.removeLayer(tempMarker);
      }
      tempMarker = L.marker([lat, lon]).addTo(map);

      // è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      newSpotName.textContent = spotName;
      newSpotCoords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      newSpotDetails.style.display = 'block';
      
      // ä¿å­˜ãƒœã‚¿ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      saveSpot.onclick = () => saveNewSpot(spotName, lat, lon);
    }

    // åœ°å›³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒå¯¾å¿œï¼‰
    map.on('click', handleMapClick);
    map.on('tap', handleMapClick); // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ

    // æ–°è¦å¹²å ´ä¿å­˜
    function saveNewSpot(name, lat, lon) {
      const spotData = { name, lat, lon };
      
      fetch(`${API_BASE}/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(spotData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('æ–°ã—ã„å¹²å ´ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
          cancelAddMode();
          loadSpots();
        } else {
          alert('å¹²å ´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
        }
      })
      .catch(err => {
        console.error('å¹²å ´è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
        alert('å¹²å ´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // å¹²å ´å‰Šé™¤
    deleteButton.addEventListener('click', () => {
      if (!selectedSpot) return;
      
      // å†åº¦è¨˜éŒ²æœ‰ç„¡ã‚’ç¢ºèªï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(selectedSpot.name)}`)
        .then(res => res.json())
        .then(data => {
          if (data.has_records) {
            alert('ã“ã®å¹²å ´ã«ã¯è¨˜éŒ²ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
            return;
          }
          
          if (confirm(`å¹²å ´ã€Œ${selectedSpot.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»è¨˜éŒ²ãŒãªã„å¹²å ´ã®ã¿å‰Šé™¤å¯èƒ½ã§ã™ã€‚`)) {
            fetch(`${API_BASE}/delete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: selectedSpot.name })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                alert('å¹²å ´ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                spotInfo.style.display = 'none';
                forecastPanel.style.display = 'none';
                recordPanel.style.display = 'none';
                document.getElementById('adaptiveLearningPanel').style.display = 'none';
                document.getElementById('seaFogPanel').style.display = 'none';
                // æµ·éœ§ãƒ‘ãƒãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸå ´åˆã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
                if (seaFogLayer && map.hasLayer(seaFogLayer)) {
                  removeSeaFogLayerWithAutoUpdate();
                }
                document.getElementById('seasonPanel').style.display = 'none';
                document.getElementById('notificationPanel').style.display = 'none';
                selectedSpot = null;
                loadSpots();
              } else {
                alert('å¹²å ´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            })
            .catch(err => {
              console.error('å¹²å ´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
              alert('å¹²å ´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
          }
        })
        .catch(err => {
          console.error('è¨˜éŒ²ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
          alert('è¨˜éŒ²ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    });

    // äºˆå ±è¡¨ç¤º
    forecastButton.addEventListener('click', () => {
      console.log('Forecast button clicked, selectedSpot:', selectedSpot);
      if (!selectedSpot) return;
      
      forecastPanel.style.display = 'block';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      forecastContent.innerHTML = '<div class="loading">äºˆå ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const startDate = tomorrow.toISOString().split('T')[0];
      
      console.log('Fetching forecast for:', selectedSpot.lat, selectedSpot.lon, 'date:', startDate);
      
      fetch(`${API_BASE}/forecast?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}`)
        .then(res => {
          console.log('Fetch response received:', res.status);
          return res.json();
        })
        .then(data => {
          console.log('API Response received:', data);
          displayForecast(data);
        })
        .catch(err => {
          console.error('äºˆå ±å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          forecastContent.innerHTML = '<div style="color: red;">äºˆå ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // äºˆå ±è¡¨ç¤º
    function displayForecast(forecastData) {
      console.log('displayForecast called with:', forecastData);
      
      const forecastContent = document.getElementById('forecastContent');
      if (!forecastContent) {
        console.error('forecastContent element not found');
        return;
      }
      
      if (!forecastData) {
        console.log('No forecast data:', forecastData);
        forecastContent.innerHTML = '<div style="color: red;">äºˆå ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const result = forecastData;
      let html = '';
      
      // ç¿Œæ—¥äºˆå ±ã‚’æœ€å„ªå…ˆã§è¡¨ç¤ºï¼ˆæ–°APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å¯¾å¿œï¼‰
      html += `
        <div class="tomorrow-forecast" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
          <div style="font-size: 18px; font-weight: bold; color: #1976d2; margin-bottom: 15px;">
            ğŸŒ… æ˜æ—¥ã®äºˆå ± (${new Date(Date.now() + 24*60*60*1000).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})})
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">ğŸŒŠ åˆ©å°»å³¶ç‰¹åŒ–äºˆæ¸¬</div>
            <div class="recommendation ${getRecommendationClass(result.prediction)}" style="font-size: 16px;">
              ${result.prediction || 'äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãªã—'}
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              ä¿¡é ¼åº¦: ${result.confidence}%
            </div>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">ğŸŒ¬ï¸ æ°—è±¡æ¡ä»¶</div>
            <div style="margin-bottom: 5px;">é¢¨é€Ÿ: ${result.wind} m/s</div>
            <div style="margin-bottom: 5px;">æ¹¿åº¦: ${result.humidity}%</div>
          </div>
      `;
      
      // å®‰å…¨è­¦å‘Šã®è¡¨ç¤º
      if (result.safety_warnings && result.safety_warnings.length > 0) {
        html += `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">âš ï¸ å®‰å…¨æƒ…å ±</div>
        `;
        result.safety_warnings.forEach(warning => {
          html += `<div style="color: #856404; margin-bottom: 3px;">â€¢ ${warning}</div>`;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      
      // æ¨å¥¨æƒ…å ±ï¼ˆç°¡ç´ åŒ–ï¼‰
      if (result.recommendation) {
        html += `
          <div style="background: #f0f8ff; border: 1px solid #b0d4f1; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="font-weight: bold; color: #1565c0; margin-bottom: 8px;">
              âœ… ä½œæ¥­æ¨å¥¨
            </div>
            <div style="background: white; padding: 12px; border-radius: 5px;">
              <div class="recommendation" style="font-size: 16px; font-weight: bold; color: #1565c0;">
                ${result.recommendation}
              </div>
            </div>
          </div>
        `;
      }
      
      // è¡¨ç¤ºå®Œäº†
      forecastContent.innerHTML = html;
    }


    // æ¨å¥¨ãƒ¬ãƒ™ãƒ«ã®CSSã‚¯ãƒ©ã‚¹å–å¾—ï¼ˆç°¡ç´ åŒ–ï¼‰
    function getRecommendationClass(recommendation) {
      if (!recommendation) return 'poor';
      if (recommendation.includes('â—') || recommendation.includes('Good')) return 'excellent';
      if (recommendation.includes('â—‹')) return 'good';
      if (recommendation.includes('â–³') || recommendation.includes('Storm')) return 'caution';
      return 'poor';
    }

    // å¤©æ°—äºˆå ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function getWeatherForecast(lat, lon) {
      if (!lat || !lon) {
        console.error('ç·¯åº¦ã¾ãŸã¯çµŒåº¦ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      // äºˆå ±ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
      const forecastPanel = document.getElementById('forecastPanel');
      const forecastContent = document.getElementById('forecastContent');
      
      if (forecastPanel && forecastContent) {
        forecastPanel.style.display = 'block';
        forecastContent.innerHTML = '<div class="loading">å¤©æ°—äºˆå ±ã‚’å–å¾—ä¸­...</div>';
        
        // APIå‘¼ã³å‡ºã—
        fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}`)
          .then(response => response.json())
          .then(data => {
            console.log('Weather API Response:', data);
            displayForecast(data);
          })
          .catch(error => {
            console.error('å¤©æ°—äºˆå ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            forecastContent.innerHTML = '<div style="color: red;">å¤©æ°—äºˆå ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          });
      }
    }


    // è¨˜éŒ²é–¢é€£æ©Ÿèƒ½
    function generateDetailedHourlyDisplay(detailedHourly) {
      let html = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
          <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸŒ¤ï¸ è©³ç´°æ°—è±¡æ¡ä»¶ (æ™‚é–“å¸¯åˆ¥)</h3>
          <div style="font-size: 12px; color: #666; text-align: center; margin-bottom: 15px;">
            å¹²å ´Î¸å€¤: ${detailedHourly.hoshiba_theta?.toFixed(1)}Â°
          </div>
      `;

      // åˆå‰4æ™‚ã€œåˆå¾Œ4æ™‚ï¼ˆæ°—æ¸©ãƒ»æ¹¿åº¦ï¼‰
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #e3f2fd; padding: 10px; font-weight: bold; color: #1976d2;">
            ğŸ“Š åˆå‰4æ™‚ã€œåˆå¾Œ4æ™‚ (æ°—æ¸©ãƒ»æ¹¿åº¦)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; font-size: 11px;">
      `;
      
      detailedHourly.work_hours_4_16?.forEach(hour => {
        const temp = hour.temperature?.toFixed(1) || '--';
        const humidity = hour.humidity?.toFixed(0) || '--';
        html += `
          <div style="text-align: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333;">${hour.hour}æ™‚</div>
            <div style="color: #d32f2f; margin: 2px 0;">${temp}Â°C</div>
            <div style="color: #1976d2;">${humidity}%</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // åˆå‰4æ™‚ã€œ10æ™‚ï¼ˆé¢¨å‘ãƒ»é¢¨é€Ÿãƒ»è§’åº¦å·®ï¼‰
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #e8f5e8; padding: 10px; font-weight: bold; color: #2e7d32;">
            ğŸŒ¬ï¸ åˆå‰4æ™‚ã€œ10æ™‚ (é¢¨å‘ãƒ»é¢¨é€Ÿãƒ»è§’åº¦å·®)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; font-size: 10px;">
      `;
      
      detailedHourly.morning_4_10?.forEach(hour => {
        const windDir = hour.wind_direction?.toFixed(0) || '--';
        const windSpeed = hour.wind_speed?.toFixed(1) || '--';
        const angleDiff = hour.wind_theta_diff?.toFixed(0) || '--';
        html += `
          <div style="text-align: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 3px;">${hour.hour}æ™‚</div>
            <div style="color: #2e7d32;">é¢¨å‘: ${windDir}Â°</div>
            <div style="color: #1976d2;">é¢¨é€Ÿ: ${windSpeed}m/s</div>
            <div style="color: #f57c00;">è§’åº¦å·®: ${angleDiff}Â°</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // åˆå‰10æ™‚ã€œåˆå¾Œ4æ™‚ï¼ˆæ—¥å°„ãƒ»é›²é‡ãƒ»æ°—è±¡æŒ‡æ¨™ï¼‰
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #fff3e0; padding: 10px; font-weight: bold; color: #e65100;">
            â˜€ï¸ åˆå‰10æ™‚ã€œåˆå¾Œ4æ™‚ (æ—¥å°„ãƒ»é›²é‡ãƒ»æ°—è±¡æŒ‡æ¨™)
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 9px;">
      `;
      
      detailedHourly.afternoon_10_16?.forEach(hour => {
        const solar = hour.solar_radiation?.toFixed(0) || '--';
        const cloud = hour.cloud_cover?.toFixed(0) || '--';
        const verticalV = hour.vertical_velocity?.toFixed(2) || '--';
        const ssi = hour.ssi?.toFixed(1) || '--';
        const equivTemp = hour.equivalent_potential_temp?.toFixed(0) || '--';
        
        html += `
          <div style="text-align: center; padding: 6px; border: 1px solid #eee; border-radius: 4px;">
            <div style="font-weight: bold; color: #333; margin-bottom: 2px;">${hour.hour}æ™‚</div>
            <div style="color: #ff9800; line-height: 1.2;">æ—¥å°„: ${solar}W/mÂ²</div>
            <div style="color: #607d8b; line-height: 1.2;">é›²é‡: ${cloud}%</div>
            <div style="color: #9c27b0; line-height: 1.2;">é‰›ç›´: ${verticalV}m/s</div>
            <div style="color: #4caf50; line-height: 1.2;">SSI: ${ssi}</div>
            <div style="color: #795548; line-height: 1.2;">ç›¸å½“æ¸©ä½: ${equivTemp}K</div>
          </div>
        `;
      });
      
      html += `
            </div>
          </div>
        </div>
      `;

      // ç·åˆåˆ¤å®š
      html += `
        <div style="background: white; border-radius: 8px; overflow: hidden;">
          <div style="background: #f3e5f5; padding: 10px; font-weight: bold; color: #7b1fa2;">
            ğŸ¯ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãç·åˆåˆ¤å®š
          </div>
          <div style="padding: 15px; text-align: center;">
            <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
              ä¸Šè¨˜ã®æ°—è±¡æ¡ä»¶ã¨éå»ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ç·åˆçš„ã«åˆ†æã—ãŸçµæœ:
            </div>
            <div style="padding: 10px; background: #e8f5e8; border-radius: 6px; font-weight: bold; color: #2e7d32;">
              å¹²ã›ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®šã¯ä¸Šè¨˜ã€ŒçµŒé¨“ãƒ«ãƒ¼ãƒ«äºˆæ¸¬ã€ã‚’ã”å‚ç…§ãã ã•ã„
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 8px;">
              â€» é¢¨å‘ãƒ»é¢¨é€Ÿã¯æœã®ä½œæ¥­æ™‚é–“å¸¯ã€æ—¥å°„ãƒ»é›²é‡ã¯ä¹¾ç‡¥æ™‚é–“å¸¯ã‚’é‡è¦–
            </div>
          </div>
        </div>
      `;

      html += `</div>`;
      
      return html;
    }

    // åœ°å½¢æƒ…å ±ã¨åœ°å½¢è£œæ­£åŠ¹æœè¡¨ç¤ºã‚’ç”Ÿæˆ
    function generateTerrainInfoDisplay(terrainInfo, terrainCorrections) {
      let html = `
        <div style="background: #fff8e1; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ff9800;">
          <h3 style="color: #e65100; margin-bottom: 15px; text-align: center;">ğŸ”ï¸ åœ°å½¢æ¡ä»¶ã¨æ°—è±¡è£œæ­£åŠ¹æœ</h3>
      `;

      // åœ°å½¢æƒ…å ±è¡¨ç¤º
      html += `
        <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
          <div style="background: #ffcc02; padding: 10px; font-weight: bold; color: #bf360c;">
            ğŸ“ ã“ã®åœ°ç‚¹ã®åœ°å½¢ç‰¹æ€§
          </div>
          <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">æ¨™é«˜</div>
                <div style="color: #d32f2f; font-size: 16px; font-weight: bold;">${terrainInfo.elevation?.toFixed(1) || '--'}m</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">åœŸåœ°åˆ©ç”¨</div>
                <div style="color: #2e7d32; font-size: 14px; font-weight: bold;">${terrainInfo.land_use || '--'}</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">æµ·å²¸è·é›¢</div>
                <div style="color: #1976d2;">${terrainInfo.distance_to_coast?.toFixed(1) || '--'}km</div>
              </div>
              <div>
                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">å‚¾æ–œè§’åº¦</div>
                <div style="color: #f57c00;">${terrainInfo.slope?.toFixed(1) || '--'}Â°</div>
              </div>
            </div>
          </div>
        </div>
      `;

      // åœ°å½¢è£œæ­£åŠ¹æœè¡¨ç¤º
      if (terrainCorrections) {
        const forestEffect = terrainCorrections.forest_effect;
        const coastalEffect = terrainCorrections.coastal_effect;
        
        html += `
          <div style="background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
            <div style="background: #e8f5e8; padding: 10px; font-weight: bold; color: #2e7d32;">
              ğŸ”§ åœ°å½¢ã«ã‚ˆã‚‹æ°—è±¡è£œæ­£ï¼ˆäºˆå ±ã«è‡ªå‹•é©ç”¨æ¸ˆã¿ï¼‰
            </div>
            <div style="padding: 15px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px;">
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">æ°—æ¸©è£œæ­£</div>
                  <div style="color: ${terrainCorrections.temperature_correction >= 0 ? '#d32f2f' : '#1976d2'};">
                    ${terrainCorrections.temperature_correction >= 0 ? '+' : ''}${terrainCorrections.temperature_correction?.toFixed(2) || '0.0'}Â°C
                  </div>
                  <div style="font-size: 10px; color: #666;">æ¨™é«˜ã«ã‚ˆã‚‹æ°—æ¸©ä½ä¸‹</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">æ¹¿åº¦è£œæ­£</div>
                  <div style="color: ${terrainCorrections.humidity_correction >= 0 ? '#f57c00' : '#2e7d32'};">
                    ${terrainCorrections.humidity_correction >= 0 ? '+' : ''}${terrainCorrections.humidity_correction?.toFixed(1) || '0.0'}%
                  </div>
                  <div style="font-size: 10px; color: #666;">${forestEffect ? 'æ£®æ—åŠ¹æœå«ã‚€' : 'æ¨™é«˜åŠ¹æœã®ã¿'}</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">é¢¨é€Ÿè£œæ­£</div>
                  <div style="color: ${terrainCorrections.wind_correction >= 0 ? '#2e7d32' : '#d32f2f'};">
                    ${terrainCorrections.wind_correction >= 0 ? '+' : ''}${terrainCorrections.wind_correction?.toFixed(1) || '0.0'}m/s
                  </div>
                  <div style="font-size: 10px; color: #666;">${forestEffect ? 'æ£®æ—ã«ã‚ˆã‚‹æ¸›é¢¨' : 'åœ°å½¢åŠ¹æœ'}</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #333; margin-bottom: 5px;">æ—¥å°„é‡è£œæ­£</div>
                  <div style="color: #2e7d32;">
                    ${terrainCorrections.solar_reduction > 0 ? '-' : ''}${(terrainCorrections.solar_reduction * 100)?.toFixed(0) || '0'}%
                  </div>
                  <div style="font-size: 10px; color: #666;">å¹²å ´ã¯æ—¥å°„é®è”½ãªã—</div>
                </div>
              </div>
        `;

        // ç‰¹åˆ¥ãªè­¦å‘Šè¡¨ç¤º
        if (forestEffect) {
          html += `
              <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 6px; padding: 12px; margin-top: 15px;">
                <div style="font-weight: bold; color: #d32f2f; margin-bottom: 8px;">âš ï¸ æ£®æ—åœ°å¸¯ã«ã‚ˆã‚‹é‡è¦ãªå½±éŸ¿</div>
                <div style="font-size: 12px; color: #333; line-height: 1.4;">
                  â€¢ <strong>é¢¨é€Ÿå¤§å¹…æ¸›å°‘</strong>ï¼šå‘¨å›²ã®æ£®æ—ã«ã‚ˆã‚‹é¢¨ã®é®è”½ã§æ˜†å¸ƒä¹¾ç‡¥ã«å¿…è¦ãªé¢¨é€šã—ãŒæ‚ªåŒ–<br>
                  â€¢ <strong>æ¹¿åº¦ä¸Šæ˜‡</strong>ï¼šæ£®æ—åœ°å¸¯ã®æ¹¿æ½¤ãªç©ºæ°—ã«ã‚ˆã‚Šä¹¾ç‡¥åŠ¹ç‡ãŒä½ä¸‹<br>
                  â€¢ <strong>æ—¥å°„é‡</strong>ï¼šå¹²å ´è‡ªä½“ã¯æ•´åœ°ã•ã‚ŒãŸç ‚åˆ©ã®å ´ãªã®ã§æ—¥å°„é®è”½ã¯ãªã—
                </div>
                <div style="font-size: 11px; color: #d32f2f; margin-top: 8px; font-weight: bold;">
                  â†’ ã“ã®åœ°ç‚¹ã§ã¯ä¹¾ç‡¥æ¡ä»¶ãŒæ‚ªåŒ–ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                </div>
              </div>
          `;
        }

        if (coastalEffect) {
          html += `
              <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-top: 10px;">
                <div style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">ğŸŒŠ æµ·å²¸åŠ¹æœ</div>
                <div style="font-size: 12px; color: #333;">
                  æµ·é¢¨ã«ã‚ˆã‚‹æ¹¿åº¦ä¸Šæ˜‡ã¨é¢¨é€Ÿå¢—åŠ ã®å½±éŸ¿ãŒã‚ã‚Šã¾ã™
                </div>
              </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      }

      html += `</div>`;
      
      return html;
    }

    // è¨˜éŒ²å…¥åŠ›
    recordButton.addEventListener('click', () => {
      if (!selectedSpot) return;
      
      recordPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      recordStatus.innerHTML = '';
    });

    // è‡ªå‹•å­¦ç¿’ãƒ‘ãƒãƒ«
    const adaptiveLearningButton = document.getElementById('adaptiveLearningButton');
    adaptiveLearningButton.addEventListener('click', () => {
      const adaptiveLearningPanel = document.getElementById('adaptiveLearningPanel');
      adaptiveLearningPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('adaptiveStatus').innerHTML = '';
    });

    // æ¼æœŸç®¡ç†ãƒ‘ãƒãƒ«
    const seasonButton = document.getElementById('seasonButton');
    seasonButton.addEventListener('click', () => {
      const seasonPanel = document.getElementById('seasonPanel');
      seasonPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      loadSeasonStatus();
    });

    // é€šçŸ¥è¨­å®šãƒ‘ãƒãƒ«
    const notificationButton = document.getElementById('notificationButton');
    notificationButton.addEventListener('click', () => {
      const notificationPanel = document.getElementById('notificationPanel');
      notificationPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadNotificationStatus();
    });

    // æµ·éœ§äºˆæ¸¬ãƒ‘ãƒãƒ«
    const seaFogButton = document.getElementById('seaFogButton');
    seaFogButton.addEventListener('click', () => {
      const seaFogPanel = document.getElementById('seaFogPanel');
      seaFogPanel.style.display = 'block';
      
      // æµ·éœ§ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•èª­ã¿è¾¼ã¿
      if (selectedSpot) {
        loadSeaFogStatus();
      }
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadSeaFogStatus();
    });

    // ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ‘ãƒãƒ«
    const systemMonitorButton = document.getElementById('systemMonitorButton');
    systemMonitorButton.addEventListener('click', () => {
      const systemMonitorPanel = document.getElementById('systemMonitorPanel');
      systemMonitorPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadSystemMonitorStatus();
    });

    // ãŠæ°—ã«å…¥ã‚Šãƒ‘ãƒãƒ«
    const favoritesButton = document.getElementById('favoritesButton');
    favoritesButton.addEventListener('click', () => {
      const favoritesPanel = document.getElementById('favoritesPanel');
      favoritesPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadFavoritesStatus();
    });
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«
    const backupButton = document.getElementById('backupButton');
    backupButton.addEventListener('click', () => {
      const backupPanel = document.getElementById('backupPanel');
      backupPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('helpPanel').style.display = 'none';
      loadBackupStatus();
    });

    // ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ«
    const helpButton = document.getElementById('helpButton');
    helpButton.addEventListener('click', () => {
      const helpPanel = document.getElementById('helpPanel');
      helpPanel.style.display = 'block';
      forecastPanel.style.display = 'none';
      recordPanel.style.display = 'none';
      document.getElementById('adaptiveLearningPanel').style.display = 'none';
      document.getElementById('seasonPanel').style.display = 'none';
      document.getElementById('notificationPanel').style.display = 'none';
      document.getElementById('favoritesPanel').style.display = 'none';
      document.getElementById('systemMonitorPanel').style.display = 'none';
      document.getElementById('backupPanel').style.display = 'none';
      loadHelpContent();
    });

    // è¨˜éŒ²ä¿å­˜
    document.querySelectorAll('#recordPanel .btn[data-result]').forEach(button => {
      button.addEventListener('click', () => {
        if (!selectedSpot) return;
        
        const result = button.dataset.result;
        const date = recordDate.value;
        
        if (!date) {
          alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        const recordData = {
          name: selectedSpot.name,
          date: date,
          result: result
        };
        
        fetch(`${API_BASE}/record`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(recordData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            recordStatus.innerHTML = '<div style="color: green;">âœ“ è¨˜éŒ²ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>';
          } else {
            recordStatus.innerHTML = '<div style="color: red;">âœ— è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          }
        })
        .catch(err => {
          console.error('è¨˜éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
          recordStatus.innerHTML = '<div style="color: red;">âœ— è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
      });
    });

    // è‡ªå‹•å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
    document.getElementById('processLearningButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">ğŸ”„ å­¦ç¿’å‡¦ç†ä¸­...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/process`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            adaptiveStatus.innerHTML = `
              <div style="color: green;">âœ“ å­¦ç¿’å‡¦ç†å®Œäº†</div>
              <div>æ–°ãƒ‡ãƒ¼ã‚¿è¿½åŠ : ${data.new_data_added ? 'ã‚ã‚Š' : 'ãªã—'}</div>
              ${data.model_retrained ? '<div>ãƒ¢ãƒ‡ãƒ«å†è¨“ç·´: å®Œäº†</div>' : ''}
            `;
          } else {
            adaptiveStatus.innerHTML = `<div style="color: red;">âœ— ã‚¨ãƒ©ãƒ¼: ${data.message}</div>`;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">âœ— é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>';
        });
    });

    document.getElementById('qualityReportButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆå–å¾—ä¸­...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/quality`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            adaptiveStatus.innerHTML = `<div style="color: red;">âœ— ${data.error}</div>`;
          } else {
            let html = '<div style="color: green;">ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ¬ãƒãƒ¼ãƒˆ</div>';
            html += `<div>ç·è¨˜éŒ²æ•°: ${data.total_records}</div>`;
            if (data.quality_distribution) {
              html += '<div>å“è³ªåˆ†å¸ƒ:</div>';
              Object.entries(data.quality_distribution).forEach(([key, value]) => {
                html += `<div style="margin-left: 10px;">${key}: ${value}</div>`;
              });
            }
            if (data.result_statistics) {
              html += '<div>çµæœçµ±è¨ˆ:</div>';
              Object.entries(data.result_statistics).forEach(([result, stats]) => {
                html += `<div style="margin-left: 10px;">${result}: ${stats.count}ä»¶ (å“è³ª: ${stats.avg_quality.toFixed(1)})</div>`;
              });
            }
            adaptiveStatus.innerHTML = html;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">âœ— é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>';
        });
    });

    document.getElementById('retrainModelButton').addEventListener('click', () => {
      const adaptiveStatus = document.getElementById('adaptiveStatus');
      adaptiveStatus.innerHTML = '<div style="color: blue;">ğŸ§  ãƒ¢ãƒ‡ãƒ«å†è¨“ç·´ä¸­...</div>';
      
      fetch(`${API_BASE}/adaptive_learning/retrain`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            adaptiveStatus.innerHTML = `
              <div style="color: green;">âœ“ ãƒ¢ãƒ‡ãƒ«å†è¨“ç·´å®Œäº†</div>
              <div>ç‰¹å¾´é‡: ${data.features ? data.features.join(', ') : 'ä¸æ˜'}</div>
              <div>è¨“ç·´ã‚µã‚¤ã‚º: ${data.training_size}</div>
            `;
          } else {
            adaptiveStatus.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
          }
        })
        .catch(err => {
          adaptiveStatus.innerHTML = '<div style="color: red;">âœ— é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>';
        });
    });

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    cancelSpot.addEventListener('click', cancelAddMode);
    
    // æ›´æ–°ãƒœã‚¿ãƒ³
    refreshButton.addEventListener('click', loadSpots);

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
    const townSelect = document.getElementById('townSelect');
    const districtSelect = document.getElementById('districtSelect');
    const areaSelect = document.getElementById('areaSelect');
    const districtStep = document.getElementById('districtStep');
    const areaStep = document.getElementById('areaStep');
    const resetNavButton = document.getElementById('resetNavButton');
    const currentLocation = document.getElementById('currentLocation');
    const currentLocationText = document.getElementById('currentLocationText');

    // ç”ºé¸æŠ
    townSelect.addEventListener('change', (e) => {
      const townId = e.target.value;
      
      if (!townId) {
        districtStep.style.display = 'none';
        areaStep.style.display = 'none';
        resetNavButton.style.display = 'none';
        return;
      }

      const town = rishiriGeography[townId];
      
      // åœ°å›³ã‚’ç”ºã«ã‚ºãƒ¼ãƒ 
      map.setView(town.center, town.zoom);
      
      // ç”ºã®å¢ƒç•Œã‚’è¡¨ç¤º
      clearTownBoundaries();
      showTownBoundary(townId, town);
      
      // åœ°åŒºé¸æŠè‚¢ã‚’æ›´æ–°
      districtSelect.innerHTML = '<option value="">-- åœ°åŒºã‚’é¸æŠ --</option>';
      Object.entries(town.districts).forEach(([districtId, district]) => {
        const option = document.createElement('option');
        option.value = districtId;
        option.textContent = district.name;
        districtSelect.appendChild(option);
      });
      
      districtStep.style.display = 'block';
      areaStep.style.display = 'none';
      resetNavButton.style.display = 'inline-block';
      
      // ç¾åœ¨åœ°è¡¨ç¤ºã‚’æ›´æ–°
      currentLocationText.textContent = town.name;
      currentLocation.style.display = 'block';
    });

    // åœ°åŒºé¸æŠ
    districtSelect.addEventListener('change', (e) => {
      const districtId = e.target.value;
      const townId = townSelect.value;
      
      if (!districtId || !townId) {
        areaStep.style.display = 'none';
        return;
      }

      const district = rishiriGeography[townId].districts[districtId];
      
      // åœ°å›³ã‚’åœ°åŒºã«ã‚ºãƒ¼ãƒ 
      map.setView(district.center, district.zoom);
      
      // åœ°åŸŸé¸æŠè‚¢ã‚’æ›´æ–°
      areaSelect.innerHTML = '<option value="">-- åœ°åŸŸã‚’é¸æŠ --</option>';
      Object.entries(district.areas).forEach(([areaId, area]) => {
        const option = document.createElement('option');
        option.value = areaId;
        option.textContent = area.name;
        areaSelect.appendChild(option);
      });
      
      areaStep.style.display = 'block';
      
      // ç¾åœ¨åœ°è¡¨ç¤ºã‚’æ›´æ–°
      const townName = rishiriGeography[townId].name;
      currentLocationText.textContent = `${townName} > ${district.name}`;
      currentLocation.style.display = 'block';
    });

    // åœ°åŸŸé¸æŠ
    areaSelect.addEventListener('change', (e) => {
      const areaId = e.target.value;
      const districtId = districtSelect.value;
      const townId = townSelect.value;
      
      if (!areaId || !districtId || !townId) return;

      const area = rishiriGeography[townId].districts[districtId].areas[areaId];
      
      // åœ°å›³ã‚’åœ°åŸŸã«ã‚ºãƒ¼ãƒ 
      map.setView(area.center, area.zoom);
      
      // ç¾åœ¨åœ°è¡¨ç¤ºã‚’æ›´æ–°
      const townName = rishiriGeography[townId].name;
      const districtName = rishiriGeography[townId].districts[districtId].name;
      currentLocationText.textContent = `${townName} > ${districtName} > ${area.name}`;
      currentLocation.style.display = 'block';
    });

    // å¢ƒç•Œè¡¨ç¤ºæ©Ÿèƒ½
    function showTownBoundary(townId, town) {
      const boundaries = {
        'rishiri-town': [
          [45.120, 141.180], [45.178, 141.180], [45.178, 141.225], 
          [45.165, 141.240], [45.145, 141.235], [45.130, 141.220], [45.120, 141.200]
        ],
        'rishiri-fuji-town': [
          [45.178, 141.225], [45.260, 141.225], [45.260, 141.280], 
          [45.200, 141.280], [45.165, 141.240], [45.178, 141.225]
        ]
      };

      if (boundaries[townId]) {
        const polygon = L.polygon(boundaries[townId], {
          color: townId === 'rishiri-town' ? '#28a745' : '#007bff',
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.1
        }).addTo(map);
        
        polygon.bindPopup(`ğŸ“ ${town.name}ã‚¨ãƒªã‚¢`);
        townBoundaries[townId] = polygon;
      }
    }

    function clearTownBoundaries() {
      Object.values(townBoundaries).forEach(boundary => {
        if (boundary) map.removeLayer(boundary);
      });
      townBoundaries = {};
    }

    // å…¨å³¶è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
    resetNavButton.addEventListener('click', () => {
      map.setView([45.178269, 141.228528], 11);
      
      townSelect.value = '';
      districtSelect.value = '';
      areaSelect.value = '';
      
      districtStep.style.display = 'none';
      areaStep.style.display = 'none';
      resetNavButton.style.display = 'none';
      currentLocation.style.display = 'none';
      
      clearTownBoundaries();
    });

    // æ¼æœŸç®¡ç†æ©Ÿèƒ½
    function loadSeasonStatus() {
      const seasonStatus = document.getElementById('seasonStatus');
      const seasonDetails = document.getElementById('seasonDetails');
      
      seasonStatus.innerHTML = '<div style="color: blue;">ğŸ“… æ¼æœŸæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/fishing_season/status`)
        .then(res => res.json())
        .then(data => {
          seasonStatus.className = `season-status ${data.status}`;
          
          let html = `<strong>${data.message}</strong><br>`;
          
          if (data.status === 'in_season') {
            html += `é€²æ—: ${data.progress}% (æ®‹ã‚Š${data.days_remaining}æ—¥)`;
          } else if (data.status === 'pre_season') {
            html += `é–‹å§‹ã¾ã§: ${data.days_until_start}æ—¥`;
          } else if (data.status === 'post_season') {
            html += `æ¬¡æœŸé–‹å§‹ã¾ã§: ${data.days_until_next}æ—¥`;
          }
          
          seasonStatus.innerHTML = html;
          seasonDetails.innerHTML = '';
        })
        .catch(err => {
          seasonStatus.innerHTML = '<div style="color: red;">âœ— æ¼æœŸæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    // é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
    document.getElementById('weeklyScheduleButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">ğŸ“‹ é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/fishing_season/schedule?type=weekly`)
        .then(res => res.json())
        .then(data => {
          let html = '<div><strong>ğŸ“‹ ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</strong></div>';
          
          data.forEach(day => {
            const workStatus = day.work_permitted ? 'ä½œæ¥­å¯èƒ½' : 'ä½œæ¥­ä¸å¯';
            const cssClass = day.work_permitted ? 'work-day' : 'rest-day';
            const icon = day.work_permitted ? 'âœ“' : 'Ã—';
            
            html += `
              <div class="schedule-item ${cssClass}">
                <strong>${day.date} (${day.day_of_week.substring(0,3)})</strong>
                <span style="float: right;">${icon} ${workStatus}</span>
                <br>
                <small>${day.note || '4:00-16:00 æ˜†å¸ƒå¹²ã—ä½œæ¥­'}</small>
              </div>
            `;
          });
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">âœ— ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // ä¼‘æ¼æ—¥ç®¡ç†
    document.getElementById('restDaysButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">ğŸš« ä¼‘æ¼æ—¥æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/fishing_season/rest_days`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>ğŸš« ä¼‘æ¼æ—¥ç®¡ç†</strong></div>
            <div style="margin: 10px 0;">
              <input type="date" id="newRestDate" style="padding: 5px; margin-right: 10px;">
              <button onclick="addRestDay()" class="btn" style="padding: 5px 10px;">ä¼‘æ¼æ—¥è¿½åŠ </button>
            </div>
            <div><strong>ç¾åœ¨ã®ä¼‘æ¼æ—¥ (${data.count}æ—¥):</strong></div>
          `;
          
          if (data.rest_days.length === 0) {
            html += '<div style="color: #666; font-style: italic;">ä¼‘æ¼æ—¥ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          } else {
            data.rest_days.forEach(restDay => {
              html += `
                <div class="schedule-item rest-day">
                  <span>${restDay}</span>
                  <button onclick="removeRestDay('${restDay}')" style="float: right; background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
                </div>
              `;
            });
          }
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">âœ— ä¼‘æ¼æ—¥æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // æ¼æœŸè¨­å®š
    document.getElementById('seasonConfigButton').addEventListener('click', () => {
      const seasonDetails = document.getElementById('seasonDetails');
      seasonDetails.innerHTML = '<div style="color: blue;">âš™ï¸ æ¼æœŸè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/fishing_season/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>âš™ï¸ æ¼æœŸè¨­å®š</strong></div>
            <div class="schedule-item">
              <strong>æ¼æœŸæœŸé–“:</strong> ${data.season_period}<br>
              <strong>ä½œæ¥­æ™‚é–“:</strong> ${data.work_hours}<br>
              <strong>ä¼‘æ¼æ—¥æ•°:</strong> ${data.rest_days_count}æ—¥<br>
              <strong>é€šçŸ¥è¨­å®š:</strong> ${data.notifications_enabled.daily_forecast_time ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
            </div>
          `;
          
          seasonDetails.innerHTML = html;
        })
        .catch(err => {
          seasonDetails.innerHTML = '<div style="color: red;">âœ— è¨­å®šæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // ä¼‘æ¼æ—¥è¿½åŠ é–¢æ•°
    function addRestDay() {
      const dateInput = document.getElementById('newRestDate');
      const date = dateInput.value;
      
      if (!date) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      fetch(`${API_BASE}/fishing_season/rest_days`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: date })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('ä¼‘æ¼æ—¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
          document.getElementById('restDaysButton').click(); // å†èª­ã¿è¾¼ã¿
          dateInput.value = '';
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('ä¼‘æ¼æ—¥ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // ä¼‘æ¼æ—¥å‰Šé™¤é–¢æ•°
    function removeRestDay(dateStr) {
      if (!confirm(`${dateStr}ã®ä¼‘æ¼æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      fetch(`${API_BASE}/fishing_season/rest_days`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: `2024-${dateStr}` })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('ä¼‘æ¼æ—¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          document.getElementById('restDaysButton').click(); // å†èª­ã¿è¾¼ã¿
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('ä¼‘æ¼æ—¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
    function loadNotificationStatus() {
      const notificationStatus = document.getElementById('notificationStatus');
      const notificationDetails = document.getElementById('notificationDetails');
      
      notificationStatus.innerHTML = '<div style="color: blue;">ğŸ”” é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/notifications/scheduler`)
        .then(res => res.json())
        .then(data => {
          const status = data.running ? 'ğŸŸ¢ ç¨¼åƒä¸­' : 'ğŸ”´ åœæ­¢ä¸­';
          const config = data.config;
          
          let html = `
            <div><strong>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³:</strong> ${status}</div>
            <div><strong>é€šçŸ¥å¯¾è±¡è€…:</strong> ${config.subscriber_count}å</div>
            <div><strong>é€šçŸ¥æ™‚åˆ»:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>ç¿Œæ—¥äºˆå ±: ${config.notification_times.daily_forecast}</li>
              <li>æœã®è­¦å ±: ${config.notification_times.morning_alert}</li>
              <li>å¤•æ–¹ã¾ã¨ã‚: ${config.notification_times.evening_summary}</li>
            </ul>
          `;
          
          notificationStatus.innerHTML = html;
          notificationDetails.innerHTML = '';
        })
        .catch(err => {
          notificationStatus.innerHTML = '<div style="color: red;">âœ— é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    document.getElementById('notificationConfigButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">âš™ï¸ é€šçŸ¥è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/notifications/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>âš™ï¸ é€šçŸ¥æ™‚åˆ»è¨­å®š</strong></div>
            <div style="margin: 10px 0;">
              <div>ç¿Œæ—¥äºˆå ±é€šçŸ¥: 
                <input type="time" id="dailyForecastTime" value="${data.notification_times.daily_forecast}">
                <button onclick="updateNotificationTime('daily_forecast', document.getElementById('dailyForecastTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">æ›´æ–°</button>
              </div>
              <div style="margin-top: 5px;">æœã®è­¦å ±é€šçŸ¥: 
                <input type="time" id="morningAlertTime" value="${data.notification_times.morning_alert}">
                <button onclick="updateNotificationTime('morning_alert', document.getElementById('morningAlertTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">æ›´æ–°</button>
              </div>
              <div style="margin-top: 5px;">å¤•æ–¹ã¾ã¨ã‚é€šçŸ¥: 
                <input type="time" id="eveningSummaryTime" value="${data.notification_times.evening_summary}">
                <button onclick="updateNotificationTime('evening_summary', document.getElementById('eveningSummaryTime').value)" class="btn" style="padding: 2px 8px; margin-left: 5px;">æ›´æ–°</button>
              </div>
            </div>
            <div style="margin-top: 15px;"><strong>ğŸ“Š é…ä¿¡æ–¹æ³•:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›: ${data.delivery_methods.console ? 'âœ“' : 'âœ—'}</li>
              <li>ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›: ${data.delivery_methods.file ? 'âœ“' : 'âœ—'}</li>
              <li>ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${data.delivery_methods.email ? 'âœ“' : 'âœ—'}</li>
              <li>Webhooké€ä¿¡: ${data.delivery_methods.webhook ? 'âœ“' : 'âœ—'}</li>
            </ul>
          `;
          
          notificationDetails.innerHTML = html;
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">âœ— è¨­å®šæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('subscribersButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">ğŸ‘¥ é€šçŸ¥å¯¾è±¡è€…ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/notifications/subscribers`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>ğŸ‘¥ é€šçŸ¥å¯¾è±¡è€…ç®¡ç†</strong></div>
            <div style="margin: 10px 0;">
              <input type="text" id="newSubscriberName" placeholder="åå‰" style="padding: 5px; margin-right: 5px;">
              <input type="email" id="newSubscriberEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰" style="padding: 5px; margin-right: 5px;">
              <button onclick="addSubscriber()" class="btn" style="padding: 5px 10px;">è¿½åŠ </button>
            </div>
            <div><strong>ç¾åœ¨ã®é€šçŸ¥å¯¾è±¡è€… (${data.subscribers.length}å):</strong></div>
          `;
          
          if (data.subscribers.length === 0) {
            html += '<div style="color: gray; font-style: italic;">ã¾ã é€šçŸ¥å¯¾è±¡è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            data.subscribers.forEach(subscriber => {
              const activeStatus = subscriber.active ? 'ğŸŸ¢' : 'ğŸ”´';
              html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee;">
                  <span>${activeStatus} ${subscriber.name} ${subscriber.email ? `(${subscriber.email})` : ''}</span>
                  <button onclick="removeSubscriber(${subscriber.id})" class="btn btn-danger" style="padding: 2px 6px; font-size: 11px;">å‰Šé™¤</button>
                </div>
              `;
            });
            html += '</div>';
          }
          
          notificationDetails.innerHTML = html;
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">âœ— é€šçŸ¥å¯¾è±¡è€…ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('testNotificationButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      notificationDetails.innerHTML = '<div style="color: blue;">ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...</div>';
      
      fetch(`${API_BASE}/notifications/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          notificationDetails.innerHTML = '<div style="color: green;">âœ“ ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>';
        } else {
          notificationDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
        }
      })
      .catch(err => {
        notificationDetails.innerHTML = '<div style="color: red;">âœ— ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
    });

    document.getElementById('schedulerButton').addEventListener('click', () => {
      const notificationDetails = document.getElementById('notificationDetails');
      
      fetch(`${API_BASE}/notifications/scheduler`)
        .then(res => res.json())
        .then(data => {
          const isRunning = data.running;
          const action = isRunning ? 'DELETE' : 'POST';
          const actionText = isRunning ? 'åœæ­¢' : 'é–‹å§‹';
          
          if (confirm(`é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’${actionText}ã—ã¾ã™ã‹ï¼Ÿ`)) {
            notificationDetails.innerHTML = `<div style="color: blue;">ğŸ¯ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’${actionText}ä¸­...</div>`;
            
            fetch(`${API_BASE}/notifications/scheduler`, { method: action })
              .then(res => res.json())
              .then(result => {
                if (result.status === 'success') {
                  notificationDetails.innerHTML = `<div style="color: green;">âœ“ ${result.message}</div>`;
                  loadNotificationStatus(); // çŠ¶æ…‹æ›´æ–°
                } else {
                  notificationDetails.innerHTML = `<div style="color: red;">âœ— ${result.message}</div>`;
                }
              })
              .catch(err => {
                notificationDetails.innerHTML = `<div style="color: red;">âœ— ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼${actionText}ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
              });
          }
        })
        .catch(err => {
          notificationDetails.innerHTML = '<div style="color: red;">âœ— ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // é€šçŸ¥æ™‚åˆ»æ›´æ–°é–¢æ•°
    function updateNotificationTime(notificationType, newTime) {
      if (!newTime) {
        alert('æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      fetch(`${API_BASE}/notifications/config`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          notification_type: notificationType, 
          new_time: newTime 
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          loadNotificationStatus(); // çŠ¶æ…‹æ›´æ–°
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('é€šçŸ¥æ™‚åˆ»ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // é€šçŸ¥å¯¾è±¡è€…è¿½åŠ é–¢æ•°
    function addSubscriber() {
      const nameInput = document.getElementById('newSubscriberName');
      const emailInput = document.getElementById('newSubscriberEmail');
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      
      if (!name) {
        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      fetch(`${API_BASE}/notifications/subscribers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email: email || null })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          nameInput.value = '';
          emailInput.value = '';
          document.getElementById('subscribersButton').click(); // ãƒªãƒ­ãƒ¼ãƒ‰
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('é€šçŸ¥å¯¾è±¡è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // é€šçŸ¥å¯¾è±¡è€…å‰Šé™¤é–¢æ•°
    function removeSubscriber(subscriberId) {
      if (!confirm('ã“ã®é€šçŸ¥å¯¾è±¡è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      fetch(`${API_BASE}/notifications/subscribers`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriber_id: subscriberId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('subscribersButton').click(); // ãƒªãƒ­ãƒ¼ãƒ‰
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert('é€šçŸ¥å¯¾è±¡è€…ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½
    function loadSystemMonitorStatus() {
      const systemMonitorStatus = document.getElementById('systemMonitorStatus');
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      
      systemMonitorStatus.innerHTML = '<div style="color: blue;">ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/system/monitor`)
        .then(res => res.json())
        .then(data => {
          const monitor = data.monitor_status;
          const health = data.latest_health;
          
          const statusIcon = monitor.running ? 'ğŸŸ¢' : 'ğŸ”´';
          const statusText = monitor.running ? 'ç¨¼åƒä¸­' : 'åœæ­¢ä¸­';
          
          let healthIcon = 'â“';
          let healthColor = 'gray';
          if (health.overall_status === 'healthy') {
            healthIcon = 'ğŸ’š';
            healthColor = 'green';
          } else if (health.overall_status === 'warning') {
            healthIcon = 'âš ï¸';
            healthColor = 'orange';
          } else if (health.overall_status === 'error') {
            healthIcon = 'ğŸ”´';
            healthColor = 'red';
          }
          
          let html = `
            <div><strong>ç›£è¦–çŠ¶æ³:</strong> ${statusIcon} ${statusText}</div>
            <div><strong>ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹:</strong> <span style="color: ${healthColor};">${healthIcon} ${health.overall_status}</span></div>
            <div><strong>æœ€çµ‚ãƒã‚§ãƒƒã‚¯:</strong> ${monitor.last_check ? new Date(monitor.last_check).toLocaleString() : 'ãªã—'}</div>
            <div><strong>ç›£è¦–é–“éš”:</strong> ${monitor.config.interval}ç§’</div>
          `;
          
          if (health.issues && health.issues.length > 0) {
            html += `<div style="margin-top: 5px;"><strong>âš ï¸ å•é¡Œ:</strong></div>`;
            html += `<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px;">`;
            health.issues.forEach(issue => {
              html += `<li style="color: red;">${issue}</li>`;
            });
            html += `</ul>`;
          }
          
          systemMonitorStatus.innerHTML = html;
          systemMonitorDetails.innerHTML = '';
          
          // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
          const toggleButton = document.getElementById('monitorToggleButton');
          if (monitor.running) {
            toggleButton.textContent = 'â¸ï¸ ç›£è¦–åœæ­¢';
            toggleButton.className = 'btn btn-danger';
          } else {
            toggleButton.textContent = 'â–¶ï¸ ç›£è¦–é–‹å§‹';
            toggleButton.className = 'btn btn-secondary';
          }
        })
        .catch(err => {
          systemMonitorStatus.innerHTML = '<div style="color: red;">âœ— ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    document.getElementById('healthCheckButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">ğŸ’š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</div>';
      
      fetch(`${API_BASE}/system/health`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>ğŸ’š ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span style="color: ${data.overall_status === 'healthy' ? 'green' : data.overall_status === 'warning' ? 'orange' : 'red'};">${data.overall_status}</span></div>
              <div><strong>ãƒã‚§ãƒƒã‚¯æ™‚åˆ»:</strong> ${new Date(data.timestamp).toLocaleString()}</div>
            </div>
          `;
          
          // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
          if (data.metrics) {
            html += `<div><strong>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹:</strong></div>`;
            html += `<ul style="margin: 5px 0; padding-left: 15px; font-size: 11px;">`;
            html += `<li>CPUä½¿ç”¨ç‡: ${data.metrics.cpu_usage?.toFixed(1)}%</li>`;
            html += `<li>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡: ${data.metrics.memory_usage?.toFixed(1)}% (ç©ºã: ${data.metrics.memory_available_gb?.toFixed(1)}GB)</li>`;
            html += `<li>ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡: ${data.metrics.disk_usage?.toFixed(1)}% (ç©ºã: ${data.metrics.disk_free_gb?.toFixed(1)}GB)</li>`;
            if (data.metrics.process_memory_mb) {
              html += `<li>ã‚¢ãƒ—ãƒªãƒ¡ãƒ¢ãƒª: ${data.metrics.process_memory_mb?.toFixed(1)}MB</li>`;
            }
            html += `</ul>`;
          }
          
          // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçŠ¶æ³
          if (data.endpoints) {
            html += `<div style="margin-top: 10px;"><strong>ğŸŒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçŠ¶æ³:</strong></div>`;
            data.endpoints.forEach(endpoint => {
              const statusIcon = endpoint.status === 'healthy' ? 'âœ…' : endpoint.status === 'slow' ? 'âš ï¸' : 'âŒ';
              const responseTime = endpoint.response_time ? ` (${(endpoint.response_time * 1000).toFixed(0)}ms)` : '';
              html += `<div style="font-size: 11px;">${statusIcon} ${endpoint.endpoint.replace('http://localhost:8000', '')}${responseTime}</div>`;
            });
          }
          
          // ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³
          if (data.files) {
            html += `<div style="margin-top: 10px;"><strong>ğŸ“ é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³:</strong></div>`;
            data.files.forEach(file => {
              const statusIcon = file.status === 'ok' ? 'âœ…' : 'âŒ';
              const sizeInfo = file.size_mb ? ` (${file.size_mb.toFixed(1)}MB)` : '';
              html += `<div style="font-size: 11px;">${statusIcon} ${file.file}${sizeInfo}</div>`;
            });
          }
          
          // å•é¡ŒãŒã‚ã‚‹å ´åˆ
          if (data.issues && data.issues.length > 0) {
            html += `<div style="margin-top: 10px;"><strong>âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:</strong></div>`;
            html += `<ul style="margin: 5px 0; padding-left: 15px; font-size: 11px;">`;
            data.issues.forEach(issue => {
              html += `<li style="color: red;">${issue}</li>`;
            });
            html += `</ul>`;
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">âœ— ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('healthHistoryButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">ğŸ“ˆ ãƒ˜ãƒ«ã‚¹å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/system/health/history?hours=24`)
        .then(res => res.json())
        .then(data => {
          let html = `<div><strong>ğŸ“ˆ 24æ™‚é–“ãƒ˜ãƒ«ã‚¹å±¥æ­´ (${data.history.length}ä»¶)</strong></div>`;
          
          if (data.history.length === 0) {
            html += '<div style="color: gray; font-style: italic;">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            // æœ€æ–°ã®10ä»¶ã‚’è¡¨ç¤º
            const recentHistory = data.history.slice(-10).reverse();
            recentHistory.forEach(record => {
              const time = new Date(record.timestamp).toLocaleString();
              const statusColor = record.overall_status === 'healthy' ? 'green' : record.overall_status === 'warning' ? 'orange' : 'red';
              const statusIcon = record.overall_status === 'healthy' ? 'ğŸ’š' : record.overall_status === 'warning' ? 'âš ï¸' : 'ğŸ”´';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div><strong>${time}</strong> <span style="color: ${statusColor};">${statusIcon} ${record.overall_status}</span></div>
              `;
              
              if (record.metrics) {
                html += `<div style="margin-left: 10px; color: #666;">CPU: ${record.metrics.cpu_usage?.toFixed(1)}%, ãƒ¡ãƒ¢ãƒª: ${record.metrics.memory_usage?.toFixed(1)}%, ãƒ‡ã‚£ã‚¹ã‚¯: ${record.metrics.disk_usage?.toFixed(1)}%</div>`;
              }
              
              if (record.issues && record.issues.length > 0) {
                html += `<div style="margin-left: 10px; color: red;">å•é¡Œ: ${record.issues.length}ä»¶</div>`;
              }
              
              html += `</div>`;
            });
            
            html += '</div>';
            
            if (data.history.length > 10) {
              html += `<div style="font-size: 11px; color: #666; margin-top: 5px;">æœ€æ–°10ä»¶ã‚’è¡¨ç¤ºä¸­ (å…¨${data.history.length}ä»¶)</div>`;
            }
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">âœ— ãƒ˜ãƒ«ã‚¹å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('alertHistoryButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/system/alerts?hours=24`)
        .then(res => res.json())
        .then(data => {
          let html = `<div><strong>ğŸš¨ 24æ™‚é–“ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ (${data.alerts.length}ä»¶)</strong></div>`;
          
          if (data.alerts.length === 0) {
            html += '<div style="color: green; font-style: italic;">ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‘</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            data.alerts.reverse().forEach(alert => {
              const time = new Date(alert.timestamp).toLocaleString();
              const severityColor = alert.severity === 'critical' ? 'red' : alert.severity === 'warning' ? 'orange' : 'blue';
              const severityIcon = alert.severity === 'critical' ? 'ğŸ”´' : alert.severity === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div><strong>${time}</strong> <span style="color: ${severityColor};">${severityIcon} ${alert.severity}</span></div>
                  <div style="margin-left: 10px;">${alert.message}</div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">âœ— ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('monitorConfigButton').addEventListener('click', () => {
      const systemMonitorDetails = document.getElementById('systemMonitorDetails');
      systemMonitorDetails.innerHTML = '<div style="color: blue;">âš™ï¸ ç›£è¦–è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/system/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>âš™ï¸ ç›£è¦–è¨­å®š</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>ç›£è¦–é–“éš”:</strong> ${data.monitoring_interval}ç§’</div>
              <div><strong>ç›£è¦–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ•°:</strong> ${data.endpoints_to_monitor.length}å€‹</div>
              <div><strong>ç›£è¦–ãƒ•ã‚¡ã‚¤ãƒ«æ•°:</strong> ${data.files_to_monitor.length}å€‹</div>
            </div>
            <div><strong>ğŸ“Š è­¦å‘Šã—ãã„å€¤:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>CPUä½¿ç”¨ç‡: ${data.alert_thresholds.cpu_usage_max}%ä»¥ä¸Š</li>
              <li>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡: ${data.alert_thresholds.memory_usage_max}%ä»¥ä¸Š</li>
              <li>ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡: ${data.alert_thresholds.disk_usage_max}%ä»¥ä¸Š</li>
              <li>ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${data.alert_thresholds.response_time_max}ç§’ä»¥ä¸Š</li>
              <li>ã‚¨ãƒ©ãƒ¼å›æ•°: ${data.alert_thresholds.error_count_max}å›/æ™‚é–“ä»¥ä¸Š</li>
            </ul>
            <div style="margin-top: 10px;"><strong>ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆæ–¹æ³•:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›: ${data.alert_methods.console ? 'âœ“' : 'âœ—'}</li>
              <li>ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›: ${data.alert_methods.file ? 'âœ“' : 'âœ—'}</li>
              <li>ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${data.alert_methods.email ? 'âœ“' : 'âœ—'}</li>
              <li>Webhooké€ä¿¡: ${data.alert_methods.webhook ? 'âœ“' : 'âœ—'}</li>
            </ul>
          `;
          
          systemMonitorDetails.innerHTML = html;
        })
        .catch(err => {
          systemMonitorDetails.innerHTML = '<div style="color: red;">âœ— ç›£è¦–è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('monitorToggleButton').addEventListener('click', () => {
      const button = document.getElementById('monitorToggleButton');
      const isStarting = button.textContent.includes('é–‹å§‹');
      const method = isStarting ? 'POST' : 'DELETE';
      const action = isStarting ? 'é–‹å§‹' : 'åœæ­¢';
      
      if (confirm(`ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const systemMonitorDetails = document.getElementById('systemMonitorDetails');
        systemMonitorDetails.innerHTML = `<div style="color: blue;">ğŸ” ç›£è¦–ã‚’${action}ä¸­...</div>`;
        
        fetch(`${API_BASE}/system/monitor`, { method: method })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              systemMonitorDetails.innerHTML = `<div style="color: green;">âœ“ ${data.message}</div>`;
              loadSystemMonitorStatus(); // çŠ¶æ…‹æ›´æ–°
            } else {
              systemMonitorDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
            }
          })
          .catch(err => {
            systemMonitorDetails.innerHTML = `<div style="color: red;">âœ— ç›£è¦–${action}ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
          });
      }
    });

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
    function loadBackupStatus() {
      const backupStatus = document.getElementById('backupStatus');
      const backupDetails = document.getElementById('backupDetails');
      
      backupStatus.innerHTML = '<div style="color: blue;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/backup`)
        .then(res => res.json())
        .then(data => {
          const status = data.status;
          
          const autoStatus = status.auto_backup_running ? 'ğŸŸ¢ ç¨¼åƒä¸­' : 'ğŸ”´ åœæ­¢ä¸­';
          const lastBackup = status.last_backup ? new Date(status.last_backup).toLocaleString() : 'ãªã—';
          
          let html = `
            <div><strong>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</strong> ${autoStatus}</div>
            <div><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°:</strong> ${status.backup_count}å€‹</div>
            <div><strong>ç·ã‚µã‚¤ã‚º:</strong> ${status.total_size_mb.toFixed(1)}MB</div>
            <div><strong>æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</strong> ${lastBackup}</div>
          `;
          
          backupStatus.innerHTML = html;
          backupDetails.innerHTML = '';
          
          // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®æ›´æ–°
          const autoToggleButton = document.getElementById('autoBackupToggleButton');
          if (status.auto_backup_running) {
            autoToggleButton.textContent = 'â¸ï¸ è‡ªå‹•åœæ­¢';
            autoToggleButton.className = 'btn btn-danger';
          } else {
            autoToggleButton.textContent = 'â–¶ï¸ è‡ªå‹•é–‹å§‹';
            autoToggleButton.className = 'btn btn-secondary';
          }
        })
        .catch(err => {
          backupStatus.innerHTML = '<div style="color: red;">âœ— ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    document.getElementById('createBackupButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      
      if (confirm('æ–°ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
        backupDetails.innerHTML = '<div style="color: blue;">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...</div>';
        
        fetch(`${API_BASE}/backup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ include_logs: true })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            const info = data.backup_info;
            let html = `
              <div style="color: green;"><strong>âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å:</strong> ${info.backup_name}</div>
                <div><strong>ä½œæˆæ™‚åˆ»:</strong> ${new Date(info.created_at).toLocaleString()}</div>
                <div><strong>ã‚µã‚¤ã‚º:</strong> ${info.size_mb}MB</div>
                <div><strong>ãƒ•ã‚¡ã‚¤ãƒ«æ•°:</strong> ${info.files.length}å€‹</div>
              </div>
            `;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è©³ç´°
            const categories = ['critical', 'config', 'logs'];
            categories.forEach(category => {
              const categoryFiles = info.files.filter(f => f.category === category);
              if (categoryFiles.length > 0) {
                html += `<div style="margin-top: 5px;"><strong>${category}:</strong> ${categoryFiles.filter(f => f.backed_up).length}/${categoryFiles.length}ãƒ•ã‚¡ã‚¤ãƒ«</div>`;
              }
            });
            
            backupDetails.innerHTML = html;
            loadBackupStatus(); // çŠ¶æ…‹æ›´æ–°
          } else {
            backupDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
          }
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">âœ— ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
      }
    });

    document.getElementById('backupListButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/backup`)
        .then(res => res.json())
        .then(data => {
          const backups = data.backups;
          
          let html = `<div><strong>ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ (${backups.length}å€‹)</strong></div>`;
          
          if (backups.length === 0) {
            html += '<div style="color: gray; font-style: italic;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            backups.forEach(backup => {
              const createdAt = new Date(backup.created_at).toLocaleString();
              const compressionIcon = backup.is_compressed ? 'ğŸ“¦' : 'ğŸ“';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 5px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong>${compressionIcon} ${backup.name}</strong><br>
                      <span style="color: #666;">${createdAt} (${backup.size_mb}MB)</span>
                    </div>
                    <div>
                      <button onclick="restoreBackup('${backup.name}')" class="btn" style="padding: 2px 6px; font-size: 10px; margin-right: 5px;">å¾©å…ƒ</button>
                      <button onclick="deleteBackup('${backup.name}')" class="btn btn-danger" style="padding: 2px 6px; font-size: 10px;">å‰Šé™¤</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          backupDetails.innerHTML = html;
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">âœ— ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('autoBackupToggleButton').addEventListener('click', () => {
      const button = document.getElementById('autoBackupToggleButton');
      const isStarting = button.textContent.includes('é–‹å§‹');
      const method = isStarting ? 'POST' : 'DELETE';
      const action = isStarting ? 'é–‹å§‹' : 'åœæ­¢';
      
      if (confirm(`è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const backupDetails = document.getElementById('backupDetails');
        backupDetails.innerHTML = `<div style="color: blue;">â° è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’${action}ä¸­...</div>`;
        
        fetch(`${API_BASE}/backup/auto`, { method: method })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              backupDetails.innerHTML = `<div style="color: green;">âœ“ ${data.message}</div>`;
              loadBackupStatus(); // çŠ¶æ…‹æ›´æ–°
            } else {
              backupDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
            }
          })
          .catch(err => {
            backupDetails.innerHTML = `<div style="color: red;">âœ— è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—${action}ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
          });
      }
    });

    document.getElementById('backupConfigButton').addEventListener('click', () => {
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">âš™ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/backup/config`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div><strong>âš™ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</strong> ${data.auto_backup_enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</div>
              <div><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚åˆ»:</strong> ${data.backup_time}</div>
              <div><strong>æœ€å¤§ä¿æŒæ•°:</strong> ${data.max_backups}å€‹</div>
              <div><strong>åœ§ç¸®:</strong> ${data.compress_backups ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</div>
            </div>
            <div><strong>ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾è±¡:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«: ${data.backup_targets.critical_files.length}å€‹</li>
              <li>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ${data.backup_targets.config_files.length}å€‹</li>
              <li>ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: ${data.backup_targets.log_files.length}å€‹</li>
            </ul>
            <div style="margin-top: 10px;"><strong>ğŸ”” é€šçŸ¥è¨­å®š:</strong></div>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†é€šçŸ¥: ${data.notification_on_backup ? 'âœ“' : 'âœ—'}</li>
              <li>ã‚¨ãƒ©ãƒ¼é€šçŸ¥: ${data.notification_on_error ? 'âœ“' : 'âœ—'}</li>
            </ul>
          `;
          
          backupDetails.innerHTML = html;
        })
        .catch(err => {
          backupDetails.innerHTML = '<div style="color: red;">âœ— ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒé–¢æ•°
    function restoreBackup(backupName) {
      if (!confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€Œ${backupName}ã€ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\næ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ .backup æ‹¡å¼µå­ä»˜ãã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚`)) {
        return;
      }
      
      const backupDetails = document.getElementById('backupDetails');
      backupDetails.innerHTML = '<div style="color: blue;">ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒä¸­...</div>';
      
      fetch(`${API_BASE}/backup/restore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          backup_name: backupName,
          target_files: ['critical', 'config'] // ãƒ­ã‚°ã¯å¾©å…ƒã—ãªã„
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          const info = data.restore_info;
          let html = `
            <div style="color: green;"><strong>âœ“ å¾©å…ƒå®Œäº†</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>å¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«æ•°:</strong> ${info.restored_files.length}å€‹</div>
              <div><strong>ã‚¨ãƒ©ãƒ¼æ•°:</strong> ${info.errors.length}å€‹</div>
            </div>
          `;
          
          if (info.restored_files.length > 0) {
            html += '<div style="margin-top: 5px;"><strong>å¾©å…ƒã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</strong></div>';
            html += '<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px;">';
            info.restored_files.forEach(file => {
              const actionText = file.action === 'replaced' ? 'ç½®æ›' : 'ä½œæˆ';
              html += `<li>${file.file} (${actionText})</li>`;
            });
            html += '</ul>';
          }
          
          if (info.errors.length > 0) {
            html += '<div style="margin-top: 5px;"><strong style="color: red;">ã‚¨ãƒ©ãƒ¼:</strong></div>';
            html += '<ul style="margin: 2px 0; padding-left: 15px; font-size: 11px; color: red;">';
            info.errors.forEach(error => {
              html += `<li>${error.file}: ${error.error}</li>`;
            });
            html += '</ul>';
          }
          
          html += '<div style="margin-top: 10px; color: orange;"><strong>âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã®å†èµ·å‹•ã‚’æ¨å¥¨ã—ã¾ã™</strong></div>';
          
          backupDetails.innerHTML = html;
        } else {
          backupDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
        }
      })
      .catch(err => {
        backupDetails.innerHTML = '<div style="color: red;">âœ— å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
    }

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤é–¢æ•°
    function deleteBackup(backupName) {
      if (!confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€Œ${backupName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }
      
      fetch(`${API_BASE}/backup/${encodeURIComponent(backupName)}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          document.getElementById('backupListButton').click(); // ãƒªãƒ­ãƒ¼ãƒ‰
          loadBackupStatus(); // çŠ¶æ…‹æ›´æ–°
        } else {
          alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message}`);
        }
      })
      .catch(err => {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // ãŠæ°—ã«å…¥ã‚Šç®¡ç†æ©Ÿèƒ½
    function loadFavoritesStatus() {
      const favoritesStatus = document.getElementById('favoritesStatus');
      const favoritesDetails = document.getElementById('favoritesDetails');
      
      favoritesStatus.innerHTML = '<div style="color: blue;">â­ ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const summary = data.summary;
          
          let html = `
            <div><strong>ãŠæ°—ã«å…¥ã‚Šå¹²å ´:</strong> ${summary.total_count}/${summary.max_favorites}å€‹</div>
            <div><strong>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹:</strong> ${summary.quick_access_count}/${summary.max_quick_access}å€‹</div>
            <div><strong>ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°:</strong> ${summary.total_access_count}å›</div>
            <div><strong>å¹³å‡ã‚¢ã‚¯ã‚»ã‚¹æ•°:</strong> ${summary.average_access_count}å›/å ´æ‰€</div>
          `;
          
          favoritesStatus.innerHTML = html;
          favoritesDetails.innerHTML = '';
          
          // ç¾åœ¨é¸æŠä¸­ã®å¹²å ´ãŒãŠæ°—ã«å…¥ã‚Šã‹ãƒã‚§ãƒƒã‚¯
          updateFavoriteButton();
        })
        .catch(err => {
          favoritesStatus.innerHTML = '<div style="color: red;">âœ— ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function updateFavoriteButton() {
      const addButton = document.getElementById('addFavoriteButton');
      if (!currentSelectedSpot) {
        addButton.textContent = 'â­ å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„';
        addButton.disabled = true;
        return;
      }

      // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const isFavorite = data.favorites.some(fav => fav.name === currentSelectedSpot);
          if (isFavorite) {
            addButton.textContent = 'âŒ ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤';
            addButton.className = 'btn btn-danger';
          } else {
            addButton.textContent = 'â­ ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ';
            addButton.className = 'btn';
          }
          addButton.disabled = false;
        })
        .catch(err => {
          console.error('Favorites check error:', err);
        });
    }

    document.getElementById('addFavoriteButton').addEventListener('click', () => {
      if (!currentSelectedSpot) {
        alert('å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const favoritesDetails = document.getElementById('favoritesDetails');
      
      // ç¾åœ¨ã®ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const isFavorite = data.favorites.some(fav => fav.name === currentSelectedSpot);
          
          if (isFavorite) {
            // å‰Šé™¤
            if (confirm(`ã€Œ${currentSelectedSpot}ã€ã‚’ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
              favoritesDetails.innerHTML = '<div style="color: blue;">âŒ ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ä¸­...</div>';
              
              fetch(`${API_BASE}/favorites`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spot_name: currentSelectedSpot })
              })
              .then(res => res.json())
              .then(data => {
                if (data.status === 'success') {
                  favoritesDetails.innerHTML = `<div style="color: green;">âœ“ ${data.message}</div>`;
                  loadFavoritesStatus();
                  updateFavoriteButton();
                } else {
                  favoritesDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
                }
              })
              .catch(err => {
                favoritesDetails.innerHTML = '<div style="color: red;">âœ— å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
              });
            }
          } else {
            // è¿½åŠ 
            favoritesDetails.innerHTML = '<div style="color: blue;">â­ ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ä¸­...</div>';
            
            const spotData = {
              lat: map.getCenter().lat,
              lon: map.getCenter().lng
            };
            
            fetch(`${API_BASE}/favorites`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                spot_name: currentSelectedSpot,
                spot_data: spotData
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                favoritesDetails.innerHTML = `<div style="color: green;">âœ“ ${data.message}</div>`;
                loadFavoritesStatus();
                updateFavoriteButton();
              } else {
                favoritesDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
              }
            })
            .catch(err => {
              favoritesDetails.innerHTML = '<div style="color: red;">âœ— è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
          }
        });
    });

    document.getElementById('quickAccessButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/favorites/quick`)
        .then(res => res.json())
        .then(data => {
          const quickFavorites = data.quick_favorites;
          
          let html = `<div><strong>ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ (${quickFavorites.length}å€‹)</strong></div>`;
          
          if (quickFavorites.length === 0) {
            html += '<div style="color: gray; font-style: italic;">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            quickFavorites.forEach(fav => {
              const lastAccessed = fav.last_accessed ? new Date(fav.last_accessed).toLocaleString() : 'ãªã—';
              const colorTag = fav.color_tag !== 'default' ? `ğŸ·ï¸${fav.color_tag}` : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 12px;">
                  <div style="display: flex; justify-content: between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">ã‚¢ã‚¯ã‚»ã‚¹æ•°: ${fav.access_count}å› | æœ€çµ‚: ${lastAccessed}</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 4px 8px; font-size: 11px;">ç§»å‹•</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">âœ— ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('favoritesListButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">ğŸ“‹ ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/favorites`)
        .then(res => res.json())
        .then(data => {
          const favorites = data.favorites;
          
          let html = `<div><strong>ğŸ“‹ ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ (${favorites.length}å€‹)</strong></div>`;
          
          if (favorites.length === 0) {
            html += '<div style="color: gray; font-style: italic;">ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            favorites.forEach(fav => {
              const addedAt = new Date(fav.added_at).toLocaleString();
              const lastAccessed = fav.last_accessed ? new Date(fav.last_accessed).toLocaleString() : 'ãªã—';
              const colorTag = fav.color_tag !== 'default' ? `ğŸ·ï¸${fav.color_tag}` : '';
              const quickIcon = fav.quick_access ? 'ğŸš€' : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${quickIcon}${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">è¿½åŠ : ${addedAt}</span><br>
                      <span style="color: #666;">ã‚¢ã‚¯ã‚»ã‚¹: ${fav.access_count}å› | æœ€çµ‚: ${lastAccessed}</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 2px 6px; font-size: 10px; margin-right: 3px;">ç§»å‹•</button>
                      <button onclick="toggleQuickAccess('${fav.name}')" class="btn btn-secondary" style="padding: 2px 6px; font-size: 10px; margin-right: 3px;">${fav.quick_access ? 'QAè§£é™¤' : 'QAè¨­å®š'}</button>
                      <button onclick="removeFavorite('${fav.name}')" class="btn btn-danger" style="padding: 2px 6px; font-size: 10px;">å‰Šé™¤</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">âœ— ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('searchFavoritesButton').addEventListener('click', () => {
      const query = prompt('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!query || query.trim() === '') {
        return;
      }

      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">ğŸ” æ¤œç´¢ä¸­...</div>';
      
      fetch(`${API_BASE}/favorites/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const results = data.results;
          
          let html = `<div><strong>ğŸ” æ¤œç´¢çµæœ "${query}" (${results.length}ä»¶)</strong></div>`;
          
          if (results.length === 0) {
            html += '<div style="color: gray; font-style: italic;">è©²å½“ã™ã‚‹ãŠæ°—ã«å…¥ã‚ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px;">';
            
            results.forEach(fav => {
              const colorTag = fav.color_tag !== 'default' ? `ğŸ·ï¸${fav.color_tag}` : '';
              const quickIcon = fav.quick_access ? 'ğŸš€' : '';
              
              html += `
                <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <strong>${quickIcon}${colorTag} ${fav.name}</strong><br>
                      <span style="color: #666;">ã‚¢ã‚¯ã‚»ã‚¹æ•°: ${fav.access_count}å›</span>
                      ${fav.custom_note ? `<br><span style="color: #888; font-style: italic;">"${fav.custom_note}"</span>` : ''}
                    </div>
                    <div>
                      <button onclick="jumpToFavorite('${fav.name}', ${fav.lat}, ${fav.lon})" class="btn" style="padding: 4px 8px; font-size: 11px;">ç§»å‹•</button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          favoritesDetails.innerHTML = html;
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">âœ— æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('favoritesExportButton').addEventListener('click', () => {
      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...</div>';
      
      fetch(`${API_BASE}/favorites/export`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            favoritesDetails.innerHTML = `
              <div style="color: green;"><strong>âœ“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${data.filename}</div>
                <div><strong>ãŠæ°—ã«å…¥ã‚Šæ•°:</strong> ${data.count}å€‹</div>
              </div>
              <div style="color: #666; font-size: 11px;">ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>
            `;
          } else {
            favoritesDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
          }
        })
        .catch(err => {
          favoritesDetails.innerHTML = '<div style="color: red;">âœ— ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    });

    document.getElementById('favoritesImportButton').addEventListener('click', () => {
      const filename = prompt('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n(ä¾‹: konbu_favorites_export_20241201_120000.json):');
      if (!filename || filename.trim() === '') {
        return;
      }

      const mergeMode = confirm('æ—¢å­˜ã®ãŠæ°—ã«å…¥ã‚Šã¨ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€: ãƒãƒ¼ã‚¸ï¼ˆé‡è¤‡ã¯è¿½åŠ ã—ãªã„ï¼‰\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ç½®æ›ï¼ˆæ—¢å­˜ã‚’å‰Šé™¤ï¼‰');

      const favoritesDetails = document.getElementById('favoritesDetails');
      favoritesDetails.innerHTML = '<div style="color: blue;">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...</div>';
      
      fetch(`${API_BASE}/favorites/import`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          import_file: filename.trim(),
          merge_mode: mergeMode
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          favoritesDetails.innerHTML = `
            <div style="color: green;"><strong>âœ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</strong></div>
            <div style="margin: 10px 0;">
              <div>${data.message}</div>
              <div><strong>ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ•°:</strong> ${data.imported_count}å€‹</div>
              <div><strong>ç¾åœ¨ã®ç·æ•°:</strong> ${data.current_count}å€‹</div>
            </div>
          `;
          loadFavoritesStatus();
        } else {
          favoritesDetails.innerHTML = `<div style="color: red;">âœ— ${data.message}</div>`;
        }
      })
      .catch(err => {
        favoritesDetails.innerHTML = '<div style="color: red;">âœ— ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
    });

    // ãŠæ°—ã«å…¥ã‚Šé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
    function jumpToFavorite(spotName, lat, lon) {
      // åœ°å›³ã‚’ç§»å‹•
      map.setView([lat, lon], 15);
      
      // å¹²å ´ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      currentSelectedSpot = spotName;
      updateSelectedSpotInfo();
      updateFavoriteButton();
      
      // ã‚¢ã‚¯ã‚»ã‚¹æ•°ã‚’æ›´æ–°
      fetch(`${API_BASE}/favorites/${encodeURIComponent(spotName)}/access`, {
        method: 'POST'
      })
      .then(() => {
        console.log(`Access count updated for ${spotName}`);
      })
      .catch(err => {
        console.error('Access count update failed:', err);
      });
    }

    function toggleQuickAccess(spotName) {
      if (!confirm(`ã€Œ${spotName}ã€ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      fetch(`${API_BASE}/favorites/${encodeURIComponent(spotName)}/quick`, {
        method: 'PUT'
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('favoritesListButton').click(); // ãƒªãƒ­ãƒ¼ãƒ‰
          loadFavoritesStatus();
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
      })
      .catch(err => {
        alert('ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function removeFavorite(spotName) {
      if (!confirm(`ã€Œ${spotName}ã€ã‚’ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      fetch(`${API_BASE}/favorites`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spot_name: spotName })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          document.getElementById('favoritesListButton').click(); // ãƒªãƒ­ãƒ¼ãƒ‰
          loadFavoritesStatus();
          updateFavoriteButton();
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${data.message}`);
        }
      })
      .catch(err => {
        alert('ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    // ãƒ˜ãƒ«ãƒ—ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ©Ÿèƒ½
    function loadHelpContent() {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <h3>ğŸ“– åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </h3>
          <p>ã‚ˆã†ã“ãï¼å„æ©Ÿèƒ½ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      `;
    }

    // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«æ©Ÿèƒ½
    document.getElementById('tutorialButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</strong></div>
        <div style="margin: 15px 0;">
          <h4>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1: å¹²å ´ã®é¸æŠ</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>åœ°å›³ä¸Šã®ğŸ“ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¹²å ´ã‚’é¸æŠ</li>
            <li>ã¾ãŸã¯ã€ŒğŸ“ åœ°åŒºé¸æŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ã§ã‚¨ãƒªã‚¢ã‚’çµã‚Šè¾¼ã¿</li>
            <li>é¸æŠã—ãŸå¹²å ´ã®æƒ…å ±ãŒå³å´ã«è¡¨ç¤ºã•ã‚Œã¾ã™</li>
          </ol>
          
          <h4>ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—2: å¤©æ°—äºˆå ±ã®ç¢ºèª</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>å¹²å ´é¸æŠå¾Œã€ã€ŒğŸ“Š äºˆå ±ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>5æ—¥é–“ã®è©³ç´°äºˆå ±ã¨å¹²ã—é©åˆåº¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
            <li>ğŸŸ¢è‰¯å¥½ ğŸŸ¡æ³¨æ„ ğŸŸ é›£ã—ã„ ğŸ”´ä¸é© ã§åˆ¤å®šã•ã‚Œã¾ã™</li>
          </ol>
          
          <h4>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—3: å®Ÿç¸¾ã®è¨˜éŒ²</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>ã€ŒğŸ“ è¨˜éŒ²ã‚’å…¥åŠ›ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
            <li>å®Ÿéš›ã®å¹²ã—çµæœã‚’ã€Œè‰¯å¥½ã€ã€Œæ™®é€šã€ã€Œä¸è‰¯ã€ã‹ã‚‰é¸æŠ</li>
            <li>è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å­¦ç¿’ã«æ´»ç”¨ã•ã‚Œã¾ã™</li>
          </ol>
          
          <h4>â­ ã‚¹ãƒ†ãƒƒãƒ—4: ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã®æ´»ç”¨</h4>
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>ã‚ˆãä½¿ã†å¹²å ´ã¯ã€Œâ­ ãŠæ°—ã«å…¥ã‚Šã€ã«ç™»éŒ²</li>
            <li>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§ç´ æ—©ãç§»å‹•å¯èƒ½</li>
            <li>ä½¿ç”¨é »åº¦ã«å¿œã˜ã¦è‡ªå‹•ã‚½ãƒ¼ãƒˆã•ã‚Œã¾ã™</li>
          </ol>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ãƒ¢ãƒã‚¤ãƒ«ã§ã¯åœ°å›³ã‚’2ç§’é•·æŠ¼ã—ã§è©³ç´°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
        </div>
      `;
    });

    // FAQæ©Ÿèƒ½
    document.getElementById('faqButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>â“ ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆFAQï¼‰</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: å¤©æ°—äºˆå ±ã®ç²¾åº¦ã¯ã©ã®ç¨‹åº¦ã§ã™ã‹ï¼Ÿ</h4>
            <p><strong>A:</strong> Open-Meteo APIã‚’ä½¿ç”¨ã—ã€åˆ©å°»å³¶ã®åœ°åŸŸç‰¹æ€§ã‚’è€ƒæ…®ã—ãŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å­¦ç¿’ã™ã‚‹ã“ã¨ã§ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ï¼Ÿ</h4>
            <p><strong>A:</strong> ãƒ¢ãƒã‚¤ãƒ«ã§ã¯åœ°å›³ã‚’é•·æŠ¼ã—ï¼ˆ2ç§’ï¼‰â†’ã€Œã“ã®ä½ç½®ã‚’è¨˜éŒ²ã€ã‚’é¸æŠã€‚PCã§ã¯åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯å¾Œã€åº§æ¨™ã‚’ç¢ºèªã—ã¦æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: æ¼æœŸä»¥å¤–ã§ã‚‚ä½¿ç”¨ã§ãã¾ã™ã‹ï¼Ÿ</h4>
            <p><strong>A:</strong> ã¯ã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ã¯å¹´ä¸­åˆ©ç”¨å¯èƒ½ã§ã™ãŒã€æ˜†å¸ƒæ¼æœŸï¼ˆ6-9æœˆï¼‰ã®ç®¡ç†æ©Ÿèƒ½ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚æ¼æœŸè¨­å®šã¯ã€ŒğŸ“… æ¼æœŸç®¡ç†ã€ã§å¤‰æ›´å¯èƒ½ã§ã™ã€‚</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å¿…è¦ã§ã™ã‹ï¼Ÿ</h4>
            <p><strong>A:</strong> ã€ŒğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€æ©Ÿèƒ½ã§å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’æ¨å¥¨ã—ã¾ã™ã€‚è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚è¨­å®šå¯èƒ½ã§ã€é‡è¦ãªãƒ‡ãƒ¼ã‚¿ä¿è­·ã«å½¹ç«‹ã¡ã¾ã™ã€‚</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: è¤‡æ•°ã®äººã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã‹ï¼Ÿ</h4>
            <p><strong>A:</strong> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿å…±æœ‰ãŒå¯èƒ½ã§ã™ã€‚ãŠæ°—ã«å…¥ã‚Šã‚„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–ã®åˆ©ç”¨è€…ã¨å…±æœ‰ã§ãã¾ã™ã€‚</p>
          </div>
          
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <h4 style="color: #2c5f2d;">Q: é€šçŸ¥æ©Ÿèƒ½ã®è¨­å®šæ–¹æ³•ã¯ï¼Ÿ</h4>
            <p><strong>A:</strong> ã€ŒğŸ”” é€šçŸ¥è¨­å®šã€ã‹ã‚‰æ™‚åˆ»ã‚„æ¡ä»¶ã‚’è¨­å®šã§ãã¾ã™ã€‚æ¼å¸«ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆã‚ã›ã¦æŸ”è»Ÿã«èª¿æ•´å¯èƒ½ã§ã™ã€‚</p>
          </div>
          
          <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>ğŸ“ ãã®ä»–ã®ã”è³ªå•:</strong> ä¸‹è¨˜ã®ã€ŒğŸ“ ãŠå•ã„åˆã‚ã›ã€ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„
          </div>
        </div>
      `;
    });

    // æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰
    document.getElementById('featuresGuideButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>ğŸ› ï¸ æ©Ÿèƒ½è©³ç´°ã‚¬ã‚¤ãƒ‰</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ“Š å¤©æ°—äºˆå ±æ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>5æ—¥é–“äºˆå ±:</strong> æ°—æ¸©ã€æ¹¿åº¦ã€é¢¨é€Ÿã€é™æ°´é‡ã®è©³ç´°æƒ…å ±</li>
              <li><strong>å¹²ã—é©åˆåº¦åˆ¤å®š:</strong> æ°—è±¡æ¡ä»¶ã‹ã‚‰æ˜†å¸ƒå¹²ã—ã®é©æ€§ã‚’è‡ªå‹•åˆ¤å®š</li>
              <li><strong>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :</strong> æ°—æ¸©22-28â„ƒã€æ¹¿åº¦50-70%ã€é¢¨é€Ÿ1-3m/sã€é™æ°´é‡0mmã‚’ç†æƒ³æ¡ä»¶ã¨ã—ã¦è©•ä¾¡</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ“ è¨˜éŒ²ãƒ»å­¦ç¿’æ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>å®Ÿç¸¾è¨˜éŒ²:</strong> è‰¯å¥½ãƒ»æ™®é€šãƒ»ä¸è‰¯ã®3æ®µéšè©•ä¾¡ã§è¨˜éŒ²</li>
              <li><strong>è‡ªå‹•å­¦ç¿’:</strong> è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åœ°åŸŸç‰¹æ€§ã‚’å­¦ç¿’ã—äºˆæ¸¬ç²¾åº¦ã‚’å‘ä¸Š</li>
              <li><strong>ãƒ‡ãƒ¼ã‚¿å“è³ªç®¡ç†:</strong> ç•°å¸¸å€¤ã®æ¤œå‡ºã¨é™¤å¤–ã§å­¦ç¿’å“è³ªã‚’ç¶­æŒ</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ“… æ¼æœŸç®¡ç†æ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ä½œæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:</strong> 6-9æœˆã®æ¼æœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</li>
              <li><strong>ä¼‘æ¼æ—¥è¨­å®š:</strong> å®šæœŸä¼‘æ—¥ã‚„è‡¨æ™‚ä¼‘æ¥­æ—¥ã®ç™»éŒ²</li>
              <li><strong>é€²æ—è¿½è·¡:</strong> ç¾åœ¨ã®æ¼æœŸé€²æ—ã¨æ®‹ã‚ŠæœŸé–“ã®è¡¨ç¤º</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ”” é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ </h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ã‚«ã‚¹ã‚¿ãƒ æ™‚åˆ»:</strong> æ¼å¸«ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆã‚ã›ãŸé€šçŸ¥æ™‚åˆ»è¨­å®š</li>
              <li><strong>æ¡ä»¶é€šçŸ¥:</strong> è‰¯å¥½ãªæ°—è±¡æ¡ä»¶æ™‚ã®è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆ</li>
              <li><strong>é…ä¿¡æ–¹æ³•:</strong> ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ¡ãƒ¼ãƒ«ã€Webhookå¯¾å¿œ</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">â­ ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹:</strong> æœ€å¤§5ã¤ã¾ã§ã®é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹è¨­å®š</li>
              <li><strong>ä½¿ç”¨çµ±è¨ˆ:</strong> ã‚¢ã‚¯ã‚»ã‚¹å›æ•°ã¨æœ€çµ‚åˆ©ç”¨æ—¥ã®è¿½è·¡</li>
              <li><strong>è‰²åˆ†ã‘ã‚¿ã‚°:</strong> è¦–è¦šçš„ãªåˆ†é¡ç®¡ç†ï¼ˆ7è‰²å¯¾å¿œï¼‰</li>
              <li><strong>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿:</strong> åå‰ã‚„ãƒ¡ãƒ¢ã§ã®é«˜é€Ÿæ¤œç´¢</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯:</strong> CPUã€ãƒ¡ãƒ¢ãƒªã€ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã®ç›£è¦–</li>
              <li><strong>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç›£è¦–:</strong> APIã®å¿œç­”æ™‚é–“ã¨å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯</li>
              <li><strong>ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½:</strong> ç•°å¸¸æ¤œå‡ºæ™‚ã®è‡ªå‹•é€šçŸ¥</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</strong> æ¯æ—¥åˆå‰2æ™‚ã®å®šæœŸå®Ÿè¡Œ</li>
              <li><strong>ãƒ‡ãƒ¼ã‚¿åœ§ç¸®:</strong> ZIPå½¢å¼ã§ã®åŠ¹ç‡çš„ãªä¿å­˜</li>
              <li><strong>é¸æŠå¾©å…ƒ:</strong> å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®éƒ¨åˆ†å¾©å…ƒå¯¾å¿œ</li>
              <li><strong>ä¿æŒæœŸé–“ç®¡ç†:</strong> æœ€å¤§30å€‹ã¾ã§ã®è‡ªå‹•å‰Šé™¤</li>
            </ul>
          </div>
        </div>
      `;
    });

    // æ“ä½œæ—©è¦‹è¡¨
    document.getElementById('quickRefButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>ğŸ“‹ æ“ä½œæ—©è¦‹è¡¨</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ–±ï¸ åŸºæœ¬æ“ä½œ</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <tr style="background: #e9ecef;"><th style="border: 1px solid #ddd; padding: 5px;">æ“ä½œ</th><th style="border: 1px solid #ddd; padding: 5px;">PC</th><th style="border: 1px solid #ddd; padding: 5px;">ãƒ¢ãƒã‚¤ãƒ«</th></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">å¹²å ´é¸æŠ</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ“ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ“ãƒãƒ¼ã‚«ãƒ¼ã‚¿ãƒƒãƒ—</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">åœ°å›³ç§»å‹•</td><td style="border: 1px solid #ddd; padding: 5px;">ãƒ‰ãƒ©ãƒƒã‚°</td><td style="border: 1px solid #ddd; padding: 5px;">ã‚¹ãƒ¯ã‚¤ãƒ—</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">ã‚ºãƒ¼ãƒ </td><td style="border: 1px solid #ddd; padding: 5px;">ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ« / +/-ãƒœã‚¿ãƒ³</td><td style="border: 1px solid #ddd; padding: 5px;">ãƒ”ãƒ³ãƒ / +/-ãƒœã‚¿ãƒ³</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">è©³ç´°ãƒ¡ãƒ‹ãƒ¥ãƒ¼</td><td style="border: 1px solid #ddd; padding: 5px;">å³ã‚¯ãƒªãƒƒã‚¯</td><td style="border: 1px solid #ddd; padding: 5px;">2ç§’é•·æŠ¼ã—</td></tr>
            </table>
          </div>
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">âš¡ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <tr style="background: #e9ecef;"><th style="border: 1px solid #ddd; padding: 5px;">æ©Ÿèƒ½</th><th style="border: 1px solid #ddd; padding: 5px;">ãƒœã‚¿ãƒ³</th><th style="border: 1px solid #ddd; padding: 5px;">èª¬æ˜</th></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">äºˆå ±ç¢ºèª</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ“Š</td><td style="border: 1px solid #ddd; padding: 5px;">5æ—¥é–“ã®å¤©æ°—äºˆå ±ã¨é©åˆåº¦</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">è¨˜éŒ²å…¥åŠ›</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ“</td><td style="border: 1px solid #ddd; padding: 5px;">å®Ÿéš›ã®å¹²ã—çµæœã‚’è¨˜éŒ²</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">ãŠæ°—ã«å…¥ã‚Š</td><td style="border: 1px solid #ddd; padding: 5px;">â­</td><td style="border: 1px solid #ddd; padding: 5px;">ã‚ˆãä½¿ã†å¹²å ´ã®ç®¡ç†</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">æ¼æœŸç®¡ç†</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ“…</td><td style="border: 1px solid #ddd; padding: 5px;">ä½œæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 5px;">é€šçŸ¥è¨­å®š</td><td style="border: 1px solid #ddd; padding: 5px;">ğŸ””</td><td style="border: 1px solid #ddd; padding: 5px;">ã‚¢ãƒ©ãƒ¼ãƒˆæ™‚åˆ»ã®è¨­å®š</td></tr>
            </table>
          </div>
          
          <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #2c5f2d;">ğŸ“± ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½</h4>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li><strong>ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³:</strong> å³ä¸‹ã®å††å½¢ãƒœã‚¿ãƒ³ã§ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹</li>
              <li><strong>é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼:</strong> åœ°å›³ã‚’2ç§’é•·æŠ¼ã—ã§è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º</li>
              <li><strong>è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:</strong> ç”»é¢å›è»¢æ™‚ã«æœ€é©è¡¨ç¤ºã«è‡ªå‹•èª¿æ•´</li>
              <li><strong>ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼:</strong> 44pxä»¥ä¸Šã®ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º</li>
            </ul>
          </div>
          
          <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>ğŸ’¡ åŠ¹ç‡çš„ãªä½¿ã„æ–¹:</strong>
            <ol style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
              <li>ã‚ˆãä½¿ã†å¹²å ´ã¯æœ€åˆã«ãŠæ°—ã«å…¥ã‚Šç™»éŒ²</li>
              <li>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã§ç´ æ—©ã„ã‚¢ã‚¯ã‚»ã‚¹</li>
              <li>è¨˜éŒ²ã‚’æ®‹ã—ã¦äºˆæ¸¬ç²¾åº¦ã‚’å‘ä¸Š</li>
              <li>é€šçŸ¥è¨­å®šã§è¦‹é€ƒã—é˜²æ­¢</li>
            </ol>
          </div>
        </div>
      `;
    });

    // ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    document.getElementById('troubleshootButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã‚¬ã‚¤ãƒ‰</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">ğŸš¨ åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆ</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ç¢ºèªäº‹é …:</strong> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª</li>
              <li><strong>å¯¾å‡¦æ³•:</strong> ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆF5ã‚­ãƒ¼ï¼‰</li>
              <li><strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong> Chromeã€Firefoxã€Safariã€Edgeæ¨å¥¨</li>
              <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">ğŸ“Š å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆ</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>åŸå› :</strong> Open-Meteo APIã¸ã®æ¥ç¶šå•é¡Œ</li>
              <li><strong>å¯¾å‡¦æ³•:</strong> æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œ</li>
              <li><strong>ç¢ºèª:</strong> ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”»é¢ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª</li>
              <li><strong>ä»£æ›¿:</strong> æ°—è±¡åºãªã©ã®å…¬å¼æƒ…å ±ã‚‚ä½µç”¨æ¨å¥¨</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ã§æ“ä½œã—ã«ãã„å ´åˆ</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ã‚ºãƒ¼ãƒ å•é¡Œ:</strong> ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§ã‚ºãƒ¼ãƒ 100%ã«è¨­å®š</li>
              <li><strong>ã‚¿ãƒƒãƒæ“ä½œ:</strong> å³ä¸‹ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã‚’æ´»ç”¨</li>
              <li><strong>è¡¨ç¤ºå•é¡Œ:</strong> ç”»é¢ã‚’å›è»¢ã•ã›ã¦æœ€é©è¡¨ç¤ºã«èª¿æ•´</li>
              <li><strong>å‹•ä½œé‡ã„:</strong> ä»–ã®ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¦ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿å•é¡Œ</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>è¨˜éŒ²æ¶ˆå¤±:</strong> ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã§å®šæœŸä¿å­˜ã‚’è¨­å®š</li>
              <li><strong>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—:</strong> ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒJSONã‹ç¢ºèª</li>
              <li><strong>åŒæœŸå•é¡Œ:</strong> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆâ†’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§æ‰‹å‹•åŒæœŸ</li>
              <li><strong>å®¹é‡ä¸è¶³:</strong> å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤</li>
            </ul>
          </div>
          
          <div style="border: 1px solid #ffc107; background: #fff3cd; padding: 12px; margin: 10px 0; border-radius: 5px;">
            <h4 style="color: #856404;">ğŸ”” é€šçŸ¥ãŒå±Šã‹ãªã„å ´åˆ</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>è¨­å®šç¢ºèª:</strong> é€šçŸ¥æ™‚åˆ»ã¨æ¡ä»¶ã‚’å†ç¢ºèª</li>
              <li><strong>ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»:</strong> ãƒ‡ãƒã‚¤ã‚¹ã®æ™‚åˆ»è¨­å®šã‚’ç¢ºèª</li>
              <li><strong>æ¨©é™:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥è¨±å¯è¨­å®šã‚’ç¢ºèª</li>
              <li><strong>æ‰‹å‹•ç¢ºèª:</strong> ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã§å‹•ä½œçŠ¶æ³ã‚’ç¢ºèª</li>
            </ul>
          </div>
          
          <div style="background: #dc3545; color: white; padding: 10px; border-radius: 5px; margin-top: 15px;">
            <strong>ğŸ†˜ ç·Šæ€¥æ™‚ã®å¯¾å¿œ:</strong>
            <ol style="margin: 5px 0; padding-left: 20px;">
              <li>ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèªãƒ»ä½œæˆ</li>
              <li>æ°—è±¡åºãªã©å…¬å¼æƒ…å ±æºã®ä½µç”¨</li>
              <li>ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ç”»é¢ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª</li>
              <li>å¿…è¦ã«å¿œã˜ã¦ç®¡ç†è€…ã¸ã®é€£çµ¡</li>
            </ol>
          </div>
        </div>
      `;
    });

    // ãŠå•ã„åˆã‚ã›æƒ…å ±
    document.getElementById('contactButton').addEventListener('click', () => {
      const helpDetails = document.getElementById('helpDetails');
      helpDetails.innerHTML = `
        <div><strong>ğŸ“ ãŠå•ã„åˆã‚ã›ãƒ»ã‚µãƒãƒ¼ãƒˆ</strong></div>
        <div style="margin: 15px 0;">
          
          <div style="background: #e8f5e8; border: 1px solid #4a8a5a; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #2c5f2d;">ğŸŒŠ åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </h4>
            <p><strong>ã‚·ã‚¹ãƒ†ãƒ å:</strong> åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </p>
            <p><strong>å¯¾è±¡åœ°åŸŸ:</strong> åŒ—æµ·é“åˆ©å°»å³¶ï¼ˆåˆ©å°»ç”ºãƒ»åˆ©å°»å¯Œå£«ç”ºï¼‰</p>
            <p><strong>å¯¾è±¡ç”£æ¥­:</strong> æ˜†å¸ƒæ¼æ¥­ãƒ»æ˜†å¸ƒåŠ å·¥æ¥­</p>
            <p><strong>é–‹ç™ºç›®çš„:</strong> æ˜†å¸ƒå¹²å ´ã®åŠ¹ç‡çš„ãªç®¡ç†ã¨å¤©å€™äºˆæ¸¬æ”¯æ´</p>
          </div>
          
          <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #495057;">ğŸ› ï¸ æŠ€è¡“ã‚µãƒãƒ¼ãƒˆ</h4>
            <p><strong>ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–:</strong> ã€ŒğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã€ç”»é¢ã§çŠ¶æ…‹ç¢ºèª</p>
            <p><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</strong> ã€ŒğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ã§ãƒ‡ãƒ¼ã‚¿ä¿è­·</p>
            <p><strong>ãƒ­ã‚°ç¢ºèª:</strong> ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§è¨˜éŒ²</p>
            <p><strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong> Chromeã€Firefoxã€Safariã€Edgeæ¨å¥¨</p>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #856404;">ğŸ“‹ ãŠå•ã„åˆã‚ã›æ™‚ã®æƒ…å ±</h4>
            <p>ä»¥ä¸‹ã®æƒ…å ±ã‚’ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ï¼š</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>ç™ºç”Ÿæ—¥æ™‚:</strong> å•é¡ŒãŒç™ºç”Ÿã—ãŸæ—¥æ™‚</li>
              <li><strong>æ“ä½œå†…å®¹:</strong> ä½•ã‚’ã—ã¦ã„ã‚‹ã¨ãã«å•é¡ŒãŒç™ºç”Ÿã—ãŸã‹</li>
              <li><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã®å†…å®¹</li>
              <li><strong>ä½¿ç”¨ç’°å¢ƒ:</strong> ãƒ‡ãƒã‚¤ã‚¹ï¼ˆPC/ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼‰</li>
              <li><strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong> ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¨®é¡</li>
              <li><strong>å†ç¾æ€§:</strong> åŒã˜å•é¡ŒãŒå†åº¦ç™ºç”Ÿã™ã‚‹ã‹</li>
            </ul>
          </div>
          
          <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4 style="color: #155724;">ğŸ’¡ æ”¹å–„ææ¡ˆãƒ»è¦æœ›</h4>
            <p>ã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„ã‚„æ–°æ©Ÿèƒ½ã®ã”è¦æœ›ã‚‚æ­“è¿ã—ã¾ã™ï¼š</p>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><strong>æ©Ÿèƒ½è¿½åŠ :</strong> ã“ã‚“ãªæ©Ÿèƒ½ãŒã‚ã‚Œã°ä¾¿åˆ©</li>
              <li><strong>æ“ä½œæ”¹å–„:</strong> ã‚‚ã£ã¨ä½¿ã„ã‚„ã™ãã™ã‚‹ã«ã¯</li>
              <li><strong>è¡¨ç¤ºæ”¹å–„:</strong> è¦‹ãŸç›®ã‚„é…ç½®ã®æ”¹å–„æ¡ˆ</li>
              <li><strong>ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ:</strong> ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®ä½¿ã„å‹æ‰‹</li>
              <li><strong>ãƒ‡ãƒ¼ã‚¿æ´»ç”¨:</strong> è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨æ–¹æ³•</li>
            </ul>
          </div>
          
          <div style="text-align: center; background: #f8f9fa; padding: 20px; border-radius: 5px; margin-top: 20px;">
            <h4 style="color: #2c5f2d;">ğŸ¤ åˆ©å°»å³¶ã®æ˜†å¸ƒæ¼æ¥­ç™ºå±•ã®ãŸã‚ã«</h4>
            <p>ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯åˆ©å°»å³¶ã®æ˜†å¸ƒæ¼å¸«ã®çš†æ§˜ã®ä½œæ¥­åŠ¹ç‡å‘ä¸Šã¨<br>
            å“è³ªã®é«˜ã„æ˜†å¸ƒç”Ÿç”£ã‚’æ”¯æ´ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
            <p><strong>çš†æ§˜ã®ã”æ„è¦‹ãƒ»ã”è¦æœ›ã‚’ãŠèã‹ã›ãã ã•ã„</strong></p>
          </div>
        </div>
      `;
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
    window.selectSpot = selectSpot;
    window.addRestDay = addRestDay;
    window.removeRestDay = removeRestDay;
    window.updateNotificationTime = updateNotificationTime;
    window.addSubscriber = addSubscriber;
    window.removeSubscriber = removeSubscriber;
    window.restoreBackup = restoreBackup;
    window.deleteBackup = deleteBackup;
    window.jumpToFavorite = jumpToFavorite;
    window.toggleQuickAccess = toggleQuickAccess;
    window.removeFavorite = removeFavorite;

    // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œæ©Ÿèƒ½
    function initMobileOptimizations() {
      // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouch = 'ontouchstart' in window;
      
      if (isMobile || isTouch) {
        // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒãƒƒãƒ—è¨­å®šã®èª¿æ•´
        map.options.zoomControl = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ ï¼ˆã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼‰
        const customZoomControl = L.control.zoom({
          position: 'bottomright'
        });
        customZoomControl.addTo(map);
        
        // ã‚¿ãƒƒãƒ—æ™‚ã®é…å»¶ã‚’å‰Šé™¤
        map.options.tap = true;
        if (map.tap) {
          map.tap.enable();
        }
        
        // åœ°å›³ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’èª¿æ•´
        map.options.doubleClickZoom = true;
        
        // ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ã®æ…£æ€§ã‚’æœ‰åŠ¹åŒ–
        map.options.inertia = true;
        map.options.inertiaDeceleration = 2000;
        
        console.log('Mobile optimizations enabled');
      }
      
      // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          map.invalidateSize();
          adjustMapHeight();
        }, 250);
      });
      
      // ç”»é¢å›è»¢æ™‚ã®å‡¦ç†
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          map.invalidateSize();
          adjustMapHeight();
        }, 500);
      });
      
      // åˆæœŸãƒãƒƒãƒ—é«˜ã•èª¿æ•´
      adjustMapHeight();
    }

    function adjustMapHeight() {
      const mapElement = document.getElementById('map');
      const windowHeight = window.innerHeight;
      const windowWidth = window.innerWidth;
      
      // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆã€ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦åœ°å›³ã®é«˜ã•ã‚’å‹•çš„èª¿æ•´
      if (windowWidth <= 480) {
        // å°ç”»é¢ï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç¸¦å‘ãï¼‰
        const headerHeight = document.querySelector('.header').offsetHeight;
        const sidebarHeight = document.querySelector('.sidebar').offsetHeight;
        const availableHeight = windowHeight - headerHeight - sidebarHeight - 60;
        mapElement.style.height = Math.max(250, Math.min(400, availableHeight)) + 'px';
      } else if (windowWidth <= 768) {
        // ä¸­ç”»é¢ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼‰
        mapElement.style.height = '350px';
      } else if (windowWidth <= 1024) {
        // å¤§ç”»é¢ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæ¨ªå‘ãï¼‰
        mapElement.style.height = '400px';
      }
      
      // åœ°å›³ã‚µã‚¤ã‚ºã®å†è¨ˆç®—
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    // ã‚¿ãƒƒãƒæ”¹å–„ï¼šé•·æŠ¼ã—ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼é¢¨ã®æ©Ÿèƒ½
    function initTouchGestures() {
      let touchTimer;
      let touchStarted = false;
      
      map.on('touchstart', (e) => {
        touchStarted = true;
        touchTimer = setTimeout(() => {
          if (touchStarted) {
            // é•·æŠ¼ã—æ™‚ã®å‡¦ç†ï¼ˆ2ç§’ï¼‰
            showQuickActions(e.latlng);
          }
        }, 2000);
      });
      
      map.on('touchend touchcancel', () => {
        touchStarted = false;
        clearTimeout(touchTimer);
      });
      
      map.on('touchmove', () => {
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã¯é•·æŠ¼ã—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        touchStarted = false;
        clearTimeout(touchTimer);
      });
    }

    function showQuickActions(latlng) {
      // ç¾åœ¨ä½ç½®ã‚’è¨˜éŒ²
      const lat = latlng.lat.toFixed(6);
      const lon = latlng.lng.toFixed(6);
      
      // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const actions = [
        'ğŸ“ ã“ã®ä½ç½®ã‚’è¨˜éŒ²',
        'â­ ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ',
        'ğŸ” è©³ç´°ã‚’è¡¨ç¤º',
        'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      ];
      
      const choice = prompt(`ä½ç½®: ${lat}, ${lon}\n\né¸æŠã—ã¦ãã ã•ã„ï¼š\n1. ${actions[0]}\n2. ${actions[1]}\n3. ${actions[2]}\n4. ${actions[3]}\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-4):`);
      
      switch(choice) {
        case '1':
          // åœ°å½¢ãƒã‚§ãƒƒã‚¯å¾Œã«æ–°ã—ã„å¹²å ´ã¨ã—ã¦è¿½åŠ 
          if (confirm(`æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nç·¯åº¦: ${lat}\nçµŒåº¦: ${lon}`)) {
            addNewSpotWithValidation(lat, lon);
          }
          break;
        case '2':
          // ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ï¼ˆè¿‘ã„å¹²å ´ãŒã‚ã‚Œã°ï¼‰
          findNearestSpotAndAddToFavorites(latlng);
          break;
        case '3':
          // è©³ç´°è¡¨ç¤º
          showLocationDetails(latlng);
          break;
        default:
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ç„¡åŠ¹ãªå…¥åŠ›
          break;
      }
    }

    function findNearestSpotAndAddToFavorites(latlng) {
      let nearest = null;
      let minDistance = Infinity;
      
      spots.forEach(spot => {
        const distance = map.distance(latlng, [spot.lat, spot.lon]);
        if (distance < minDistance) {
          minDistance = distance;
          nearest = spot;
        }
      });
      
      if (nearest && minDistance < 1000) { // 1kmä»¥å†…
        const distanceText = Math.round(minDistance) + 'm';
        if (confirm(`æœ€å¯„ã‚Šã®å¹²å ´ã€Œ${nearest.name}ã€(${distanceText}å…ˆ) ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
          currentSelectedSpot = nearest.name;
          selectSpot(nearest.name);
          // ãŠæ°—ã«å…¥ã‚Šãƒ‘ãƒãƒ«ã‚’é–‹ã
          document.getElementById('favoritesButton').click();
        }
      } else {
        alert('è¿‘ãã«ç™»éŒ²æ¸ˆã¿ã®å¹²å ´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\næ–°ã—ã„å¹²å ´ã¨ã—ã¦è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    function showLocationDetails(latlng) {
      const lat = latlng.lat.toFixed(6);
      const lon = latlng.lng.toFixed(6);
      
      // å¤©æ°—äºˆå ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}&start_date=${new Date().toISOString().split('T')[0]}`)
        .then(res => res.json())
        .then(data => {
          if (data.forecast && data.forecast.length > 0) {
            const today = data.forecast[0];
            const temp = today.temperature || 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            const humidity = today.humidity || 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            const wind = today.wind_speed || 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            
            alert(`ğŸ“ ä½ç½®ã®å¤©æ°—æƒ…å ±\nç·¯åº¦: ${lat}\nçµŒåº¦: ${lon}\n\nğŸŒ¡ï¸ æ°—æ¸©: ${temp}Â°C\nğŸ’§ æ¹¿åº¦: ${humidity}%\nğŸ’¨ é¢¨é€Ÿ: ${wind}m/s`);
          } else {
            alert(`ğŸ“ ä½ç½®æƒ…å ±\nç·¯åº¦: ${lat}\nçµŒåº¦: ${lon}\n\nå¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`);
          }
        })
        .catch(err => {
          alert(`ğŸ“ ä½ç½®æƒ…å ±\nç·¯åº¦: ${lat}\nçµŒåº¦: ${lon}\n\nå¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
        });
    }

    function addNewSpot(lat, lon) {
      const spotName = prompt('æ–°ã—ã„å¹²å ´ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!spotName || spotName.trim() === '') {
        return;
      }
      
      // æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ 
      const newSpotData = {
        name: spotName.trim(),
        lat: parseFloat(lat),
        lon: parseFloat(lon)
      };
      
      fetch(`${API_BASE}/spots`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newSpotData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.message && data.message.includes('æˆåŠŸ')) {
          alert('âœ… æ–°ã—ã„å¹²å ´ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
          loadSpots(); // å¹²å ´ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        } else {
          alert('âŒ å¹²å ´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(err => {
        console.error('Error adding spot:', err);
        showMobileMessage('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'warning', 3000);
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã®ä»®ä¿å­˜
        saveOfflineSpot(lat, lon);
      });
    }

    function saveOfflineSpot(lat, lon) {
      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ä»®ä¿å­˜
      try {
        const offlineSpots = JSON.parse(localStorage.getItem('offlineSpots') || '[]');
        const newSpot = {
          lat: lat,
          lon: lon,
          timestamp: Date.now(),
          type: 'add'
        };
        offlineSpots.push(newSpot);
        localStorage.setItem('offlineSpots', JSON.stringify(offlineSpots));

        showMobileMessage('ğŸ“± ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚', 'info', 4000);
      } catch (e) {
        console.error('Offline save failed:', e);
      }
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸæ©Ÿèƒ½
    function checkAndSyncOfflineData() {
      if (!navigator.onLine) return;

      const offlineSpots = JSON.parse(localStorage.getItem('offlineSpots') || '[]');
      if (offlineSpots.length === 0) return;

      showMobileMessage('ğŸ”„ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...', 'info', 2000);

      offlineSpots.forEach((spot, index) => {
        if (spot.type === 'add') {
          fetch(`${API_BASE}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: spot.lat, lon: spot.lon })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              console.log(`Offline spot ${index} synced successfully`);
            }
          })
          .catch(error => console.error(`Offline sync failed for spot ${index}:`, error));
        }
      });

      // åŒæœŸå®Œäº†å¾Œã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      localStorage.removeItem('offlineSpots');
      showMobileMessage('âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'success', 3000);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«åŒæœŸãƒã‚§ãƒƒã‚¯
    window.addEventListener('load', checkAndSyncOfflineData);
    window.addEventListener('online', checkAndSyncOfflineData);

    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–
    function initMobileNavigation() {
      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
      const selects = document.querySelectorAll('select');
      selects.forEach(select => {
        select.addEventListener('focus', function() {
          this.style.fontSize = '16px'; // iOS Safari ã®ã‚ºãƒ¼ãƒ é˜²æ­¢
        });
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    }

    // ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆã®æ”¹å–„ï¼ˆãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼‰
    function initMobilePanelSwitching() {
      // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ‘ãƒãƒ«ã‚’è¿½è·¡
      let currentPanel = null;
      
      // ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      const panelButtons = document.querySelectorAll('#forecastButton, #recordButton, #adaptiveLearningButton, #seasonButton, #notificationButton, #favoritesButton, #systemMonitorButton, #backupButton');
      
      panelButtons.forEach(button => {
        const originalClick = button.onclick;
        button.addEventListener('click', function(e) {
          // å…ƒã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ
          if (originalClick) {
            originalClick.call(this, e);
          }
          
          // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              const activePanel = document.querySelector('.forecast-panel[style*="block"], .record-panel[style*="block"]');
              if (activePanel) {
                activePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          }
        });
      });
    }

    // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã‚’æœ‰åŠ¹åŒ–
    function initAllMobileFeatures() {
      initMobileOptimizations();
      initTouchGestures();
      initMobileNavigation();
      initMobilePanelSwitching();
      
      // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      console.log('Device info:', {
        userAgent: navigator.userAgent,
        screenWidth: window.screen.width,
        screenHeight: window.screen.height,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        devicePixelRatio: window.devicePixelRatio,
        isTouch: 'ontouchstart' in window
      });
    }

    // å¤©æ°—äºˆå ±å–å¾—é–¢æ•°ã‚’å…ˆã«å®šç¾©
    function getWeatherForecast(lat, lon) {
      console.log('å¤©æ°—äºˆå ±å–å¾—é–‹å§‹:', lat, lon);
      
      // å¤©æ°—äºˆå ±ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆãƒ»è¡¨ç¤º
      createWeatherForecastDialog(lat, lon);
    }

    function createWeatherForecastDialog(lat, lon) {
      // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚Œã°å‰Šé™¤
      const existingDialog = document.getElementById('weatherForecastDialog');
      if (existingDialog) {
        existingDialog.remove();
      }

      const dialog = document.createElement('div');
      dialog.id = 'weatherForecastDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #2c5f2d;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      `;

      dialog.innerHTML = `
        <div style="margin-bottom: 20px; border-bottom: 2px solid #2c5f2d; padding-bottom: 15px;">
          <h3 style="margin: 0; color: #2c5f2d; display: flex; align-items: center; justify-content: space-between;">
            <span>ğŸŒ¤ï¸ å¤©æ°—äºˆå ±</span>
            <button onclick="closeWeatherForecastDialog()" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">Ã—</button>
          </h3>
          <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">åº§æ¨™: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
        </div>

        <!-- æ—¥ä»˜ã‚¿ãƒ– -->
        <div style="margin-bottom: 20px;">
          <div id="dateTabsContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;">
            <!-- ã‚¿ãƒ–ã¯å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

        <!-- äºˆå ±å†…å®¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="forecastContentContainer" style="min-height: 400px;">
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“Š</div>
            <p>äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <div style="text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          <button onclick="closeWeatherForecastDialog()" style="background: #2c5f2d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">é–‰ã˜ã‚‹</button>
        </div>
      `;

      document.body.appendChild(dialog);

      // äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»è¡¨ç¤º
      loadWeatherForecastData(lat, lon);
    }

    function closeWeatherForecastDialog() {
      const dialog = document.getElementById('weatherForecastDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    async function loadWeatherForecastData(lat, lon) {
      try {
        // æ—¥ä»˜ã‚¿ãƒ–ã‚’ç”Ÿæˆï¼ˆç¿Œæ—¥ã‹ã‚‰1é€±é–“ï¼‰
        generateDateTabs();
        
        // APIã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const response = await fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}`);
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        console.log('äºˆå ±ãƒ‡ãƒ¼ã‚¿:', data);
        
        // äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å†åˆ©ç”¨ï¼‰
        window.currentForecastData = data;
        window.currentLat = lat;
        window.currentLon = lon;
        
        // æœ€åˆã®ã‚¿ãƒ–ï¼ˆç¿Œæ—¥ï¼‰ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¦è¡¨ç¤º
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        displayForecastForDate(data, tomorrowStr, lat, lon);
        setActiveTab(tomorrowStr);
        
      } catch (error) {
        console.error('å¤©æ°—äºˆå ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('forecastContentContainer').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #f44336;">
            <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸</div>
            <p><strong>äºˆå ±ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong></p>
            <p style="font-size: 14px; color: #666;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            <p style="font-size: 12px; color: #999; margin-top: 15px;">â€» å®Ÿéš›ã®APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</p>
          </div>
        `;
      }
    }

    function generateDateTabs() {
      const tabsContainer = document.getElementById('dateTabsContainer');
      const today = new Date();
      
      let tabsHTML = '';
      
      for (let i = 1; i <= 6; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        const dateStr = date.toISOString().split('T')[0];
        const displayDate = `${date.getMonth() + 1}/${date.getDate()}`;
        const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        
        const isFirst = i === 1;
        
        tabsHTML += `
          <button 
            id="tab-${dateStr}" 
            onclick="selectForecastDate('${dateStr}')"
            style="
              padding: 8px 12px;
              border: 2px solid #2c5f2d;
              background: ${isFirst ? '#2c5f2d' : 'white'};
              color: ${isFirst ? 'white' : '#2c5f2d'};
              border-radius: 20px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
              transition: all 0.3s ease;
            "
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'"
          >
            ${i === 1 ? 'æ˜æ—¥' : `${i}æ—¥å¾Œ`}<br>
            <small style="font-size: 11px;">${displayDate}(${dayName})</small>
          </button>
        `;
      }
      
      tabsContainer.innerHTML = tabsHTML;
    }

    function selectForecastDate(dateStr) {
      // ã‚¿ãƒ–ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      setActiveTab(dateStr);
      
      const contentContainer = document.getElementById('forecastContentContainer');
      
      // æœ€åˆã®æ—¥ä»˜ï¼ˆç¿Œæ—¥ï¼‰ä»¥å¤–ã¯åˆ¶é™ç‰ˆã‚’è¡¨ç¤º
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      
      if (dateStr === tomorrowStr) {
        // ç¿Œæ—¥ã®å ´åˆã¯ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        if (window.currentForecastData) {
          displayForecastForDate(window.currentForecastData, dateStr, window.currentLat, window.currentLon);
          return;
        }
      }
      
      // 2æ—¥å¾Œä»¥é™ã‚‚APIãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦æ®µéšåˆ¥åˆ†æã‚’è¡¨ç¤º
      // ã¾ãšäºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      if (window.currentForecastData && window.currentForecastData.forecasts) {
        displayForecastForDate(window.currentForecastData, dateStr, window.currentLat, window.currentLon);
        return;
      }

      // APIãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ–°ã—ãå–å¾—
      fetch(`/api/forecast?lat=${window.currentLat}&lon=${window.currentLon}`)
        .then(response => response.json())
        .then(data => {
          window.currentForecastData = data;
          displayForecastForDate(data, dateStr, window.currentLat, window.currentLon);
        })
        .catch(error => {
          console.error('äºˆå ±ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);

          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç°¡æ˜“è¡¨ç¤º
          const dayOffset = Math.ceil((new Date(dateStr) - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
          let reliabilityInfo = '';

          if (dayOffset === 2) {
            reliabilityInfo = 'ä¿¡é ¼åº¦: 95% (é«˜ç²¾åº¦)';
          } else if (dayOffset === 3) {
            reliabilityInfo = 'ä¿¡é ¼åº¦: 85% (è‰¯å¥½)';
          } else if (dayOffset <= 5) {
            reliabilityInfo = 'ä¿¡é ¼åº¦: 70% (ä¸­ç¨‹åº¦)';
          } else {
            reliabilityInfo = 'ä¿¡é ¼åº¦: 50% (å‚è€ƒç¨‹åº¦)';
          }

          contentContainer.innerHTML = `
            <div style="padding: 20px;">
              <h4 style="color: #2c5f2d; margin-bottom: 20px; text-align: center;">
                ğŸ“… ${dateStr} ã®äºˆå ±
              </h4>

              <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h5 style="color: #856404; margin-bottom: 10px;">ğŸ“Š ${dayOffset}æ—¥å¾Œäºˆå ±</h5>
                <div style="color: #856404;">
                  ${reliabilityInfo}<br>
                  ${dayOffset > 3 ? 'â€» è¨ˆç”»ã®å‚è€ƒç¨‹åº¦ã«ã”æ´»ç”¨ãã ã•ã„' : 'â€» ä½œæ¥­è¨ˆç”»ã®æ¤œè¨ã«ã”æ´»ç”¨ãã ã•ã„'}
                </div>
              </div>

              <div style="background: #ffebee; border-radius: 8px; padding: 15px; border: 1px solid #f44336;">
                <h5 style="color: #d32f2f; margin-bottom: 10px;">âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</h5>
                <div style="color: #d32f2f;">
                  äºˆå ±ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                </div>
              </div>

              <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                <p style="font-size: 12px; color: #666; margin: 0;">
                  ğŸ’¡ é«˜ç²¾åº¦äºˆå ±ã¯ç¿Œæ—¥ãƒ»2æ—¥å¾ŒãŒãŠã™ã™ã‚ã§ã™ | ğŸ“Š åˆ©å°»å³¶æ˜†å¸ƒå¹²ã—ç‰¹åŒ–äºˆå ±
                </p>
              </div>
            </div>
          `;
        });
    }

    function setActiveTab(activeDate) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éé¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const allTabs = document.querySelectorAll('[id^="tab-"]');
      allTabs.forEach(tab => {
        tab.style.background = 'white';
        tab.style.color = '#2c5f2d';
      });
      
      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const activeTab = document.getElementById(`tab-${activeDate}`);
      if (activeTab) {
        activeTab.style.background = '#2c5f2d';
        activeTab.style.color = 'white';
      }
    }

    function displayForecastForDate(data, dateStr, lat, lon) {
      const contentContainer = document.getElementById('forecastContentContainer');
      
      console.log('è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿:', data);
      
      // æ–°ã—ã„APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œ
      if (!data || !data.forecasts) {
        contentContainer.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">äºˆå ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // æŒ‡å®šã—ãŸæ—¥ä»˜ã®äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
      const targetForecast = data.forecasts.find(f => f.date === dateStr);
      if (!targetForecast) {
        contentContainer.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // é•·æœŸäºˆå ±ã®å ´åˆã®ä¿¡é ¼åº¦è­¦å‘Š
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      const dayOffset = Math.ceil((new Date(dateStr) - tomorrow) / (1000 * 60 * 60 * 24)) + 1;

      let longTermWarningHTML = '';
      if (dateStr !== tomorrowStr) {
        let reliabilityInfo = '';
        let warningColor = '#fff3cd';
        let borderColor = '#ffeaa7';
        let textColor = '#856404';

        if (dayOffset === 2) {
          reliabilityInfo = 'ä¿¡é ¼åº¦: 95% (é«˜ç²¾åº¦)';
        } else if (dayOffset === 3) {
          reliabilityInfo = 'ä¿¡é ¼åº¦: 85% (è‰¯å¥½)';
        } else if (dayOffset <= 5) {
          reliabilityInfo = 'ä¿¡é ¼åº¦: 70% (ä¸­ç¨‹åº¦)';
          warningColor = '#fff3e0';
          borderColor = '#ffcc02';
          textColor = '#e65100';
        } else {
          reliabilityInfo = 'ä¿¡é ¼åº¦: 50% (å‚è€ƒç¨‹åº¦)';
          warningColor = '#ffebee';
          borderColor = '#f44336';
          textColor = '#d32f2f';
        }

        longTermWarningHTML = `
          <div style="background: ${warningColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h5 style="color: ${textColor}; margin-bottom: 10px;">ğŸ“Š ${dayOffset}æ—¥å¾Œäºˆå ±</h5>
            <div style="color: ${textColor};">
              ${reliabilityInfo}<br>
              ${dayOffset > 3 ? 'â€» è¨ˆç”»ã®å‚è€ƒç¨‹åº¦ã«ã”æ´»ç”¨ãã ã•ã„' : 'â€» ä½œæ¥­è¨ˆç”»ã®æ¤œè¨ã«ã”æ´»ç”¨ãã ã•ã„'}
            </div>
          </div>
        `;
      }

      // æ›æ°—é‡è¦–æœŸé–“ï¼ˆ4:00-10:00ï¼‰ã®é¢¨é€Ÿã‚’è¨ˆç®—
      const ventilationHours = targetForecast.hourly_details.filter(h => {
        const hour = parseInt(h.time.split(':')[0]);
        return hour >= 4 && hour <= 10;
      });
      const avgVentilationWind = ventilationHours.length > 0 ?
        ventilationHours.reduce((sum, h) => sum + (h.wind_speed || 0), 0) / ventilationHours.length : 0;

      // ç†±ä¾›çµ¦é‡è¦–æœŸé–“ï¼ˆ10:00-16:00ï¼‰ã®æ¹¿åº¦ã‚’è¨ˆç®—
      const solarHours = targetForecast.hourly_details.filter(h => {
        const hour = parseInt(h.time.split(':')[0]);
        return hour >= 10 && hour <= 16;
      });
      const avgSolarHumidity = solarHours.length > 0 ?
        solarHours.reduce((sum, h) => sum + (h.humidity || 0), 0) / solarHours.length : 0;

      // åŸºæœ¬æ°—è±¡æƒ…å ±ã®HTMLç”Ÿæˆ
      const tempHumidityHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">ğŸŒ¡ï¸ åŸºæœ¬æ°—è±¡æƒ…å ±</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>å¹³å‡æ¹¿åº¦: ${targetForecast.daily_summary.humidity.toFixed(1)}%</div>
            <div>å¹³å‡é¢¨é€Ÿ: ${targetForecast.daily_summary.wind_speed.toFixed(1)} m/s</div>
          </div>
        </div>
      `;

      const windHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">ğŸŒ¬ï¸ æ›æ°—é‡è¦–æœŸé–“ï¼ˆåˆå‰4æ™‚ã€œ10æ™‚ï¼‰</h5>
          <div>é¢¨é€Ÿ: ${avgVentilationWind.toFixed(1)} m/s</div>
          <div style="margin-top: 8px; padding: 8px; background: ${avgVentilationWind > 1.5 ? '#e8f5e8' : '#fff3cd'}; border-radius: 4px;">
            ${avgVentilationWind > 1.5 ? 'âœ“ æ›æ°—æ¡ä»¶è‰¯å¥½' : 'âš  é¢¨ãŒå¼±ã‚ - æ›æ°—æ³¨æ„'}
          </div>
        </div>
      `;

      const solarHTML = `
        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">â˜€ï¸ ç†±ä¾›çµ¦é‡è¦–æœŸé–“ï¼ˆåˆå‰10æ™‚ã€œåˆå¾Œ4æ™‚ï¼‰</h5>
          <div>æ¹¿åº¦: ${avgSolarHumidity.toFixed(1)}%</div>
          <div style="margin-top: 8px; padding: 8px; background: ${avgSolarHumidity < 80 ? '#e8f5e8' : '#fff3cd'}; border-radius: 4px;">
            ${avgSolarHumidity < 80 ? 'âœ“ ä¹¾ç‡¥æ¡ä»¶è‰¯å¥½' : 'âš  é«˜æ¹¿åº¦ - ä¹¾ç‡¥æ³¨æ„'}
          </div>
        </div>
      `;
      
      // ä¹¾ç‡¥åˆ¤å®šçµæœã®å‡¦ç†
      const reliabilityData = targetForecast.reliability || {};
      const suitabilityColor = targetForecast.daily_summary.suitability === 'excellent' ? '#2e7d32' :
                              targetForecast.daily_summary.suitability === 'good' ? '#388e3c' :
                              targetForecast.daily_summary.suitability === 'fair' ? '#f57c00' : '#d32f2f';
      const dryingHTML = `
        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
          <h5 style="color: #2c5f2d; margin-bottom: 10px;">ğŸ¯ ç·åˆåˆ¤å®š</h5>
          <div style="font-size: 16px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 8px;">
            ${targetForecast.daily_summary.estimated_drying_time}
          </div>
          <div>ä¿¡é ¼åº¦: ${reliabilityData.accuracy || '--'}%</div>
          <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">ä¹¾ç‡¥é©æ€§: ${targetForecast.daily_summary.suitability}</div>
        </div>
      `;
      
      // å®‰å…¨è­¦å‘Šã®å‡¦ç†
      let safetyWarningsHTML = '';
      if (data.safety_warnings && data.safety_warnings.length > 0) {
        const warningsList = data.safety_warnings.map(warning => `<li>${warning}</li>`).join('');
        safetyWarningsHTML = `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h5 style="color: #856404; margin-bottom: 10px;">âš ï¸ å®‰å…¨è­¦å‘Š</h5>
            <ul style="color: #856404; margin: 0; padding-left: 20px;">
              ${warningsList}
            </ul>
          </div>
        `;
      }
      
      // æ®µéšåˆ¥åˆ†æãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
      const stageAnalysis = targetForecast.daily_summary.stage_analysis || {};

      // PWV/PBLHåˆ†æãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
      const pwvPblhAnalysis = stageAnalysis.pwv_pblh_analysis || {};


      // 1æ™‚é–“åˆ»ã¿æ¨ç§»è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
      const hourlyData = targetForecast.hourly_details || [];

      // åˆ©å°»å³¶ä¼çµ±é¢¨åå¤‰æ›é–¢æ•°ï¼ˆ16æ–¹ä½ï¼‰
      function getRishiriWindName(windDirection) {
        if (windDirection === null || windDirection === undefined) return { name: '--', cardinal: '--' };

        const windNames = [
          { dir: 0, name: 'ã‚¢ã‚¤', cardinal: 'åŒ—' }, { dir: 22.5, name: 'ã‚¢ã‚¤ã‚·ãƒ¢', cardinal: 'åŒ—åŒ—æ±' },
          { dir: 45, name: 'ã‚·ãƒ¢', cardinal: 'åŒ—æ±' }, { dir: 67.5, name: 'ã‚·ãƒ¢ãƒ¤ãƒã‚»', cardinal: 'æ±åŒ—æ±' },
          { dir: 90, name: 'ãƒ›ãƒ³ãƒ¤ãƒã‚»', cardinal: 'æ±' }, { dir: 112.5, name: 'ãƒ¤ãƒã‚»', cardinal: 'æ±å—æ±' },
          { dir: 135, name: 'ãƒŸãƒŠãƒŸãƒ¤ãƒã‚»', cardinal: 'å—æ±' }, { dir: 157.5, name: 'ãƒŸãƒŠãƒŸãƒ¤ãƒ', cardinal: 'å—å—æ±' },
          { dir: 180, name: 'ã‚¯ãƒ€ãƒª', cardinal: 'å—' }, { dir: 202.5, name: 'ã‚¯ãƒ€ãƒªãƒ’ã‚«ã‚¿', cardinal: 'å—å—è¥¿' },
          { dir: 225, name: 'ãƒ’ã‚«ã‚¿', cardinal: 'å—è¥¿' }, { dir: 247.5, name: 'ãƒ‹ã‚·ãƒ’ã‚«ã‚¿', cardinal: 'è¥¿å—è¥¿' },
          { dir: 270, name: 'ãƒ‹ã‚·', cardinal: 'è¥¿' }, { dir: 292.5, name: 'ãƒ‹ã‚·ã‚¿ãƒ', cardinal: 'è¥¿åŒ—è¥¿' },
          { dir: 315, name: 'ã‚¿ãƒ', cardinal: 'åŒ—è¥¿' }, { dir: 337.5, name: 'ã‚¢ã‚¤ã‚¿ãƒ', cardinal: 'åŒ—åŒ—è¥¿' }
        ];

        const normalizedDir = ((windDirection % 360) + 360) % 360;
        let minDiff = 360;
        let closestWind = windNames[0];

        for (const wind of windNames) {
          let diff = Math.abs(normalizedDir - wind.dir);
          diff = Math.min(diff, 360 - diff);
          if (diff < minDiff) {
            minDiff = diff;
            closestWind = wind;
          }
        }
        return closestWind;
      }

      // 1æ™‚é–“åˆ»ã¿ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆå…¨æ°—è±¡ãƒ‡ãƒ¼ã‚¿ï¼‰
      const hourlyAllData = hourlyData.map(hour => {
        const time = hour.time || '--';

        // åŸºæœ¬æ°—è±¡ãƒ‡ãƒ¼ã‚¿
        const temperature = hour.temperature !== null && hour.temperature !== undefined ?
          hour.temperature.toFixed(1) : '--';
        const humidity = hour.humidity !== null && hour.humidity !== undefined ?
          hour.humidity.toFixed(0) : '--';
        const windSpeed = hour.wind_speed !== null && hour.wind_speed !== undefined ?
          hour.wind_speed.toFixed(1) : '--';
        const windInfo = hour.wind_direction !== null && hour.wind_direction !== undefined ?
          getRishiriWindName(hour.wind_direction) : { name: '--', arrow: '--' };
        const solarRadiation = hour.solar_radiation !== null && hour.solar_radiation !== undefined ?
          hour.solar_radiation.toFixed(0) : '--';
        const precipitation = hour.precipitation !== null && hour.precipitation !== undefined ?
          hour.precipitation.toFixed(1) : '--';
        const cloudCover = hour.cloud_cover !== null && hour.cloud_cover !== undefined ?
          hour.cloud_cover.toFixed(0) : '--';

        // é«˜åº¦æ°—è±¡ãƒ‡ãƒ¼ã‚¿
        const verticalVel = hour.vertical_p_velocity !== null && hour.vertical_p_velocity !== undefined ?
          hour.vertical_p_velocity.toFixed(3) : '--';
        const ssi = hour.ssi !== null && hour.ssi !== undefined ?
          hour.ssi.toFixed(1) : '--';
        const ssiCategory = hour.ssi !== null && hour.ssi !== undefined ?
          (hour.ssi >= 3 ? 'å®‰å®š' : hour.ssi >= 0 ? 'ä¸­æ€§' : hour.ssi >= -3 ? 'ã‚„ã‚„ä¸å®‰å®š' : 'ä¸å®‰å®š') : '--';
        const equivTemp = hour.equivalent_potential_temperature !== null && hour.equivalent_potential_temperature !== undefined ?
          hour.equivalent_potential_temperature.toFixed(1) : '--';

        // 500hPaæ¸¦åº¦ãƒ‡ãƒ¼ã‚¿
        const vorticity = hour.vorticity_500hpa !== null && hour.vorticity_500hpa !== undefined ?
          (hour.vorticity_500hpa * 100000).toFixed(1) : '--'; // Convert to 10^-5 s^-1 units

        // PWV and PBLH data
        const pwv = hour.precipitable_water !== null && hour.precipitable_water !== undefined ?
          hour.precipitable_water.toFixed(1) : '--';
        const pblh = hour.boundary_layer_height !== null && hour.boundary_layer_height !== undefined ?
          hour.boundary_layer_height.toFixed(0) : '--';

        const pwvCategory = hour.pwv_pblh_analysis?.pwv_category || '--';
        const pblhCategory = hour.pwv_pblh_analysis?.pblh_category || '--';

        return {
          time, temperature, humidity, windSpeed, windInfo, solarRadiation, precipitation, cloudCover,
          verticalVel, ssi, ssiCategory, equivTemp, vorticity,
          pwv, pblh, pwvCategory, pblhCategory
        };
      });

      // åŸºæœ¬æ°—è±¡ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©
      const basicWeatherTableHTML = `
        <div style="margin-top: 15px;">
          <h6 style="color: #2e7d32; margin: 0 0 12px 0;">ğŸŒ¤ï¸ åŸºæœ¬æ°—è±¡ãƒ‡ãƒ¼ã‚¿ (1æ™‚é–“åˆ»ã¿æ¨ç§»)</h6>
          <div style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
            <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
              <thead style="background: #f5f5f5; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 40px;">æ™‚åˆ»</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">æ°—æ¸©<br>(Â°C)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">æ¹¿åº¦<br>(%)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 35px;">é¢¨é€Ÿ<br>(m/s)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 55px;">é¢¨å‘<br>(ä¼çµ±é¢¨å/16æ–¹ä½)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">æ—¥å°„<br>(W/mÂ²)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">é™æ°´é‡<br>(mm)</th>
                  <th style="padding: 6px 3px; border: 1px solid #ddd; text-align: center; min-width: 45px;">é›²é‡<br>(%)</th>
                </tr>
              </thead>
              <tbody>
                ${hourlyAllData.map(hour => `
                  <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 4px 2px; text-align: center; font-weight: bold; background: #f9f9f9;">${hour.time}</td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.temperature !== '--' && parseFloat(hour.temperature) > 20 ? '#d32f2f' : hour.temperature !== '--' && parseFloat(hour.temperature) < 10 ? '#1976d2' : '#333'};">
                      ${hour.temperature}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.humidity !== '--' && parseFloat(hour.humidity) > 80 ? '#d32f2f' : hour.humidity !== '--' && parseFloat(hour.humidity) < 60 ? '#4caf50' : '#333'};">
                      ${hour.humidity}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.windSpeed !== '--' && parseFloat(hour.windSpeed) > 3 ? '#4caf50' : hour.windSpeed !== '--' && parseFloat(hour.windSpeed) < 1.5 ? '#d32f2f' : '#333'};">
                      ${hour.windSpeed}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; font-weight: bold; color: #1976d2;">
                      <div style="font-size: 10px;">${hour.windInfo.name}</div>
                      <div style="font-size: 8px; color: #666;">${hour.windInfo.cardinal}</div>
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.solarRadiation !== '--' && parseFloat(hour.solarRadiation) > 600 ? '#ff9800' : '#333'};">
                      ${hour.solarRadiation}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.precipitation !== '--' && parseFloat(hour.precipitation) > 0.1 ? '#f44336' : '#4caf50'};">
                      ${hour.precipitation}
                    </td>
                    <td style="padding: 4px 2px; text-align: center; color: ${hour.cloudCover !== '--' && parseFloat(hour.cloudCover) > 80 ? '#666' : hour.cloudCover !== '--' && parseFloat(hour.cloudCover) < 30 ? '#4caf50' : '#ff9800'};">
                      ${hour.cloudCover}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div style="font-size: 9px; color: #666; margin-top: 8px; text-align: center;">
            â€» åŸºæœ¬æ°—è±¡ãƒ‡ãƒ¼ã‚¿ (4:00-16:00) | ğŸ”´é«˜æ¸©ãƒ»é«˜æ¹¿åº¦ãƒ»é™é›¨ ğŸ”µä½æ¸© ğŸŸ¢å¥½æ¡ä»¶é¢¨é€Ÿãƒ»ä½æ¹¿åº¦ãƒ»ä¹¾ç‡¥ãƒ»æ™´å¤© ğŸŸ å¼·æ—¥å°„ãƒ»éƒ¨åˆ†æ›‡ã‚Š âš«é«˜é›²é‡
          </div>
        </div>
      `;

      // ä¸€èˆ¬æ¼å¸«å‘ã‘ç°¡æ˜“è¡¨ç¤º
      const fisherHTML = `
        <div style="background: #e8f5e8; border-radius: 8px; padding: 15px; border: 1px solid #4caf50;">
          <h5 style="color: #2e7d32; margin-bottom: 10px;">ğŸ£ ä¸€èˆ¬æ¼å¸«å‘ã‘äºˆå ±</h5>
          <div style="font-size: 18px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 10px;">
            ${stageAnalysis.predicted_completion_time || targetForecast.daily_summary.estimated_drying_time}
          </div>
          <div style="font-size: 14px; color: #2e7d32; margin-bottom: 10px;">
            ç·åˆã‚¹ã‚³ã‚¢: ${stageAnalysis.overall_score || '--'}/100
          </div>
          ${pwvPblhAnalysis.avg_pwv || pwvPblhAnalysis.avg_pblh ? `
            <div style="background: #e8f5e9; border-radius: 6px; padding: 10px; margin-bottom: 10px; border: 1px solid #66bb6a;">
              <div style="font-size: 12px; font-weight: bold; color: #2e7d32; margin-bottom: 6px;">ğŸ’§ å¤§æ°—æ¹¿æ½¤ãƒ»å¢ƒç•Œå±¤çŠ¶æ…‹</div>
              <div style="font-size: 11px; line-height: 1.6;">
                ${pwvPblhAnalysis.avg_pwv ? `<div>å¯é™æ°´é‡(PWV): <strong>${pwvPblhAnalysis.avg_pwv}mm</strong> <span style="color: ${
                  pwvPblhAnalysis.pwv_category === 'éå¸¸ã«ä¹¾ç‡¥' || pwvPblhAnalysis.pwv_category === 'ä¹¾ç‡¥' ? '#4caf50' :
                  pwvPblhAnalysis.pwv_category === 'ã‚„ã‚„ä¹¾ç‡¥' || pwvPblhAnalysis.pwv_category === 'æ™®é€š' ? '#ff9800' :
                  '#d32f2f'
                };">(${pwvPblhAnalysis.pwv_category})</span></div>` : ''}
                ${pwvPblhAnalysis.avg_pblh ? `<div>å¢ƒç•Œå±¤é«˜åº¦(PBLH): <strong>${pwvPblhAnalysis.avg_pblh}m</strong> <span style="color: ${
                  pwvPblhAnalysis.pblh_category === 'éå¸¸ã«è‰¯å¥½' || pwvPblhAnalysis.pblh_category === 'è‰¯å¥½' ? '#4caf50' :
                  pwvPblhAnalysis.pblh_category === 'ã‚„ã‚„è‰¯å¥½' || pwvPblhAnalysis.pblh_category === 'æ™®é€š' ? '#ff9800' :
                  '#d32f2f'
                };">(${pwvPblhAnalysis.pblh_category})</span></div>` : ''}
                ${pwvPblhAnalysis.risk_level ? `<div style="margin-top: 4px; padding: 4px 8px; background: ${
                  pwvPblhAnalysis.risk_level === 'ç†æƒ³çš„æ¡ä»¶' ? '#c8e6c9' :
                  pwvPblhAnalysis.risk_level === 'è‰¯å¥½ãªæ¡ä»¶' ? '#dcedc8' :
                  pwvPblhAnalysis.risk_level.includes('æµ·éœ§') ? '#ffcdd2' :
                  '#fff9c4'
                }; border-radius: 4px; font-weight: bold;">
                  ${pwvPblhAnalysis.sea_fog_risk ? 'âš ï¸ ' : ''}${pwvPblhAnalysis.risk_level}
                </div>` : ''}
              </div>
            </div>
          ` : ''}
          ${basicWeatherTableHTML}
        </div>
      `;

      // å°‚é–€å®¶å‘ã‘è©³ç´°è¡¨ç¤º
      const expertHTML = `
        <div style="background: #f3e5f5; border-radius: 8px; padding: 15px; border: 1px solid #9c27b0;">
          <h5 style="color: #7b1fa2; margin-bottom: 15px;">ğŸ”¬ å°‚é–€å®¶å‘ã‘æ®µéšåˆ¥åˆ†æ</h5>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div style="background: white; padding: 12px; border-radius: 6px;">
              <h6 style="color: #1976d2; margin: 0 0 8px 0;">æ›æ°—æ®µéš (4:00-10:00)</h6>
              <div>ã‚¹ã‚³ã‚¢: ${stageAnalysis.ventilation_stage_score || '--'}/100</div>
              <div style="font-size: 12px; color: #666;">
                å¹³å‡é¢¨é€Ÿ: ${stageAnalysis.stage_breakdown?.ventilation_period?.avg_wind_speed || '--'} m/s
              </div>
            </div>

            <div style="background: white; padding: 12px; border-radius: 6px;">
              <h6 style="color: #f57c00; margin: 0 0 8px 0;">ç†±ä¾›çµ¦æ®µéš (10:00-16:00)</h6>
              <div>ã‚¹ã‚³ã‚¢: ${stageAnalysis.heat_supply_stage_score || '--'}/100</div>
              <div style="font-size: 12px; color: #666;">
                å¹³å‡æ°—æ¸©: ${stageAnalysis.stage_breakdown?.heat_supply_period?.avg_temperature || '--'}Â°C
              </div>
            </div>
          </div>

          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <h6 style="color: #7b1fa2; margin: 0 0 8px 0;">é‡ã¿ä»˜ã‘è¨­å®š</h6>
            <div style="font-size: 12px;">
              é¢¨é‡è¦–: ${Math.round((stageAnalysis.time_weights?.wind_weight || 0.7) * 100)}% |
              ç†±é‡è¦–: ${Math.round((stageAnalysis.time_weights?.solar_weight || 0.3) * 100)}%
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
              äºˆæ¸¬æ™‚é–“: ${stageAnalysis.estimated_drying_hours || '--'}æ™‚é–“
            </div>
          </div>

          <div style="background: #fff8e1; padding: 12px; border-radius: 6px; border: 1px solid #ffcc02;">
            <h6 style="color: #e65100; margin: 0 0 12px 0;">ğŸŒªï¸ é«˜åº¦æ°—è±¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (1æ™‚é–“åˆ»ã¿æ¨ç§»)</h6>

            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
              <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                <thead style="background: #f5f5f5; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">æ™‚åˆ»</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">PWV<br>(mm)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">PBLH<br>(m)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">é‰›ç›´pé€Ÿåº¦<br>(700hPa)<br>(Pa/s)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">SSI</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">ç›¸å½“æ¸©ä½<br>(850hPa)<br>(K)</th>
                    <th style="padding: 6px 4px; border: 1px solid #ddd; text-align: center;">ç›¸å¯¾æ¸¦åº¦<br>(500hPa)<br>(Ã—10â»âµ sâ»Â¹)</th>
                  </tr>
                </thead>
                <tbody>
                  ${hourlyAllData.map(hour => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 4px; text-align: center; font-weight: bold;">${hour.time}</td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.pwv}</div>
                        <div style="font-size: 8px; color: ${
                          hour.pwvCategory === 'éå¸¸ã«ä¹¾ç‡¥' || hour.pwvCategory === 'ä¹¾ç‡¥' ? '#4caf50' :
                          hour.pwvCategory === 'ã‚„ã‚„ä¹¾ç‡¥' || hour.pwvCategory === 'æ™®é€š' ? '#ff9800' :
                          hour.pwvCategory === 'ã‚„ã‚„æ¹¿æ½¤' || hour.pwvCategory === 'æ¹¿æ½¤' ? '#f44336' :
                          hour.pwvCategory === 'éå¸¸ã«æ¹¿æ½¤' ? '#d32f2f' : '#666'
                        };">${hour.pwvCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.pblh}</div>
                        <div style="font-size: 8px; color: ${
                          hour.pblhCategory === 'éå¸¸ã«è‰¯å¥½' || hour.pblhCategory === 'è‰¯å¥½' ? '#4caf50' :
                          hour.pblhCategory === 'ã‚„ã‚„è‰¯å¥½' || hour.pblhCategory === 'æ™®é€š' ? '#ff9800' :
                          hour.pblhCategory === 'ã‚„ã‚„ä¸è‰¯' || hour.pblhCategory === 'ä¸è‰¯' ? '#f44336' :
                          hour.pblhCategory === 'æµ·éœ§ãƒªã‚¹ã‚¯' ? '#d32f2f' : '#666'
                        };">${hour.pblhCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center; color: ${hour.verticalVel !== '--' && parseFloat(hour.verticalVel) > 0 ? '#d32f2f' : '#1976d2'};">
                        ${hour.verticalVel}
                      </td>
                      <td style="padding: 4px; text-align: center;">
                        <div>${hour.ssi}</div>
                        <div style="font-size: 8px; color: ${
                          hour.ssiCategory === 'å®‰å®š' ? '#4caf50' :
                          hour.ssiCategory === 'ä¸­æ€§' ? '#ff9800' :
                          hour.ssiCategory === 'ã‚„ã‚„ä¸å®‰å®š' ? '#f44336' :
                          hour.ssiCategory === 'ä¸å®‰å®š' ? '#d32f2f' : '#666'
                        };">${hour.ssiCategory}</div>
                      </td>
                      <td style="padding: 4px; text-align: center;">${hour.equivTemp}</td>
                      <td style="padding: 4px; text-align: center; color: ${hour.vorticity !== '--' && parseFloat(hour.vorticity) > 0 ? '#d32f2f' : hour.vorticity !== '--' && parseFloat(hour.vorticity) < 0 ? '#1976d2' : '#333'};">
                        ${hour.vorticity}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div style="font-size: 9px; color: #666; margin-top: 8px; text-align: center;">
              â€» é«˜å±¤å¤§æ°—è§£æãƒ‡ãƒ¼ã‚¿ (4:00-16:00) | ğŸ”´æ­£å€¤=ä¸‹é™æ°—æµãƒ»ã‚µã‚¤ã‚¯ãƒ­ãƒ³æ€§ ğŸ”µè² å€¤=ä¸Šæ˜‡æ°—æµãƒ»ã‚¢ãƒ³ãƒã‚µã‚¤ã‚¯ãƒ­ãƒ³æ€§
            </div>
          </div>
        </div>
      `;

      // ä»•æ§˜æ›¸ã«å¾“ã£ãŸäºˆå ±è¡¨ç¤ºã‚’ä½œæˆ
      contentContainer.innerHTML = `
        <div style="padding: 20px;">
          <h4 style="color: #2c5f2d; margin-bottom: 20px; text-align: center;">
            ğŸ“… ${dateStr} ã®è©³ç´°äºˆå ±
          </h4>

          ${safetyWarningsHTML}

          ${longTermWarningHTML}

          <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; border-bottom: 2px solid #e0e0e0;">
              <button
                id="fisher-tab"
                onclick="switchForecastTab('fisher')"
                style="flex: 1; padding: 12px; border: none; background: #4caf50; color: white; cursor: pointer; border-radius: 8px 0 0 0; font-weight: bold;">
                ğŸ£ ä¸€èˆ¬æ¼å¸«å‘ã‘
              </button>
              <button
                id="expert-tab"
                onclick="switchForecastTab('expert')"
                style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; cursor: pointer; border-radius: 0 8px 0 0; font-weight: bold;">
                ğŸ”¬ å°‚é–€å®¶å‘ã‘
              </button>
            </div>
          </div>

          <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
          <div id="fisher-content" style="display: block;">
            ${fisherHTML}
          </div>

          <div id="expert-content" style="display: none;">
            ${expertHTML}
          </div>


          <!-- ç·åˆåˆ¤å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
            <h5 style="color: #2c5f2d; margin-bottom: 10px;">ğŸ¯ ç·åˆåˆ¤å®š</h5>
            <div style="font-size: 16px; font-weight: bold; color: ${suitabilityColor}; margin-bottom: 8px;">
              ${targetForecast.daily_summary.estimated_drying_time}
            </div>
            <div>ä¿¡é ¼åº¦: ${reliabilityData.accuracy || '--'}%</div>
            <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">ä¹¾ç‡¥é©æ€§: ${targetForecast.daily_summary.suitability}</div>
          </div>

          <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
            <p style="font-size: 12px; color: #666; margin: 0;">
              âœ… åœ°å½¢è£œæ­£ãƒ»æ®µéšåˆ¥ä¹¾ç‡¥åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ é©ç”¨æ¸ˆã¿ | ğŸ“Š åˆ©å°»å³¶æ˜†å¸ƒå¹²ã—ç‰¹åŒ–äºˆå ±
            </p>
          </div>
        </div>
      `;
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function switchForecastTab(tabType) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
      const fisherTab = document.getElementById('fisher-tab');
      const expertTab = document.getElementById('expert-tab');
      const fisherContent = document.getElementById('fisher-content');
      const expertContent = document.getElementById('expert-content');

      if (tabType === 'fisher') {
        // ä¸€èˆ¬æ¼å¸«å‘ã‘ã‚¿ãƒ–ã‚’æœ‰åŠ¹åŒ–
        fisherTab.style.background = '#4caf50';
        fisherTab.style.color = 'white';
        expertTab.style.background = '#e0e0e0';
        expertTab.style.color = '#666';

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
        fisherContent.style.display = 'block';
        expertContent.style.display = 'none';
      } else if (tabType === 'expert') {
        // å°‚é–€å®¶å‘ã‘ã‚¿ãƒ–ã‚’æœ‰åŠ¹åŒ–
        expertTab.style.background = '#9c27b0';
        expertTab.style.color = 'white';
        fisherTab.style.background = '#e0e0e0';
        fisherTab.style.color = '#666';

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
        expertContent.style.display = 'block';
        fisherContent.style.display = 'none';
      }
    }

    function generateTempHumiditySection(hourlyData, dateStr) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">ğŸŒ¡ï¸ åŸºæœ¬æ°—è±¡æƒ…å ± (4:00ã€œ16:00)</h5>
            <p style="color: #666; text-align: center;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>
          </div>
        `;
      }
      
      // 4:00-16:00ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const targetHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 4 && hour <= 16) {
          targetHours.push({
            time: timeStr,
            hour: hour,
            temp: hourlyData.temperature_2m ? hourlyData.temperature_2m[i] : null,
            humidity: hourlyData.relative_humidity_2m ? hourlyData.relative_humidity_2m[i] : null
          });
        }
      }
      
      let tempChartHTML = '';
      let humidityChartHTML = '';
      
      if (targetHours.length > 0) {
        // æ°—æ¸©ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        const tempValues = targetHours.map(h => h.temp).filter(t => t !== null);
        const minTemp = Math.min(...tempValues);
        const maxTemp = Math.max(...tempValues);
        
        tempChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>4:00</span><span>8:00</span><span>12:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #ff9800, #ffc107); height: ${h.temp ? ((h.temp - minTemp) / (maxTemp - minTemp + 1)) * 100 : 0}%; min-height: 3px; border-radius: 2px;" title="${h.temp}Â°C"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #333; margin-top: 3px;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `<span>${h.temp || '--'}Â°C</span>`).join('')}
            </div>
          </div>
        `;
        
        // æ¹¿åº¦ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        const humidityValues = targetHours.map(h => h.humidity).filter(h => h !== null);
        const avgHumidity = humidityValues.reduce((a, b) => a + b, 0) / humidityValues.length;
        const maxHumidity = Math.max(...humidityValues);
        
        const humidityRisk = maxHumidity >= 85 ? 'âš ï¸ é«˜æ¹¿åº¦è­¦å ±' : 
                           avgHumidity >= 80 ? 'âš¡ æ³¨æ„' : 'âœ… è‰¯å¥½';
        const humidityColor = maxHumidity >= 85 ? '#f44336' :
                            avgHumidity >= 80 ? '#ff9800' : '#4caf50';
        
        humidityChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>4:00</span><span>8:00</span><span>12:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #2196f3, #03a9f4); height: ${h.humidity || 0}%; min-height: 3px; border-radius: 2px;" title="${h.humidity}%"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #333; margin-top: 3px;">
              ${targetHours.filter(h => [4,8,12,16].includes(h.hour)).map(h => `<span>${h.humidity || '--'}%</span>`).join('')}
            </div>
            <div style="margin-top: 8px; padding: 5px; background: ${humidityColor}22; border-left: 3px solid ${humidityColor}; border-radius: 3px;">
              <span style="color: ${humidityColor}; font-weight: bold; font-size: 12px;">${humidityRisk}</span>
              <span style="color: #666; font-size: 11px; margin-left: 8px;">å¹³å‡: ${Math.round(avgHumidity)}%</span>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">ğŸŒ¡ï¸ åŸºæœ¬æ°—è±¡æƒ…å ± (4:00ã€œ16:00)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>æ°—æ¸©æ¨ç§»</strong>
              ${tempChartHTML}
            </div>
            <div>
              <strong>æ¹¿åº¦æ¨ç§»</strong>
              ${humidityChartHTML}
            </div>
          </div>
        </div>
      `;
    }

    function generateWindSection(hourlyData, dateStr, lat, lon) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #e8f5e8;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">ğŸ’¨ æ›æ°—é‡è¦–æœŸé–“ (4:00ã€œ10:00)</h5>
            <p style="color: #666; text-align: center;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>
          </div>
        `;
      }
      
      // 4:00-10:00ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const windHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 4 && hour <= 10) {
          const windDirection = hourlyData.wind_direction_10m ? hourlyData.wind_direction_10m[i] : null;
          const windSpeed = hourlyData.wind_speed_10m ? hourlyData.wind_speed_10m[i] : null;
          
          windHours.push({
            time: timeStr,
            hour: hour,
            direction: windDirection,
            speed: windSpeed,
            traditionName: getTraditionalWindName(windDirection),
            angleFromSpot: calculateAngleFromSpot(windDirection, lat, lon)
          });
        }
      }
      
      let windChartHTML = '';
      let windAnalysisHTML = '';
      
      if (windHours.length > 0) {
        // é¢¨é€Ÿã®è©•ä¾¡
        const avgWindSpeed = windHours.reduce((sum, h) => sum + (h.speed || 0), 0) / windHours.length;
        const goodWindCount = windHours.filter(h => h.speed >= 1.5).length;
        const windQuality = goodWindCount >= windHours.length * 0.7 ? 'âœ… è‰¯å¥½' : 
                          goodWindCount >= windHours.length * 0.4 ? 'âš¡ æ™®é€š' : 'âš ï¸ å¼±é¢¨';
        const windColor = goodWindCount >= windHours.length * 0.7 ? '#4caf50' :
                        goodWindCount >= windHours.length * 0.4 ? '#ff9800' : '#f44336';
        
        // é¢¨å‘ãƒ»é¢¨é€Ÿãƒãƒ£ãƒ¼ãƒˆ
        windChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `<span>${h.hour}:00</span>`).join('')}
            </div>
            <div style="display: flex; gap: 3px; height: 40px; align-items: end; margin-bottom: 5px;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="background: ${h.speed >= 1.5 ? '#4caf50' : '#ff5722'}; height: ${Math.min((h.speed || 0) * 8, 40)}px; width: 100%; min-height: 3px; border-radius: 2px; margin-bottom: 2px;" title="${h.speed}m/s"></div>
                  <span style="font-size: 9px; transform: rotate(${h.direction || 0}deg);">â†‘</span>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333;">
              ${windHours.filter(h => [4,6,8,10].includes(h.hour)).map(h => `<span>${h.speed || '--'}m/s</span>`).join('')}
            </div>
          </div>
        `;
        
        // åˆ©å°»å³¶ä¼çµ±é¢¨åè¡¨ç¤º
        const uniqueWindNames = [...new Set(windHours.map(h => h.traditionName).filter(n => n))];
        const windNameHTML = uniqueWindNames.length > 0 ? uniqueWindNames.join('ã€') : 'ä¸æ˜';
        
        windAnalysisHTML = `
          <div style="margin-top: 10px; padding: 8px; background: ${windColor}22; border-left: 3px solid ${windColor}; border-radius: 3px;">
            <div style="color: ${windColor}; font-weight: bold; font-size: 12px; margin-bottom: 3px;">${windQuality}</div>
            <div style="font-size: 11px; color: #666;">
              <div>å¹³å‡é¢¨é€Ÿ: ${avgWindSpeed.toFixed(1)}m/s</div>
              <div>ä¸»é¢¨å‘: ${windNameHTML}</div>
              <div>é©æ­£æ™‚é–“: ${goodWindCount}/${windHours.length}æ™‚é–“</div>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #e8f5e8;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">ğŸ’¨ æ›æ°—é‡è¦–æœŸé–“ (4:00ã€œ10:00)</h5>
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
            <div>
              <strong>é¢¨é€Ÿãƒ»é¢¨å‘æ¨ç§»</strong>
              ${windChartHTML}
            </div>
            <div>
              <strong>é¢¨æ³è©•ä¾¡</strong>
              ${windAnalysisHTML}
            </div>
          </div>
        </div>
      `;
    }

    function getTraditionalWindName(direction) {
      if (direction === null || direction === undefined) return 'ä¸æ˜';
      
      // åˆ©å°»å³¶ä¼çµ±é¢¨åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
      const windNames = [
        { min: 348.75, max: 11.25, name: 'ã‚¢ã‚¤' },
        { min: 11.25, max: 33.75, name: 'ã‚¢ã‚¤ã‚·ãƒ¢ãƒ»ã‚·ãƒ¢' },
        { min: 33.75, max: 56.25, name: 'ã‚·ãƒ¢' },
        { min: 56.25, max: 78.75, name: 'ã‚·ãƒ¢ãƒ¤ãƒã‚»' },
        { min: 78.75, max: 101.25, name: 'ãƒ›ãƒ³ãƒ¤ãƒã‚»' },
        { min: 101.25, max: 123.75, name: 'ãƒ¤ãƒã‚»' },
        { min: 123.75, max: 146.25, name: 'ãƒŸãƒŠãƒŸãƒ¤ãƒã‚»' },
        { min: 146.25, max: 168.75, name: 'ãƒŸãƒŠãƒŸãƒ¤ãƒ' },
        { min: 168.75, max: 191.25, name: 'ã‚¯ãƒ€ãƒª' },
        { min: 191.25, max: 213.75, name: 'ã‚¯ãƒ€ãƒªãƒ’ã‚«ã‚¿' },
        { min: 213.75, max: 236.25, name: 'ãƒ’ã‚«ã‚¿' },
        { min: 236.25, max: 258.75, name: 'ãƒ‹ã‚·ãƒ’ã‚«ã‚¿' },
        { min: 258.75, max: 281.25, name: 'ãƒ‹ã‚·' },
        { min: 281.25, max: 303.75, name: 'ãƒ‹ã‚·ã‚¿ãƒ' },
        { min: 303.75, max: 326.25, name: 'ã‚¿ãƒ' },
        { min: 326.25, max: 348.75, name: 'ã‚¢ã‚¤ã‚¿ãƒ' }
      ];
      
      for (const wind of windNames) {
        if (wind.min > wind.max) { // åŒ—é¢¨ã®å ´åˆï¼ˆ0åº¦ã‚’ã¾ãŸãï¼‰
          if (direction >= wind.min || direction <= wind.max) {
            return wind.name;
          }
        } else {
          if (direction >= wind.min && direction <= wind.max) {
            return wind.name;
          }
        }
      }
      
      return 'ä¸æ˜';
    }

    function calculateAngleFromSpot(windDirection, lat, lon) {
      if (windDirection === null || windDirection === undefined) return null;
      
      // åˆ©å°»å±±ã®åº§æ¨™ï¼ˆÎ¸å€¤è¨ˆç®—ç”¨ï¼‰
      const RISHIRI_SAN_LAT = 45.1821;
      const RISHIRI_SAN_LON = 141.2421;
      
      // ç°¡æ˜“çš„ãªå¹²å ´Î¸å€¤è¨ˆç®—
      const deltaLon = lon - RISHIRI_SAN_LON;
      const deltaLat = lat - RISHIRI_SAN_LAT;
      let spotTheta = Math.atan2(deltaLon, deltaLat) * 180 / Math.PI;
      if (spotTheta < 0) spotTheta += 360;
      
      // é¢¨å‘ã¨ã®è§’åº¦å·®ã‚’è¨ˆç®—
      let angleDiff = Math.abs(windDirection - spotTheta);
      if (angleDiff > 180) angleDiff = 360 - angleDiff;
      
      return Math.round(angleDiff);
    }

    function generateSolarSection(hourlyData, dateStr) {
      if (!hourlyData || !hourlyData.time) {
        return `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff3e0;">
            <h5 style="color: #2c5f2d; margin-bottom: 15px;">â˜€ï¸ ç†±ä¾›çµ¦é‡è¦–æœŸé–“ (10:00ã€œ16:00)</h5>
            <p style="color: #666; text-align: center;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>
          </div>
        `;
      }
      
      // 10:00-16:00ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const solarHours = [];
      for (let i = 0; i < hourlyData.time.length; i++) {
        const timeStr = hourlyData.time[i];
        const hour = new Date(timeStr).getHours();
        const dateMatch = timeStr.includes(dateStr);
        
        if (dateMatch && hour >= 10 && hour <= 16) {
          solarHours.push({
            time: timeStr,
            hour: hour,
            solar: hourlyData.shortwave_radiation ? hourlyData.shortwave_radiation[i] : null,
            cloud: hourlyData.cloud_cover ? hourlyData.cloud_cover[i] : null,
            temp: hourlyData.temperature_2m ? hourlyData.temperature_2m[i] : null
          });
        }
      }
      
      let solarChartHTML = '';
      let cloudChartHTML = '';
      
      if (solarHours.length > 0) {
        // æ—¥å°„é‡è©•ä¾¡
        const avgSolar = solarHours.reduce((sum, h) => sum + (h.solar || 0), 0) / solarHours.length;
        const avgCloud = solarHours.reduce((sum, h) => sum + (h.cloud || 0), 0) / solarHours.length;
        
        const solarQuality = avgSolar >= 600 ? 'âœ… å¼·ã„' :
                           avgSolar >= 300 ? 'âš¡ æ™®é€š' : 'âš ï¸ å¼±ã„';
        const solarColor = avgSolar >= 600 ? '#ff9800' :
                         avgSolar >= 300 ? '#ffc107' : '#757575';
        
        // æ—¥å°„é‡ãƒãƒ£ãƒ¼ãƒˆ
        solarChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
              <span>10:00</span><span>12:00</span><span>14:00</span><span>16:00</span>
            </div>
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #ff9800, #ffc107); height: ${Math.min((h.solar || 0) / 10, 30)}px; min-height: 3px; border-radius: 2px;" title="${h.solar}W/mÂ²"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-top: 3px;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `<span>${h.solar || '--'}</span>`).join('')}
            </div>
          </div>
        `;
        
        // é›²é‡ãƒãƒ£ãƒ¼ãƒˆ
        cloudChartHTML = `
          <div style="margin-top: 10px;">
            <div style="display: flex; gap: 2px; height: 30px; align-items: end;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `
                <div style="flex: 1; background: linear-gradient(to top, #78909c, #90a4ae); height: ${h.cloud || 0}%; min-height: 3px; border-radius: 2px;" title="${h.cloud}%"></div>
              `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-top: 3px;">
              ${solarHours.filter(h => [10,12,14,16].includes(h.hour)).map(h => `<span>${h.cloud || '--'}%</span>`).join('')}
            </div>
            <div style="margin-top: 8px; padding: 5px; background: ${solarColor}22; border-left: 3px solid ${solarColor}; border-radius: 3px;">
              <span style="color: ${solarColor}; font-weight: bold; font-size: 12px;">${solarQuality}</span>
              <span style="color: #666; font-size: 11px; margin-left: 8px;">å¹³å‡é›²é‡: ${Math.round(avgCloud)}%</span>
            </div>
          </div>
        `;
      }
      
      return `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff3e0;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">â˜€ï¸ ç†±ä¾›çµ¦é‡è¦–æœŸé–“ (10:00ã€œ16:00)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>æ—¥å°„é‡ (W/mÂ²)</strong>
              ${solarChartHTML}
            </div>
            <div>
              <strong>é›²é‡ (%)</strong>
              ${cloudChartHTML}
            </div>
          </div>
        </div>
      `;
    }

    function generateDryingAnalysis(analysisData, hourlyData, dateStr) {
      // ä¹¾ç‡¥é©åˆåº¦ã‚’ç·åˆçš„ã«åˆ¤å®š
      let dryingScore = 0;
      let analysisText = [];
      let completionTime = 'ä¸æ˜';
      let riskFactors = [];
      
      if (hourlyData && hourlyData.time) {
        // æ¹¿åº¦ãƒªã‚¹ã‚¯è©•ä¾¡
        const humidityValues = [];
        const windValues = [];
        const solarValues = [];
        
        for (let i = 0; i < hourlyData.time.length; i++) {
          const timeStr = hourlyData.time[i];
          if (timeStr.includes(dateStr)) {
            const hour = new Date(timeStr).getHours();
            if (hour >= 4 && hour <= 16) {
              if (hourlyData.relative_humidity_2m && hourlyData.relative_humidity_2m[i] !== null) {
                humidityValues.push(hourlyData.relative_humidity_2m[i]);
              }
              if (hourlyData.wind_speed_10m && hourlyData.wind_speed_10m[i] !== null) {
                windValues.push(hourlyData.wind_speed_10m[i]);
              }
              if (hour >= 10 && hourlyData.shortwave_radiation && hourlyData.shortwave_radiation[i] !== null) {
                solarValues.push(hourlyData.shortwave_radiation[i]);
              }
            }
          }
        }
        
        // æ¹¿åº¦è©•ä¾¡ï¼ˆ40ç‚¹æº€ç‚¹ï¼‰
        const maxHumidity = humidityValues.length > 0 ? Math.max(...humidityValues) : 100;
        const avgHumidity = humidityValues.length > 0 ? humidityValues.reduce((a, b) => a + b) / humidityValues.length : 100;
        
        if (maxHumidity < 70) {
          dryingScore += 40;
          analysisText.push('âœ… æ¹¿åº¦æ¡ä»¶è‰¯å¥½');
        } else if (maxHumidity < 85) {
          dryingScore += 25;
          analysisText.push('âš¡ æ¹¿åº¦æ¡ä»¶æ™®é€š');
        } else {
          dryingScore += 5;
          analysisText.push('âš ï¸ é«˜æ¹¿åº¦ãƒªã‚¹ã‚¯');
          riskFactors.push('é«˜æ¹¿åº¦');
        }
        
        // é¢¨é€Ÿè©•ä¾¡ï¼ˆ30ç‚¹æº€ç‚¹ï¼‰
        const avgWind = windValues.length > 0 ? windValues.reduce((a, b) => a + b) / windValues.length : 0;
        const goodWindHours = windValues.filter(w => w >= 1.5).length;
        
        if (avgWind >= 2.0 && goodWindHours >= windValues.length * 0.7) {
          dryingScore += 30;
          analysisText.push('âœ… é¢¨æ³è‰¯å¥½');
        } else if (avgWind >= 1.5) {
          dryingScore += 20;
          analysisText.push('âš¡ é¢¨æ³æ™®é€š');
        } else {
          dryingScore += 5;
          analysisText.push('âš ï¸ å¼±é¢¨');
          riskFactors.push('é¢¨é€Ÿä¸è¶³');
        }
        
        // æ—¥å°„è©•ä¾¡ï¼ˆ30ç‚¹æº€ç‚¹ï¼‰
        const avgSolar = solarValues.length > 0 ? solarValues.reduce((a, b) => a + b) / solarValues.length : 0;
        
        if (avgSolar >= 500) {
          dryingScore += 30;
          analysisText.push('âœ… æ—¥å°„é‡è‰¯å¥½');
          completionTime = 'åˆå¾Œ2æ™‚é ƒ';
        } else if (avgSolar >= 300) {
          dryingScore += 20;
          analysisText.push('âš¡ æ—¥å°„é‡æ™®é€š');
          completionTime = 'åˆå¾Œ3æ™‚é ƒ';
        } else {
          dryingScore += 10;
          analysisText.push('âš ï¸ æ—¥å°„é‡ä¸è¶³');
          completionTime = 'å¤•æ–¹ä»¥é™';
          riskFactors.push('æ—¥å°„é‡ä¸è¶³');
        }
      }
      
      // ç·åˆåˆ¤å®š
      let overallStatus = '';
      let statusIcon = '';
      let statusColor = '';
      
      if (dryingScore >= 80) {
        overallStatus = 'éå¸¸ã«è‰¯å¥½';
        statusIcon = 'ğŸŒŸ';
        statusColor = '#4caf50';
      } else if (dryingScore >= 60) {
        overallStatus = 'è‰¯å¥½';
        statusIcon = 'âœ…';
        statusColor = '#8bc34a';
      } else if (dryingScore >= 40) {
        overallStatus = 'è¦æ³¨æ„';
        statusIcon = 'âš¡';
        statusColor = '#ff9800';
      } else {
        overallStatus = 'ä¸é©';
        statusIcon = 'âš ï¸';
        statusColor = '#f44336';
      }
      
      const riskText = riskFactors.length > 0 ? 
        `<div style="margin-top: 8px; padding: 5px; background: #ffebee; border-left: 3px solid #f44336; border-radius: 3px;">
          <span style="color: #f44336; font-size: 11px;">âš ï¸ ãƒªã‚¹ã‚¯è¦å› : ${riskFactors.join('ã€')}</span>
        </div>` : '';
      
      return `
        <div style="border: 2px solid ${statusColor}; border-radius: 8px; padding: 15px; background: ${statusColor}11;">
          <h5 style="color: #2c5f2d; margin-bottom: 15px;">ğŸ¯ ç§‘å­¦çš„ä¹¾ç‡¥äºˆæ¸¬</h5>
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${statusIcon}</div>
            <p style="font-size: 20px; font-weight: bold; color: #2c5f2d; margin-bottom: 10px;">
              ä¹¾ç‡¥é©åˆåº¦: <span style="color: ${statusColor};">${overallStatus}</span>
            </p>
            <p style="font-size: 16px; color: ${statusColor}; margin-bottom: 5px;">
              ã‚¹ã‚³ã‚¢: ${dryingScore}/100ç‚¹
            </p>
            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
              äºˆæ¸¬å®Œäº†æ™‚é–“: ${completionTime}
            </p>
            <div style="text-align: left; margin-top: 15px;">
              ${analysisText.map(text => `<div style="font-size: 12px; color: #333; margin: 2px 0;">â€¢ ${text}</div>`).join('')}
            </div>
            ${riskText}
          </div>
        </div>
      `;
    }

    // è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãé–¢æ•°ï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
    function openRecordDialog(spotName) {
      console.log('è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã:', spotName);
      
      // Step 1: æ—¥ä»˜é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">${spotName} ã®è¨˜éŒ²</h3>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 10px 0; color: #856404;">
              <strong>âš ï¸ æ³¨æ„:</strong> æ—¥ä»˜ã®å…¥åŠ›é–“é•ã„ã¯æ©Ÿæ¢°å­¦ç¿’ã«è² ã®å½±éŸ¿ã‚’åŠã¼ã™ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„
            </div>
            <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">æ—¥ä»˜ã‚’é¸æŠ:</label>
            
            <!-- å¹´é¸æŠ -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">å¹´:</label>
              <div id="yearContainer" style="display: flex; gap: 5px; flex-wrap: wrap;">
                <!-- å¹´ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
              </div>
            </div>
            
            <!-- æœˆé¸æŠ -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">æœˆ:</label>
              <div id="monthContainer" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;">
                <!-- æœˆãƒœã‚¿ãƒ³ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
              </div>
            </div>
            
            <!-- æ—¥é¸æŠ -->
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">æ—¥:</label>
              <div id="dayContainer" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; max-height: 120px; overflow-y: auto;">
                <!-- æ—¥ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
              </div>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 10px; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 4px;">
              é¸æŠã•ã‚ŒãŸæ—¥ä»˜: <span id="selectedDateDisplay">æœªé¸æŠ</span>
            </div>
            <button onclick="window.checkExistingRecord('${spotName}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">æ¬¡ã¸</button>
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 5px 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
      
      // æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      generateDateButtons();
      
      // æ—¥ä»˜å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setTimeout(() => {
        const dateInput = document.getElementById('recordDate');
        const nextButton = document.querySelector('#recordDialog button[onclick*="checkExistingRecord"]');
        
        if (dateInput && nextButton) {
          // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
          dateInput.value = '';
          nextButton.disabled = true;
          nextButton.style.background = '#ccc';
          nextButton.textContent = 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„';
          
          console.log('æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæº–å‚™ã•ã‚Œã¾ã—ãŸï¼ˆåˆæœŸå€¤ã‚¯ãƒªã‚¢ï¼‰');
          console.log('åˆæœŸçŠ¶æ…‹ã®æ—¥ä»˜å€¤:', dateInput.value);
          
          // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
          const today = new Date();
          const todayString = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
          
          console.log('ä»Šæ—¥ã®æ—¥ä»˜åŸºæº–:', todayString);
          
          // æ—¥ä»˜å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          function updateButton() {
            console.log('updateButtonå‘¼ã³å‡ºã— - ç¾åœ¨ã®å€¤:', dateInput.value);
            console.log('å€¤ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯:', !!dateInput.value);
            console.log('å€¤ã®é•·ã•:', dateInput.value.length);
            
            if (dateInput.value && dateInput.value.length > 0) {
              // æœªæ¥ã®æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
              if (dateInput.value > todayString) {
                nextButton.disabled = true;
                nextButton.style.background = '#ff5722';
                nextButton.textContent = 'æœªæ¥ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“';
                console.log('æœªæ¥ã®æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', dateInput.value);
              } else {
                nextButton.disabled = false;
                nextButton.style.background = '#4caf50';
                nextButton.textContent = 'æ¬¡ã¸';
                console.log('æœ‰åŠ¹ãªæ—¥ä»˜ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', dateInput.value);
              }
            } else {
              nextButton.disabled = true;
              nextButton.style.background = '#ccc';
              nextButton.textContent = 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„';
              console.log('æ—¥ä»˜ãŒç©ºã§ã™');
            }
          }
          
          dateInput.addEventListener('change', function(e) {
            console.log('change ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ:', e.target.value);
            updateButton();
          });
          
          dateInput.addEventListener('input', function(e) {
            console.log('input ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ:', e.target.value);
            updateButton();
          });
          
          // è¿½åŠ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          dateInput.addEventListener('blur', function(e) {
            console.log('blur ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ:', e.target.value);
            updateButton();
          });
          
          dateInput.addEventListener('keyup', function(e) {
            console.log('keyup ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ:', e.target.value);
            updateButton();
          });
          
          // ãƒãƒ¼ãƒªãƒ³ã‚°ã§å€¤ã®å¤‰åŒ–ã‚’ç›£è¦–ï¼ˆã‚ˆã‚Šé »ç¹ã«ï¼‰
          let lastValue = '';
          const checkValue = setInterval(() => {
            if (dateInput.value !== lastValue) {
              console.log('ãƒãƒ¼ãƒªãƒ³ã‚°æ¤œçŸ¥ - å€¤å¤‰æ›´:', lastValue, '->', dateInput.value);
              lastValue = dateInput.value;
              updateButton();
            }
          }, 100); // 500ms -> 100msã«å¤‰æ›´
          
          // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList') {
                mutation.removedNodes.forEach((node) => {
                  if (node.id === 'recordDialog') {
                    clearInterval(checkValue);
                    observer.disconnect();
                  }
                });
              }
            });
          });
          observer.observe(document.body, { childList: true });
          
          // åˆæœŸçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          updateButton();
        }
      }, 10);
    }
    
    // æ—¢å­˜è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function checkExistingRecord(spotName) {
      const selectedDate = window.selectedRecordDate;
      console.log('é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', selectedDate);
      
      if (!selectedDate) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        console.log('æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      // æœªæ¥ã®æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
      const today = new Date();
      const todayString = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
      
      if (selectedDate > todayString) {
        alert('æœªæ¥ã®æ—¥ä»˜ã¯è¨˜éŒ²ã§ãã¾ã›ã‚“ã€‚éå»ã¾ãŸã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        console.log('æœªæ¥ã®æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', selectedDate);
        return;
      }
      
      console.log('æ—¢å­˜è¨˜éŒ²ãƒã‚§ãƒƒã‚¯:', spotName, selectedDate);
      console.log('é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®è©³ç´°ç¢ºèª:', selectedDate);
      
      // æ—¢å­˜è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}&date=${selectedDate}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.record) {
            // æ—¢å­˜è¨˜éŒ²ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            showExistingRecordDialog(spotName, selectedDate, data.record.result);
          } else {
            // æ–°è¦è¨˜éŒ²ã®å ´åˆ
            showRecordOptionsDialog(spotName, selectedDate);
          }
        })
        .catch(error => {
          console.error('è¨˜éŒ²ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚æ–°è¦è¨˜éŒ²ã¨ã—ã¦é€²ã‚ã‚‹
          showRecordOptionsDialog(spotName, selectedDate);
        });
    }
    
    // æ—¢å­˜è¨˜éŒ²ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showExistingRecordDialog(spotName, date, existingResult) {
      closeRecordDialog();
      
      console.log('showExistingRecordDialogå‘¼ã³å‡ºã— - å—ä¿¡ã—ãŸæ—¥ä»˜:', date);
      
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">è¨˜éŒ²ãŒå­˜åœ¨ã—ã¾ã™</h3>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 10px; margin: 10px 0;">
              <strong>åœ°ç‚¹:</strong> ${spotName}<br>
              <strong>æ—¥ä»˜:</strong> ${date}<br>
              <strong>æ—¢å­˜è¨˜éŒ²:</strong> ${existingResult}
            </div>
            <p style="font-size: 12px; color: #666;">ãƒ‡ãƒãƒƒã‚°: å—ä¿¡ã—ãŸæ—¥ä»˜ = ${date}</p>
            <button onclick="window.showRecordOptionsDialog('${spotName}', '${date}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">è¨˜éŒ²ã‚’å¤‰æ›´</button>
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 5px 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // è¨˜éŒ²é¸æŠè‚¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆä»•æ§˜æ›¸æº–æ‹ ã®3æŠï¼‰
    function showRecordOptionsDialog(spotName, date) {
      closeRecordDialog();
      
      console.log('showRecordOptionsDialogå‘¼ã³å‡ºã— - å—ä¿¡ã—ãŸæ—¥ä»˜:', date);
      
      const recordOptions = [
        'å®Œå…¨ä¹¾ç‡¥',
        'ä¸­æ­¢',
        'å¹²ã—ãŸãŒå®Œå…¨ã«ã¯ä¹¾ã‹ã›ãªã‹ã£ãŸï¼ˆæ³£ï¼‰'
      ];
      
      let optionsHtml = '';
      recordOptions.forEach((option) => {
        optionsHtml += `<button onclick="window.submitRecord('${spotName}', '${date}', '${option}')" style="display: block; width: 100%; margin: 5px 0; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">${option}</button>`;
      });
      
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="recordDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c5f2d;">${spotName} ã®è¨˜éŒ²</h3>
            <p><strong>æ—¥ä»˜:</strong> ${date}</p>
            <p style="font-size: 12px; color: #666;">ãƒ‡ãƒãƒƒã‚°: å—ä¿¡ã—ãŸæ—¥ä»˜ = ${date}</p>
            <p>ä¹¾ç‡¥çµæœã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
            ${optionsHtml}
            <button onclick="window.closeRecordDialog()" style="display: block; width: 100%; margin: 10px 0 0 0; padding: 8px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // è¨˜éŒ²ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    function submitRecord(spotName, date, result) {
      console.log('è¨˜éŒ²é€ä¿¡:', spotName, date, result);
      console.log('é€ä¿¡ã•ã‚Œã‚‹æ—¥ä»˜ã®ç¢ºèª:', date);
      console.log('æ—¥ä»˜ã®ã‚¿ã‚¤ãƒ—:', typeof date);
      
      fetch(`${API_BASE}/record`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          date: date,
          name: spotName,
          result: result
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('è¨˜éŒ²é€ä¿¡çµæœ:', data);
        if (data.status === 'success') {
          alert(`è¨˜éŒ²ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼\n\nåœ°ç‚¹: ${spotName}\næ—¥ä»˜: ${date}\nçµæœ: ${result}\n\næ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ãŒè‡ªå‹•ã§ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚`);
        } else {
          alert('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
        }
        closeRecordDialog();
      })
      .catch(error => {
        console.error('è¨˜éŒ²é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨˜éŒ²ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        closeRecordDialog();
      });
    }
    
    // æ—¥ä»˜é¸æŠUIå¤‰æ•°
    let selectedYear = null;
    let selectedMonth = null;
    let selectedDay = null;

    // æ—¥ä»˜é¸æŠUIã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function generateDateButtons() {
      generateYearButtons();
      generateMonthButtons();
      updateDateDisplay();
    }
    
    // å¹´ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
    function generateYearButtons() {
      const container = document.getElementById('yearContainer');
      if (!container) return;
      
      const currentYear = new Date().getFullYear();
      const years = [currentYear - 1, currentYear]; // æ˜¨å¹´ã¨ä»Šå¹´
      
      const buttons = years.map(year => 
        `<button type="button" onclick="window.selectYear(${year})" id="year-${year}"
                 style="padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
           ${year}å¹´
         </button>`
      ).join('');
      
      container.innerHTML = buttons;
    }
    
    // æœˆãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
    function generateMonthButtons() {
      const container = document.getElementById('monthContainer');
      if (!container) return;
      
      const months = Array.from({length: 12}, (_, i) => i + 1);
      
      const buttons = months.map(month => 
        `<button type="button" onclick="window.selectMonth(${month})" id="month-${month}"
                 style="padding: 6px; background: #666; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
           ${month}æœˆ
         </button>`
      ).join('');
      
      container.innerHTML = buttons;
    }
    
    // æ—¥ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
    function generateDayButtons() {
      const container = document.getElementById('dayContainer');
      if (!container || !selectedYear || !selectedMonth) return;
      
      // è©²å½“æœˆã®æ—¥æ•°ã‚’å–å¾—
      const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
      const today = new Date();
      
      const buttons = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(selectedYear, selectedMonth - 1, day);
        const isValidDate = dateObj <= today; // æœªæ¥ã®æ—¥ä»˜ã¯ç„¡åŠ¹
        
        const buttonStyle = isValidDate 
          ? "padding: 6px; background: #666; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;"
          : "padding: 6px; background: #ccc; color: #999; border: none; border-radius: 3px; font-size: 11px; cursor: not-allowed;";
        
        const onClick = isValidDate ? `onclick="window.selectDay(${day})"` : '';
        
        buttons.push(
          `<button type="button" ${onClick} id="day-${day}" style="${buttonStyle}">
             ${day}
           </button>`
        );
      }
      
      container.innerHTML = buttons.join('');
    }
    
    // å¹´ã‚’é¸æŠ
    function selectYear(year) {
      selectedYear = year;
      
      // å¹´ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»æ›´æ–°
      document.querySelectorAll('[id^="year-"]').forEach(btn => btn.style.background = '#666');
      document.getElementById(`year-${year}`).style.background = '#2196f3';
      
      console.log('å¹´ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', year);
      generateDayButtons();
      updateDateDisplay();
    }
    
    // æœˆã‚’é¸æŠ
    function selectMonth(month) {
      selectedMonth = month;
      
      // æœˆãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»æ›´æ–°
      document.querySelectorAll('[id^="month-"]').forEach(btn => btn.style.background = '#666');
      document.getElementById(`month-${month}`).style.background = '#4caf50';
      
      console.log('æœˆãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', month);
      generateDayButtons();
      updateDateDisplay();
    }
    
    // æ—¥ã‚’é¸æŠ
    function selectDay(day) {
      selectedDay = day;
      
      // æ—¥ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»æ›´æ–°
      document.querySelectorAll('[id^="day-"]').forEach(btn => {
        if (btn.style.background !== 'rgb(204, 204, 204)') { // ç„¡åŠ¹ãªæ—¥ä»˜ã§ãªã‘ã‚Œã°
          btn.style.background = '#666';
        }
      });
      document.getElementById(`day-${day}`).style.background = '#ff9800';
      
      console.log('æ—¥ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', day);
      updateDateDisplay();
    }
    
    // æ—¥ä»˜è¡¨ç¤ºã‚’æ›´æ–°
    function updateDateDisplay() {
      const displayElement = document.getElementById('selectedDateDisplay');
      const nextButton = document.querySelector('#recordDialog button[onclick*="checkExistingRecord"]');
      
      if (selectedYear && selectedMonth && selectedDay) {
        const year = selectedYear;
        const month = String(selectedMonth).padStart(2, '0');
        const day = String(selectedDay).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        // è¡¨ç¤ºæ›´æ–°
        displayElement.textContent = `${selectedYear}å¹´${selectedMonth}æœˆ${selectedDay}æ—¥`;
        displayElement.style.color = '#2c5f2d';
        displayElement.style.fontWeight = 'bold';
        
        // å†…éƒ¨çš„ã«æ—¥ä»˜ã‚’ä¿å­˜
        window.selectedRecordDate = dateString;
        console.log('å®Œå…¨ãªæ—¥ä»˜ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', dateString);
        
        // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        if (nextButton) {
          nextButton.disabled = false;
          nextButton.style.background = '#4caf50';
          nextButton.textContent = 'æ¬¡ã¸';
        }
      } else {
        displayElement.textContent = 'æœªé¸æŠ';
        displayElement.style.color = '#666';
        displayElement.style.fontWeight = 'normal';
        
        // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        if (nextButton) {
          nextButton.disabled = true;
          nextButton.style.background = '#ccc';
          nextButton.textContent = 'å¹´ãƒ»æœˆãƒ»æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
        }
      }
    }
    
    // å¹²å ´å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function confirmDeleteSpot(spotName, lat, lon) {
      console.log('å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã:', spotName);
      
      // ã¾ãšè¨˜éŒ²ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
      fetch(`${API_BASE}/check_spot_records?name=${encodeURIComponent(spotName)}`)
        .then(response => response.json())
        .then(data => {
          if (data.has_records) {
            // è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            showCannotDeleteDialog(spotName, lat, lon);
          } else {
            // è¨˜éŒ²ãŒãªã„å ´åˆã¯å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            showDeleteConfirmDialog(spotName, lat, lon);
          }
        })
        .catch(error => {
          console.error('è¨˜éŒ²ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
          showDeleteConfirmDialog(spotName, lat, lon);
        });
    }
    
    // å‰Šé™¤ä¸å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showCannotDeleteDialog(spotName, lat, lon) {
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="deleteDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #f44336;">âŒ å‰Šé™¤ã§ãã¾ã›ã‚“</h3>
            <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0;">
              <p style="margin: 0; color: #c62828;"><strong>å¯¾è±¡å¹²å ´:</strong></p>
              <p style="margin: 5px 0 0 0; font-weight: bold;">${spotName}</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">åº§æ¨™: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
            </div>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 15px; margin: 15px 0; color: #1976d2;">
              <strong>å‰Šé™¤ã§ããªã„ç†ç”±:</strong><br>
              ã“ã®å¹²å ´ã«ã¯hoshiba_records.csvå†…ã«è¨˜éŒ²ãŒå­˜åœ¨ã—ã¾ã™ã€‚<br><br>
              è¨˜éŒ²ãŒã‚ã‚‹å¹²å ´ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚
            </div>
            <button onclick="window.closeDeleteDialog()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">äº†è§£</button>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showDeleteConfirmDialog(spotName, lat, lon) {
      const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="deleteDialog">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #f44336;">âš ï¸ å¹²å ´å‰Šé™¤ã®ç¢ºèª</h3>
            <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0;">
              <p style="margin: 0; color: #c62828;"><strong>å‰Šé™¤å¯¾è±¡:</strong></p>
              <p style="margin: 5px 0 0 0; font-weight: bold;">${spotName}</p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">åº§æ¨™: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
            </div>
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 15px 0; color: #2e7d32;">
              âœ… <strong>å‰Šé™¤å¯èƒ½:</strong> ã“ã®å¹²å ´ã«ã¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin: 15px 0; color: #856404;">
              <strong>æ³¨æ„:</strong> å‰Šé™¤ã•ã‚ŒãŸå¹²å ´ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å®Œå…¨ã«é™¤å»ã•ã‚Œã¾ã™ï¼š
              <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                <li>hoshiba_spots.csv</li>
                <li>hoshiba_spots_named.kml</li>
              </ul>
              ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button onclick="window.deleteSpot('${spotName}')" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">å‰Šé™¤å®Ÿè¡Œ</button>
              <button onclick="window.closeDeleteDialog()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', dialogHtml);
    }
    
    // å¹²å ´å‰Šé™¤å®Ÿè¡Œ
    function deleteSpot(spotName) {
      console.log('å¹²å ´å‰Šé™¤å®Ÿè¡Œ:', spotName);
      
      fetch(`${API_BASE}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: spotName
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('å‰Šé™¤çµæœ:', data);
        if (data.status === 'success') {
          alert(`å¹²å ´ã€Œ${spotName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\né–¢é€£ã™ã‚‹è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚\nåœ°å›³ã‚’æ›´æ–°ã—ã¾ã™ã€‚`);
          closeDeleteDialog();
          
          // åœ°å›³ã‚’æ›´æ–°
          loadSpots();
        } else {
          alert('å¹²å ´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
        }
      })
      .catch(error => {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      });
    }
    
    // å‰Šé™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
    function closeDeleteDialog() {
      const dialog = document.getElementById('deleteDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½
    function toggleFavorite(spotName, lat, lon) {
      console.log('ãŠæ°—ã«å…¥ã‚Šåˆ‡ã‚Šæ›¿ãˆ:', spotName);
      
      // ã¾ãšç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      fetch(`${API_BASE}/favorites/check?name=${encodeURIComponent(spotName)}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            if (data.is_favorite) {
              // ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤
              removeFavorite(spotName);
            } else {
              // ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
              addFavorite(spotName, lat, lon);
            }
          }
        })
        .catch(error => {
          console.error('ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãŠæ°—ã«å…¥ã‚Šã®çŠ¶æ…‹ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }

    function addFavorite(spotName, lat, lon) {
      const data = {
        name: spotName,
        lat: lat,
        lon: lon
      };

      fetch(`${API_BASE}/favorites/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          updateFavoriteButton(spotName, true);
          // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã‚’æ›´æ–°
          updateMarkerColor(spotName, true);
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('ãŠæ°—ã«å…¥ã‚Šè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãŠæ°—ã«å…¥ã‚Šã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function removeFavorite(spotName) {
      const data = {
        name: spotName
      };

      fetch(`${API_BASE}/favorites/remove`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          updateFavoriteButton(spotName, false);
          // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã‚’æ›´æ–°
          updateMarkerColor(spotName, false);
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function updateFavoriteButton(spotName, isFavorite) {
      const buttonId = `favorite-btn-${spotName.replace(/[^a-zA-Z0-9]/g, '_')}`;
      const button = document.getElementById(buttonId);
      
      if (button) {
        if (isFavorite) {
          button.textContent = 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å¤–ã™';
          button.style.background = '#28a745';
        } else {
          button.textContent = 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ';
          button.style.background = '#ffc107';
        }
      }
    }

    function updateMarkerColor(spotName, isFavorite) {
      // ã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼šç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒãƒƒãƒˆã§å†æç”»
      const currentDisplayedSpots = [];
      
      // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚¹ãƒãƒƒãƒˆã‚’ç‰¹å®š
      for (let marker of spotMarkers) {
        if (marker.options && marker.options.title) {
          const spot = spots.find(s => s.name === marker.options.title);
          if (spot) {
            currentDisplayedSpots.push(spot);
          }
        }
      }
      
      // çµ±ä¸€é–¢æ•°ã§å†æç”»ï¼ˆãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ãŒæ­£ã—ãåæ˜ ã•ã‚Œã‚‹ï¼‰
      if (currentDisplayedSpots.length > 0) {
        createMarkersWithFavorites(currentDisplayedSpots);
      }
    }
    
    // è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeRecordDialog() {
      const dialog = document.getElementById('recordDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦è¨­å®š
    window.getWeatherForecast = getWeatherForecast;
    window.openRecordDialog = openRecordDialog;
    window.checkExistingRecord = checkExistingRecord;
    window.showExistingRecordDialog = showExistingRecordDialog;
    window.showRecordOptionsDialog = showRecordOptionsDialog;
    window.submitRecord = submitRecord;
    window.generateDateButtons = generateDateButtons;
    window.selectYear = selectYear;
    window.selectMonth = selectMonth;
    window.selectDay = selectDay;
    window.confirmDeleteSpot = confirmDeleteSpot;
    window.showCannotDeleteDialog = showCannotDeleteDialog;
    window.showDeleteConfirmDialog = showDeleteConfirmDialog;
    window.deleteSpot = deleteSpot;
    window.closeDeleteDialog = closeDeleteDialog;
    window.closeRecordDialog = closeRecordDialog;
    window.toggleFavorite = toggleFavorite;
    window.addFavorite = addFavorite;
    window.removeFavorite = removeFavorite;
    window.closeWeatherForecastDialog = closeWeatherForecastDialog;
    window.selectForecastDate = selectForecastDate;

    // åˆæœŸèª­ã¿è¾¼ã¿
    loadSpots();
    
    // ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®åˆæœŸåŒ–
    initAllMobileFeatures();
    
    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    window.addEventListener('beforeunload', () => {
      stopSeaFogAutoUpdate();
    });
  </script>
  
  <!-- ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="mobile-quick-actions" id="mobileQuickActions">
    <button class="quick-action-btn" onclick="document.getElementById('helpButton').click()" title="ãƒ˜ãƒ«ãƒ—">ğŸ“–</button>
    <button class="quick-action-btn" onclick="document.getElementById('favoritesButton').click()" title="ãŠæ°—ã«å…¥ã‚Š">â­</button>
    <button class="quick-action-btn" onclick="document.getElementById('forecastButton').click()" title="äºˆå ±">ğŸ“Š</button>
    <button class="quick-action-btn primary" onclick="toggleQuickActions()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
  </div>
  
  <script>
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
    function toggleQuickActions() {
      const quickActions = document.getElementById('mobileQuickActions');
      const isShow = quickActions.classList.contains('show');
      
      if (window.innerWidth <= 768) {
        if (isShow) {
          quickActions.classList.remove('show');
        } else {
          quickActions.classList.add('show');
          // 5ç§’å¾Œã«è‡ªå‹•ã§éš ã™
          setTimeout(() => {
            quickActions.classList.remove('show');
          }, 5000);
        }
      }
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã¯è‡ªå‹•ã§ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        document.getElementById('mobileQuickActions').classList.add('show');
      }, 2000);
    }

    // æµ·éœ§äºˆæ¸¬é–¢é€£æ©Ÿèƒ½
    function loadSeaFogStatus() {
      if (!selectedSpot) return;
      
      const seaFogStatus = document.getElementById('seaFogStatus');
      seaFogStatus.innerHTML = '<div class="loading">æµ·éœ§äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/dashboard?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(data => {
          displaySeaFogStatus(data);
        })
        .catch(err => {
          console.error('æµ·éœ§äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', err);
          seaFogStatus.innerHTML = '<div style="color: red;">æµ·éœ§äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function displaySeaFogStatus(data) {
      const seaFogStatus = document.getElementById('seaFogStatus');
      
      if (data.error) {
        seaFogStatus.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
        return;
      }
      
      const summary = data.summary || {};
      const maxRisk = summary.max_probability || 0;
      const workRisk = summary.work_hours_average || 0;
      const recommendation = summary.work_recommendation || 'ä¸æ˜';
      const trend = summary.trend || 'ä¸æ˜';
      
      // ãƒªã‚¹ã‚¯è‰²ã®æ±ºå®š
      let riskColor = '#28a745'; // ç·‘
      if (maxRisk >= 0.8) riskColor = '#dc3545'; // èµ¤
      else if (maxRisk >= 0.6) riskColor = '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸
      else if (maxRisk >= 0.3) riskColor = '#ffc107'; // é»„
      
      seaFogStatus.innerHTML = `
        <div><strong>ğŸŒ«ï¸ æµ·éœ§ãƒªã‚¹ã‚¯çŠ¶æ³</strong></div>
        <div style="margin: 8px 0;">
          <strong>æœ€å¤§ç¢ºç‡:</strong> 
          <span style="color: ${riskColor}; font-weight: bold;">${(maxRisk * 100).toFixed(1)}%</span>
        </div>
        <div style="margin: 8px 0;">
          <strong>ä½œæ¥­æ™‚é–“å¹³å‡:</strong> ${(workRisk * 100).toFixed(1)}%
        </div>
        <div style="margin: 8px 0;">
          <strong>æ¨å¥¨:</strong> ${recommendation}
        </div>
        <div style="margin: 8px 0;">
          <strong>å‚¾å‘:</strong> ${trend}
        </div>
        <div style="font-size: 11px; color: #6c757d;">
          ${data.generated_at ? `æ›´æ–°: ${new Date(data.generated_at).toLocaleString()}` : ''}
        </div>
      `;
    }

    // å„ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
    document.addEventListener('DOMContentLoaded', () => {
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
      const fogDashboardButton = document.getElementById('fogDashboardButton');
      if (fogDashboardButton) {
        fogDashboardButton.addEventListener('click', () => {
          loadSeaFogDashboard();
        });
      }

      // æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆãƒœã‚¿ãƒ³
      const fogTimelineButton = document.getElementById('fogTimelineButton');
      if (fogTimelineButton) {
        fogTimelineButton.addEventListener('click', () => {
          generateSeaFogTimeline();
        });
      }

      // ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³
      const fogHeatmapButton = document.getElementById('fogHeatmapButton');
      if (fogHeatmapButton) {
        fogHeatmapButton.addEventListener('click', () => {
          generateSeaFogHeatmap();
        });
      }

      // è¦å› åˆ†æãƒœã‚¿ãƒ³
      const fogFactorsButton = document.getElementById('fogFactorsButton');
      if (fogFactorsButton) {
        fogFactorsButton.addEventListener('click', () => {
          generateSeaFogFactors();
        });
      }

      // åœ°ç‚¹æ¯”è¼ƒãƒœã‚¿ãƒ³
      const fogComparisonButton = document.getElementById('fogComparisonButton');
      if (fogComparisonButton) {
        fogComparisonButton.addEventListener('click', () => {
          generateSeaFogComparison();
        });
      }

      // åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœã‚¿ãƒ³
      const fogMapLayerButton = document.getElementById('fogMapLayerButton');
      if (fogMapLayerButton) {
        fogMapLayerButton.addEventListener('click', () => {
          toggleSeaFogMapLayer();
        });
      }

      // ã‚¢ãƒ©ãƒ¼ãƒˆãƒœã‚¿ãƒ³
      const fogAlertsButton = document.getElementById('fogAlertsButton');
      if (fogAlertsButton) {
        fogAlertsButton.addEventListener('click', () => {
          showSeaFogAlerts();
        });
      }

      // è¦³æ¸¬è¨˜éŒ²ãƒœã‚¿ãƒ³
      const fogObservationButton = document.getElementById('fogObservationButton');
      if (fogObservationButton) {
        fogObservationButton.addEventListener('click', () => {
          showSeaFogObservation();
        });
      }
    });

    function loadSeaFogDashboard() {
      if (!selectedSpot) {
        alert('å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/dashboard?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          displaySeaFogDashboard(data);
        })
        .catch(err => {
          console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function displaySeaFogDashboard(data) {
      const seaFogDetails = document.getElementById('seaFogDetails');
      const timeline = data.timeline_data || [];
      const riskDistribution = data.risk_distribution || {};
      
      let html = '<div><strong>ğŸ“Š æµ·éœ§äºˆæ¸¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong></div>';
      
      // ãƒªã‚¹ã‚¯åˆ†å¸ƒ
      html += '<div style="margin: 10px 0;"><strong>ãƒªã‚¹ã‚¯åˆ†å¸ƒ (24æ™‚é–“):</strong></div>';
      html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 11px;">';
      Object.entries(riskDistribution).forEach(([level, count]) => {
        html += `<div>â€¢ ${level}: ${count}æ™‚é–“</div>`;
      });
      html += '</div>';
      
      // ä½œæ¥­æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿
      const workHours = data.work_hours_data || [];
      if (workHours.length > 0) {
        html += '<div style="margin: 10px 0;"><strong>ä½œæ¥­æ™‚é–“å¸¯ (4-16æ™‚):</strong></div>';
        html += '<div style="max-height: 150px; overflow-y: auto; font-size: 11px;">';
        workHours.forEach(hour => {
          const riskColor = hour.probability >= 0.6 ? '#dc3545' : 
                           hour.probability >= 0.3 ? '#ffc107' : '#28a745';
          html += `<div style="margin: 2px 0;">
            ${hour.hour}æ™‚: <span style="color: ${riskColor}">${(hour.probability * 100).toFixed(1)}%</span>
          </div>`;
        });
        html += '</div>';
      }
      
      seaFogDetails.innerHTML = html;
    }

    function generateSeaFogTimeline() {
      if (!selectedSpot) {
        alert('å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/predict?lat=${selectedSpot.lat}&lon=${selectedSpot.lon}&hours=24`)
        .then(res => res.json())
        .then(predictionData => {
          if (predictionData.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${predictionData.error}</div>`;
            return;
          }
          
          return fetch(`${API_BASE}/sea_fog/charts/timeline`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prediction_data: predictionData })
          });
        })
        .then(res => res.json())
        .then(chartResult => {
          if (chartResult.status === 'success') {
            seaFogDetails.innerHTML = `
              <div><strong>ğŸ“ˆ æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆå®Œäº†</strong></div>
              <div style="margin: 10px 0;">
                <a href="${API_BASE}/sea_fog/charts/${chartResult.chart_path.split('/').pop()}" target="_blank" class="btn btn-secondary">
                  ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
                </a>
              </div>
              <div style="font-size: 11px; color: #6c757d;">
                ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ: ${chartResult.data_points}å€‹
              </div>
            `;
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${chartResult.error}</div>`;
          }
        })
        .catch(err => {
          console.error('ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ãƒãƒ£ãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function generateSeaFogHeatmap() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—ã‚’ç”Ÿæˆä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/spots?hours=12`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          return fetch(`${API_BASE}/sea_fog/charts/heatmap`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ spot_predictions: data.spot_predictions })
          });
        })
        .then(res => res.json())
        .then(chartResult => {
          if (chartResult.status === 'success') {
            seaFogDetails.innerHTML = `
              <div><strong>ğŸ—ºï¸ ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—ç”Ÿæˆå®Œäº†</strong></div>
              <div style="margin: 10px 0;">
                <a href="${API_BASE}/sea_fog/charts/${chartResult.chart_path.split('/').pop()}" target="_blank" class="btn btn-secondary">
                  ğŸ—ºï¸ ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
                </a>
              </div>
              <div style="font-size: 11px; color: #6c757d;">
                åˆ†æåœ°ç‚¹: ${chartResult.spots_analyzed}ç®‡æ‰€
              </div>
            `;
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">ãƒãƒƒãƒ—ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${chartResult.error}</div>`;
          }
        })
        .catch(err => {
          console.error('ãƒãƒƒãƒ—ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ãƒªã‚¹ã‚¯ãƒãƒƒãƒ—ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    // æµ·éœ§åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½
    function toggleSeaFogMapLayer() {
      const button = document.getElementById('fogMapLayerButton');
      
      if (seaFogLayer && map.hasLayer(seaFogLayer)) {
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
        map.removeLayer(seaFogLayer);
        if (seaFogLayerControl) {
          map.removeControl(seaFogLayerControl);
          seaFogLayerControl = null;
        }
        seaFogLayer = null;
        button.textContent = 'ğŸ—ºï¸ åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        button.style.backgroundColor = '';
      } else {
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
        loadSeaFogMapLayer();
      }
    }

    function loadSeaFogMapLayer() {
      const button = document.getElementById('fogMapLayerButton');
      button.textContent = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
      button.disabled = true;
      
      // åˆ©å°»å³¶å‘¨è¾ºã®ä¸»è¦åœ°ç‚¹ã®æµ·éœ§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const keyPoints = [
        { name: 'é´›æ³Šæ¸¯', lat: 45.242, lon: 141.231 },
        { name: 'ä»™æ³•å¿—æ¸¯', lat: 45.136, lon: 141.211 },
        { name: 'æ²“å½¢', lat: 45.210, lon: 141.200 },
        { name: 'é¬¼è„‡', lat: 45.180, lon: 141.270 },
        { name: 'åˆ©å°»å±±éº“', lat: 45.178, lon: 141.228 }
      ];
      
      Promise.all(
        keyPoints.map(point => 
          fetch(`${API_BASE}/sea_fog/dashboard?lat=${point.lat}&lon=${point.lon}&hours=12`)
            .then(res => res.json())
            .then(data => ({ ...point, fogData: data }))
            .catch(err => ({ ...point, fogData: { error: err.message } }))
        )
      )
      .then(results => {
        createSeaFogOverlay(results);
        button.textContent = 'ğŸŒ«ï¸ ãƒ¬ã‚¤ãƒ¤ãƒ¼ON';
        button.style.backgroundColor = '#007bff';
        button.style.color = 'white';
        button.disabled = false;
      })
      .catch(err => {
        console.error('æµ·éœ§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        alert('æµ·éœ§ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        button.textContent = 'ğŸ—ºï¸ åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        button.disabled = false;
      });
    }

    function createSeaFogOverlay(fogPoints) {
      seaFogLayer = L.layerGroup();
      
      fogPoints.forEach(point => {
        if (point.fogData && !point.fogData.error) {
          const summary = point.fogData.summary || {};
          const maxRisk = summary.max_probability || 0;
          const workRisk = summary.work_hours_average || 0;
          
          // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²ã¨ã‚µã‚¤ã‚º
          let color, opacity, radius;
          if (maxRisk >= 0.8) {
            color = '#dc3545'; // èµ¤
            opacity = 0.8;
            radius = 2000;
          } else if (maxRisk >= 0.6) {
            color = '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸
            opacity = 0.7;
            radius = 1500;
          } else if (maxRisk >= 0.3) {
            color = '#ffc107'; // é»„
            opacity = 0.6;
            radius = 1000;
          } else {
            color = '#28a745'; // ç·‘
            opacity = 0.4;
            radius = 800;
          }
          
          // å††å½¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
          const circle = L.circle([point.lat, point.lon], {
            color: color,
            fillColor: color,
            fillOpacity: opacity * 0.3,
            opacity: opacity,
            radius: radius,
            weight: 2
          });
          
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æƒ…å ±
          const popupContent = `
            <div style="font-size: 12px;">
              <strong>ğŸŒ«ï¸ ${point.name} æµ·éœ§äºˆæ¸¬</strong><br>
              <strong>æœ€å¤§ç¢ºç‡:</strong> <span style="color: ${color}">${(maxRisk * 100).toFixed(1)}%</span><br>
              <strong>ä½œæ¥­æ™‚é–“å¹³å‡:</strong> ${(workRisk * 100).toFixed(1)}%<br>
              <strong>æ¨å¥¨:</strong> ${summary.work_recommendation || 'ä¸æ˜'}<br>
              <strong>å‚¾å‘:</strong> ${summary.trend || 'ä¸æ˜'}
            </div>
          `;
          
          circle.bindPopup(popupContent);
          
          // ä¸­å¿ƒã«ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®
          const fogIcon = L.divIcon({
            html: `<div style="
              background: ${color};
              border: 2px solid white;
              border-radius: 50%;
              width: 16px;
              height: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 10px;
              font-weight: bold;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">${Math.round(maxRisk * 100)}</div>`,
            iconSize: [16, 16],
            className: 'fog-risk-marker'
          });
          
          const marker = L.marker([point.lat, point.lon], { icon: fogIcon });
          marker.bindPopup(popupContent);
          
          seaFogLayer.addLayer(circle);
          seaFogLayer.addLayer(marker);
        }
      });
      
      // åœ°å›³ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
      seaFogLayer.addTo(map);
      
      // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
      createSeaFogLayerControl();
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      seaFogDataCache = fogPoints;
    }

    function createSeaFogLayerControl() {
      seaFogLayerControl = L.control({ position: 'topright' });
      
      seaFogLayerControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'sea-fog-control');
        div.style.cssText = `
          background: white;
          padding: 8px;
          border-radius: 4px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          font-size: 11px;
          min-width: 140px;
        `;
        
        div.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 4px;">ğŸŒ«ï¸ æµ·éœ§ãƒªã‚¹ã‚¯</div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 4px;"></div>
            <span>å±é™º (80%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%; margin-right: 4px;"></div>
            <span>è­¦æˆ’ (60%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 50%; margin-right: 4px;"></div>
            <span>æ³¨æ„ (30%+)</span>
          </div>
          <div style="display: flex; align-items: center; margin: 2px 0;">
            <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 4px;"></div>
            <span>æ­£å¸¸ (30%æœªæº€)</span>
          </div>
          <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #ddd; font-size: 10px; color: #666;">
            æ›´æ–°: ${new Date().toLocaleTimeString()}
          </div>
          <button onclick="refreshSeaFogLayer()" style="
            width: 100%;
            margin-top: 4px;
            padding: 2px 4px;
            font-size: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
          ">ğŸ”„ æ›´æ–°</button>
        `;
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
        L.DomEvent.disableClickPropagation(div);
        
        return div;
      };
      
      seaFogLayerControl.addTo(map);
    }

    function refreshSeaFogLayer() {
      if (seaFogLayer) {
        map.removeLayer(seaFogLayer);
        if (seaFogLayerControl) {
          map.removeControl(seaFogLayerControl);
          seaFogLayerControl = null;
        }
        seaFogLayer = null;
      }
      loadSeaFogMapLayer();
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦è¿½åŠ 
    window.refreshSeaFogLayer = refreshSeaFogLayer;

    // æµ·éœ§ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ é–¢æ•°
    function showSeaFogAlerts() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      loadAlertSystemStatus();
    }

    function loadAlertSystemStatus() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      
      fetch(`${API_BASE}/sea_fog/alerts/status`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          displayAlertSystemStatus(data);
        })
        .catch(err => {
          console.error('ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function displayAlertSystemStatus(status) {
      const seaFogDetails = document.getElementById('seaFogDetails');
      
      const monitoringStatus = status.monitoring_active ? 'ğŸŸ¢ ç¨¼åƒä¸­' : 'ğŸ”´ åœæ­¢ä¸­';
      const lastCheck = status.last_check ? new Date(status.last_check).toLocaleString() : 'æœªå®Ÿè¡Œ';
      
      let html = `
        <div><strong>ğŸš¨ æµ·éœ§ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ </strong></div>
        <div style="margin: 10px 0;">
          <div><strong>ç›£è¦–çŠ¶æ³:</strong> ${monitoringStatus}</div>
          <div><strong>æœ€çµ‚ãƒã‚§ãƒƒã‚¯:</strong> ${lastCheck}</div>
          <div><strong>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆ:</strong> ${status.active_alerts_count}ä»¶</div>
          <div><strong>è³¼èª­è€…:</strong> ${status.subscribers_count}å</div>
          <div><strong>ç›£è¦–ã‚¾ãƒ¼ãƒ³:</strong> ${status.zones_monitored}ç®‡æ‰€</div>
          <div><strong>ãƒã‚§ãƒƒã‚¯é–“éš”:</strong> ${status.check_interval}åˆ†</div>
        </div>
        
        <div style="margin: 15px 0;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
            <button onclick="toggleAlertMonitoring()" class="btn" style="font-size: 11px; padding: 5px;">
              ${status.monitoring_active ? 'â¹ï¸ ç›£è¦–åœæ­¢' : 'â–¶ï¸ ç›£è¦–é–‹å§‹'}
            </button>
            <button onclick="runManualAlertCheck()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              ğŸ” æ‰‹å‹•ãƒã‚§ãƒƒã‚¯
            </button>
            <button onclick="showActiveAlerts()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              ğŸš¨ ç¾åœ¨ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
            </button>
            <button onclick="showAlertHistory()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              ğŸ“‹ å±¥æ­´
            </button>
            <button onclick="showAlertSubscribers()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              ğŸ‘¥ è³¼èª­è€…ç®¡ç†
            </button>
            <button onclick="testAlertSystem()" class="btn btn-secondary" style="font-size: 11px; padding: 5px;">
              ğŸ§ª ãƒ†ã‚¹ãƒˆ
            </button>
          </div>
        </div>
      `;
      
      seaFogDetails.innerHTML = html;
    }

    function toggleAlertMonitoring() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ç›£è¦–çŠ¶æ…‹ã‚’å¤‰æ›´ä¸­...</div>';
      
      // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã¦åˆ‡ã‚Šæ›¿ãˆ
      fetch(`${API_BASE}/sea_fog/alerts/monitoring`)
        .then(res => res.json())
        .then(status => {
          const method = status.monitoring_active ? 'DELETE' : 'POST';
          
          return fetch(`${API_BASE}/sea_fog/alerts/monitoring`, { method: method });
        })
        .then(res => res.json())
        .then(result => {
          if (result.status) {
            seaFogDetails.innerHTML = `<div style="color: green;">âœ“ ${result.message}</div>`;
            setTimeout(loadAlertSystemStatus, 2000);
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">âœ— ${result.error || 'æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ'}</div>`;
          }
        })
        .catch(err => {
          console.error('ç›£è¦–çŠ¶æ…‹å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ç›£è¦–çŠ¶æ…‹ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function runManualAlertCheck() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/check`, { method: 'POST' })
        .then(res => res.json())
        .then(result => {
          if (result.status === 'completed') {
            let html = `
              <div style="color: green;"><strong>âœ“ ãƒã‚§ãƒƒã‚¯å®Œäº†</strong></div>
              <div style="margin: 10px 0;">
                <div><strong>ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‚¾ãƒ¼ãƒ³:</strong> ${result.zones_checked}ç®‡æ‰€</div>
                <div><strong>ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒˆ:</strong> ${result.alerts_generated}ä»¶</div>
                <div><strong>ãƒã‚§ãƒƒã‚¯æ™‚åˆ»:</strong> ${new Date(result.check_time).toLocaleString()}</div>
              </div>
            `;
            
            if (result.alerts && result.alerts.length > 0) {
              html += '<div><strong>ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒˆ:</strong></div>';
              result.alerts.forEach(alert => {
                html += `<div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                  <strong>${alert.zone}</strong>: ${alert.summary.message}
                </div>`;
              });
            }
            
            seaFogDetails.innerHTML = html;
            setTimeout(loadAlertSystemStatus, 3000);
          } else {
            seaFogDetails.innerHTML = `<div style="color: red;">âœ— ${result.error || 'ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ'}</div>`;
          }
        })
        .catch(err => {
          console.error('æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function showActiveAlerts() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/active`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          let html = `<div><strong>ğŸš¨ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆ (${data.count}ä»¶)</strong></div>`;
          
          if (data.count === 0) {
            html += '<div style="color: green; margin: 10px 0;">ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            data.alerts.forEach(alert => {
              const alertTime = new Date(alert.timestamp).toLocaleString();
              const riskLevel = alert.alert_level === 'danger' ? 'ğŸ”´' : 
                              alert.alert_level === 'watch' ? 'ğŸŸ ' : 'ğŸŸ¡';
              
              html += `
                <div style="margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 11px;">
                  <div><strong>${riskLevel} ${alert.zone}</strong></div>
                  <div>${alert.summary.message}</div>
                  <div style="color: #666; margin-top: 3px;">
                    ${alertTime} | æœ€å¤§ãƒªã‚¹ã‚¯: ${(alert.risk_assessment.max_probability * 100).toFixed(1)}%
                  </div>
                  <div style="margin-top: 5px;">
                    <strong>æ¨å¥¨äº‹é …:</strong><br>
                    ${alert.recommendations.slice(0, 2).join('<br>')}
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">æˆ»ã‚‹</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function showAlertHistory() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/history?days=7`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          let html = `<div><strong>ğŸ“‹ ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ (${data.period_days}æ—¥é–“ãƒ»${data.count}ä»¶)</strong></div>`;
          
          if (data.count === 0) {
            html += '<div style="color: gray; margin: 10px 0;">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            data.alerts.reverse().forEach(alert => {
              const alertTime = new Date(alert.timestamp).toLocaleString();
              const riskLevel = alert.alert_level === 'danger' ? 'ğŸ”´' : 
                              alert.alert_level === 'watch' ? 'ğŸŸ ' : 'ğŸŸ¡';
              
              html += `
                <div style="margin: 3px 0; padding: 5px; border-bottom: 1px solid #eee; font-size: 10px;">
                  <strong>${riskLevel} ${alert.zone}</strong> - ${alertTime}<br>
                  ${alert.summary.message} (${(alert.risk_assessment.max_probability * 100).toFixed(1)}%)
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">æˆ»ã‚‹</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function showAlertSubscribers() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">è³¼èª­è€…æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            seaFogDetails.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
            return;
          }
          
          let html = `
            <div><strong>ğŸ‘¥ ã‚¢ãƒ©ãƒ¼ãƒˆè³¼èª­è€…ç®¡ç† (${data.count}å)</strong></div>
            <div style="margin: 10px 0;">
              <input type="text" id="newSubscriberName" placeholder="åå‰" style="padding: 3px; font-size: 11px; margin-right: 5px;">
              <button onclick="addAlertSubscriber()" class="btn" style="font-size: 10px; padding: 3px 6px;">è¿½åŠ </button>
            </div>
          `;
          
          if (data.count === 0) {
            html += '<div style="color: gray; margin: 10px 0;">è³¼èª­è€…ãŒã„ã¾ã›ã‚“</div>';
          } else {
            html += '<div style="max-height: 200px; overflow-y: auto; margin: 10px 0;">';
            data.subscribers.forEach(subscriber => {
              const activeStatus = subscriber.alert_preferences?.active ? 'ğŸŸ¢' : 'ğŸ”´';
              const minLevel = subscriber.alert_preferences?.minimum_level || 'warning';
              
              html += `
                <div style="margin: 3px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${activeStatus} ${subscriber.name} (${minLevel})</span>
                    <button onclick="removeAlertSubscriber(${subscriber.id})" class="btn btn-danger" style="font-size: 9px; padding: 2px 4px;">å‰Šé™¤</button>
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '<button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">æˆ»ã‚‹</button>';
          seaFogDetails.innerHTML = html;
        })
        .catch(err => {
          console.error('è³¼èª­è€…å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          seaFogDetails.innerHTML = '<div style="color: red;">è³¼èª­è€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }

    function addAlertSubscriber() {
      const name = document.getElementById('newSubscriberName').value.trim();
      if (!name) {
        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const subscriberData = {
        name: name,
        contact_info: { type: 'manual' },
        alert_preferences: {
          minimum_level: 'warning',
          zones: ['oshidomari', 'senposhi'],
          notification_methods: ['console', 'file'],
          active: true
        }
      };
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(subscriberData)
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          alert('è³¼èª­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
          showAlertSubscribers();
        } else {
          alert(result.error || 'è³¼èª­è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(err => {
        console.error('è³¼èª­è€…è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
        alert('è³¼èª­è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function removeAlertSubscriber(subscriberId) {
      if (!confirm('ã“ã®è³¼èª­è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      fetch(`${API_BASE}/sea_fog/alerts/subscribers`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriber_id: subscriberId })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          alert('è³¼èª­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          showAlertSubscribers();
        } else {
          alert(result.error || 'è³¼èª­è€…ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(err => {
        console.error('è³¼èª­è€…å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
        alert('è³¼èª­è€…ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    function testAlertSystem() {
      const seaFogDetails = document.getElementById('seaFogDetails');
      seaFogDetails.innerHTML = '<div class="loading">ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</div>';
      
      fetch(`${API_BASE}/sea_fog/alerts/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zone: 'oshidomari' })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success') {
          seaFogDetails.innerHTML = `
            <div style="color: green;"><strong>âœ“ ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆå®Œäº†</strong></div>
            <div style="margin: 10px 0;">
              <div><strong>ã‚¢ãƒ©ãƒ¼ãƒˆID:</strong> ${result.alert.id}</div>
              <div><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${result.alert.summary.message}</div>
              <div><strong>ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«:</strong> ${result.alert.alert_level}</div>
            </div>
            <button onclick="loadAlertSystemStatus()" class="btn" style="margin-top: 10px; font-size: 11px;">æˆ»ã‚‹</button>
          `;
        } else {
          seaFogDetails.innerHTML = `<div style="color: red;">âœ— ${result.error || 'ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'}</div>`;
        }
      })
      .catch(err => {
        console.error('ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', err);
        seaFogDetails.innerHTML = '<div style="color: red;">ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦è¿½åŠ 
    window.toggleAlertMonitoring = toggleAlertMonitoring;
    window.runManualAlertCheck = runManualAlertCheck;
    window.showActiveAlerts = showActiveAlerts;
    window.showAlertHistory = showAlertHistory;
    window.showAlertSubscribers = showAlertSubscribers;
    window.addAlertSubscriber = addAlertSubscriber;
    window.removeAlertSubscriber = removeAlertSubscriber;
    window.testAlertSystem = testAlertSystem;
    window.loadAlertSystemStatus = loadAlertSystemStatus;

    function submitFogObservation() {
      if (!selectedSpot) return;
      
      const datetime = document.getElementById('fogObsDateTime').value;
      const fogRadios = document.getElementsByName('fogObserved');
      let fogObserved = null;
      
      for (let radio of fogRadios) {
        if (radio.checked) {
          fogObserved = radio.value === 'true';
          break;
        }
      }
      
      if (!datetime) {
        alert('è¦³æ¸¬æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (fogObserved === null) {
        alert('æµ·éœ§ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const observationData = {
        lat: selectedSpot.lat,
        lon: selectedSpot.lon,
        datetime: datetime,
        fog_observed: fogObserved,
        conditions: {
          spot_name: selectedSpot.name,
          observer: 'manual_entry'
        }
      };
      
      fetch(`${API_BASE}/sea_fog/observation`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(observationData)
      })
      .then(res => res.json())
      .then(data => {
        const result = document.getElementById('fogObsResult');
        if (data.status === 'success') {
          result.innerHTML = '<div style="color: green;">âœ“ è¦³æ¸¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>';
          document.getElementById('fogObsDateTime').value = '';
          document.getElementsByName('fogObserved').forEach(r => r.checked = false);
        } else {
          result.innerHTML = `<div style="color: red;">âœ— ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message}</div>`;
        }
      })
      .catch(err => {
        console.error('è¦³æ¸¬è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', err);
        document.getElementById('fogObsResult').innerHTML = '<div style="color: red;">âœ— ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      });
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ç°¡ç´ åŒ–
    function initializeOfflineHandlers() {
        // Handle online/offline status
        window.addEventListener('online', () => {
          updateOfflineStatus(true);
          console.log('Connection restored');
        });
        
        window.addEventListener('offline', () => {
          updateOfflineStatus(false);
          console.log('Connection lost');
        });
    }

    // Offline status indicator functions
    function showOfflineStatusIndicator() {
      // Create offline status indicator
      const indicator = document.createElement('div');
      indicator.id = 'offline-indicator';
      indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        z-index: 10000;
        transition: all 0.3s ease;
        display: none;
      `;
      document.body.appendChild(indicator);
      
      // Update initial status
      updateOfflineStatus(navigator.onLine);
    }

    function updateOfflineStatus(isOnline) {
      const indicator = document.getElementById('offline-indicator');
      if (!indicator) return;
      
      if (isOnline) {
        indicator.style.display = 'none';
      } else {
        indicator.style.display = 'block';
        indicator.style.background = 'rgba(244, 67, 54, 0.9)';
        indicator.style.color = 'white';
        indicator.innerHTML = 'ğŸ”´ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        
        // Show cached data status
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.ready.then(registration => {
            caches.open('rishiri-kelp-weather-v1').then(cache => {
              cache.keys().then(keys => {
                if (keys.length > 0) {
                  indicator.innerHTML = 'ğŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨å¯èƒ½)';
                  indicator.style.background = 'rgba(255, 193, 7, 0.9)';
                }
              });
            });
          });
        }
      }
    }
  </script>
</body>
</html>