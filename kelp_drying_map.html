<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>利尻島昆布干場マップ - 7日間予報システム</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js for forecast charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 干場データの読み込み -->
    <script src="all_spots_array.js?v=20251010"></script>

    <!-- 利尻島伝統風名システム (インライン読み込み) -->
    <script>
    // 利尻島16方位伝統風名データベース
    const RISHIRI_WIND_NAMES = [
        { meteoDirection: 0,     kanbaTheta: 177.2, name: "アイ",         reading: "ai",            cardinal: "北",   cardinal16: "N" },
        { meteoDirection: 22.5,  kanbaTheta: 154.7, name: "アイシモ",     reading: "aishimo",       cardinal: "北北東", cardinal16: "NNE" },
        { meteoDirection: 45,    kanbaTheta: 132.2, name: "シモ",         reading: "shimo",         cardinal: "北東",  cardinal16: "NE" },
        { meteoDirection: 67.5,  kanbaTheta: 109.7, name: "シモヤマセ",   reading: "shimoyamase",   cardinal: "東北東", cardinal16: "ENE" },
        { meteoDirection: 90,    kanbaTheta: 87.2,  name: "ホンヤマセ",   reading: "honyamase",     cardinal: "東",   cardinal16: "E" },
        { meteoDirection: 112.5, kanbaTheta: 64.7,  name: "ヤマセ",       reading: "yamase",        cardinal: "東南東", cardinal16: "ESE" },
        { meteoDirection: 135,   kanbaTheta: 42.2,  name: "ミナミヤマセ", reading: "minamiyamase",  cardinal: "南東",  cardinal16: "SE" },
        { meteoDirection: 157.5, kanbaTheta: 19.7,  name: "ミナミヤマ",   reading: "minamiyama",    cardinal: "南南東", cardinal16: "SSE" },
        { meteoDirection: 180,   kanbaTheta: 357.2, name: "クダリ",       reading: "kudari",        cardinal: "南",   cardinal16: "S" },
        { meteoDirection: 202.5, kanbaTheta: 334.7, name: "クダリヒカタ", reading: "kudarihikata",  cardinal: "南南西", cardinal16: "SSW" },
        { meteoDirection: 225,   kanbaTheta: 312.2, name: "ヒカタ",       reading: "hikata",        cardinal: "南西",  cardinal16: "SW" },
        { meteoDirection: 247.5, kanbaTheta: 289.7, name: "ニシヒカタ",   reading: "nishihikata",   cardinal: "西南西", cardinal16: "WSW" },
        { meteoDirection: 270,   kanbaTheta: 267.2, name: "ニシ",         reading: "nishi",         cardinal: "西",   cardinal16: "W" },
        { meteoDirection: 292.5, kanbaTheta: 244.7, name: "ニシタマ",     reading: "nishitama",     cardinal: "西北西", cardinal16: "WNW" },
        { meteoDirection: 315,   kanbaTheta: 222.2, name: "タマ",         reading: "tama",          cardinal: "北西",  cardinal16: "NW" },
        { meteoDirection: 337.5, kanbaTheta: 199.7, name: "アイタマ",     reading: "aitama",        cardinal: "北北西", cardinal16: "NNW" }
    ];

    function getRishiriWindName(meteorologicalDirection) {
        if (meteorologicalDirection === null || meteorologicalDirection === undefined) {
            return "--";
        }
        const normalizedDir = ((meteorologicalDirection % 360) + 360) % 360;
        let minDiff = 360;
        let closestWind = RISHIRI_WIND_NAMES[0];
        for (const wind of RISHIRI_WIND_NAMES) {
            let diff = Math.abs(normalizedDir - wind.meteoDirection);
            diff = Math.min(diff, 360 - diff);
            if (diff < minDiff) {
                minDiff = diff;
                closestWind = wind;
            }
        }
        return closestWind.name;
    }

    function meteorologicalToKanbaTheta(meteorologicalDirection) {
        if (meteorologicalDirection === null || meteorologicalDirection === undefined) {
            return null;
        }
        let kanbaTheta = 177.2 - meteorologicalDirection;
        if (kanbaTheta < 0) {
            kanbaTheta += 360;
        }
        return kanbaTheta;
    }

    function getRishiriWindDetails(meteorologicalDirection) {
        if (meteorologicalDirection === null || meteorologicalDirection === undefined) {
            return {
                name: "--",
                reading: "--",
                cardinal: "--",
                cardinal16: "--",
                kanbaTheta: null
            };
        }
        const normalizedDir = ((meteorologicalDirection % 360) + 360) % 360;
        let minDiff = 360;
        let closestWind = RISHIRI_WIND_NAMES[0];
        for (const wind of RISHIRI_WIND_NAMES) {
            let diff = Math.abs(normalizedDir - wind.meteoDirection);
            diff = Math.min(diff, 360 - diff);
            if (diff < minDiff) {
                minDiff = diff;
                closestWind = wind;
            }
        }
        return {
            name: closestWind.name,
            reading: closestWind.reading,
            cardinal: closestWind.cardinal,
            cardinal16: closestWind.cardinal16,
            kanbaTheta: meteorologicalToKanbaTheta(meteorologicalDirection)
        };
    }

    function getWindArrow(direction) {
        const arrows = ['↓', '↙', '←', '↖', '↑', '↗', '→', '↘'];
        const index = Math.round(direction / 45) % 8;
        return arrows[index];
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
            background: white;
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .forecast-panel {
            width: 420px;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
            display: none;
            max-height: 80vh;
        }

        .forecast-panel.active {
            display: block;
        }

        .forecast-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .forecast-tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .forecast-tab {
            padding: 8px 12px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-size: 0.85rem;
            border-radius: 5px 5px 0 0;
            margin-right: 2px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .forecast-tab.active {
            background: white;
            border-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .forecast-tab:hover {
            background: #f8f9fa;
        }

        .forecast-content {
            display: none;
        }

        .forecast-content.active {
            display: block;
        }

        .reliability-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .reliability-high { background: #d4edda; color: #155724; }
        .reliability-medium { background: #fff3cd; color: #856404; }
        .reliability-low { background: #f8d7da; color: #721c24; }

        .hourly-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        /* 一般/専門家向けタブ */
        .view-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .view-mode-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }

        .view-mode-tab:hover {
            color: #667eea;
        }

        .view-mode-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* 時間別予報テーブル */
        .hourly-table-container {
            overflow-x: auto;
            margin-top: 10px;
        }

        .hourly-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .hourly-table th {
            background: #667eea;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .hourly-table td {
            padding: 8px 5px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .hourly-table tr:hover {
            background: #f8f9fa;
        }

        .hourly-table .time-cell {
            font-weight: bold;
            color: #667eea;
            background: #f0f4ff;
        }

        .hourly-table .expert-row {
            display: none;
        }

        .hourly-table .general-row {
            display: table-row;
        }

        .hourly-table.show-expert .expert-row {
            display: table-row;
        }

        .hourly-table.show-expert .general-row {
            display: none;
        }

        /* 旧スタイル（後方互換性のため残す） */
        .hourly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .hourly-item {
            text-align: center;
            padding: 8px 4px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .hourly-time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .forecast-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .forecast-date {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .forecast-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .suitability {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }

        .excellent { background: #d4edda; color: #155724; }
        .good { background: #cce7ff; color: #004085; }
        .fair { background: #fff3cd; color: #856404; }
        .poor { background: #f8d7da; color: #721c24; }

        .instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .chart-container {
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom marker styles */
        .custom-div-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .selected-marker {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f) !important;
            transform: scale(1.3);
        }

        .favorite-controls {
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .spot-management-controls {
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .management-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        .management-btn.add {
            background: #28a745;
            color: white;
        }

        .management-btn.add:hover {
            background: #218838;
        }

        .management-btn.delete {
            background: #dc3545;
            color: white;
        }

        .management-btn.delete:hover {
            background: #c82333;
        }

        .instructions {
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .record-form {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            max-width: 350px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .record-form h4 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .record-form input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .record-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }

        .record-btn {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .record-btn.success {
            background: #28a745;
            color: white;
        }

        .record-btn.warning {
            background: #ffc107;
            color: black;
        }

        .record-btn.danger {
            background: #dc3545;
            color: white;
        }

        .record-btn:hover {
            opacity: 0.8;
        }

        .existing-record {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #6c757d;
        }

        .filter-controls {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section h4 {
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1rem;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #adb5bd;
        }

        .filter-stats {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #495057;
        }

        .favorite-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9rem;
        }

        .favorite-btn:hover {
            background: #218838;
        }

        .favorite-btn.remove {
            background: #dc3545;
        }

        .favorite-btn.remove:hover {
            background: #c82333;
        }

        .favorites-list {
            background: white;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .favorite-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-item:hover {
            background: #f8f9fa;
        }

        .favorite-marker {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }

        .feedback-section {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .feedback-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .feedback-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
            min-width: 45px;
        }

        .feedback-btn.excellent { background: #d4edda; color: #155724; }
        .feedback-btn.good { background: #cce7ff; color: #004085; }
        .feedback-btn.fair { background: #fff3cd; color: #856404; }
        .feedback-btn.poor { background: #f8d7da; color: #721c24; }

        .feedback-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .feedback-submitted {
            background: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed;
        }

        .expert-only {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌊 利尻島昆布干場予報システム</h1>
        <p>干場を選択して7日間の乾燥適性予報を確認できます</p>
        <div id="connectionStatus" style="margin-top: 10px; padding: 8px 15px; border-radius: 20px; display: inline-block; font-size: 0.9rem; font-weight: 500;">
            <span id="statusIcon">🌐</span> <span id="statusText">オンライン</span>
        </div>
    </div>

    <div class="instructions">
        <strong>使い方:</strong> 地図上の🔵マーカーをクリックすると、その干場の詳細な7日間予報が右側に表示されます
    </div>

    <div class="favorite-controls">
        <h4>🌟 お気に入り干場管理</h4>
        <button id="showFavoritesBtn" class="favorite-btn">お気に入り一覧</button>
        <button id="clearFavoritesBtn" class="favorite-btn remove">全て削除</button>

        <div id="favoritesList" class="favorites-list" style="display: none;">
            <div id="favoritesContent"></div>
        </div>
    </div>

    <div class="notification-controls" style="background: white; padding: 20px; margin: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h4>🔔 通知設定</h4>
        <div style="margin: 15px 0;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="notificationEnabled" onchange="toggleNotifications()" style="margin-right: 10px; width: 20px; height: 20px;">
                <span>午後4時に予報通知を受け取る</span>
            </label>
        </div>

        <div id="notificationSettings" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                お気に入り干場の明日の予報を毎日午後4時に通知します
            </p>

            <div style="margin: 15px 0;">
                <h5 style="font-size: 0.95rem; margin-bottom: 10px;">通知対象干場</h5>
                <div id="notificationSpotsList" style="font-size: 0.85rem; color: #555;">
                    お気に入りに干場を追加してください
                </div>
            </div>

            <div style="margin: 15px 0;">
                <h5 style="font-size: 0.95rem; margin-bottom: 10px;">🚢 沖止め日設定</h5>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">昆布漁が休みの日を設定すると、その前日は通知されません</p>
                <input type="date" id="offDayDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                <button onclick="addOffDay()" style="margin-top: 8px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                    沖止め日を追加
                </button>
                <div id="offDaysList" style="margin-top: 10px; font-size: 0.85rem;">
                </div>
            </div>

            <div style="margin: 15px 0;">
                <h5 style="font-size: 0.95rem; margin-bottom: 10px;">📅 漁期設定</h5>
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem; color: #666;">開始日:</label>
                    <input type="date" id="seasonStartDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 0.85rem; color: #666;">終了日:</label>
                    <input type="date" id="seasonEndDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; margin-top: 5px;">
                </div>
                <button onclick="saveSeasonDates()" style="margin-top: 8px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                    漁期を保存
                </button>
                <p style="font-size: 0.75rem; color: #999; margin-top: 8px;">※ 6月～9月が推奨です</p>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                <p style="font-size: 0.8rem; color: #856404; margin: 0;">
                    ⚠️ ブラウザの通知許可が必要です。初回は許可ダイアログが表示されます。
                </p>
            </div>
        </div>
    </div>

    <div class="spot-management-controls">
        <h4>📍 干場管理</h4>
        <button id="addSpotBtn" class="management-btn add" onclick="enableAddSpotMode()">➕ 新しい干場を追加</button>
        <p id="addSpotInstructions" class="instructions" style="display: none;">
            地図上をクリックして新しい干場を追加してください
        </p>
    </div>

<!-- サイドバーのタブナビゲーション -->
    <div class="sidebar-tabs" style="background: white; margin: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden;">
        <div class="sidebar-tab-header" style="display: flex; border-bottom: 2px solid #e9ecef;">
            <button class="sidebar-tab-btn active" onclick="switchSidebarTab('filter')" data-tab="filter" style="flex: 1; padding: 15px; background: white; border: none; border-bottom: 3px solid #667eea; cursor: pointer; font-weight: 600; color: #667eea; transition: all 0.3s;">
                📍 エリア絞込
            </button>
            <button class="sidebar-tab-btn" onclick="switchSidebarTab('contour')" data-tab="contour" style="flex: 1; padding: 15px; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #6c757d; transition: all 0.3s;">
                🌪️ 等値線解析
            </button>
        </div>

        <div class="sidebar-tab-content active" id="filterTabContent" style="padding: 20px;">
            <div class="filter-breadcrumb" id="filterBreadcrumb">
                <span class="breadcrumb-item" onclick="resetFilters()">全エリア</span>
            </div>

            <div class="filter-section">
                <h4>町を選択</h4>
                <select id="townSelect" class="filter-select" onchange="filterByTown()">
                    <option value="">-- 町を選択してください --</option>
                    <option value="利尻富士町">利尻富士町</option>
                    <option value="利尻町">利尻町</option>
                </select>
            </div>

            <div class="filter-section" id="districtSection" style="display: none;">
                <h4>地区を選択</h4>
                <select id="districtSelect" class="filter-select" onchange="filterByDistrict()">
                    <option value="">-- 地区を選択してください --</option>
                </select>
            </div>

            <div class="filter-section" id="burakuSection" style="display: none;">
                <h4>部落を選択</h4>
                <select id="burakuSelect" class="filter-select" onchange="filterByBuraku()">
                    <option value="">-- 部落を選択してください --</option>
                </select>
            </div>

            <div class="filter-stats" id="filterStats">
                表示中: 331箇所の干場
            </div>
        </div>

        <div class="sidebar-tab-content" id="contourTabContent" style="padding: 20px; display: none;">
            <h4 style="margin-bottom: 15px; color: #2c3e50;">🌪️ 島内全域気象解析</h4>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                利尻島全体の気象状況を等値線マップで概観できます
            </p>

            <div class="filter-section">
                <h4>解析カテゴリー</h4>
                <select id="contourCategory" class="filter-select" onchange="updateContourTimeOptions()">
                    <option value="">-- カテゴリーを選択 --</option>
                    <optgroup label="地上レベル（1時間刻み）">
                        <option value="temperature">🌡️ 等温線（気温分布）</option>
                        <option value="humidity">💧 等湿線（湿度分布）</option>
                        <option value="pressure">📊 等圧線（気圧分布）</option>
                        <option value="wind">💨 風向・風速場</option>
                        <option value="precipitation">🌧️ 降水量分布</option>
                    </optgroup>
                    <optgroup label="海域レベル（1時間刻み）">
                        <option value="wave_height">🌊 有義波高分布</option>
                        <option value="wave_direction_period">🌊 波向・波周期場</option>
                    </optgroup>
                    <optgroup label="高層レベル（3時間刻み）">
                        <option value="vorticity_500hpa">🌀 渦度場（500hPa）</option>
                        <option value="omega_700hpa">⬇️ 鉛直流（700hPa）</option>
                        <option value="theta_e_850hpa">🌡️ 相当温位（850hPa）</option>
                    </optgroup>
                    <optgroup label="超高層レベル（長期予測・3時間刻み）">
                        <option value="jet_stream_300hpa">✈️ ジェット気流（300hPa）</option>
                        <option value="height_anomaly_200hpa">📈 高度偏差（200hPa）</option>
                    </optgroup>
                </select>
            </div>

            <div class="filter-section">
                <h4>解析時刻（JST）</h4>
                <select id="contourTime" class="filter-select" onchange="updateContourDisplay()">
                    <!-- 動的に生成される -->
                </select>
            </div>

            <button onclick="loadContourAnalysis()" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; transition: all 0.3s;">
                🔍 解析図を表示
            </button>

            <div id="contourMapDisplay" style="margin-top: 20px; background: #f8f9fa; border-radius: 8px; padding: 15px; min-height: 200px; display: none;">
                <h5 style="margin-bottom: 10px; color: #667eea;">解析結果</h5>
                <div id="contourMapImage" style="text-align: center;">
                    <p style="color: #999;">解析図を読み込み中...</p>
                </div>
                <div id="contourMetadata" style="margin-top: 15px; font-size: 0.8rem; color: #666; border-top: 1px solid #ddd; padding-top: 10px;">
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="map"></div>

        <!-- 記録フォーム（非表示） -->
        <div id="recordFormContainer" class="record-form" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
            <h4>📝 乾燥記録の入力</h4>
            <div id="recordSpotInfo"></div>
            <label for="recordDate">日付を選択してください:</label>
            <input type="date" id="recordDate" />
            <div id="existingRecordInfo"></div>
            <div id="recordButtons" class="record-buttons">
                <button class="record-btn success" onclick="submitRecord('完全乾燥')">完全乾燥</button>
                <button class="record-btn warning" onclick="submitRecord('干したが完全には乾かせなかった（泣）')">干したが完全には乾かせなかった（泣）</button>
                <button class="record-btn danger" onclick="submitRecord('中止')">中止</button>
            </div>
            <button onclick="closeRecordForm()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">キャンセル</button>
        </div>

        <div class="forecast-panel" id="forecastPanel">
            <div class="forecast-header">
                <h3 id="selectedSpotName">干場を選択してください</h3>
                <p id="selectedSpotLocation"></p>
            </div>

            <div id="autoUpdateStatus" style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                <span id="updateStatusText">自動更新: 停止中</span>
                <span id="nextUpdateTime" style="display: block; margin-top: 3px;"></span>
            </div>

            <div class="forecast-tabs" id="forecastTabs" style="display: none;">
                <!-- Dynamic tabs will be inserted here -->
            </div>
            <!-- 簡易エマグラム表示セクション -->
            <div id="emagramSection" style="display: none; margin-bottom: 20px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-top: 0;">
                    📊 簡易エマグラム - 気温・露点温度鉛直プロファイル
                </h3>
                <p style="color: #666; font-size: 14px; margin: 10px 0;">
                    大気の鉛直構造を確認（大気安定度・逆転層・雲底高度の推定）<br>
                    <span style="font-size: 12px; color: #999;">※作業時間帯（6-18時）の3時間刻みデータ</span>
                </p>

                <!-- 時刻選択（作業時間帯6-18時、3時間刻み） -->
                <div style="margin: 15px 0;">
                    <label style="font-weight: bold; margin-right: 10px;">予報時刻（JST）:</label>
                    <select id="emagramTimeSelect" onchange="loadEmagramData()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <!-- JavaScriptで動的生成 -->
                    </select>
                </div>

                <!-- Canvas for chart -->
                <div style="position: relative; height: 500px; margin: 20px 0;">
                    <canvas id="emagramCanvas"></canvas>
                </div>

                <!-- 解説情報 -->
                <div id="emagramInfo" style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px; font-size: 0.9rem;">
                    <div style="margin-bottom: 8px;">
                        <strong>📌 読み方:</strong>
                    </div>
                    <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8;">
                        <li><span style="color: #dc3545; font-weight: bold;">赤線</span>: 気温（右に高温）</li>
                        <li><span style="color: #007bff; font-weight: bold;">青線</span>: 露点温度（気温に近いほど湿潤）</li>
                        <li><strong>気温と露点が接近</strong>: 湿度100%に近い（霧・雲発生層）</li>
                        <li><strong>気温が上に向かって上昇</strong>: 逆転層（霧・汚染物質の閉じ込め）</li>
                        <li><strong>気温と露点の差が大きい</strong>: 乾燥した空気（乾燥に有利）</li>
                    </ul>
                </div>
            </div>

            <!-- 等値線マップ表示セクション -->
            <div id="contourMapSection" style="display: none; margin-bottom: 20px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 10px; color: #2c3e50; font-size: 1.1rem;">気象解析マップ</h3>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="showContourMap('500hpa')" id="contour500Btn" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        500hPa 渦度
                    </button>
                    <button onclick="showContourMap('700hpa')" id="contour700Btn" style="flex: 1; padding: 8px; background: #e9ecef; color: #333; border: none; border-radius: 5px; cursor: pointer;">
                        700hPa 鉛直流
                    </button>
                </div>

                <div id="contourMapContainer" style="text-align: center;">
                    <img id="contourMapImage" src="" alt="等値線マップ" style="max-width: 100%; border-radius: 5px;">
                    <p id="contourMapCaption" style="margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;"></p>
                </div>

                <div id="calibrationInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #555;">
                    <strong>予報補正情報:</strong>
                    <div id="calibrationDetails"></div>
                </div>
            </div>

            <div id="forecastContent">
                <div class="loading">
                    <div class="spinner"></div>
                    予報データを取得中...
                </div>
                <!-- Dynamic daily forecast content will be inserted here -->
            </div>

            <div class="chart-container">
                <canvas id="forecastChart" width="350" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 利尻島の中心座標
        const RISHIRI_CENTER = [45.178269, 141.228528];

        // マップ初期化
        const map = L.map('map').setView(RISHIRI_CENTER, 12);

        // 航空写真タイル (Google Satellite)
        L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: '© Google',
            maxZoom: 20
        }).addTo(map);

        // 現在選択されているマーカー
        let selectedMarker = null;
        let selectedSpot = null;
        let forecastChart = null;

        // マーカー管理
        let allMarkers = [];
        let visibleMarkers = [];

        // フィルタリング状態
        let currentFilters = {
            town: '',
            district: '',
            buraku: ''
        };

        // お気に入り管理
        let favorites = JSON.parse(localStorage.getItem('hoshibaFavorites')) || [];

        // フィードバック管理
        let feedbackData = JSON.parse(localStorage.getItem('forecastFeedback')) || {};

        // 自動更新管理
        let autoUpdateTimer = null;
        let lastUpdateTime = null;
        const UPDATE_INTERVAL = 60 * 60 * 1000; // 1時間

        // 干場データ（hoshiba_spots.csvから全331箇所）
        // データ一貫性のためall_spots_array.jsから読み込み
        /* const hoshibaSpots = [
            { name: "H_1021_2473", lat: 45.1021947, lon: 141.247311, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1025_2483", lat: 45.1025111, lon: 141.2483481, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1034_2485", lat: 45.1034294, lon: 141.2485286, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1037_2486", lat: 45.1037247, lon: 141.2486332, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1040_2502", lat: 45.1040639, lon: 141.250253, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1048_2519", lat: 45.1048553, lon: 141.2519053, town: "利尻富士町", district: "鬼脇", buraku: "野中" },
            { name: "H_1094_2687", lat: 45.1094479, lon: 141.268727, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1089_2701", lat: 45.1089406, lon: 141.2701461, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1098_2701", lat: 45.1098663, lon: 141.2701888, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1089_2721", lat: 45.1089222, lon: 141.2721856, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1093_2722", lat: 45.1093235, lon: 141.2722929, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1087_2725", lat: 45.1087049, lon: 141.2725681, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1103_2721", lat: 45.1103838, lon: 141.2721514, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1128_2736", lat: 45.1128726, lon: 141.2736647, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1109_2745", lat: 45.1109264, lon: 141.2745775, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1123_2744", lat: 45.1123653, lon: 141.2744747, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1110_2758", lat: 45.1110778, lon: 141.2758374, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1109_2760", lat: 45.1109604, lon: 141.276001, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1120_2760", lat: 45.1120335, lon: 141.276079, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1110_2765", lat: 45.1110214, lon: 141.2765827, town: "利尻富士町", district: "鬼脇", buraku: "南浜" },
            { name: "H_1132_2845", lat: 45.1132552, lon: 141.28455, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1135_2852", lat: 45.1135576, lon: 141.2852805, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1131_2857", lat: 45.1131534, lon: 141.2857969, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1127_2865", lat: 45.1127594, lon: 141.2865226, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1142_2856", lat: 45.1142836, lon: 141.2856837, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1144_2856", lat: 45.1144161, lon: 141.2856904, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1150_2859", lat: 45.1150648, lon: 141.2859724, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1152_2861", lat: 45.1152692, lon: 141.2861105, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1158_2868", lat: 45.1158224, lon: 141.286849, town: "利尻富士町", district: "鬼脇", buraku: "沼浦" },
            { name: "H_1278_3025", lat: 45.1278291, lon: 141.3025525, town: "利尻富士町", district: "鬼脇", buraku: "金崎" },
            { name: "H_1274_3032", lat: 45.1274206, lon: 141.3032061, town: "利尻富士町", district: "鬼脇", buraku: "金崎" },
            { name: "H_1285_3022", lat: 45.1285684, lon: 141.3022085, town: "利尻富士町", district: "鬼脇", buraku: "金崎" },
            { name: "H_1302_3047", lat: 45.1302484, lon: 141.3047225, town: "利尻富士町", district: "鬼脇", buraku: "金崎" },
            { name: "H_1304_3063", lat: 45.1304074, lon: 141.3063238, town: "利尻富士町", district: "鬼脇", buraku: "金崎" },
            { name: "H_1338_3064", lat: 45.1338215, lon: 141.3064824, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1351_3093", lat: 45.1351708, lon: 141.3093172, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1361_3088", lat: 45.1361111, lon: 141.3088355, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1367_3096", lat: 45.1367493, lon: 141.3096145, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1370_3094", lat: 45.137052, lon: 141.3094106, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1359_3112", lat: 45.1359889, lon: 141.3112589, town: "利尻富士町", district: "鬼脇", buraku: "鬼脇" },
            { name: "H_1442_3184", lat: 45.1442677, lon: 141.3184243, town: "利尻富士町", district: "鬼脇", buraku: "清川" },
            { name: "H_1451_3204", lat: 45.1451173, lon: 141.3204306, town: "利尻富士町", district: "鬼脇", buraku: "清川" },
            { name: "H_1524_3268", lat: 45.1524539, lon: 141.3268048, town: "利尻富士町", district: "鬼脇", buraku: "二石" },
            { name: "H_1540_3282", lat: 45.1540826, lon: 141.328278, town: "利尻富士町", district: "鬼脇", buraku: "二石" },
            { name: "H_1567_3281", lat: 45.1567282, lon: 141.3281503, town: "利尻富士町", district: "鬼脇", buraku: "二石" },
            { name: "H_1742_3256", lat: 45.1742397, lon: 141.3256546, town: "利尻富士町", district: "鬼脇", buraku: "石崎" },
            { name: "H_1753_3251", lat: 45.1753987, lon: 141.3251336, town: "利尻富士町", district: "鬼脇", buraku: "石崎" },
            { name: "H_1778_3244", lat: 45.1778217, lon: 141.324457, town: "利尻富士町", district: "鬼脇", buraku: "石崎" },
            { name: "H_1893_3209", lat: 45.1893588, lon: 141.3209405, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1940_3177", lat: 45.1940268, lon: 141.317736, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1946_3173", lat: 45.1946346, lon: 141.3173819, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1947_3177", lat: 45.1947542, lon: 141.3177935, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1950_3176", lat: 45.1950056, lon: 141.3176728, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1953_3176", lat: 45.1953685, lon: 141.3176299, town: "利尻富士町", district: "鬼脇", buraku: "旭浜" },
            { name: "H_1980_3109", lat: 45.1980472, lon: 141.3109215, town: "利尻富士町", district: "鬼脇", buraku: "鰊泊" },
            { name: "H_2031_3110", lat: 45.2031365, lon: 141.3110767, town: "利尻富士町", district: "鬼脇", buraku: "鰊泊" },
            { name: "H_2040_3104", lat: 45.2040524, lon: 141.3104559, town: "利尻富士町", district: "鬼脇", buraku: "鰊泊" },
            { name: "H_2042_3110", lat: 45.2042659, lon: 141.3110326, town: "利尻富士町", district: "鬼脇", buraku: "鰊泊" },
            { name: "H_2079_3079", lat: 45.2079224, lon: 141.3079776, town: "利尻富士町", district: "鬼脇", buraku: "鰊泊" },
            { name: "H_2194_2962", lat: 45.2194176, lon: 141.2962013, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2193_2959", lat: 45.2193194, lon: 141.2959867, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2201_2935", lat: 45.2201345, lon: 141.2935349, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2204_2938", lat: 45.2204618, lon: 141.2938303, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2199_2928", lat: 45.219963, lon: 141.2928647, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2210_2904", lat: 45.2210151, lon: 141.2904494, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2210_2890", lat: 45.2210388, lon: 141.2890304, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2214_2893", lat: 45.221457, lon: 141.2893312, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2212_2878", lat: 45.2212342, lon: 141.2878744, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2219_2868", lat: 45.2219079, lon: 141.2868433, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2220_2862", lat: 45.2220439, lon: 141.286221, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2215_2856", lat: 45.2215376, lon: 141.2856577, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2218_2852", lat: 45.2218248, lon: 141.2852661, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2221_2854", lat: 45.2221875, lon: 141.2854324, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2224_2845", lat: 45.2224066, lon: 141.2845634, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2227_2836", lat: 45.2227795, lon: 141.2836497, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2227_2825", lat: 45.2227253, lon: 141.2825291, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2239_2811", lat: 45.2239435, lon: 141.2811209, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2237_2808", lat: 45.2237319, lon: 141.2808312, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2247_2802", lat: 45.2247828, lon: 141.2802683, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2256_2798", lat: 45.2256531, lon: 141.2798945, town: "利尻富士町", district: "鴛泊", buraku: "雄忠志内" },
            { name: "H_2285_2795", lat: 45.2285744, lon: 141.2795595, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2291_2795", lat: 45.2291147, lon: 141.2795005, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2286_2789", lat: 45.2286084, lon: 141.2789346, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2289_2791", lat: 45.2289031, lon: 141.2791304, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2293_2788", lat: 45.2293262, lon: 141.2788997, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2290_2784", lat: 45.2290731, lon: 141.2784035, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2303_2784", lat: 45.2303186, lon: 141.2784865, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2310_2788", lat: 45.2310321, lon: 141.2788517, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2306_2783", lat: 45.2306511, lon: 141.2783337, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2310_2782", lat: 45.2310828, lon: 141.2782263, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2301_2772", lat: 45.230104, lon: 141.27726, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2306_2774", lat: 45.2306823, lon: 141.2774055, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2324_2761", lat: 45.2324163, lon: 141.276199, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2335_2755", lat: 45.2335589, lon: 141.2755405, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2328_2750", lat: 45.2328752, lon: 141.2750577, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2295_2716", lat: 45.2295769, lon: 141.2716298, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2336_2735", lat: 45.2336033, lon: 141.273556, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2333_2728", lat: 45.2333984, lon: 141.2728951, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2334_2721", lat: 45.2334664, lon: 141.2721763, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2339_2724", lat: 45.2339094, lon: 141.2724089, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2338_2721", lat: 45.2338328, lon: 141.2721387, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2336_2709", lat: 45.2336399, lon: 141.2709148, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2304_2689", lat: 45.2304117, lon: 141.2689928, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2321_2696", lat: 45.2321359, lon: 141.2696453, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2335_2702", lat: 45.2335381, lon: 141.2702816, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2343_2707", lat: 45.2343497, lon: 141.2707242, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2312_2687", lat: 45.2312126, lon: 141.2687881, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2333_2698", lat: 45.2333266, lon: 141.2698847, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2335_2699", lat: 45.2335683, lon: 141.2699598, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2341_2689", lat: 45.2341459, lon: 141.2689975, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2349_2692", lat: 45.2349392, lon: 141.2692443, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2320_2676", lat: 45.2320281, lon: 141.2676805, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2345_2687", lat: 45.2345161, lon: 141.2687186, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2311_2669", lat: 45.2311673, lon: 141.2669597, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2334_2676", lat: 45.2334409, lon: 141.2676698, town: "利尻富士町", district: "鴛泊", buraku: "野塚" },
            { name: "H_2308_2619", lat: 45.230855, lon: 141.2619475, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2336_2570", lat: 45.2336527, lon: 141.2570902, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2341_2459", lat: 45.2341015, lon: 141.2459467, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2337_2440", lat: 45.2337844, lon: 141.2440412, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2339_2435", lat: 45.2339622, lon: 141.2435604, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2337_2418", lat: 45.2337851, lon: 141.2418753, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2340_2417", lat: 45.2340382, lon: 141.2417412, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2343_2407", lat: 45.2343285, lon: 141.2407067, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2344_2393", lat: 45.2344229, lon: 141.2393335, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2342_2390", lat: 45.2342601, lon: 141.2390011, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2339_2388", lat: 45.2339941, lon: 141.238894, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2339_2382", lat: 45.2339095, lon: 141.2382436, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2331_2380", lat: 45.2331577, lon: 141.2380102, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2337_2369", lat: 45.2337791, lon: 141.2369709, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2448_2304", lat: 45.24477126204745, lon: 141.23042285442355, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2449_2271", lat: 45.2449474, lon: 141.2271061, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2451_2270", lat: 45.245108, lon: 141.2270471, town: "利尻富士町", district: "鴛泊", buraku: "湾内" },
            { name: "H_2449_2267", lat: 45.244904, lon: 141.2267682, town: "利尻富士町", district: "鴛泊", buraku: "港町" },
            { name: "H_2393_2280", lat: 45.2393215, lon: 141.2280094, town: "利尻富士町", district: "鴛泊", buraku: "港町" },
            { name: "H_2446_2262", lat: 45.2446982, lon: 141.2262474, town: "利尻富士町", district: "鴛泊", buraku: "港町" },
            { name: "H_2463_2219", lat: 45.2463148, lon: 141.2219816, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2464_2216", lat: 45.2464662, lon: 141.2216058, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2467_2209", lat: 45.2467619, lon: 141.2209986, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2477_2203", lat: 45.2477271, lon: 141.2203331, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2480_2198", lat: 45.2480376, lon: 141.2198462, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2478_2195", lat: 45.2478847, lon: 141.2195726, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2479_2191", lat: 45.24793, lon: 141.2191086, town: "利尻富士町", district: "鴛泊", buraku: "栄町" },
            { name: "H_2579_1966", lat: 45.2579463, lon: 141.1966851, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2575_1968", lat: 45.257528, lon: 141.1968466, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2579_1957", lat: 45.2579451, lon: 141.195735, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2581_1945", lat: 45.258163, lon: 141.1945494, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2581_1934", lat: 45.2581336, lon: 141.1934075, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2579_1933", lat: 45.2579048, lon: 141.1933233, town: "利尻富士町", district: "鴛泊", buraku: "富士岬" },
            { name: "H_2575_1930", lat: 45.2575895, lon: 141.1930146, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2574_1919", lat: 45.2574384, lon: 141.1919687, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2565_1899", lat: 45.2565726, lon: 141.1899583, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2565_1893", lat: 45.2565726, lon: 141.1893602, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2563_1893", lat: 45.2563989, lon: 141.1893575, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2512_1861", lat: 45.2512927, lon: 141.186103, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2507_1861", lat: 45.2507977, lon: 141.1861938, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2517_1848", lat: 45.2517003, lon: 141.1848425, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2494_1848", lat: 45.2494955, lon: 141.1848312, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2516_1829", lat: 45.2516839, lon: 141.1829666, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2476_1852", lat: 45.2476831, lon: 141.1852532, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2475_1845", lat: 45.2475868, lon: 141.1845035, town: "利尻富士町", district: "鴛泊", buraku: "本泊" },
            { name: "H_2466_1826", lat: 45.2466719, lon: 141.1826188, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2455_1813", lat: 45.2455728, lon: 141.1813367, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2462_1785", lat: 45.2462307, lon: 141.17855, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2455_1786", lat: 45.2455802, lon: 141.1786554, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2449_1787", lat: 45.2449797, lon: 141.1787923, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2468_1766", lat: 45.2468489, lon: 141.176613, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2454_1779", lat: 45.2454745, lon: 141.1779728, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2446_1774", lat: 45.2446706, lon: 141.1774097, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2439_1772", lat: 45.2439473, lon: 141.1772333, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2434_1764", lat: 45.2434053, lon: 141.1764709, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2426_1759", lat: 45.2426844, lon: 141.1759649, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2414_1760", lat: 45.241472, lon: 141.1760937, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2422_1746", lat: 45.242235, lon: 141.174656, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2426_1741", lat: 45.2426801, lon: 141.1741546, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2297_1543", lat: 45.2297761, lon: 141.1543565, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2292_1551", lat: 45.229217, lon: 141.1551159, town: "利尻富士町", district: "鴛泊", buraku: "大磯" },
            { name: "H_2183_1381", lat: 45.2183318, lon: 141.1381607, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2182_1377", lat: 45.2182693, lon: 141.1377479, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2176_1383", lat: 45.2176465, lon: 141.1383282, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2162_1369", lat: 45.2162989, lon: 141.1369268, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2153_1377", lat: 45.2153768, lon: 141.137775, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2150_1362", lat: 45.215014, lon: 141.1362997, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2148_1356", lat: 45.2148553, lon: 141.1356077, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2139_1335", lat: 45.2139627, lon: 141.1335752, town: "利尻町", district: "沓形", buraku: "栄浜" },
            { name: "H_2088_1443", lat: 45.2088707, lon: 141.1443995, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2110_1346", lat: 45.2110922, lon: 141.1346602, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2080_1451", lat: 45.208048, lon: 141.1451738, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2095_1370", lat: 45.2095628, lon: 141.1370219, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2095_1365", lat: 45.2095666, lon: 141.1365163, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2091_1377", lat: 45.2091917, lon: 141.1377542, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2073_1446", lat: 45.2073413, lon: 141.1446213, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2089_1368", lat: 45.2089394, lon: 141.1368919, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2064_1420", lat: 45.2064953, lon: 141.1420567, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2077_1364", lat: 45.2077046, lon: 141.1364899, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2065_1375", lat: 45.2065728, lon: 141.137565, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2065_1369", lat: 45.2065164, lon: 141.1369002, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2052_1384", lat: 45.2052096, lon: 141.1384087, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2030_1392", lat: 45.2030471, lon: 141.1392327, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2020_1404", lat: 45.2020959, lon: 141.140491, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_2011_1417", lat: 45.201169, lon: 141.141782, town: "利尻町", district: "沓形", buraku: "新湊" },
            { name: "H_1998_1383", lat: 45.1998289, lon: 141.1383242, town: "利尻町", district: "沓形", buraku: "種富町" },
            { name: "H_1883_1394", lat: 45.1883009, lon: 141.1394494, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1885_1351", lat: 45.1885151, lon: 141.1351124, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1857_1317", lat: 45.1857184, lon: 141.131719, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1845_1337", lat: 45.1845217, lon: 141.1337514, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1838_1349", lat: 45.1838904, lon: 141.134998, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1836_1371", lat: 45.1836457, lon: 141.1371968, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1835_1363", lat: 45.1835834, lon: 141.1363493, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1835_1367", lat: 45.1835456, lon: 141.1367007, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1834_1386", lat: 45.1834255, lon: 141.1386249, town: "利尻町", district: "沓形", buraku: "富野・日出町・緑町・本町・富士見町" },
            { name: "H_1818_1416", lat: 45.1818894, lon: 141.141604, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1817_1402", lat: 45.1817422, lon: 141.1402608, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1811_1399", lat: 45.1811051, lon: 141.1399778, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1804_1404", lat: 45.1804171, lon: 141.1404971, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1799_1392", lat: 45.1799133, lon: 141.1392124, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1798_1396", lat: 45.1798377, lon: 141.139647, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1795_1395", lat: 45.1795258, lon: 141.1395881, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1795_1393", lat: 45.1795069, lon: 141.1393681, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1790_1377", lat: 45.1790034, lon: 141.1377481, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1788_1372", lat: 45.1788408, lon: 141.1372921, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1782_1394", lat: 45.1782154, lon: 141.1394976, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1762_1377", lat: 45.1762629, lon: 141.1377278, town: "利尻町", district: "沓形", buraku: "泉町" },
            { name: "H_1745_1387", lat: 45.1745589, lon: 141.1387238, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1725_1392", lat: 45.1725647, lon: 141.1392606, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1723_1388", lat: 45.1723075, lon: 141.1388261, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1721_1390", lat: 45.1721789, lon: 141.1390943, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1719_1390", lat: 45.1719407, lon: 141.1390031, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1704_1384", lat: 45.1704874, lon: 141.1384103, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1698_1385", lat: 45.1698969, lon: 141.1385708, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1695_1397", lat: 45.1695078, lon: 141.1397705, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1642_1430", lat: 45.1642297, lon: 141.1430654, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1637_1420", lat: 45.163794, lon: 141.1420934, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1629_1421", lat: 45.1629892, lon: 141.1421148, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1630_1426", lat: 45.1630233, lon: 141.1426459, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1631_1434", lat: 45.1631035, lon: 141.1434784, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1624_1426", lat: 45.1624446, lon: 141.1426244, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1613_1450", lat: 45.1613739, lon: 141.1450036, town: "利尻町", district: "沓形", buraku: "神居" },
            { name: "H_1544_1510", lat: 45.1544086, lon: 141.1510617, town: "利尻町", district: "沓形", buraku: "蘭泊" },
            { name: "H_1517_1528", lat: 45.151713, lon: 141.152844, town: "利尻町", district: "沓形", buraku: "蘭泊" },
            { name: "H_1490_1564", lat: 45.1490644, lon: 141.1564134, town: "利尻町", district: "沓形", buraku: "蘭泊" },
            { name: "H_1488_1568", lat: 45.1488286, lon: 141.1568409, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1484_1578", lat: 45.1484215, lon: 141.1578882, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1386_1658", lat: 45.1386527, lon: 141.165883, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1376_1662", lat: 45.1376793, lon: 141.166274, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1370_1684", lat: 45.1370722, lon: 141.168404, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1364_1676", lat: 45.1364546, lon: 141.1676095, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1362_1681", lat: 45.1362881, lon: 141.1681353, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1364_1688", lat: 45.1364516, lon: 141.1688868, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1360_1691", lat: 45.1360732, lon: 141.1691658, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1356_1687", lat: 45.1356264, lon: 141.1687017, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1352_1690", lat: 45.1352972, lon: 141.1690933, town: "利尻町", district: "仙法志", buraku: "久連" },
            { name: "H_1279_1806", lat: 45.1279996, lon: 141.180658, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1275_1824", lat: 45.1275998, lon: 141.1824476, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1274_1829", lat: 45.1274371, lon: 141.182984, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1266_1851", lat: 45.1266709, lon: 141.18514, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1264_1862", lat: 45.1264901, lon: 141.1862968, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1261_1871", lat: 45.1261867, lon: 141.1871998, town: "利尻町", district: "仙法志", buraku: "長浜" },
            { name: "H_1254_1910", lat: 45.1254663, lon: 141.1910171, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1201_1983", lat: 45.12012, lon: 141.1983058, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1202_1987", lat: 45.1202539, lon: 141.1987064, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1190_2001", lat: 45.1190237, lon: 141.2001839, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1187_2006", lat: 45.1187323, lon: 141.2006667, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1179_2012", lat: 45.1179306, lon: 141.2012737, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1187_2021", lat: 45.1187228, lon: 141.2021983, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1174_2017", lat: 45.1174726, lon: 141.2017458, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1193_2032", lat: 45.1193133, lon: 141.2032926, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1168_2021", lat: 45.1168902, lon: 141.202176, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1163_2023", lat: 45.1163905, lon: 141.2023047, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1159_2022", lat: 45.1159627, lon: 141.2022511, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1156_2027", lat: 45.1156135, lon: 141.2027696, town: "利尻町", district: "仙法志", buraku: "神磯" },
            { name: "H_1176_2048", lat: 45.1176023, lon: 141.2048161, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1157_2040", lat: 45.1157831, lon: 141.2040999, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1155_2039", lat: 45.115509, lon: 141.2039961, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1154_2050", lat: 45.1154598, lon: 141.2050234, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1152_2053", lat: 45.115263, lon: 141.2053721, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1150_2053", lat: 45.1150699, lon: 141.205356, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1176_2068", lat: 45.1176175, lon: 141.2068331, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1141_2080", lat: 45.1141486, lon: 141.2080556, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1138_2086", lat: 45.1138382, lon: 141.208667, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1135_2085", lat: 45.1135127, lon: 141.2085382, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1132_2088", lat: 45.1132505, lon: 141.2088686, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1131_2104", lat: 45.1131045, lon: 141.2104698, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1121_2106", lat: 45.1121695, lon: 141.2106951, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1125_2109", lat: 45.1125215, lon: 141.2109204, town: "利尻町", district: "仙法志", buraku: "政泊" },
            { name: "H_1109_2141", lat: 45.1109702, lon: 141.2141438, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1112_2148", lat: 45.1112163, lon: 141.214868, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1107_2152", lat: 45.1107242, lon: 141.2152221, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1105_2154", lat: 45.1105336, lon: 141.2154636, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1113_2168", lat: 45.1113909, lon: 141.2168461, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1099_2183", lat: 45.1099756, lon: 141.218347, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1071_2182", lat: 45.1071109, lon: 141.2182966, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1080_2187", lat: 45.1080022, lon: 141.2187599, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1076_2188", lat: 45.1076646, lon: 141.218891, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1072_2189", lat: 45.1072161, lon: 141.2189003, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1068_2198", lat: 45.1068639, lon: 141.2198209, town: "利尻町", district: "仙法志", buraku: "本町" },
            { name: "H_1067_2201", lat: 45.1067276, lon: 141.2201696, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1064_2209", lat: 45.1064436, lon: 141.2209367, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1079_2225", lat: 45.1079586, lon: 141.2225588, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1064_2224", lat: 45.1064667, lon: 141.2224071, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1064_2238", lat: 45.1064311, lon: 141.2238985, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1061_2255", lat: 45.1061591, lon: 141.2255371, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1059_2261", lat: 45.1059702, lon: 141.2261239, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1064_2264", lat: 45.1064435, lon: 141.2264297, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1058_2266", lat: 45.105861, lon: 141.2266559, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1058_2269", lat: 45.1058005, lon: 141.2269617, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1054_2274", lat: 45.1054103, lon: 141.2274857, town: "利尻町", district: "仙法志", buraku: "元村" },
            { name: "H_1052_2278", lat: 45.1052855, lon: 141.2278468, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0999_2282", lat: 45.099954, lon: 141.228227, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0996_2286", lat: 45.0996921, lon: 141.228644, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1013_2289", lat: 45.1013171, lon: 141.2289152, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1021_2294", lat: 45.1021501, lon: 141.2294408, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1002_2305", lat: 45.1002115, lon: 141.2305065, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1000_2307", lat: 45.100083, lon: 141.2307556, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0999_2310", lat: 45.0999335, lon: 141.2310079, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1014_2312", lat: 45.1014286, lon: 141.2312722, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0993_2312", lat: 45.0993577, lon: 141.2312092, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0985_2332", lat: 45.098564, lon: 141.2332933, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0989_2335", lat: 45.0989786, lon: 141.2335938, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0991_2343", lat: 45.0991319, lon: 141.234371, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0991_2351", lat: 45.09916, lon: 141.2351819, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0988_2353", lat: 45.0988753, lon: 141.2353402, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0982_2358", lat: 45.0982545, lon: 141.2358986, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0978_2363", lat: 45.0978959, lon: 141.2363079, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0983_2369", lat: 45.0983261, lon: 141.2369949, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0986_2371", lat: 45.0986909, lon: 141.237183, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0983_2378", lat: 45.0983485, lon: 141.2378509, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0976_2378", lat: 45.0976072, lon: 141.2378178, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0980_2384", lat: 45.0980579, lon: 141.2384079, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_1047_2387", lat: 45.104712, lon: 141.2387548, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0988_2393", lat: 45.0988451, lon: 141.2393708, town: "利尻町", district: "仙法志", buraku: "御崎" },
            { name: "H_0988_2398", lat: 45.0988214, lon: 141.2398858, town: "利尻町", district: "仙法志", buraku: "御崎" }
        ]; */

        // 干場マーカーを地図に追加
        function addHoshibaMarkers() {
            // 既存のマーカーをクリア
            allMarkers.forEach(markerData => {
                map.removeLayer(markerData.marker);
            });
            allMarkers = [];

            // hoshibaSpots変数の有効性確認
            if (typeof hoshibaSpots === 'undefined') {
                console.error('hoshibaSpots is not defined. Trying to load from API...');
                loadSpotsFromAPI();
                return;
            }

            // all_spots_array.jsから読み込んだデータを使用
            hoshibaSpots.forEach((spot, index) => {
                const isFavorite = favorites.includes(index);
                const marker = L.circleMarker([spot.lat, spot.lon], {
                    radius: 8,
                    fillColor: isFavorite ? '#28a745' : '#667eea',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // マーカーデータを配列に保存
                allMarkers.push({
                    marker: marker,
                    spot: spot,
                    index: index,
                    visible: true
                });

                marker.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <strong>${spot.name}</strong><br>
                        <span style="color: #666;">${spot.town} ${spot.district}</span><br>
                        <button onclick="selectSpot(${index})" style="
                            background: #667eea;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin: 5px;
                        ">7日間予報を表示</button>
                        <button onclick="toggleFavorite(${index})" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin: 5px;
                        ">お気に入り登録</button>
                        <button onclick="deleteSpot(${index})" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin: 5px;
                        ">🗑️ 干場を削除</button>
                        <button onclick="console.log('Record button clicked for index:', ${index}); showRecordForm(${index})" style="
                            background: #17a2b8;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin: 5px;
                        ">📝 記録を入力</button>
                    </div>
                `);

                marker.on('click', () => selectSpot(index));
                spot.marker = marker;
            });
        }

        // 階層フィルタリング関数
        function filterByTown() {
            const townSelect = document.getElementById('townSelect');
            const selectedTown = townSelect.value;

            currentFilters.town = selectedTown;
            currentFilters.district = '';
            currentFilters.buraku = '';

            // 地区セレクトボックスを更新
            updateDistrictOptions(selectedTown);

            // マーカーをフィルタリング
            applyFilters();
            updateBreadcrumb();
            updateStats();
        }

        function filterByDistrict() {
            const districtSelect = document.getElementById('districtSelect');
            const selectedDistrict = districtSelect.value;

            currentFilters.district = selectedDistrict;
            currentFilters.buraku = '';

            // 部落セレクトボックスを更新
            updateBurakuOptions(currentFilters.town, selectedDistrict);

            // マーカーをフィルタリング
            applyFilters();
            updateBreadcrumb();
            updateStats();
        }

        function filterByBuraku() {
            const burakuSelect = document.getElementById('burakuSelect');
            const selectedBuraku = burakuSelect.value;

            currentFilters.buraku = selectedBuraku;

            // マーカーをフィルタリング
            applyFilters();
            updateBreadcrumb();
            updateStats();
        }

        function resetFilters() {
            currentFilters = { town: '', district: '', buraku: '' };

            // セレクトボックスをリセット
            document.getElementById('townSelect').value = '';
            document.getElementById('districtSelect').value = '';
            document.getElementById('burakuSelect').value = '';

            // セクションを隠す
            document.getElementById('districtSection').style.display = 'none';
            document.getElementById('burakuSection').style.display = 'none';

            // 全マーカーを表示
            showAllMarkers();
            updateBreadcrumb();
            updateStats();

            // 全体表示にズーム
            map.setView(RISHIRI_CENTER, 12);
        }

        function updateDistrictOptions(selectedTown) {
            const districtSelect = document.getElementById('districtSelect');
            const districtSection = document.getElementById('districtSection');
            const burakuSection = document.getElementById('burakuSection');

            districtSelect.innerHTML = '<option value="">-- 地区を選択してください --</option>';

            if (selectedTown) {
                // 選択された町の地区を取得
                const districts = [...new Set(
                    hoshibaSpots
                        .filter(spot => spot.town === selectedTown)
                        .map(spot => spot.district)
                )].sort();

                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });

                districtSection.style.display = 'block';
                burakuSection.style.display = 'none';
            } else {
                districtSection.style.display = 'none';
                burakuSection.style.display = 'none';
            }
        }

        function updateBurakuOptions(selectedTown, selectedDistrict) {
            const burakuSelect = document.getElementById('burakuSelect');
            const burakuSection = document.getElementById('burakuSection');

            burakuSelect.innerHTML = '<option value="">-- 部落を選択してください --</option>';

            if (selectedTown && selectedDistrict) {
                // 選択された町・地区の部落を取得
                const burakus = [...new Set(
                    hoshibaSpots
                        .filter(spot => spot.town === selectedTown && spot.district === selectedDistrict)
                        .map(spot => spot.buraku)
                )].sort();

                burakus.forEach(buraku => {
                    const option = document.createElement('option');
                    option.value = buraku;
                    option.textContent = buraku;
                    burakuSelect.appendChild(option);
                });

                burakuSection.style.display = 'block';
            } else {
                burakuSection.style.display = 'none';
            }
        }

        // フィルタリング実行
        function applyFilters() {
            let visibleCount = 0;
            const filteredMarkers = [];

            allMarkers.forEach(markerData => {
                const { marker, spot, index } = markerData;
                let shouldShow = true;

                // 町フィルター
                if (currentFilters.town && spot.town !== currentFilters.town) {
                    shouldShow = false;
                }

                // 地区フィルター
                if (currentFilters.district && spot.district !== currentFilters.district) {
                    shouldShow = false;
                }

                // 部落フィルター
                if (currentFilters.buraku && spot.buraku !== currentFilters.buraku) {
                    shouldShow = false;
                }

                if (shouldShow) {
                    if (!map.hasLayer(marker)) {
                        map.addLayer(marker);
                    }
                    markerData.visible = true;
                    filteredMarkers.push(markerData);
                    visibleCount++;
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                    markerData.visible = false;
                }
            });

            // フィルタリングされた範囲にズーム
            if (filteredMarkers.length > 0) {
                zoomToMarkers(filteredMarkers);
            }

            return visibleCount;
        }

        // 指定されたマーカーの範囲にズーム
        function zoomToMarkers(markerData) {
            if (markerData.length === 0) return;

            const latLngs = markerData.map(data => [data.spot.lat, data.spot.lon]);
            const group = L.latLngBounds(latLngs);

            // 適切なパディングでズーム
            map.fitBounds(group, {
                padding: [50, 50],
                maxZoom: 16
            });
        }

        // 全マーカーを表示
        function showAllMarkers() {
            allMarkers.forEach(markerData => {
                const { marker } = markerData;
                if (!map.hasLayer(marker)) {
                    map.addLayer(marker);
                }
                markerData.visible = true;
            });
        }

        // パンくずナビゲーション更新
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('filterBreadcrumb');
            let html = '<span class="breadcrumb-item" onclick="resetFilters()">全エリア</span>';

            if (currentFilters.town) {
                html += '<span class="breadcrumb-separator"> > </span>';
                html += `<span class="breadcrumb-item" onclick="filterToTown('${currentFilters.town}')">${currentFilters.town}</span>`;
            }

            if (currentFilters.district) {
                html += '<span class="breadcrumb-separator"> > </span>';
                html += `<span class="breadcrumb-item" onclick="filterToDistrict('${currentFilters.town}', '${currentFilters.district}')">${currentFilters.district}</span>`;
            }

            if (currentFilters.buraku) {
                html += '<span class="breadcrumb-separator"> > </span>';
                html += `<span class="breadcrumb-item">${currentFilters.buraku}</span>`;
            }

            breadcrumb.innerHTML = html;
        }

        // 統計情報更新
        function updateStats() {
            const visibleCount = allMarkers.filter(m => m.visible).length;
            const statsElement = document.getElementById('filterStats');
            statsElement.textContent = `表示中: ${visibleCount}箇所の干場`;
        }

        // パンくずナビゲーションから町レベルにフィルタ
        function filterToTown(town) {
            currentFilters = { town: town, district: '', buraku: '' };
            document.getElementById('townSelect').value = town;
            updateDistrictOptions(town);
            applyFilters();
            updateBreadcrumb();
            updateStats();
        }

        // パンくずナビゲーションから地区レベルにフィルタ
        function filterToDistrict(town, district) {
            currentFilters = { town: town, district: district, buraku: '' };
            document.getElementById('townSelect').value = town;
            document.getElementById('districtSelect').value = district;
            updateDistrictOptions(town);
            updateBurakuOptions(town, district);
            applyFilters();
            updateBreadcrumb();
            updateStats();
        }

        // 干場選択処理
        async function selectSpot(index) {
            const spot = hoshibaSpots[index];

            // 前の選択をリセット
            if (selectedMarker) {
                selectedMarker.setStyle({
                    fillColor: '#667eea',
                    radius: 8
                });
            }

            // 新しい選択をハイライト
            selectedMarker = spot.marker;
            selectedMarker.setStyle({
                fillColor: '#ff6b6b',
                radius: 12
            });

            selectedSpot = spot;

            // パネル表示
            const panel = document.getElementById('forecastPanel');
            panel.classList.add('active');

            // ヘッダー更新
            document.getElementById('selectedSpotName').textContent = spot.name;
            document.getElementById('selectedSpotLocation').textContent = `${spot.town} ${spot.district} ${spot.buraku}`;

            // 予報データ取得
            await loadForecastData(spot);

            // 自動更新開始
            startAutoUpdate();
        }

        // 予報データ取得と表示
        async function loadForecastData(spot) {
            const forecastContent = document.getElementById('forecastContent');
            const forecastTabs = document.getElementById('forecastTabs');

            forecastContent.innerHTML = '<div class="loading"><div class="spinner"></div>予報データを取得中...</div>';
            forecastTabs.style.display = 'none';

            try {
                // Enhanced API call
                const response = await fetch(`/api/forecast?lat=${spot.lat}&lon=${spot.lon}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayEnhancedForecast(data.forecasts);
                    updateChart(data.forecasts);
                    lastUpdateTime = new Date();
                    updateAutoUpdateStatus();
                } else {
                    forecastContent.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">予報データの取得に失敗しました</div>';
                }
            } catch (error) {
                console.error('Forecast fetch error:', error);
                forecastContent.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">ネットワークエラーが発生しました</div>';
            }
        }

        // 予報表示
        function displayForecast(forecasts) {
            const forecastContent = document.getElementById('forecastContent');
            let html = '';

            forecasts.forEach(forecast => {
                const date = new Date(forecast.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const dayStr = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];

                html += `
                    <div class="forecast-item">
                        <div class="forecast-date">${dateStr} (${dayStr})</div>
                        <div class="forecast-data">
                            <div class="data-item">
                                <span>最高気温:</span>
                                <span>${forecast.temperature_max}°C</span>
                            </div>
                            <div class="data-item">
                                <span>湿度:</span>
                                <span>${forecast.humidity}%</span>
                            </div>
                            <div class="data-item">
                                <span>風速:</span>
                                <span>${forecast.wind_speed}m/s</span>
                            </div>
                            <div class="data-item">
                                <span>降水量:</span>
                                <span>${forecast.precipitation}mm</span>
                            </div>
                            <div class="data-item expert-only">
                                <span>気圧:</span>
                                <span>${forecast.pressure || '1013'}hPa</span>
                            </div>
                            <div class="data-item">
                                <span>風向:</span>
                                <span>${forecast.daily_summary && forecast.daily_summary.wind_direction ? getRishiriWindDetails(forecast.daily_summary.wind_direction).name + ' (' + getRishiriWindDetails(forecast.daily_summary.wind_direction).cardinal16 + ')' : '--'}</span>
                            </div>
                            <div class="data-item expert-only">
                                <span>紫外線指数:</span>
                                <span>${forecast.uv_index || '5'}</span>
                            </div>
                            <div class="data-item expert-only">
                                <span>雲量:</span>
                                <span>${forecast.cloud_cover || '30'}%</span>
                            </div>
                        </div>
                        <div class="suitability ${forecast.suitability}">
                            乾燥適性: ${getSuitabilityText(forecast.suitability)} (${forecast.drying_score}点)
                        </div>
                        <div class="schedule-recommendation" style="margin-top: 10px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; font-size: 0.85rem;">
                            <strong>🕒 推奨作業時間:</strong>
                            <div id="workSchedule_${forecast.date}" style="margin-top: 5px; color: #333;"></div>
                        </div>
                        <div class="feedback-section">
                            <small style="color: #666; margin-bottom: 5px; display: block;">実際の乾燥状況をフィードバック:</small>
                            <div class="feedback-buttons">
                                <button onclick="submitFeedback('${forecast.date}', 'excellent')" class="feedback-btn excellent">非常に良い</button>
                                <button onclick="submitFeedback('${forecast.date}', 'good')" class="feedback-btn good">良い</button>
                                <button onclick="submitFeedback('${forecast.date}', 'fair')" class="feedback-btn fair">普通</button>
                                <button onclick="submitFeedback('${forecast.date}', 'poor')" class="feedback-btn poor">悪い</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            forecastContent.innerHTML = html;

            // 作業スケジュール計算
            forecasts.forEach(forecast => {
                calculateWorkSchedule(forecast);
            });
        }

        // Enhanced forecast display with tabs and hourly details
        function displayEnhancedForecast(forecasts) {
            const forecastContent = document.getElementById('forecastContent');
            const forecastTabs = document.getElementById('forecastTabs');

            // Create tabs
            let tabsHtml = '';
            forecasts.forEach((forecast, index) => {
                const date = new Date(forecast.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const dayStr = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                const isActive = index === 0 ? 'active' : '';
                const reliabilityClass = getReliabilityClass(forecast.reliability);

                const dayLabel = index === 0 ? '今日' : index === 1 ? '明日' : `${index}日後`;

                tabsHtml += `
                    <div class="forecast-tab ${isActive}" onclick="showForecastDay(${index})" data-day="${index}">
                        ${dayLabel}<br>
                        <small>${dateStr}(${dayStr})</small><br>
                        <span class="reliability-badge ${reliabilityClass}">${forecast.reliability.accuracy}%</span>
                    </div>
                `;
            });

            forecastTabs.innerHTML = tabsHtml;
            forecastTabs.style.display = 'flex';

            // Create content for each day
            let contentHtml = '';
            forecasts.forEach((forecast, index) => {
                const date = new Date(forecast.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const dayStr = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                const isActive = index === 0 ? 'active' : '';
                const reliabilityClass = getReliabilityClass(forecast.reliability);

                const dayLabel2 = index === 0 ? '今日' : index === 1 ? '明日' : `${index}日後`;

                contentHtml += `
                    <div class="forecast-content ${isActive}" id="forecastDay${index}">
                        <div class="forecast-item">
                            <div class="forecast-date">${dateStr} (${dayStr}) - ${dayLabel2}</div>

                            <div class="reliability-badge ${reliabilityClass}" style="margin-bottom: 15px;">
                                信頼度: ${forecast.reliability.accuracy}% (${forecast.reliability.confidence}) - ${forecast.reliability.usage}
                            </div>

                            <div class="forecast-data">
                                <div class="data-item">
                                    <span>最高気温:</span>
                                    <span>${forecast.daily_summary.temperature_max.toFixed(1)}°C</span>
                                </div>
                                <div class="data-item">
                                    <span>最低気温:</span>
                                    <span>${forecast.daily_summary.temperature_min.toFixed(1)}°C</span>
                                </div>
                                <div class="data-item">
                                    <span>平均湿度:</span>
                                    <span>${forecast.daily_summary.humidity.toFixed(1)}%</span>
                                </div>
                                <div class="data-item">
                                    <span>最大風速:</span>
                                    <span>${forecast.daily_summary.wind_speed.toFixed(1)}m/s</span>
                                </div>
                                <div class="data-item">
                                    <span>降水量:</span>
                                    <span>${forecast.daily_summary.precipitation.toFixed(1)}mm</span>
                                </div>
                            </div>

                            <div class="suitability ${forecast.daily_summary.suitability}">
                                乾燥適性: ${getSuitabilityText(forecast.daily_summary.suitability)} (${forecast.daily_summary.drying_score}点)
                            </div>

                            <div class="schedule-recommendation" style="margin: 15px 0; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px;">
                                <strong>🕒 予測乾燥時間:</strong> ${forecast.daily_summary.estimated_drying_time}
                            </div>

                            ${generateHourlyDetails(forecast.hourly_details, forecast.day_number)}

                            <div class="feedback-section">
                                <small style="color: #666; margin-bottom: 5px; display: block;">実際の乾燥状況をフィードバック:</small>
                                <div class="feedback-buttons">
                                    <button onclick="submitFeedback('${forecast.date}', 'excellent')" class="feedback-btn excellent">非常に良い</button>
                                    <button onclick="submitFeedback('${forecast.date}', 'good')" class="feedback-btn good">良い</button>
                                    <button onclick="submitFeedback('${forecast.date}', 'fair')" class="feedback-btn fair">普通</button>
                                    <button onclick="submitFeedback('${forecast.date}', 'poor')" class="feedback-btn poor">悪い</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            forecastContent.innerHTML = contentHtml;
        }

        function generateHourlyDetails(hourlyData, dayIndex = 0) {
            if (!hourlyData || hourlyData.length === 0) {
                return '<div class="hourly-section"><h4>時間別詳細データなし</h4></div>';
            }

            const tabId = `hourly-view-${dayIndex}`;

            let html = `
                <div class="hourly-section">
                    <h4>📊 時間別詳細 (4:00-16:00)</h4>

                    <!-- 一般/専門家向けタブ -->
                    <div class="view-mode-tabs">
                        <button class="view-mode-tab active" onclick="switchViewMode('${tabId}', 'general')">
                            🌤️ 一般漁師向け
                        </button>
                        <button class="view-mode-tab" onclick="switchViewMode('${tabId}', 'expert')">
                            🌪️ 気象専門家向け
                        </button>
                    </div>

                    <div class="hourly-table-container">
                        <table class="hourly-table" id="${tabId}">
                            <thead>
                                <tr>
                                    <th>時刻</th>
            `;

            // 時刻列の生成
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<th>${hour.time}</th>`;
                }
            });

            html += `
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 一般漁師向け項目 -->
                                <tr class="general-row">
                                    <td class="time-cell">🌡️ 気温(°C)</td>
            `;

            // 気温行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.temperature ? hour.temperature.toFixed(1) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="general-row">
                                    <td class="time-cell">💧 湿度(%)</td>
            `;

            // 湿度行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.humidity ? hour.humidity.toFixed(0) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="general-row">
                                    <td class="time-cell">💨 風速(m/s)</td>
            `;

            // 風速行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.wind_speed ? hour.wind_speed.toFixed(1) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="general-row">
                                    <td class="time-cell">🌬️ 風向</td>
            `;

            // 風向行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    const windDetails = hour.wind_direction ? getRishiriWindDetails(hour.wind_direction) : null;
                    const windName = windDetails ? `${windDetails.name} (${windDetails.cardinal16})` : '--';
                    html += `<td title="${windDetails ? windDetails.cardinal : ''}">${windName}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="general-row">
                                    <td class="time-cell">☀️ 日射(W/m²)</td>
            `;

            // 日射量行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.solar_radiation ? Math.round(hour.solar_radiation) : '--'}</td>`;
                }
            });

            html += `
                                </tr>

                                <!-- 専門家向け項目 -->
                                <tr class="expert-row">
                                    <td class="time-cell">☁️ 雲量(%)</td>
            `;

            // 雲量行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.cloud_cover ? hour.cloud_cover.toFixed(0) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="expert-row">
                                    <td class="time-cell">📐 風向-山頂角差(°)</td>
            `;

            // 風向-山頂角度差行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.wind_mountain_angle_diff !== undefined && hour.wind_mountain_angle_diff !== null ? hour.wind_mountain_angle_diff.toFixed(1) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="expert-row">
                                    <td class="time-cell">⬆️ 鉛直速度(Pa/s)</td>
            `;

            // 鉛直p速度行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.vertical_p_velocity !== undefined ? hour.vertical_p_velocity.toFixed(3) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="expert-row">
                                    <td class="time-cell">📊 SSI</td>
            `;

            // SSI行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    const ssiValue = hour.ssi !== undefined && hour.ssi !== null ? hour.ssi.toFixed(1) : '--';
                    const ssiCategory = hour.ssi !== undefined && hour.ssi !== null ? getSSICategory(hour.ssi) : '';
                    html += `<td title="${ssiCategory}">${ssiValue}</td>`;
                }
            });

            html += `
                                </tr>
                                <tr class="expert-row">
                                    <td class="time-cell">🌡️ 相当温位(K)</td>
            `;

            // 相当温位行
            hourlyData.forEach(hour => {
                if (hour.temperature !== null) {
                    html += `<td>${hour.equivalent_potential_temperature !== undefined && hour.equivalent_potential_temperature !== null ? hour.equivalent_potential_temperature.toFixed(1) : '--'}</td>`;
                }
            });

            html += `
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return html;
        }

        // タブ切り替え関数
        function switchViewMode(tableId, mode) {
            const table = document.getElementById(tableId);
            const tabs = document.querySelectorAll(`button[onclick*="${tableId}"]`);

            // タブのアクティブ状態を更新
            tabs.forEach(tab => {
                if (tab.onclick.toString().includes(`'${mode}'`)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // テーブルの表示切替
            if (mode === 'expert') {
                table.classList.add('show-expert');
            } else {
                table.classList.remove('show-expert');
            }
        }

        function getReliabilityClass(reliability) {
            if (reliability.accuracy >= 85) return 'reliability-high';
            if (reliability.accuracy >= 70) return 'reliability-medium';
            return 'reliability-low';
        }

        let currentForecastDay = 0;  // 現在選択されている予報日

        function showForecastDay(dayIndex) {
            console.log('showForecastDay called with dayIndex:', dayIndex);

            // Hide all content
            document.querySelectorAll('.forecast-content').forEach(content => {
                content.classList.remove('active');
            });

            // Hide all tabs
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected content and tab
            const selectedContent = document.getElementById(`forecastDay${dayIndex}`);
            const selectedTab = document.querySelector(`.forecast-tab[data-day="${dayIndex}"]`);

            if (selectedContent) selectedContent.classList.add('active');
            if (selectedTab) selectedTab.classList.add('active');

            // 現在選択されている日を保存
            currentForecastDay = dayIndex;
            console.log('currentForecastDay updated to:', currentForecastDay);

            // エマグラム時刻選択肢を更新
            updateEmagramTimeOptions();
        }

        // グローバルスコープに関数を公開（onclick から呼び出せるように）
        window.showForecastDay = showForecastDay;

        // 作業スケジュール最適化
        function calculateWorkSchedule(forecast) {
            const scheduleElement = document.getElementById(`workSchedule_${forecast.date}`);
            if (!scheduleElement) return;

            let recommendations = [];

            // 乾燥適性に基づく推奨時間帯
            if (forecast.drying_score >= 8) {
                recommendations.push('🌟 終日作業最適 (6:00-18:00)');
            } else if (forecast.drying_score >= 6) {
                // 風速と湿度を考慮
                const windSpeed = forecast.wind_speed || 5;
                const humidity = forecast.humidity || 70;

                if (windSpeed > 3 && humidity < 70) {
                    recommendations.push('☀️ 午前中推奨 (8:00-12:00)');
                    recommendations.push('🌤️ 午後も良好 (13:00-17:00)');
                } else if (windSpeed > 3) {
                    recommendations.push('🌬️ 風強時間帯 (10:00-15:00)');
                } else {
                    recommendations.push('⏰ 短時間作業 (10:00-14:00)');
                }
            } else if (forecast.drying_score >= 4) {
                recommendations.push('⚠️ 限定的作業 (11:00-13:00)');
                if (forecast.precipitation < 1) {
                    recommendations.push('💧 雨間を利用');
                }
            } else {
                recommendations.push('❌ 作業非推奨');
                if (forecast.precipitation > 5) {
                    recommendations.push('🌧️ 雨天作業停止');
                }
            }

            // 気温による調整
            const temp = forecast.temperature_max || 20;
            if (temp > 25) {
                recommendations.push('🌡️ 高温注意 (早朝・夕方推奨)');
            } else if (temp < 10) {
                recommendations.push('🧥 低温注意 (日中推奨)');
            }

            scheduleElement.innerHTML = recommendations.join('<br>');
        }

        // 適性テキスト変換
        function getSuitabilityText(suitability) {
            const suitabilityMap = {
                'excellent': '非常に良い',
                'good': '良い',
                'fair': '普通',
                'poor': '悪い'
            };
            return suitabilityMap[suitability] || suitability;
        }

        function getSSICategory(ssi) {
            if (ssi === null || ssi === undefined) {
                return '--';
            }
            if (ssi >= 3) {
                return '安定';
            } else if (ssi >= 0) {
                return '中性';
            } else if (ssi >= -3) {
                return 'やや不安定';
            } else {
                return '不安定';
            }
        }

        // チャート更新
        function updateChart(forecasts) {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            if (forecastChart) {
                forecastChart.destroy();
            }

            const labels = forecasts.map(f => {
                const date = new Date(f.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '乾燥適性スコア',
                            data: forecasts.map(f => f.daily_summary.drying_score),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: '最高気温 (°C)',
                            data: forecasts.map(f => f.daily_summary.temperature_max),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '7日間乾燥適性予報'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '適性スコア'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '気温 (°C)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // お気に入り機能
        function toggleFavorite(index) {
            const favoriteIndex = favorites.indexOf(index);
            if (favoriteIndex === -1) {
                // お気に入りに追加
                favorites.push(index);
            } else {
                // お気に入りから削除
                favorites.splice(favoriteIndex, 1);
            }

            localStorage.setItem('hoshibaFavorites', JSON.stringify(favorites));
            refreshMarkers();
            updateFavoritesList();
        }

        function refreshMarkers() {
            map.eachLayer((layer) => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            addHoshibaMarkers();
        }

        function showFavorites() {
            const favoritesList = document.getElementById('favoritesList');
            if (favoritesList.style.display === 'none') {
                favoritesList.style.display = 'block';
                updateFavoritesList();
            } else {
                favoritesList.style.display = 'none';
            }
        }

        function updateFavoritesList() {
            const content = document.getElementById('favoritesContent');

            if (favorites.length === 0) {
                content.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">お気に入りの干場がありません</div>';
                return;
            }

            let html = '';
            favorites.forEach(index => {
                const spot = hoshibaSpots[index];
                html += `
                    <div class="favorite-item" onclick="selectSpot(${index})">
                        <div>
                            <strong>${spot.name}</strong><br>
                            <small style="color: #666;">${spot.town} ${spot.district}</small>
                        </div>
                        <button onclick="event.stopPropagation(); toggleFavorite(${index})"
                                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            削除
                        </button>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function clearAllFavorites() {
            if (confirm('すべてのお気に入りを削除しますか？')) {
                favorites = [];
                localStorage.setItem('hoshibaFavorites', JSON.stringify(favorites));
                refreshMarkers();
                updateFavoritesList();
            }
        }

        // モード切替機能

        // 自動更新機能
        function startAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
            }

            if (!selectedSpot) {
                console.log('selectedSpot is not set, cannot start auto-update');
                return;
            }

            autoUpdateTimer = setInterval(() => {
                if (selectedSpot) {
                    console.log('自動更新を実行中...');
                    loadForecastData(selectedSpot);
                }
            }, UPDATE_INTERVAL);

            // タイマー設定後にステータスを更新
            setTimeout(() => {
                updateAutoUpdateStatus();
            }, 100);
        }

        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
            }
            updateAutoUpdateStatus();
        }

        function updateAutoUpdateStatus() {
            const statusText = document.getElementById('updateStatusText');
            const nextUpdateTime = document.getElementById('nextUpdateTime');

            if (autoUpdateTimer && selectedSpot) {
                statusText.textContent = '自動更新: 有効';
                if (lastUpdateTime) {
                    const nextUpdate = new Date(lastUpdateTime.getTime() + UPDATE_INTERVAL);
                    nextUpdateTime.textContent = `次回更新: ${nextUpdate.toLocaleTimeString()}`;
                    nextUpdateTime.style.display = 'block';
                } else {
                    nextUpdateTime.style.display = 'none';
                }
            } else {
                statusText.textContent = '自動更新: 停止中';
                nextUpdateTime.style.display = 'none';
            }
        }

        // ページ表示状態の監視
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && selectedSpot) {
                // ページが再表示された時に更新チェック
                if (lastUpdateTime && (new Date() - lastUpdateTime) > UPDATE_INTERVAL * 0.8) {
                    loadForecastData(selectedSpot);
                }
            }
        });

        // APIからスポットデータを読み込む関数（フォールバック）
        async function loadSpotsFromAPI() {
            try {
                console.log('Loading spots data from CSV API...');
                const response = await fetch('/api/spots');
                const data = await response.json();

                if (data && Array.isArray(data)) {
                    // グローバル変数として設定
                    window.hoshibaSpots = data;
                    console.log(`Loaded ${data.length} spots from API`);

                    // H_1174_2017の所属確認
                    const spot = data.find(s => s.name === 'H_1174_2017');
                    if (spot) {
                        console.log(`H_1174_2017: ${spot.town}, ${spot.district}, ${spot.buraku}`);
                    }

                    // マーカーを再描画
                    addHoshibaMarkers();
                } else {
                    console.error('Failed to load spots data from API');
                }
            } catch (error) {
                console.error('Error loading spots from API:', error);
            }
        }

        // グローバル関数として露出（HTML onchangeから呼び出し可能にする）
        window.filterByTown = filterByTown;
        window.filterByDistrict = filterByDistrict;
        window.filterByBuraku = filterByBuraku;

        // ========================================
        // 通知システム (仕様書 lines 335-341)
        // ========================================

        let notificationData = JSON.parse(localStorage.getItem('hoshibaNotificationData')) || {
            enabled: false,
            offDays: [],
            seasonStart: null,
            seasonEnd: null
        };

        // 通知設定の初期化
        function initializeNotifications() {
            const checkbox = document.getElementById('notificationEnabled');
            const settingsDiv = document.getElementById('notificationSettings');

            // 保存済み設定を復元
            checkbox.checked = notificationData.enabled;
            settingsDiv.style.display = notificationData.enabled ? 'block' : 'none';

            if (notificationData.seasonStart) {
                document.getElementById('seasonStartDate').value = notificationData.seasonStart;
            }
            if (notificationData.seasonEnd) {
                document.getElementById('seasonEndDate').value = notificationData.seasonEnd;
            }

            updateNotificationSpotsList();
            updateOffDaysList();

            // PWA通知権限リクエスト
            if (notificationData.enabled && 'Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('通知権限が許可されました');
                    }
                });
            }
        }

        function toggleNotifications() {
            const checkbox = document.getElementById('notificationEnabled');
            const settingsDiv = document.getElementById('notificationSettings');

            notificationData.enabled = checkbox.checked;
            settingsDiv.style.display = checkbox.checked ? 'block' : 'none';

            // PWA通知権限リクエスト
            if (checkbox.checked && 'Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            alert('通知が有効になりました。毎日午後4時にお気に入り干場の予報をお知らせします。');
                            scheduleNextNotification();
                        } else {
                            alert('通知を有効にするには、ブラウザの通知許可が必要です。');
                            checkbox.checked = false;
                            notificationData.enabled = false;
                            settingsDiv.style.display = 'none';
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    scheduleNextNotification();
                }
            }

            saveNotificationData();
            updateNotificationSpotsList();
        }

        function updateNotificationSpotsList() {
            const listDiv = document.getElementById('notificationSpotsList');

            if (favorites.length === 0) {
                listDiv.innerHTML = '<p style="color: #999;">お気に入りに干場を追加してください</p>';
            } else {
                const spotNames = favorites.map(index => hoshibaSpots[index].name).join(', ');
                listDiv.innerHTML = `<p>通知対象: ${favorites.length}箇所</p><p style="color: #666; font-size: 0.8rem;">${spotNames}</p>`;
            }
        }

        function addOffDay() {
            const dateInput = document.getElementById('offDayDate');
            const date = dateInput.value;

            if (!date) {
                alert('日付を選択してください');
                return;
            }

            if (!notificationData.offDays.includes(date)) {
                notificationData.offDays.push(date);
                notificationData.offDays.sort();
                saveNotificationData();
                updateOffDaysList();
                dateInput.value = '';
            } else {
                alert('この日付は既に登録されています');
            }
        }

        function removeOffDay(date) {
            notificationData.offDays = notificationData.offDays.filter(d => d !== date);
            saveNotificationData();
            updateOffDaysList();
        }

        function updateOffDaysList() {
            const listDiv = document.getElementById('offDaysList');

            if (notificationData.offDays.length === 0) {
                listDiv.innerHTML = '<p style="color: #999;">沖止め日は設定されていません</p>';
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
                notificationData.offDays.forEach(date => {
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; background: white; border-radius: 3px;">
                        <span>${date}</span>
                        <button onclick="removeOffDay('${date}')" style="padding: 3px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">削除</button>
                    </div>`;
                });
                html += '</div>';
                listDiv.innerHTML = html;
            }
        }

        function saveSeasonDates() {
            const startDate = document.getElementById('seasonStartDate').value;
            const endDate = document.getElementById('seasonEndDate').value;

            if (!startDate || !endDate) {
                alert('開始日と終了日の両方を設定してください');
                return;
            }

            if (startDate > endDate) {
                alert('開始日は終了日より前である必要があります');
                return;
            }

            notificationData.seasonStart = startDate;
            notificationData.seasonEnd = endDate;
            saveNotificationData();
            alert('漁期が保存されました');
        }

        function saveNotificationData() {
            localStorage.setItem('hoshibaNotificationData', JSON.stringify(notificationData));
        }

        // 午後4時の通知スケジューリング
        function scheduleNextNotification() {
            if (!notificationData.enabled) return;

            const now = new Date();
            const today4PM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 16, 0, 0);

            // 今日の4時が過ぎていれば明日の4時に設定
            if (now > today4PM) {
                today4PM.setDate(today4PM.getDate() + 1);
            }

            const timeUntilNotification = today4PM - now;

            setTimeout(() => {
                checkAndSendNotification();
                // 次回の通知をスケジュール（24時間後）
                scheduleNextNotification();
            }, timeUntilNotification);

            console.log(`次回通知予定: ${today4PM.toLocaleString()}`);
        }

        function checkAndSendNotification() {
            // 漁期チェック
            const today = new Date().toISOString().split('T')[0];

            if (notificationData.seasonStart && today < notificationData.seasonStart) {
                console.log('漁期前のため通知をスキップ');
                return;
            }

            if (notificationData.seasonEnd && today > notificationData.seasonEnd) {
                console.log('漁期後のため通知をスキップ');
                return;
            }

            // 沖止め日チェック（明日が沖止めなら今日は通知しない）
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            if (notificationData.offDays.includes(tomorrowStr)) {
                console.log('明日は沖止めのため通知をスキップ');
                return;
            }

            // お気に入り干場の予報を取得して通知
            if (favorites.length > 0 && 'Notification' in window && Notification.permission === 'granted') {
                sendForecastNotifications();
            }
        }

        async function sendForecastNotifications() {
            for (const favoriteIndex of favorites) {
                const spot = hoshibaSpots[favoriteIndex];

                try {
                    const response = await fetch(`/api/forecast?lat=${spot.lat}&lon=${spot.lon}&name=${encodeURIComponent(spot.name)}`);
                    const data = await response.json();

                    if (data.forecast && data.forecast.length > 0) {
                        const tomorrow = data.forecast[0]; // 1日後の予報

                        const title = `🌊 ${spot.name} 明日の予報`;
                        const body = `降水: ${tomorrow.precipitation}mm, 湿度: ${tomorrow.min_humidity}%, 風速: ${tomorrow.avg_wind}m/s\n判定: ${tomorrow.recommendation}`;

                        new Notification(title, {
                            body: body,
                            icon: '/static/icon-192x192.png',
                            badge: '/static/badge-72x72.png',
                            tag: `forecast-${spot.name}`,
                            requireInteraction: false
                        });
                    }
                } catch (error) {
                    console.error(`通知送信エラー (${spot.name}):`, error);
                }

                // 通知間隔を空ける（連続送信を避ける）
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        window.toggleNotifications = toggleNotifications;
        window.addOffDay = addOffDay;
        window.removeOffDay = removeOffDay;
        window.saveSeasonDates = saveSeasonDates;

        // ========================================
        // オフライン同期機能 (仕様書 lines 41-44)
        // ========================================

        let pendingSyncData = JSON.parse(localStorage.getItem('pendingSyncData')) || [];

        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const iconSpan = document.getElementById('statusIcon');
            const textSpan = document.getElementById('statusText');

            if (navigator.onLine) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                iconSpan.textContent = '🌐';
                textSpan.textContent = 'オンライン';

                // オンライン復帰時に保留中データを同期
                if (pendingSyncData.length > 0) {
                    syncPendingData();
                }
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                iconSpan.textContent = '📴';
                textSpan.textContent = `オフライン (${pendingSyncData.length}件保存中)`;
            }
        }

        async function syncPendingData() {
            if (pendingSyncData.length === 0) return;

            const textSpan = document.getElementById('statusText');
            textSpan.textContent = `同期中... (${pendingSyncData.length}件)`;

            let successCount = 0;
            let failedData = [];

            for (const dataItem of pendingSyncData) {
                try {
                    const response = await fetch(dataItem.endpoint, {
                        method: dataItem.method || 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataItem.data)
                    });

                    if (response.ok) {
                        successCount++;
                        console.log(`同期成功: ${dataItem.endpoint}`);
                    } else {
                        failedData.push(dataItem);
                        console.error(`同期失敗: ${dataItem.endpoint}`, response.status);
                    }
                } catch (error) {
                    failedData.push(dataItem);
                    console.error(`同期エラー: ${dataItem.endpoint}`, error);
                }
            }

            // 同期結果を保存
            pendingSyncData = failedData;
            localStorage.setItem('pendingSyncData', JSON.stringify(pendingSyncData));

            // ユーザーに通知
            if (successCount > 0) {
                alert(`${successCount}件のデータを同期しました`);
            }

            if (failedData.length > 0) {
                alert(`${failedData.length}件のデータ同期に失敗しました。後で再試行します。`);
            }

            updateConnectionStatus();
        }

        function addPendingSyncData(endpoint, data, method = 'POST') {
            pendingSyncData.push({
                endpoint: endpoint,
                data: data,
                method: method,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pendingSyncData', JSON.stringify(pendingSyncData));
            updateConnectionStatus();
        }

        // オンライン/オフラインイベント監視
        window.addEventListener('online', () => {
            console.log('オンラインに復帰しました');
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            console.log('オフラインになりました');
            updateConnectionStatus();
        });

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', () => {
            // all_spots_array.jsからのデータ読み込み確認
            if (typeof hoshibaSpots !== 'undefined') {
                console.log(`Loaded ${hoshibaSpots.length} hoshiba spots from all_spots_array.js`);
                // H_1174_2017の所属確認
                const spot = hoshibaSpots.find(s => s.name === 'H_1174_2017');
                if (spot) {
                    console.log(`H_1174_2017: ${spot.town}, ${spot.district}, ${spot.buraku}`);
                }
            } else {
                console.error('hoshibaSpots not loaded from all_spots_array.js');
            }

            addHoshibaMarkers();

            document.getElementById('showFavoritesBtn').addEventListener('click', showFavorites);
            document.getElementById('clearFavoritesBtn').addEventListener('click', clearAllFavorites);

            // 通知システム初期化
            initializeNotifications();
            if (notificationData.enabled) {
                scheduleNextNotification();
            }

            // オフライン状態初期化
            updateConnectionStatus();
        });

        // フィードバック送信機能
        function submitFeedback(date, rating) {
            if (!selectedSpot) return;

            const feedbackKey = `${selectedSpot.name}_${date}`;

            // フィードバックデータ保存
            feedbackData[feedbackKey] = {
                spot: selectedSpot.name,
                date: date,
                rating: rating,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('forecastFeedback', JSON.stringify(feedbackData));

            // ボタンの状態を変更
            const buttons = document.querySelectorAll(`[onclick*="${date}"]`);
            buttons.forEach(btn => {
                btn.classList.add('feedback-submitted');
                btn.textContent = '送信済み';
                btn.onclick = null;
            });

            // 確認メッセージ
            showFeedbackMessage(`${date}の乾燥状況フィードバックを送信しました`);

            // サーバーに送信（実装時）
            sendFeedbackToServer(feedbackKey, feedbackData[feedbackKey]);
        }

        function showFeedbackMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 14px;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        async function sendFeedbackToServer(key, data) {
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ key, data })
                });
            } catch (error) {
                console.log('フィードバックはローカルに保存されました');
            }
        }

        // 干場管理機能
        let addSpotMode = false;

        function enableAddSpotMode() {
            addSpotMode = !addSpotMode;
            const btn = document.getElementById('addSpotBtn');
            const instructions = document.getElementById('addSpotInstructions');

            if (addSpotMode) {
                btn.textContent = '❌ 追加モードを終了';
                btn.style.background = '#dc3545';
                instructions.style.display = 'block';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = '➕ 新しい干場を追加';
                btn.style.background = '#28a745';
                instructions.style.display = 'none';
                map.getContainer().style.cursor = '';
            }
        }

        async function addSpotAtLocation(lat, lon) {
            try {
                const response = await fetch('/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lon: lon,
                        town: '',
                        district: '',
                        buraku: ''
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`新しい干場が追加されました: ${result.spot.name}`);
                    // ページをリロードして新しい干場を表示
                    location.reload();
                } else {
                    alert(`エラー: ${result.message}`);
                }
            } catch (error) {
                alert(`エラーが発生しました: ${error.message}`);
            }
        }

        async function deleteSpot(index) {
            const spot = hoshibaSpots[index];

            if (!confirm(`本当に「${spot.name}」を削除しますか？この操作は取り消せません。`)) {
                return;
            }

            try {
                const response = await fetch('/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: spot.name
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`干場「${spot.name}」が削除されました`);
                    // ページをリロードして変更を反映
                    location.reload();
                } else {
                    alert(`エラー: ${result.message}`);
                }
            } catch (error) {
                alert(`エラーが発生しました: ${error.message}`);
            }
        }

        // 地図クリックイベントリスナー
        map.on('click', function(e) {
            if (addSpotMode) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                addSpotAtLocation(lat, lon);
                enableAddSpotMode(); // 追加モードを終了
            }
        });

        // 記録機能
        let currentRecordSpotIndex = null;

        function showRecordForm(index) {
            console.log('showRecordForm called with index:', index);
            currentRecordSpotIndex = index;
            const spot = hoshibaSpots[index];
            console.log('Selected spot:', spot);

            const container = document.getElementById('recordFormContainer');
            const spotInfo = document.getElementById('recordSpotInfo');
            const dateInput = document.getElementById('recordDate');
            const existingInfo = document.getElementById('existingRecordInfo');

            console.log('Container element:', container);

            if (!container) {
                console.error('Record form container not found!');
                return;
            }

            // 干場情報を表示
            spotInfo.innerHTML = `<strong>${spot.name}</strong><br><small>${spot.town} ${spot.district}</small>`;

            // 今日の日付をデフォルトに設定
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;

            // 既存記録をクリア
            existingInfo.innerHTML = '';

            // フォームを表示
            container.style.display = 'block';
            console.log('Record form should be visible now');

            // 日付変更時のイベントリスナー
            dateInput.onchange = function() {
                checkExistingRecord(spot.name, this.value);
            };

            // 初期チェック
            checkExistingRecord(spot.name, today);
        }

        async function checkExistingRecord(name, date) {
            try {
                const response = await fetch(`/record/${name}/${date}`);
                const data = await response.json();
                const existingInfo = document.getElementById('existingRecordInfo');

                if (data.exists) {
                    existingInfo.innerHTML = `
                        <div class="existing-record">
                            <strong>既存の記録:</strong><br>
                            ${data.record.date}: ${data.record.result}<br>
                            <small>記録を変更する場合は、下のボタンを選択してください</small>
                        </div>
                    `;
                } else {
                    existingInfo.innerHTML = '';
                }
            } catch (error) {
                console.error('記録確認エラー:', error);
            }
        }

        async function submitRecord(result) {
            if (currentRecordSpotIndex === null) return;

            const spot = hoshibaSpots[currentRecordSpotIndex];
            const date = document.getElementById('recordDate').value;

            if (!date) {
                alert('日付を選択してください');
                return;
            }

            try {
                const response = await fetch('/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: spot.name,
                        date: date,
                        result: result
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(data.message);
                    closeRecordForm();
                } else {
                    alert(`エラー: ${data.message}`);
                }
            } catch (error) {
                alert(`エラーが発生しました: ${error.message}`);
            }
        }

        function closeRecordForm() {
            document.getElementById('recordFormContainer').style.display = 'none';
            currentRecordSpotIndex = null;
        }

        // ============================================================
        // 等値線マップ表示機能
        // ============================================================

        let currentContourType = '500hpa';
        let currentContourTime = 0;
        let calibrationData = null;

        // 予報補正情報を取得
        async function loadCalibrationData() {
            try {
                const response = await fetch('/api/forecast_calibration');
                calibrationData = await response.json();
                updateCalibrationDisplay();
            } catch (error) {
                console.error('補正情報の取得に失敗:', error);
            }
        }

        // 補正情報の表示を更新
        function updateCalibrationDisplay() {
            if (!calibrationData) return;

            const detailsDiv = document.getElementById('calibrationDetails');
            const weights = calibrationData.weights;

            detailsDiv.innerHTML = `
                <div style="margin-top: 8px;">
                    <div style="margin-bottom: 5px;">
                        <strong>500hPa 渦度:</strong>
                        信頼度 ${(weights.vorticity_500hPa * 100).toFixed(0)}%
                        ${weights.vorticity_500hPa < 0.5 ? '⚠️ 要注意' : '✓ 使用可'}
                    </div>
                    <div>
                        <strong>700hPa 鉛直流:</strong>
                        信頼度 ${(weights.omega_700hPa * 100).toFixed(0)}%
                        ${weights.omega_700hPa < 0.5 ? '⚠️ 要注意' : '✓ 使用可'}
                    </div>
                </div>
            `;
        }

        // 等値線マップの種類を切り替え
        function showContourMap(type) {
            currentContourType = type;

            // ボタンのスタイルを更新
            document.getElementById('contour500Btn').style.background = type === '500hpa' ? '#667eea' : '#e9ecef';
            document.getElementById('contour500Btn').style.color = type === '500hpa' ? 'white' : '#333';
            document.getElementById('contour700Btn').style.background = type === '700hpa' ? '#667eea' : '#e9ecef';
            document.getElementById('contour700Btn').style.color = type === '700hpa' ? 'white' : '#333';

            // マップ画像を更新
            updateContourImage();
        }

        // 等値線マップ画像を更新
        function updateContourImage() {
            const img = document.getElementById('contourMapImage');
            const caption = document.getElementById('contourMapCaption');

            const timeStr = `t${String(currentContourTime).padStart(4, '0')}`;

            if (currentContourType === '500hpa') {
                img.src = `/api/contour/contour_500hpa_${timeStr}.png`;
                caption.textContent = '500hPa 高度場・相対渦度';
            } else {
                img.src = `/api/contour/contour_700hpa_omega_${timeStr}.png`;
                caption.textContent = '700hPa 高度場・鉛直P速度';
            }
        }

        // エマグラム用Chart.jsインスタンス
        let emagramChart = null;

        // エマグラム時刻選択肢を生成（固定時刻: 各日の6, 9, 12, 15, 18時JST）
        function generateEmagramTimeOptions() {
            updateEmagramTimeOptions();
        }

        // エマグラム時刻選択肢を更新（選択された予報日に基づく）
        function updateEmagramTimeOptions() {
            console.log('updateEmagramTimeOptions called, currentForecastDay:', currentForecastDay);

            const select = document.getElementById('emagramTimeSelect');
            if (!select) {
                console.log('emagramTimeSelect element not found');
                return;
            }

            const now = new Date();
            const currentHour = now.getHours();
            console.log('Current hour:', currentHour);

            let options = '';

            // 作業時間帯の固定時刻（JST）
            const workHours = [6, 9, 12, 15, 18];

            // 選択された日のみの時刻を表示
            const day = currentForecastDay;
            const dayLabel = day === 0 ? '今日' : day === 1 ? '明日' : day === 2 ? '明後日' : `${day}日後`;
            console.log('Generating options for day:', day, '(', dayLabel, ')');

            workHours.forEach(hour => {
                // 今日の場合、過去の時刻はスキップ
                if (day === 0 && hour <= currentHour) {
                    console.log('Skipping past hour:', hour);
                    return;
                }

                // 現在時刻からの経過時間を計算
                let hoursFromNow = (day * 24) + (hour - currentHour);

                // 168時間（7日間）以内
                if (hoursFromNow >= 0 && hoursFromNow <= 168) {
                    const timeLabel = `${hour}時`;
                    options += `<option value="${hoursFromNow}">${timeLabel} (${hoursFromNow}h後)</option>`;
                    console.log('Added option:', hour, 'h (', hoursFromNow, 'h from now)');
                }
            });

            console.log('Total options generated:', options ? 'yes' : 'no');
            select.innerHTML = options;

            // エマグラムを自動的に更新
            if (options && selectedSpot) {
                console.log('Calling loadEmagramData()');
                loadEmagramData();
            } else {
                console.log('Not loading emagram - options:', !!options, 'selectedSpot:', !!selectedSpot);
            }
        }

        // エマグラムデータを読み込み
        async function loadEmagramData() {
            const timeOffset = document.getElementById('emagramTimeSelect').value;
            const spot = hoshibaSpots[currentSpotId];

            if (!spot) return;

            try {
                const response = await fetch(`/api/emagram?lat=${spot.lat}&lon=${spot.lon}&time=${timeOffset}`);
                const result = await response.json();

                if (result.status === 'success') {
                    drawEmagram(result.data);
                } else {
                    console.error('Failed to load emagram data:', result.message);
                }
            } catch (error) {
                console.error('Error loading emagram:', error);
            }
        }

        // エマグラムを描画
        function drawEmagram(data) {
            const ctx = document.getElementById('emagramCanvas').getContext('2d');

            // 既存のチャートを破棄
            if (emagramChart) {
                emagramChart.destroy();
            }

            // データはそのまま使用（reverseしない）
            const pressures = data.pressure;
            const temps = data.temperature;
            const dewpoints = data.dewpoint;

            // 気温と気圧のペアを作成（X軸=気温、Y軸=気圧）
            const tempPoints = temps.map((t, i) => ({ x: t, y: pressures[i] }));
            const dewpointPoints = dewpoints.map((d, i) => ({ x: d, y: pressures[i] }));

            emagramChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: '気温 (°C)',
                            data: tempPoints,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#dc3545',
                            tension: 0.1
                        },
                        {
                            label: '露点温度 (°C)',
                            data: dewpointPoints,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#007bff',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '気温 (°C)',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            type: 'linear',
                            reverse: true,
                            title: {
                                display: true,
                                text: '気圧 (hPa)',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 12 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `気圧: ${context[0].parsed.y} hPa`;
                                },
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const dataset = context.dataset.label;
                                    return `${dataset}: ${value.toFixed(1)}°C`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const temp = temps[index];
                                    const dewpoint = dewpoints[index];
                                    const spread = temp - dewpoint;
                                    const relHumidity = 100 - (spread * 5); // 簡易計算
                                    return `T-Td: ${spread.toFixed(1)}°C (RH≈${Math.max(0, relHumidity).toFixed(0)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 解析情報を追加
            updateEmagramAnalysis(data);
        }

        // エマグラム解析情報を更新
        function updateEmagramAnalysis(data) {
            const infoDiv = document.getElementById('emagramInfo');

            // 逆転層の検出
            let inversionLayers = [];
            for (let i = 0; i < data.temperature.length - 1; i++) {
                if (data.temperature[i+1] > data.temperature[i]) {
                    inversionLayers.push({
                        pressure: data.pressure[i],
                        height: data.height[i],
                        strength: data.temperature[i+1] - data.temperature[i]
                    });
                }
            }

            // 雲底高度の推定（露点差が2℃以下の最低層）
            let cloudBase = null;
            for (let i = data.temperature.length - 1; i >= 0; i--) {
                const spread = data.temperature[i] - data.dewpoint[i];
                if (spread <= 2.0) {
                    cloudBase = {
                        pressure: data.pressure[i],
                        height: data.height[i]
                    };
                    break;
                }
            }

            // 850hPaの湿度（霧発生の目安）
            const idx850 = data.pressure.indexOf(850);
            let humidity850 = null;
            if (idx850 >= 0) {
                const spread850 = data.temperature[idx850] - data.dewpoint[idx850];
                humidity850 = 100 - (spread850 * 5); // 簡易計算
            }

            // 解析結果を表示
            let analysisHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>📌 読み方:</strong>
                </div>
                <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8;">
                    <li><span style="color: #dc3545; font-weight: bold;">赤線</span>: 気温（右に高温）</li>
                    <li><span style="color: #007bff; font-weight: bold;">青線</span>: 露点温度（気温に近いほど湿潤）</li>
                    <li><strong>気温と露点が接近</strong>: 湿度100%に近い（霧・雲発生層）</li>
                    <li><strong>気温が上に向かって上昇</strong>: 逆転層（霧・汚染物質の閉じ込め）</li>
                    <li><strong>気温と露点の差が大きい</strong>: 乾燥した空気（乾燥に有利）</li>
                </ul>

                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 3px;">
                    <strong>🔍 自動解析結果:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
            `;

            if (inversionLayers.length > 0) {
                analysisHTML += `<li><strong>逆転層:</strong> ${inversionLayers.length}層検出`;
                inversionLayers.forEach(inv => {
                    analysisHTML += ` (${inv.pressure}hPa付近 +${inv.strength.toFixed(1)}°C)`;
                });
                analysisHTML += ` ⚠️ 霧の持続・発達に注意</li>`;
            } else {
                analysisHTML += `<li><strong>逆転層:</strong> なし ✓ 大気混合良好</li>`;
            }

            if (cloudBase) {
                analysisHTML += `<li><strong>推定雲底:</strong> ${(cloudBase.height/1000).toFixed(1)}km (${cloudBase.pressure}hPa) 🌫️</li>`;
            } else {
                analysisHTML += `<li><strong>推定雲底:</strong> なし（晴天） ☀️</li>`;
            }

            if (humidity850 !== null) {
                const fogRisk = humidity850 >= 95 ? '⚠️ 高' : humidity850 >= 90 ? '△ 中' : '✓ 低';
                analysisHTML += `<li><strong>850hPa湿度:</strong> ${humidity850.toFixed(0)}% (霧リスク: ${fogRisk})</li>`;
            }

            analysisHTML += `
                    </ul>
                </div>
            `;

            infoDiv.innerHTML = analysisHTML;
        }

        // 干場選択時にエマグラムと等値線マップを表示
        const originalSelectSpot = selectSpot;
        selectSpot = function(spotId) {
            originalSelectSpot(spotId);
            currentSpotId = spotId;

            // エマグラムセクションを表示
            document.getElementById('emagramSection').style.display = 'block';

            // エマグラム時刻選択肢を生成
            generateEmagramTimeOptions();

            // エマグラムデータを読み込み
            loadEmagramData();

            // 等値線マップセクションを表示
            document.getElementById('contourMapSection').style.display = 'block';

            // 初回ロード時
            if (!calibrationData) {
                loadCalibrationData();
            }

            // 最初のマップを表示
            showContourMap('500hpa');
        };

        // サイドバータブ切り替え機能
        function switchSidebarTab(tabName) {
            // すべてのタブボタンとコンテンツを非アクティブ化
            document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#6c757d';
                btn.style.fontWeight = '500';
            });

            document.querySelectorAll('.sidebar-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // 選択されたタブをアクティブ化
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.borderBottomColor = '#667eea';
                activeBtn.style.color = '#667eea';
                activeBtn.style.fontWeight = '600';
            }

            const activeContent = document.getElementById(`${tabName}TabContent`);
            if (activeContent) {
                activeContent.classList.add('active');
                activeContent.style.display = 'block';
            }

            // 等値線タブに切り替えた時、時刻オプションを初期化
            if (tabName === 'contour') {
                updateContourTimeOptions();
            }
        }

        // カテゴリーに応じて時刻オプションを動的生成
        function updateContourTimeOptions() {
            const category = document.getElementById('contourCategory').value;
            const timeSelect = document.getElementById('contourTime');

            if (!category) {
                timeSelect.innerHTML = '<option value="">-- カテゴリーを先に選択 --</option>';
                return;
            }

            // 地上レベルか海域レベルか高層レベルかを判定
            const isSurface = ['temperature', 'humidity', 'pressure', 'wind', 'precipitation'].includes(category);
            const isMarine = ['wave_height', 'wave_direction_period'].includes(category);
            const isUpperAir = ['vorticity_500hpa', 'omega_700hpa', 'theta_e_850hpa',
                                'jet_stream_300hpa', 'height_anomaly_200hpa'].includes(category);

            let options = '';

            if (isSurface || isMarine) {
                // 地上レベル・海域レベル（漁師向け）：1時間刻み、0-168時間（7日間）
                options += '<optgroup label="短期詳細（1時間刻み）">';
                options += '<option value="0">現在</option>';
                for (let h = 1; h <= 48; h++) {
                    options += `<option value="${h}">${h}時間後</option>`;
                }
                options += '</optgroup>';

                options += '<optgroup label="週間予報（3時間刻み）">';
                for (let h = 51; h <= 168; h += 3) {
                    const days = Math.floor(h / 24);
                    const hours = h % 24;
                    options += `<option value="${h}">${h}時間後 (${days}日${hours}時間後)</option>`;
                }
                options += '</optgroup>';
            } else if (isUpperAir) {
                // 高層レベル（専門家向け）：3時間刻み、0-384時間（16日間）
                options += '<optgroup label="短期予報（3時間刻み）">';
                options += '<option value="0">現在</option>';
                for (let h = 3; h <= 72; h += 3) {
                    options += `<option value="${h}">${h}時間後</option>`;
                }
                options += '</optgroup>';

                options += '<optgroup label="週間予報（6時間刻み）">';
                for (let h = 78; h <= 168; h += 6) {
                    const days = Math.floor(h / 24);
                    options += `<option value="${h}">${h}時間後 (${days}日目)</option>`;
                }
                options += '</optgroup>';

                options += '<optgroup label="長期傾向（12時間刻み・参考）">';
                for (let h = 180; h <= 384; h += 12) {
                    const days = Math.floor(h / 24);
                    options += `<option value="${h}">${h}時間後 (${days}日目・参考)</option>`;
                }
                options += '</optgroup>';
            }

            timeSelect.innerHTML = options;
        }

        // 等値線解析マップを読み込み
        async function loadContourAnalysis() {
            const category = document.getElementById('contourCategory').value;
            const timeOffset = document.getElementById('contourTime').value;

            if (!category) {
                alert('解析カテゴリーを選択してください');
                return;
            }

            const displayDiv = document.getElementById('contourMapDisplay');
            const imageDiv = document.getElementById('contourMapImage');
            const metadataDiv = document.getElementById('contourMetadata');

            // 表示エリアを表示
            displayDiv.style.display = 'block';
            imageDiv.innerHTML = '<p style="color: #999;">解析図を読み込み中...</p>';
            metadataDiv.innerHTML = '';

            try {
                // APIリクエスト
                const response = await fetch(`/api/analysis/contours?type=${category}&time=${timeOffset}`);
                const data = await response.json();

                if (data.status === 'success') {
                    // 画像表示
                    if (data.visualization_url) {
                        imageDiv.innerHTML = `
                            <img src="${data.visualization_url}"
                                 alt="${data.map_type}解析図"
                                 style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        `;
                    } else if (data.contour_data) {
                        // データのみの場合はテキスト表示
                        imageDiv.innerHTML = `
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: left; max-height: 300px; overflow-y: auto;">
                                <pre style="margin: 0; font-size: 0.75rem;">${JSON.stringify(data.contour_data, null, 2)}</pre>
                            </div>
                        `;
                    } else if (data.parameter) {
                        // APIからパラメータ情報が返された場合
                        let valueDisplay = '';
                        if (data.value !== undefined && data.value !== null) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>${data.value} ${data.unit || ''}</strong></p>`;
                        } else if (data.wind_speed !== undefined || data.wind_direction !== undefined) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>風速: ${data.wind_speed || '--'} ${data.unit || 'm/s'} / 風向: ${data.wind_direction || '--'}°</strong></p>`;
                        } else if (data.wave_height !== undefined) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>${data.wave_height || '--'} ${data.unit || 'm'}</strong></p>`;
                            if (data.work_safety) {
                                valueDisplay += `<p style="margin: 10px 0; padding: 10px; background: ${data.work_safety.includes('危険') ? '#fee' : data.work_safety.includes('注意') ? '#ffe' : '#efe'}; border-radius: 5px;"><strong>作業安全度:</strong> ${data.work_safety}</p>`;
                            }
                        } else if (data.temperature_500hpa !== undefined) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>500hPa気温: ${data.temperature_500hpa}°C</strong></p>`;
                        } else if (data.temperature_700hpa !== undefined) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>700hPa気温: ${data.temperature_700hpa}°C</strong></p>`;
                        } else if (data.equivalent_potential_temperature !== undefined) {
                            valueDisplay = `<p style="font-size: 1.2rem; color: #667eea; margin: 10px 0;"><strong>相当温位: ${data.equivalent_potential_temperature} K</strong></p>`;
                        }

                        imageDiv.innerHTML = `
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <p style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">${data.parameter}</p>
                                ${valueDisplay}
                                ${data.message ? `<p style="font-size: 0.85rem; color: #666; margin-top: 10px;">${data.message}</p>` : ''}
                            </div>
                        `;
                    } else {
                        imageDiv.innerHTML = '<p style="color: #dc3545;">解析データが見つかりませんでした</p>';
                    }

                    // メタデータ表示
                    const categoryInfo = {
                        'temperature': { name: '等温線（気温分布）', level: '地上', interval: '1時間刻み' },
                        'humidity': { name: '等湿線（湿度分布）', level: '地上', interval: '1時間刻み' },
                        'pressure': { name: '等圧線（気圧分布）', level: '地上', interval: '1時間刻み' },
                        'wind': { name: '風向・風速場', level: '地上', interval: '1時間刻み' },
                        'precipitation': { name: '降水量分布', level: '地上', interval: '1時間刻み' },
                        'wave_height': { name: '有義波高分布', level: '海面', interval: '1時間刻み' },
                        'wave_direction_period': { name: '波向・波周期場', level: '海面', interval: '1時間刻み' },
                        'vorticity_500hpa': { name: '渦度場', level: '500hPa', interval: '3時間刻み' },
                        'omega_700hpa': { name: '鉛直流', level: '700hPa', interval: '3時間刻み' },
                        'theta_e_850hpa': { name: '相当温位（湿舌検出）', level: '850hPa', interval: '3時間刻み' },
                        'jet_stream_300hpa': { name: 'ジェット気流', level: '300hPa', interval: '3時間刻み' },
                        'height_anomaly_200hpa': { name: '高度偏差（ブロッキング検出）', level: '200hPa', interval: '3時間刻み' }
                    };

                    const info = categoryInfo[category] || { name: category, level: '不明', interval: '不明' };
                    const timeOffsetNum = parseInt(timeOffset);
                    const timeLabel = timeOffsetNum === 0 || timeOffset === 'current' ? '現在' : `${timeOffset}時間後`;
                    const days = Math.floor(timeOffsetNum / 24);
                    const hours = timeOffsetNum % 24;

                    // 予報精度の評価
                    let accuracyNote = '';
                    if (timeOffsetNum <= 72) {
                        accuracyNote = '<span style="color: #28a745;">●</span> 高精度（短期予報）';
                    } else if (timeOffsetNum <= 168) {
                        accuracyNote = '<span style="color: #ffc107;">●</span> 中精度（週間予報）';
                    } else {
                        accuracyNote = '<span style="color: #dc3545;">●</span> 参考程度（長期傾向）';
                    }

                    metadataDiv.innerHTML = `
                        <div><strong>解析カテゴリー:</strong> ${info.name}</div>
                        <div><strong>気圧面:</strong> ${info.level}</div>
                        <div><strong>時間分解能:</strong> ${info.interval}</div>
                        <div><strong>解析時刻:</strong> ${timeLabel} ${days > 0 ? `(${days}日${hours}時間後)` : ''} (JST)</div>
                        <div><strong>予報精度:</strong> ${accuracyNote}</div>
                        <div><strong>対象エリア:</strong> 利尻島全域</div>
                        ${data.grid_resolution ? `<div><strong>格子解像度:</strong> ${data.grid_resolution}</div>` : ''}
                        ${data.interpolation_method ? `<div><strong>補間手法:</strong> ${data.interpolation_method}</div>` : ''}
                        ${data.data_source ? `<div><strong>データソース:</strong> ${data.data_source}</div>` : ''}
                        ${data.parameter ? `<div><strong>パラメータ:</strong> ${data.parameter} (${data.unit || ''})</div>` : ''}
                        ${data.equivalent_potential_temperature ? `<div><strong>相当温位値:</strong> ${data.equivalent_potential_temperature.toFixed(1)} K</div>` : ''}
                        ${data.jet_intensity ? `<div><strong>ジェット強度:</strong> ${data.jet_intensity}</div>` : ''}
                        ${data.wind_speed_ms ? `<div><strong>風速:</strong> ${data.wind_speed_ms.toFixed(1)} m/s</div>` : ''}
                        ${data.height_anomaly !== undefined && data.height_anomaly !== null ? `<div><strong>高度偏差:</strong> ${data.height_anomaly > 0 ? '+' : ''}${data.height_anomaly.toFixed(0)} m</div>` : ''}
                        ${data.anomaly_category ? `<div><strong>偏差評価:</strong> ${data.anomaly_category}</div>` : ''}
                        ${data.wave_height !== undefined && data.wave_height !== null ? `<div><strong>有義波高:</strong> ${data.wave_height.toFixed(2)} m</div>` : ''}
                        ${data.work_safety ? `<div><strong>作業安全度:</strong> ${data.work_safety}</div>` : ''}
                        ${data.wave_period ? `<div><strong>波周期:</strong> ${data.wave_period.toFixed(1)} 秒</div>` : ''}
                        ${data.wave_direction ? `<div><strong>波向:</strong> ${data.wave_direction.toFixed(0)}°</div>` : ''}
                        ${data.swell_condition ? `<div><strong>うねり状態:</strong> ${data.swell_condition}</div>` : ''}
                        ${data.message ? `<div style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 5px; color: #004085; font-size: 0.75rem;">💡 ${data.message}</div>` : ''}
                        ${timeOffsetNum > 168 ? `
                            <div style="margin-top: 10px; padding: 8px; background: #f8d7da; border-radius: 5px; color: #721c24; font-size: 0.75rem;">
                                ⚠️ 8日目以降の予報は精度が低下します。長期的な気圧配置パターンの傾向把握にご利用ください。
                            </div>
                        ` : ''}
                    `;
                } else {
                    imageDiv.innerHTML = `<p style="color: #dc3545;">エラー: ${data.message || '解析図の読み込みに失敗しました'}</p>`;
                }
            } catch (error) {
                console.error('等値線解析エラー:', error);
                imageDiv.innerHTML = `<p style="color: #dc3545;">エラー: ${error.message}</p>`;
            }
        }

        // カテゴリーや時刻が変更されたときに自動更新（オプション）
        function updateContourDisplay() {
            const category = document.getElementById('contourCategory').value;
            const time = document.getElementById('contourTime').value;

            if (category && time) {
                // 自動読み込みは行わず、ボタンクリックを促す
                const displayDiv = document.getElementById('contourMapDisplay');
                if (displayDiv.style.display === 'block') {
                    // 既に表示されている場合は自動更新
                    loadContourAnalysis();
                }
            }
        }

        // グローバル関数として公開（popup内で使用するため）
        window.selectSpot = selectSpot;
        window.toggleFavorite = toggleFavorite;
        window.submitFeedback = submitFeedback;
        window.enableAddSpotMode = enableAddSpotMode;
        window.deleteSpot = deleteSpot;
        window.showRecordForm = showRecordForm;
        window.submitRecord = submitRecord;
        window.closeRecordForm = closeRecordForm;
        window.showContourMap = showContourMap;
        window.switchSidebarTab = switchSidebarTab;
        window.loadContourAnalysis = loadContourAnalysis;
        window.updateContourDisplay = updateContourDisplay;
    </script>

</body>
</html>