<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´ãƒãƒƒãƒ— - 7æ—¥é–“äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js for forecast charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
            background: white;
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .forecast-panel {
            width: 400px;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .forecast-panel.active {
            display: block;
        }

        .forecast-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .forecast-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .forecast-date {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .forecast-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .suitability {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }

        .excellent { background: #d4edda; color: #155724; }
        .good { background: #cce7ff; color: #004085; }
        .fair { background: #fff3cd; color: #856404; }
        .poor { background: #f8d7da; color: #721c24; }

        .instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .chart-container {
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom marker styles */
        .custom-div-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .selected-marker {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f) !important;
            transform: scale(1.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒŠ åˆ©å°»å³¶æ˜†å¸ƒå¹²å ´äºˆå ±ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å¹²å ´ã‚’é¸æŠã—ã¦7æ—¥é–“ã®ä¹¾ç‡¥é©æ€§äºˆå ±ã‚’ç¢ºèªã§ãã¾ã™</p>
    </div>

    <div class="instructions">
        <strong>ä½¿ã„æ–¹:</strong> åœ°å›³ä¸Šã®ğŸ”µãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å¹²å ´ã®è©³ç´°ãª7æ—¥é–“äºˆå ±ãŒå³å´ã«è¡¨ç¤ºã•ã‚Œã¾ã™
    </div>

    <div class="container">
        <div id="map"></div>

        <div class="forecast-panel" id="forecastPanel">
            <div class="forecast-header">
                <h3 id="selectedSpotName">å¹²å ´ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                <p id="selectedSpotLocation"></p>
            </div>

            <div id="forecastContent">
                <div class="loading">
                    <div class="spinner"></div>
                    äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...
                </div>
            </div>

            <div class="chart-container">
                <canvas id="forecastChart" width="350" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // åˆ©å°»å³¶ã®ä¸­å¿ƒåº§æ¨™
        const RISHIRI_CENTER = [45.178269, 141.228528];

        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        const map = L.map('map').setView(RISHIRI_CENTER, 12);

        // OpenStreetMap ã‚¿ã‚¤ãƒ«
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚«ãƒ¼
        let selectedMarker = null;
        let selectedSpot = null;
        let forecastChart = null;

        // å¹²å ´ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®hoshiba_spots.csvãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠœç²‹ï¼‰
        const hoshibaSpots = [
            { name: "é‡ä¸­å¹²å ´1", lat: 45.1021947, lon: 141.247311, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "é‡ä¸­" },
            { name: "é‡ä¸­å¹²å ´2", lat: 45.1025111, lon: 141.2483481, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "é‡ä¸­" },
            { name: "é‡ä¸­å¹²å ´3", lat: 45.1034294, lon: 141.2485286, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "é‡ä¸­" },
            { name: "å—æµœå¹²å ´1", lat: 45.1094479, lon: 141.268727, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "å—æµœ" },
            { name: "å—æµœå¹²å ´2", lat: 45.1089406, lon: 141.2701461, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "å—æµœ" },
            { name: "å—æµœå¹²å ´3", lat: 45.1098663, lon: 141.2701888, town: "åˆ©å°»å¯Œå£«ç”º", district: "é¬¼è„‡", buraku: "å—æµœ" },
            { name: "æ²“å½¢å¹²å ´1", lat: 45.1445, lon: 141.2156, town: "åˆ©å°»ç”º", district: "æ²“å½¢", buraku: "æ²“å½¢" },
            { name: "æ²“å½¢å¹²å ´2", lat: 45.1465, lon: 141.2176, town: "åˆ©å°»ç”º", district: "æ²“å½¢", buraku: "æ²“å½¢" },
            { name: "ä»™æ³•å¿—å¹²å ´1", lat: 45.1278, lon: 141.1845, town: "åˆ©å°»ç”º", district: "ä»™æ³•å¿—", buraku: "ä»™æ³•å¿—" },
            { name: "ä»™æ³•å¿—å¹²å ´2", lat: 45.1298, lon: 141.1865, town: "åˆ©å°»ç”º", district: "ä»™æ³•å¿—", buraku: "ä»™æ³•å¿—" },
            { name: "æœ¬æ³Šå¹²å ´", lat: 45.2023, lon: 141.2234, town: "åˆ©å°»å¯Œå£«ç”º", district: "æœ¬æ³Š", buraku: "æœ¬æ³Š" },
            { name: "é´›æ³Šå¹²å ´", lat: 45.2178, lon: 141.2345, town: "åˆ©å°»å¯Œå£«ç”º", district: "é´›æ³Š", buraku: "é´›æ³Š" }
        ];

        // å¹²å ´ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        function addHoshibaMarkers() {
            hoshibaSpots.forEach((spot, index) => {
                const marker = L.circleMarker([spot.lat, spot.lon], {
                    radius: 8,
                    fillColor: '#667eea',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <strong>${spot.name}</strong><br>
                        <span style="color: #666;">${spot.town} ${spot.district}</span><br>
                        <button onclick="selectSpot(${index})" style="
                            background: #667eea;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-top: 8px;
                        ">7æ—¥é–“äºˆå ±ã‚’è¡¨ç¤º</button>
                    </div>
                `);

                marker.on('click', () => selectSpot(index));
                spot.marker = marker;
            });
        }

        // å¹²å ´é¸æŠå‡¦ç†
        async function selectSpot(index) {
            const spot = hoshibaSpots[index];

            // å‰ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            if (selectedMarker) {
                selectedMarker.setStyle({
                    fillColor: '#667eea',
                    radius: 8
                });
            }

            // æ–°ã—ã„é¸æŠã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            selectedMarker = spot.marker;
            selectedMarker.setStyle({
                fillColor: '#ff6b6b',
                radius: 12
            });

            selectedSpot = spot;

            // ãƒ‘ãƒãƒ«è¡¨ç¤º
            const panel = document.getElementById('forecastPanel');
            panel.classList.add('active');

            // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
            document.getElementById('selectedSpotName').textContent = spot.name;
            document.getElementById('selectedSpotLocation').textContent = `${spot.town} ${spot.district} ${spot.buraku}`;

            // äºˆå ±ãƒ‡ãƒ¼ã‚¿å–å¾—
            await loadForecastData(spot);
        }

        // äºˆå ±ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨è¡¨ç¤º
        async function loadForecastData(spot) {
            const forecastContent = document.getElementById('forecastContent');
            forecastContent.innerHTML = '<div class="loading"><div class="spinner"></div>äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';

            try {
                // APIå‘¼ã³å‡ºã—
                const response = await fetch(`/api/forecast?lat=${spot.lat}&lon=${spot.lon}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayForecast(data.forecasts);
                    updateChart(data.forecasts);
                } else {
                    forecastContent.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">äºˆå ±ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('Forecast fetch error:', error);
                forecastContent.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // äºˆå ±è¡¨ç¤º
        function displayForecast(forecasts) {
            const forecastContent = document.getElementById('forecastContent');
            let html = '';

            forecasts.forEach(forecast => {
                const date = new Date(forecast.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                const dayStr = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];

                html += `
                    <div class="forecast-item">
                        <div class="forecast-date">${dateStr} (${dayStr})</div>
                        <div class="forecast-data">
                            <div class="data-item">
                                <span>æœ€é«˜æ°—æ¸©:</span>
                                <span>${forecast.temperature_max}Â°C</span>
                            </div>
                            <div class="data-item">
                                <span>æ¹¿åº¦:</span>
                                <span>${forecast.humidity}%</span>
                            </div>
                            <div class="data-item">
                                <span>é¢¨é€Ÿ:</span>
                                <span>${forecast.wind_speed}km/h</span>
                            </div>
                            <div class="data-item">
                                <span>é™æ°´é‡:</span>
                                <span>${forecast.precipitation}mm</span>
                            </div>
                        </div>
                        <div class="suitability ${forecast.suitability}">
                            ä¹¾ç‡¥é©æ€§: ${getSuitabilityText(forecast.suitability)} (${forecast.drying_score}ç‚¹)
                        </div>
                    </div>
                `;
            });

            forecastContent.innerHTML = html;
        }

        // é©æ€§ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
        function getSuitabilityText(suitability) {
            const suitabilityMap = {
                'excellent': 'éå¸¸ã«è‰¯ã„',
                'good': 'è‰¯ã„',
                'fair': 'æ™®é€š',
                'poor': 'æ‚ªã„'
            };
            return suitabilityMap[suitability] || suitability;
        }

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateChart(forecasts) {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            if (forecastChart) {
                forecastChart.destroy();
            }

            const labels = forecasts.map(f => {
                const date = new Date(f.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ä¹¾ç‡¥é©æ€§ã‚¹ã‚³ã‚¢',
                            data: forecasts.map(f => f.drying_score),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'æœ€é«˜æ°—æ¸© (Â°C)',
                            data: forecasts.map(f => f.temperature_max),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '7æ—¥é–“ä¹¾ç‡¥é©æ€§äºˆå ±'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'é©æ€§ã‚¹ã‚³ã‚¢'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æ°—æ¸© (Â°C)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addHoshibaMarkers();
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ï¼ˆpopupå†…ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
        window.selectSpot = selectSpot;
    </script>
</body>
</html>